
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pablo Cibraro (Cibrax)</title>
  <meta name="author" content="Cibrax">

  
  <meta name="description" content="REST is not just about CRUD interfaces for your services, a complete
long-running workflow can be modeled through the basic verbs as well. As
my &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cibrax.me/blog/page/18">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/cibrax" rel="alternate" title="Pablo Cibraro (Cibrax)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44468149-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pablo Cibraro (Cibrax)</a></h1>
  
    <h2>All about software development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/cibrax" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cibrax.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/10/24/rest-and-workflow-services-play-well-together/">REST and Workflow Services Play Well Together</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-24T00:00:00-03:00" pubdate data-updated="true">Oct 24<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/10/24/rest-and-workflow-services-play-well-together/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>REST is not just about CRUD interfaces for your services, a complete
long-running workflow can be modeled through the basic verbs as well. As
my friend <a href="http://weblogs.asp.net/gsusx/archive/2008/10/03/new-rest-quot-must-read-quot-papers.aspx">Jesus
mentioned</a>,
the article &ldquo;<a href="http://www.infoq.com/articles/webber-rest-workflow">How to get a cup of
coffee</a>&rdquo; represents
an excellent source about this topic.</p>

<p>The example I will show here is based on that article, during the course
of this post I will try to illustrate all the steps required to
implement a workflow as the one mentioned there using WF services.
Unfortunately, no examples exist (or at least I could not find any)
about how to configure the WCF web model to use the new WF services, so
I decided to create a new one from scratch.</p>

<p>This example only illustrates the workflow from the customer point of
view, he can place an order, pay it and wait for his drink. He can also
modify the order in the middle before it is paid.</p>

<p> <img src="/images/legacy/OrderWorkflow.jpg" alt="" /></p>

<p>The interface for our REST service will looks like this:</p>

<p>[ServiceContract]</p>

<p>public interface IOrderService</p>

<p>{</p>

<p>  [OperationContract]</p>

<p>  [WebInvoke(Method=&ldquo;POST&rdquo;, UriTemplate=&ldquo;order&rdquo;)]</p>

<p>  Order PlaceOrder(Order order);</p>

<p> </p>

<p>  [OperationContract]</p>

<p>  [WebInvoke(Method = &ldquo;PUT&rdquo;, UriTemplate = &ldquo;order/{id}&rdquo;)]</p>

<p>  Order UpdateOrder(string id, Order order);</p>

<p> </p>

<p>  [OperationContract]</p>

<p>  [WebInvoke(Method=&ldquo;PUT&rdquo;, UriTemplate=&ldquo;payment/order/{id}&rdquo;)]</p>

<p>  void PayOrder(string id, Payment payment);</p>

<p>}</p>

<p>Only three operations available, each one maps exactly with one
ReceiveActivity in the workflow. For instance, the receive activity
OnOrderPlaced waits for a client call to the PlaceOrder operation and
then moves the workflow to the next state, which is &ldquo;OrderPlaced&rdquo; in
this case. While the workflow is in the state &ldquo;OrderPlaced&rdquo;, only the
operations UpdateOrder and PayOrder can be executed by the client (If he
try to execute PlaceOrder again, it will receive a 404 http error, &ldquo;Not
found&rdquo;).</p>

<p><img src="/images/legacy/OnOrderPlaced.jpg" alt="" /></p>

<p>The OnOrderPlacedCode is an simple code activity that contains the
actual operation implementation. I used a code activity for a sake of
simplicity, a custom activity for creating the order could also be used
there.</p>

<p>The code for this activity is quite simple, most of it is hard-coded,</p>

<p>private void OnOrderPlacedCode_ExecuteCode(object sender, EventArgs e)</p>

<p>{</p>

<p>  currentOrder = new Order();</p>

<p>  currentOrder.OrderId = Guid.NewGuid().ToString();</p>

<p>  currentOrder.Cost = (receivedOrder.Drink == &ldquo;latte&rdquo;) ? 6 : 10;</p>

<p>  currentOrder.Drink = receivedOrder.Drink;</p>

<p>  currentOrder.Next = new Next[] {</p>

<p>      new Next</p>

<p>      {</p>

<p>         Rel = &ldquo;<a href="http://starbucks.example.org/payment">http://starbucks.example.org/payment</a>&rdquo;,</p>

<p>         Uri = &ldquo;<a href="http://localhost:8000/payment/order/">http://localhost:8000/payment/order/</a>&rdquo; +
currentOrder.OrderId.ToString(),</p>

<p>      },</p>

<p>      new Next</p>

<p>      {</p>

<p>         Rel = &ldquo;<a href="http://starbucks.example/order/update">http://starbucks.example/order/update</a>&rdquo;,</p>

<p>         Uri = &ldquo;<a href="http://localhost:8000/order/">http://localhost:8000/order/</a>&rdquo; +
currentOrder.OrderId.ToString()</p>

<p>      }};</p>

<p> </p>

<p>  //Persist the order in some place&hellip;..</p>

<p> </p>

<p>  WebOperationContext.Current.OutgoingResponse.StatusCode =
System.Net.HttpStatusCode.Created;</p>

<p>}</p>

<p>currentOrder contains the instance of the order that will be returned by
the service operation whereas receivedOrder is the order sent by the
client application. This was map to the operation signature in the
receive activity,</p>

<p> <img src="/images/legacy/ReceiveOrderSettings.jpg" alt="" /></p>

<p>Once the workflow is ready to be used, all we need is to configure the
service host so the client application can start consuming the
operations. At this point, we will face three issues:</p>

<p>​1. If you want to host a WF service, a WorkflowServiceHost class has to
be used in the host program. Therefore, we will not have all the
automatic infrastructure configuration provided by WebServiceHost, all
the configuration must be done manually. It would be great to have here
a combination of both service hosts.</p>

<p>​2. There is not a context binding for WebHttpBinding, only
BasicHttpContextBinding, NetTcpContextBinding and WsHttpContextBinding
are supported. We will have to use a custom binding.</p>

<p>​3. A cookie must be used to transfer the context information between
the client and the service, it would much better to have support for
http headers here. According to this <a href="http://weblogs.asp.net/gsusx/archive/2008/06/27/combining-durable-messaging-and-workflow-services-building-a-custom-context-channel.aspx">post written by
Jesus</a>,
this should not be complex to do.</p>

<p>&lt;system.serviceModel></p>

<p>  &lt;serviceHostingEnvironment aspNetCompatibilityEnabled=&ldquo;true&rdquo; /></p>

<p>  &lt;services></p>

<p>    &lt;service name=&ldquo;RestWorkflows.OrderWorkflow&rdquo;></p>

<p>     &lt;endpoint address=&ldquo;&rdquo; behaviorConfiguration=&ldquo;MyServiceBehavior&rdquo;
binding=&ldquo;customBinding&rdquo; bindingConfiguration=&ldquo;myServiceBinding&rdquo;
contract=&ldquo;RestWorkflows.IOrderService&rdquo; /></p>

<p>  &lt;/service></p>

<p>&lt;/services></p>

<p>&lt;bindings></p>

<p>&lt;customBinding></p>

<p>  &lt;binding name=&ldquo;myServiceBinding&rdquo;></p>

<p>  &lt;webMessageEncoding>&lt;/webMessageEncoding></p>

<p>  &lt;context contextExchangeMechanism=&ldquo;HttpCookie&rdquo;
protectionLevel=&ldquo;None&rdquo;/></p>

<p>  &lt;httpTransport manualAddressing=&ldquo;true&rdquo;/></p>

<p>  &lt;/binding></p>

<p>&lt;/customBinding></p>

<p>&lt;/bindings></p>

<p>&lt;behaviors></p>

<p>&lt;endpointBehaviors></p>

<p>  &lt;behavior name=&ldquo;MyServiceBehavior&rdquo;></p>

<p>    &lt;webHttp /></p>

<p>  &lt;/behavior></p>

<p>&lt;/endpointBehaviors></p>

<p>&lt;/behaviors></p>

<p>&lt;/system.serviceModel></p>

<p>The code for the client application looks also quite simple, you only
have to remember to include the cookie with the context between calls,
otherwise WF will try to create a new instance of the workflow resulting
in a bad request error.</p>

<p>//Lets create a new order</p>

<p>Order order = new Order { Drink = &ldquo;latte&rdquo; };</p>

<p> </p>

<p>HttpWebRequest createOrderRequest = CreateRequest(new
Uri(&ldquo;<a href="http://localhost:8000/order">http://localhost:8000/order</a>&rdquo;), &ldquo;POST&rdquo;, null, order);</p>

<p>string context =
GetContext((HttpWebResponse)createOrderRequest.GetResponse());</p>

<p>order = Execute&lt;Order>(createOrderRequest.GetResponse());</p>

<p> </p>

<p>Console.WriteLine(&ldquo;Order Cost {0}&rdquo;, order.Cost);</p>

<p>foreach (Next next in order.Next)</p>

<p>{</p>

<p>  Console.WriteLine(&ldquo;Possible next step {0}&rdquo;, next.Uri);</p>

<p>}</p>

<p> </p>

<p>//Lets update the existing order&hellip;.</p>

<p>order.Drink = &ldquo;cappuchino&rdquo;;</p>

<p> </p>

<p>Uri updateOrderUri = new Uri(order.Next.Where(n => n.Rel ==
&ldquo;<a href="http://starbucks.example/order/update">http://starbucks.example/order/update</a>&rdquo;).Single().Uri);</p>

<p>HttpWebRequest updateOrderRequest = CreateRequest(updateOrderUri, &ldquo;PUT&rdquo;,
context, order);</p>

<p>Order updatedOrder = Execute&lt;Order>(updateOrderRequest.GetResponse());</p>

<p> </p>

<p>Console.WriteLine(&ldquo;Order Cost {0}&rdquo;, updatedOrder.Cost);</p>

<p>foreach (Next next in updatedOrder.Next)</p>

<p>{</p>

<p>  Console.WriteLine(&ldquo;Possible next step {0}&rdquo;, next.Uri);</p>

<p>}</p>

<p> </p>

<p>//Lets have our drink&hellip;</p>

<p>Payment payment = new Payment { Name = &ldquo;John Doe&rdquo;, CardNumber =
&ldquo;1234567&rdquo;, Expires = &ldquo;06/08&rdquo;, Amount =
updatedOrder.Cost.GetValueOrDefault() };</p>

<p> </p>

<p>Uri payOrderUri = new Uri(order.Next.Where(n => n.Rel ==
&ldquo;<a href="http://starbucks.example.org/payment">http://starbucks.example.org/payment</a>&rdquo;).Single().Uri);</p>

<p>HttpWebRequest payOrderRequest = CreateRequest(payOrderUri, &ldquo;PUT&rdquo;,
context, payment);</p>

<p> </p>

<p>int statusCode = Execute(payOrderRequest.GetResponse());</p>

<p> </p>

<p>if (statusCode == 201)</p>

<p>  Console.WriteLine(&ldquo;Here is your drink!!!&rdquo;);</p>

<p>else</p>

<p>  Console.WriteLine(&ldquo;Sorry, there was some error while trying to process
the payment&rdquo;);</p>

<p>As you can see in the code above, I used some helper methods to execute
the operations and retrieve the response/context information. These
methods only represent a few lines of code,</p>

<p>static HttpWebRequest CreateRequest(Uri address, string method, string
context, object contract)</p>

<p>{</p>

<p>  HttpWebRequest webRequest =
(HttpWebRequest)WebRequest.Create(address);</p>

<p>  webRequest.ContentType = &ldquo;application/xml&rdquo;;</p>

<p>  webRequest.Timeout = 30000;</p>

<p>  webRequest.Method = method;</p>

<p>  webRequest.CookieContainer = new CookieContainer();</p>

<p> </p>

<p>  if (context != null)</p>

<p>  {</p>

<p>    Cookie cookie = new Cookie(&ldquo;WscContext&rdquo;, context,
address.PathAndQuery, address.Authority);</p>

<p>    webRequest.CookieContainer.Add(cookie);</p>

<p>  }</p>

<p> </p>

<p>  DataContractSerializer serializer = new
DataContractSerializer(contract.GetType());</p>

<p>  using (Stream stream = webRequest.GetRequestStream())</p>

<p>  {</p>

<p>    serializer.WriteObject(stream, contract);</p>

<p>    stream.Flush();</p>

<p>  }</p>

<p> </p>

<p>  return webRequest;</p>

<p>}</p>

<p> </p>

<p>static string GetContext(HttpWebResponse response)</p>

<p>{</p>

<p>  if (response.Cookies[&ldquo;WscContext&rdquo;] != null)</p>

<p>  {</p>

<p>    return response.Cookies[&ldquo;WscContext&rdquo;].Value;</p>

<p>  }</p>

<p> </p>

<p>  return null;</p>

<p>}</p>

<p> </p>

<p>static T Execute&lt;T>(WebResponse response)</p>

<p>{</p>

<p>  DataContractSerializer serializer = new
DataContractSerializer(typeof(T));</p>

<p>  using (Stream stream = response.GetResponseStream())</p>

<p>  {</p>

<p>    return (T)serializer.ReadObject(stream);   </p>

<p>  }</p>

<p>}</p>

<p>The complete solution is available to download from
<a href="/images/legacy/RestWorkflows.zip">here</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/10/06/importance-of-conditional-gets-in-rest/">Conditional Gets in REST</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-06T00:00:00-03:00" pubdate data-updated="true">Oct 6<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/10/06/importance-of-conditional-gets-in-rest/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>According to the Http specification, any Http GET request should be
idempotent and safe. In this context, these principles have the
following meaning:</p>

<p>Idempotence: One or more calls with identical requests should return the
same resource representation (As long as the resource has not changed on
the server between calls).</p>

<p>Safety:  The only action produced by a GET request is to retrieve a
resource representation, no side-effects should be evident on the
service side after executing the request. An example that violates this
principle could be a GET request that also updates some info in the
resource.</p>

<p>As long as these principles are applied correctly by a service
implementation, the client will have more available mechanisms to cache
the resource representation on its side. This has a very positive
meaning from a scalability view point, which represents a better use of
the network bandwidth and an optimization in the utilization of server
resources.</p>

<p>Those caching mechanisms are based on what is commonly called Http
conditional gets. An Http conditional get involves the use of two
special headers generated by the service, ETag and Last-Modified.</p>

<p>An Etag represents an opaque value that only the server knows how to
recreate, it could represent anything, but it is usually a hash
representing the resource version (it can be generated hashing the whole
representation content or just some parts of it, like the timestamp). On
the other hand, the Last-Modified headers represents a datetime that the
service can use to determine whether the resource has changed since the
last time it was served. The following example illustrates the
request/response messages interchanged by the client/service for a
service that returns information about customers</p>

<p>First request, the client does not have anything on the cache.</p>

<p>GET <a href="http://foo/customers/1">http://foo/customers/1</a></p>

<p>Host foo\
Accept */*\
Accept-Language en-us,en;q=0.5\
Accept-Encoding gzip,deflate\
Accept-Charset ISO-8859-1,utf-8;q=0.7,*;q=0.7\
Connection close\
Referer <a href="http://foo/">http://foo/</a>\
Pragma no-cache\
Cache-Control no-cache</p>

<p>Response:</p>

<p>Connection close\
Date Thu, 02 Oct 2008 14:46:57 GMT\
Server Microsoft-IIS/6.0\
X-Powered-By ASP.NET\
X-AspNet-Version 2.0.50727\
Content-Encoding gzip\
Content-Length 1212\
Expires Sat, 01 Nov 2008 14:46:57 GMT\
<strong>Last-Modified Mon, 29 Sep 2008 15:40:27 GMT\
Etag a9331828c517ac5d97f93b3cfdbcc9bc</strong>\
Content-Type text/xml</p>

<p>The next time the client sends a new request for the same customer, some
extra information will be included in the request headers,</p>

<p>GET <a href="http://foo/customers/1">http://foo/customers/1</a></p>

<p>Host foo\
Accept */*\
Accept-Language en-us,en;q=0.5\
Accept-Encoding gzip,deflate\
Accept-Charset ISO-8859-1,utf-8;q=0.7,*;q=0.7\
Connection close\
Referer foo\
<strong>If-Modified-Since Mon, 29 Sep 2008 15:40:27 GMT\
If-None-Match a9331828c517ac5d97f93b3cfdbcc9bc\
</strong></p>

<p>With these two new headers, the service can now determine whether it has
to serve the resource representation again or the client can use the
cached version. If the resource has not changed according to the values
in those headers (If-Modified-Since for Last-Modified and If-None-Match
for Etag), the service can return an Http status code &ldquo;304 Not
Modified&rdquo;, which instructs the client to use the cached version.</p>

<p>This approach is widely used nowadays by syndication, RSS or Atom, that
usually use the Last-Modified/If-Modified-Since to determine which items
they have to send to the client.</p>

<p>Since I am a WCF fan, I will also include here some code snippets to get
the value in those headers and return a &ldquo;304&rdquo; http status code,</p>

<p>Code to get those values:</p>

<p>if
(WebOperationContext.IncomingRequest.Headers[HttpRequestHeader.IfNoneMatch]
!= null)</p>

<p>{</p>

<p>  // Do something with etag&hellip;</p>

<p>}</p>

<p>else if
(WebOperationContext.IncomingRequest.Headers[HttpRequestHeader.IfModifiedSince]
!= null)</p>

<p>{</p>

<p>  var date =
DateTime.Parse(context.IncomingRequest.Headers[HttpRequestHeader.IfModifiedSince]);</p>

<p>}</p>

<p> </p>

<p>Code to set those values:</p>

<p> </p>

<p>WebOperationContext.OutgoingResponse.LastModified = // sets the last
modified;</p>

<p>WebOperationContext.OutgoingResponse.ETag = // sets the Etag</p>

<p>Code to return an Http 304 status code:</p>

<p>WebOperationContext.OutgoingResponse.StatusCode =
HttpStatusCode.NotModified;</p>

<p>WebOperationContext.OutgoingResponse.SuppressEntityBody = true;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/09/12/codecamp-buenos-aires-2008/">Codecamp Buenos Aires 2008</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-12T00:00:00-03:00" pubdate data-updated="true">Sep 12<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/09/12/codecamp-buenos-aires-2008/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The next Microsoft Codecamp will take place in Buenos Aires on Saturday,
October 4th.</p>

<p>The agenda looks very promising, be sure to register if you want to
attend! (The complete agenda is available in the <a href="http://blogs.msdn.com/masaez/">Miguel Saenz&rsquo;s
blog</a> , almost 10 sessions in parallel,
WOW)</p>

<p>I will be presenting an introductory session about the ASP.NET MVC
framework and another a little more interesting about building RESTfull
services with WCF. </p>

<p>I hope to see there !!. Thanks</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/09/01/implementing-an-identity-provider-and-relying-party-with-zermatt-and-asp-net-mvc/">Implementing an Identity Provider and Relying Party With Zermatt and ASP.NET MVC</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-01T00:00:00-03:00" pubdate data-updated="true">Sep 1<span>st</span>, 2008</time>
        
         | <a href="/blog/2008/09/01/implementing-an-identity-provider-and-relying-party-with-zermatt-and-asp-net-mvc/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Zermatt is the framework recently released by Microsoft to develop
claim-aware applications. You can find some announcements
<a href="http://blogs.msdn.com/vbertocci/archive/2008/07/09/announcing-the-beta-release-of-zermatt-developer-identity-framework.aspx">here</a>
and
<a href="http://www.leastprivilege.com/TryQuotZermattquotAndGiveFeedback.aspx">here</a>.</p>

<p>This framework supports the WS-Federation active and passive profiles.
This last one was initially designed with an unique purpose in mind,
allow the integration of &ldquo;dumb clients&rdquo; into the <a href="http://en.wikipedia.org/wiki/Identity_Metasystem">identity
metasystem</a>. As &ldquo;dumb
clients&rdquo;, I am talking about clients like web browsers that do not have
the ability to handle cryptographic material.</p>

<p>All the magic is done through some consecutive Http redirects, and today
we will see how develop an identity provider and a relying party web
(with ASP.NET MVC) that are involved in the whole process.</p>

<p>The identity provider is based on the quickstart that is automatically
generated in Visual Studio when you create a new MVC web application.
This quickstart uses FormsAuthentication to authenticate the application
users and also provides an Account controller (that internally uses
ASP.NET Membership) to manage all those users. In order to integrate
Zermatt in this application, I added a new controller STSController that
knows to process messages for getting issue tokens with the user&rsquo;s
claims.</p>

<p><img src="/images/legacy/Zermatt-MVC.gif" alt="" /></p>

<p>For the relying party, Zermatt provides some web controls to
authenticate the user against the identity provider using the passive
profile. Unfortunately, for the simple fact that ASP.NET MVC does not
support controls with view state, we can not use them here. As
workaround, I created a couple of extensions methods that generate the
Urls for sending the corresponding messages to the identity provider
(Login and Logout).</p>

<p>public static class LoginUrlExtensions</p>

<p>{</p>

<p>   public static string LoginUrl(this UrlHelper helper, string
actionName, string controllerName, string stsUrl)</p>

<p>   {</p>

<p>       string host =
helper.ViewContext.HttpContext.Request.Url.Authority;</p>

<p>       string schema =
helper.ViewContext.HttpContext.Request.Url.Scheme;</p>

<p> </p>

<p>       string realm = string.Format(&ldquo;{0}://{1}&rdquo;, schema, host);</p>

<p>       string reply = helper.Action(actionName,
controllerName).Substring(1);</p>

<p> </p>

<p>       return
string.Format(&ldquo;{0}?wa=wsignin1.0&amp;wtrealm={1}&amp;wreply={2}&amp;wctx=rm=0&amp;id=FederatedPassiveSignIn1&amp;wct={3}&rdquo;,</p>

<p>          stsUrl, realm, reply, XmlConvert.ToString(DateTime.Now));</p>

<p>   }</p>

<p> </p>

<p>   public static string LogoutUrl(this UrlHelper helper, string
actionName, string controllerName, string stsUrl)</p>

<p>   {</p>

<p>       string host =
helper.ViewContext.HttpContext.Request.Url.Authority;</p>

<p>       string schema =
helper.ViewContext.HttpContext.Request.Url.Scheme;</p>

<p> </p>

<p>       string realm = string.Format(&ldquo;{0}://{1}&rdquo;, schema, host);</p>

<p>       string reply = string.Format(&ldquo;{0}{1}&rdquo;, realm,
helper.Action(actionName, controllerName));</p>

<p> </p>

<p>       return string.Format(&ldquo;{0}?wa=wsignout1.0&amp;wreply={1}&rdquo;, stsUrl,
reply);</p>

<p>   }</p>

<p>}</p>

<p>The &ldquo;actionName&rdquo; and &ldquo;controllerName&rdquo; are just used to generate the
reply address where the user must be redirect after being authenticated
in the identity provider. These extension methods can be used in the
view as follow,</p>

<p>&lt;a href=&ldquo;&lt;%=Url.LoginUrl(&#8220;Login&rdquo;, &ldquo;Home&rdquo;,
&ldquo;localhost://STS&rdquo;)%>&ldquo;>Login&lt;/a></p>

<p>We also need a method in the relying party to parse the RRST message and
generate a cookie with the user credentials and claims.</p>

<p> </p>

<p>public interface IFederatedAuthentication</p>

<p>{</p>

<p>   IClaimsPrincipal Authenticate();</p>

<p>}</p>

<p> </p>

<p>public class FederatedAuthentication : IFederatedAuthentication</p>

<p>{</p>

<p>     private string logoutUrl;</p>

<p> </p>

<p>     public FederatedAuthentication(string logoutUrl)</p>

<p>     {</p>

<p>         this.logoutUrl = logoutUrl;</p>

<p>     }</p>

<p> </p>

<p>     public IClaimsPrincipal Authenticate()</p>

<p>     {</p>

<p>         string securityTokenXml =
FederatedAuthenticationModule.Current.GetXmlTokenFromPassiveSignInResponse(System.Web.HttpContext.Current.Request,
null);</p>

<p> </p>

<p>         FederatedAuthenticationModule current =
FederatedAuthenticationModule.Current;</p>

<p> </p>

<p>         SecurityToken token = null;</p>

<p>         IClaimsPrincipal authContext =
current.AuthenticateUser(securityTokenXml, out token);</p>

<p> </p>

<p>         TicketGenerationContext context = new
TicketGenerationContext(authContext, false, logoutUrl,
typeof(SignInControl).Name);</p>

<p>         current.IssueTicket(context);</p>

<p> </p>

<p>         return authContext;</p>

<p>     }</p>

<p>}</p>

<p> </p>

<p>As you can see in the code above, the Zermatt module
(FederatedAuthenticationModule) that parses the response message is tied
to the Request object, something that we do not have direct access from
a MVC controller (Well, it is bad practice if we want to test our code).
That&rsquo;s the reason I decided to put all that code in a pluggin that can
be injected later in the controller.</p>

<p>The complete solution is available to download from <a href="/images/legacy/MVC.Zermatt.zip">this
location</a>. Any feedback
would be great!!. Enjoy!!.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/08/21/dependency-injection-made-easy-for-the-asp-net-mvc/">Dependency Injection Made Easy for the ASP.NET MVC</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-21T00:00:00-03:00" pubdate data-updated="true">Aug 21<span>st</span>, 2008</time>
        
         | <a href="/blog/2008/08/21/dependency-injection-made-easy-for-the-asp-net-mvc/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I decided to write this post to show how cool is Autofac for doing
dependency injection in the ASP.NET MVC framework. Autofac, for me the
Moq stepbrother  in the dependency injection arena because of its
very-easy-to-use fluent interface and nice support of lambda
expressions, comes with a built-in ASP.NET module to automatically
intercept the creation of the controllers and pass the required
dependencies to them, the only thing a programmer has to do is to
provide instances of those dependencies or expressions to build them.</p>

<p>Well, it is time to see Autofac in action with a practical example. If
you have the chance to use the MVC preview 4, you may notice that it
comes with a new controller &ldquo;Account&rdquo; to manage the website membership.
This controller receives two dependencies in the constructor,</p>

<p>public AccountController(IFormsAuthentication formsAuth,
MembershipProvider provider)</p>

<p>{</p>

<p>  FormsAuth = formsAuth ?? new FormsAuthenticationWrapper();</p>

<p>  Provider = provider ?? Membership.Provider;</p>

<p>}</p>

<p> </p>

<p>public IFormsAuthentication FormsAuth</p>

<p>{</p>

<p>  get;</p>

<p>  private set;</p>

<p>}</p>

<p> </p>

<p>public MembershipProvider Provider</p>

<p>{</p>

<p>  get;</p>

<p>  private set;</p>

<p>}</p>

<p>If those dependencies are not provided, it creates a default
implementation of &ldquo;FormsAuthenticationWrapper&rdquo; and use the Membership
singleton instance. Ok, let&rsquo;s make some minor changes to this controller
so we always assume that those instances must be provided by the caller
code (It will be actually responsibility of the DI container).</p>

<p>public AccountController(IFormsAuthentication formsAuth,
MembershipProvider provider)</p>

<p>{</p>

<p>  FormsAuth = formsAuth;</p>

<p>  Provider = provider;</p>

<p>}</p>

<p>We now have to initialize a container to instruct Autofac about how to
initialize or get instances of those classes. This can be done in the
global.asax file,</p>

<p>static IContainerProvider containerProvider;</p>

<p> </p>

<p>protected void Application_Start()</p>

<p>{</p>

<p>   RegisterRoutes(RouteTable.Routes);</p>

<p> </p>

<p>   var builder = new ContainerBuilder();</p>

<p> </p>

<p>   // Automatically register all controllers in the current assembly.</p>

<p>   builder.RegisterModule(new
AutofacControllerModule(Assembly.GetExecutingAssembly()));</p>

<p> </p>

<p>   builder.Register&lt;MembershipProvider>(container =>
Membership.Provider).ExternallyOwned();</p>

<p>  
builder.Register&lt;FormsAuthenticationWrapper>().As&lt;IFormsAuthentication>().FactoryScoped();</p>

<p> </p>

<p>   containerProvider = new ContainerProvider(builder.Build());</p>

<p> </p>

<p>   // Hook MVC factory.</p>

<p>   ControllerBuilder.Current.SetControllerFactory(new
AutofacControllerFactory(containerProvider));</p>

<p>}</p>

<p>There are some lines in the code above that deserve special attention,
so let&rsquo;s discuss them in details:</p>

<ol>
<li></li>
</ol>


<p>// Automatically register all controllers in the current assembly.</p>

<p>builder.RegisterModule(new
AutofacControllerModule(Assembly.GetExecutingAssembly()));</p>

<p>This line basically discovers and registers all the controllers within
the current assembly (The website itself) into the DI container.</p>

<ol>
<li></li>
</ol>


<p>builder.Register&lt;MembershipProvider>(container =>
Membership.Provider).ExternallyOwned();</p>

<p>builder.Register&lt;FormsAuthenticationWrapper>().As&lt;IFormsAuthentication>().FactoryScoped();</p>

<p>The dependencies are registered in the container builder (The one that
later knows how to create instances of the dependencies). The Register
method optionally receives an lambda expression that will be used later
to create or get the dependency instance, it could be considered a sort
of lazy class construction. The container can also be used in the
expressions to resolve other dependencies, for example,</p>

<p>builder.Register&lt;MessagingService>(c => new
MessagingService(c.Resolve&lt;IMessageRepository>).As&lt;IMessagingService>();</p>

<p>Another important aspect in the initialization is the scope, which
basically controls the dependency lifetime. In the code above I used two
scopes, ExternallyOwned (The instance is managed by the application) and
FactoryScoped (A new instance is created for every dependency
resolution, very useful for instances that must be used and disposed
just after, like the DataContext in Linq to SQL). Other possible scopes
could be ContainerScoped (An instance per container) or Singleton (An
instance shared between all containers).</p>

<ol>
<li></li>
</ol>


<p>containerProvider = new ContainerProvider(builder.Build());</p>

<p> </p>

<p>// Hook MVC factory.</p>

<p>ControllerBuilder.Current.SetControllerFactory(new
AutofacControllerFactory(containerProvider));</p>

<p>The container provider is created, and the controller factory
implementation provided by Autofac is set for the current application.</p>

<p>As you can see, most of the plumbing code is already provided by
Autofac, just a couple of lines were needed to start using DI in the MVC
framework.</p>

<p>The code sample is available to <a href="/images/legacy/MvcDI.zip">download
here</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/08/01/combining-jquery-validation-with-asp-net-mvc/">Combining JQuery Validation With ASP.NET MVC</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-01T00:00:00-03:00" pubdate data-updated="true">Aug 1<span>st</span>, 2008</time>
        
         | <a href="/blog/2008/08/01/combining-jquery-validation-with-asp-net-mvc/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the most nicest things about JQuery &ndash; in addition to the powerful
mechanism it provides to manipulate the HTML DOM &ndash; is the great number
of very useful plugins available out there.</p>

<p><a href="http://bassistance.de/jquery-plugins/jquery-plugin-validation/">JQuery
Validation</a>
is one of my favorites, and today we will see how this plugin can be
used with the MVC framework to validate all the inputs in a form before
it is submitted to the controller.</p>

<p>This plugin supports the concept of &ldquo;validation rule&rdquo;, a validation that
has to be performed to an input field. For instance, &ldquo;The field is
required&rdquo;, &ldquo;The field should have at least N characters&rdquo;, or &ldquo;This field
has to be a valid email&rdquo;, many of them are the same you can find in the
ASP.NET validators. (These validators do not work with the MVC framework
because they are tied to the ASP.NET Viewstate). Of course, new rules
can also be created for performing custom validations specific to an
application, some examples of this are also available in the <a href="http://bassistance.de/jquery-plugins/jquery-plugin-validation/">plugin&rsquo;s
website</a>.</p>

<p>A rule can be applied to an input field in two ways:</p>

<p>​1. Declarative, the rule is specified in the input field by means of
the class attribute:</p>

<p>&lt;input name=&ldquo;email&rdquo; id=&ldquo;email&rdquo; maxlength=&ldquo;60&rdquo; class=&ldquo;required email&rdquo;
type=&ldquo;text&rdquo;/></p>

<p>As you can see, two rules were specified in the class attribute,
&ldquo;Required&rdquo; and &ldquo;Email&rdquo;, which means that two validations have to be
performed for this field. Many rules can be applied to the same field,
they only have to be separated by an space.</p>

<p>​2. Imperative in code, the rule is specified in an script:</p>

<p>&lt;script type=&ldquo;text/javascript&rdquo;></p>

<p>\$(document).ready(function(){</p>

<p>  \$(&ldquo;#form-sign-up&rdquo;).validate( {</p>

<p>    rules: {</p>

<p>      email: {</p>

<p>        required: true,</p>

<p>        email: true</p>

<p>    },</p>

<p>    messages: {</p>

<p>      email: {</p>

<p>        required: &ldquo;Please provide an email&rdquo;,</p>

<p>        email: &ldquo;Please provide a valid email&rdquo;</p>

<p>     } });</p>

<p>});</p>

<p>&lt;/script></p>

<p>The validation was attached to the input field &ldquo;email&rdquo; in the form
&ldquo;form-sign-up&rdquo;. The message displayed when a validation fails for an
specific field can also be customized using the &ldquo;messages&rdquo; section in
the script. (This is optional, the plugin already comes with a set of
pre-defined error messages)</p>

<p>And finally, one of the most interesting validation rules you can find
there is &ldquo;remote&rdquo;, which performs a remote validation using an Ajax
endpoint. At this point we can use an MVC controller method to perform
an specific validation, for instance to see if a login name is still
available to be used.</p>

<p>&lt;script type=&ldquo;text/javascript&rdquo;></p>

<p>\$(document).ready(function(){</p>

<p>\$(&ldquo;#form-sign-up&rdquo;).validate( {</p>

<p>  rules: {</p>

<p>    login: {</p>

<p>      required: true,</p>

<p>      remote: &lsquo;&lt;%=Url.Action(&ldquo;IsLoginAvailable&rdquo;, &ldquo;Accounts&rdquo;) %>&rsquo;</p>

<p>   }</p>

<p>  },</p>

<p>  messages: {</p>

<p>    login: {</p>

<p>     required: &ldquo;Please provide an alias&rdquo;,</p>

<p>     remote: jQuery.format(&ldquo;{0} is already in use&rdquo;)</p>

<p>   }</p>

<p>  } });</p>

<p>});</p>

<p>&lt;/script></p>

<p>The only requirement for the controller is that it must be return Json
with the result of the validation. This can be easily done with MVC,</p>

<p>public JsonResult IsLoginAvailable(string login)</p>

<p>{</p>

<p>    //TODO: Do the validation</p>

<p>    JsonResult result = new JsonResult();</p>

<p>    if (login == &ldquo;cibrax&rdquo;)</p>

<p>      result.Data = false;</p>

<p>    else</p>

<p>      result.Data = true;</p>

<p> </p>

<p>    return result;</p>

<p>}</p>

<p>In the example above, if &ldquo;cibrax&rdquo; is entered as login name, the
validation will fail and the user will see an error message.</p>

<p><img src="/images/legacy/MVC_Validation.jpg" alt="" /></p>

<p>The styles for the error messages can also be customized with the
following rules,</p>

<p>label.error {</p>

<p>display: block;</p>

<p>color: red;</p>

<p>font-style: italic;</p>

<p>font-weight: normal;</p>

<p>}</p>

<p>input.error {</p>

<p>border: 2px solid red;</p>

<p>}</p>

<p>td.field input.error, td.field select.error, tr.errorRow td.field
input,tr.errorRow td.field select {</p>

<p>border: 2px solid red;</p>

<p>background-color: #FFFFD5;</p>

<p>margin: 0px;</p>

<p>color: red;</p>

<p>}</p>

<p>As we have discussed here, JQuery validation is a great tool that we all
should consider at the moment to validate data in the ASP.NET MVC
framework.</p>

<p>A complete example with different validations can be <a href="/images/legacy/Mvc.Validation.zip">downloaded from
this location</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/07/29/wcf-issue-with-secure-conversation-in-web-farms/">WCF - Issue With Secure Conversation in Web Farms</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-07-29T00:00:00-03:00" pubdate data-updated="true">Jul 29<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/07/29/wcf-issue-with-secure-conversation-in-web-farms/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>While I was working for one of my customers, we ran into a very strange
problem when they tried to deploy some WCF services in a web farm using
cookie sessions (In order to enable secure conversation in this kind of
scenario, cookies must be used to track the state of the Secure
Conversation Tokens).</p>

<p>At some point, we start receiving a random exception with the following
message,</p>

<p><strong><em>System.ServiceModel.Security.MessageSecurityException: Message
security verification failed. &mdash;&ndash;&gt; System.Xml.XmlException: There was
an error deserializing the security token XML. Please see the inner
exception for more details. &mdash;&ndash;&gt; System.ArgumentException: The
SecurityContextSecurityToken with
context-id=urn:uuid:502e208e-8db2-4814-8623-d3050273e875 (no key
generation-id) has expired</em></strong></p>

<p>Later, we found out that a time skew setting was not supported in WCF
for the SCT cookies, and the error was happening because of an slight
difference in time between the servers in the farm.</p>

<p>Fortunately, <a href="http://blogs.msdn.com/brentschmaltz">Brent Schmaltz</a> has
made public a hot fix for that problem in his blog. You can find the
complete solution and a better description of the problem in <a href="http://blogs.msdn.com/brentschmaltz/archive/2008/06/20/cookie-sessions-and-wcf.aspx">this
post</a>.</p>

<p>Enjoy.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/06/25/microsoft-technight-buenos-aires/">Microsoft Technight - Buenos Aires</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-06-25T00:00:00-03:00" pubdate data-updated="true">Jun 25<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/06/25/microsoft-technight-buenos-aires/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Tonight, <a href="http://weblogs.asp.net/cazzu">Daniel</a> and I will be presenting
a session about &ldquo;synchronization on the web&rdquo; in the Microsoft Technight
event (Microsoft offices in Buenos Aires). </p>

<p>We are going to talk about some of the areas in which data
synchronization is very important, and the available technologies that
can be used in those scenarios. (&ldquo;FeedSync&rdquo;, Microsoft Framework,
Mesh4x and Live Mesh to name a few).</p>

<p>I hope to see you there.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/06/10/streaming-large-content-with-wcf-and-deferred-execution/">Streaming Large Content With WCF and Deferred Execution</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-06-10T00:00:00-03:00" pubdate data-updated="true">Jun 10<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/06/10/streaming-large-content-with-wcf-and-deferred-execution/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I will use this post to discuss an scenario that you may run into while
working with WCF, a service that returns a lot of objects (Or large
data) to the client applications. This scenario is not about
transferring files, that is a completely different story, and I already
discussed it some time ago in another post.</p>

<p>The scalability of the service&rsquo;s host may be affected if the service is
not well designed or configured. WCF will use large memory buffers to
keep the complete message before it start sending that message through
the wire.</p>

<p>Using data contracts or XML serializable classes in this scenario does
not scale well because the complete object graph has to be loaded in
memory before the corresponding serializer (Data Contract serializer or
Xml Serializer) transform it into an stream of bytes.</p>

<p>In addition, if the service throttling settings are not configured
carefully for that service, a large number of requests will practically
consume all the available resources (If that happens, the server will
stop processing additional requests and you may run into a OutOfMemory
exception as well). For more information about Service Throttling, I
recommend this <a href="http://kennyw.com/indigo/150">Kenny Wolf&rsquo;s post</a>.</p>

<p>Before getting into the streaming solution, which looks very complex at
first glance, you should consider refactoring your service&rsquo;s API to
support data paging. If you use paging, the design of the final service
will be simpler and you should not have any of the mentioned problems.
What&rsquo;s more, streaming does not work well with message security, the
default behavior for WCF is to buffer all messages when message security
is set for the channel. In order to combine message security with
streaming you should use the Chunking Channel.</p>

<p>Data Paging design sample,</p>

<p>[XmlRoot(&ldquo;Customer&rdquo;)]</p>

<p>public class Customer</p>

<p>{</p>

<p>  public string FirstName { get; set; }</p>

<p> </p>

<p>  public string LastName { get; set; }</p>

<p> </p>

<p>  public string Address { get; set; }</p>

<p>}</p>

<p> </p>

<p>[XmlRoot(&ldquo;Customers&rdquo;)]</p>

<p>public class Customers</p>

<p>{</p>

<p>    public Customer[] Customers { get; set; }</p>

<p>}</p>

<p> </p>

<p>public interface ISampleService</p>

<p>{</p>

<p>  [OperationContract]</p>

<p>  Customers GetAllCustomers(int page, int count, out int
totalCustomers); </p>

<p>}</p>

<p>The client application will have to call that method as many times as it
needs to retrieve all the customers. The service should have a limit in
the number of customers it can return per call, otherwise, we will have
the same problems if the client application asks for a large number of
customers.</p>

<p>Deferred execution is a cool feature introduced in .NET 2.0 for
enumerations. Basically the enumeration does not happen until some
calling code wants to examine the enumeration.</p>

<p>Let&rsquo;s discuss now how deferred execution can be achieved in WCF with the
help of the streaming model.</p>

<p>​1. The first extensibility point that we will need for this solution is
a custom BodyWriter class. A BodyWriter has the knowledge to serialize
an entire object graph as xml into the body of a soap message. The class
Message has an static method to create a new message from a  BodyWriter
instance.</p>

<p>public abstract class Message : &hellip;.</p>

<p>{</p>

<p>    public static Message CreateMessage(MessageVersion version, string
action, BodyWriter body)</p>

<p>}</p>

<p>The &ldquo;BodyWriter&rdquo; class is an abstract and contains a single method to
serialize the complete object graph into the soap body.</p>

<p>public class CustomBodyWriter : BodyWriter</p>

<p>  {</p>

<p>    private IEnumerable&lt;Customer> customers;</p>

<p> </p>

<p>    public CustomBodyWriter(IEnumerable&lt;Customer> customers)</p>

<p>      : base(false) // False should be passed here to avoid buffering
the message</p>

<p>    {</p>

<p>      this.customers = customers;</p>

<p>    }</p>

<p> </p>

<p>    protected override void
OnWriteBodyContents(System.Xml.XmlDictionaryWriter writer)</p>

<p>    {</p>

<p>      XmlSerializer serializer = new XmlSerializer(typeof(Customer));</p>

<p>      writer.WriteStartElement(&ldquo;customers&rdquo;);</p>

<p>      foreach (Customer customer in customers)</p>

<p>      {</p>

<p>        serializer.Serialize(writer, customer);</p>

<p>      }</p>

<p>      writer.WriteEndElement();</p>

<p>    }</p>

<p>  }</p>

<p>As you can see in the code above, our custom implementation of the
&ldquo;OnWriteBodyContents&rdquo; receives an enumeration of objects that we want to
serialize into the message. A &ldquo;false&rdquo; value is passed as argument in the
constructor to the base class to specify that our custom implementation
can not be buffered.</p>

<p>​2. We will use deferred execution to retrieve all the customers from
the database (The following code actually emulates that),</p>

<p>public IEnumerable&lt;Customer> GetAllCustomersImpl()</p>

<p>{</p>

<p>   for(long i = 0; i &lt; 1000; i++) //All the customers should be read
from the database</p>

<p>   {</p>

<p>      yield return new Customer { FirstName = &ldquo;Foo&rdquo;, LastName = &ldquo;Bar&rdquo;,
Address = &ldquo;FooBar 123&rdquo; };</p>

<p>   }</p>

<p> </p>

<p>   yield break;</p>

<p>}</p>

<p>What&rsquo;s it is important here is that we are not returning all the
customer objects at the same time (we are returning one at time, so they
are not loaded in memory) using the &ldquo;yield&rdquo; operator.</p>

<p>​3. The service implementation returns a new message created from the
custom &ldquo;CustomBodyWriter&rdquo; class.</p>

<p>public class SampleService : ISampleService</p>

<p>  {</p>

<p>    #region ISampleService Members</p>

<p> </p>

<p>    public Message GetAllCustomers()</p>

<p>    {</p>

<p>      Message message = Message.CreateMessage(MessageVersion.Soap11,
&ldquo;GetAllCustomers&rdquo;, new CustomBodyWriter(GetAllCustomersImpl()));</p>

<p>      return message;</p>

<p>    }</p>

<p> </p>

<p>    #endregion</p>

<p>    </p>

<p>  }</p>

<p> </p>

<p>The first two arguments of the CreateMessage method specifies the soap
version and soap action for the response message.</p>

<p>​4. The client application also reads one customer object at time from
the response message,</p>

<p>static IEnumerable&lt;Customer> GetAllCustomers(Message message)</p>

<p>{</p>

<p>  XmlReader reader = message.GetReaderAtBodyContents();</p>

<p>  if (reader.LocalName != &ldquo;customers&rdquo;)</p>

<p>  {</p>

<p>     throw new Exception(&ldquo;The service returned an invalid message&rdquo;);</p>

<p>  }</p>

<p> </p>

<p>  XmlSerializer serializer = new XmlSerializer(typeof(Customer));</p>

<p>  reader.ReadStartElement(&ldquo;customers&rdquo;);</p>

<p> </p>

<p>  while(!reader.EOF &amp;&amp; reader.LocalName == &ldquo;Customer&rdquo;)</p>

<p>  {</p>

<p>     Customer customer = (Customer)serializer.Deserialize(reader);</p>

<p>     yield return customer;</p>

<p>  }</p>

<p> </p>

<p>  reader.ReadEndElement();</p>

<p>}</p>

<p>​5. Finally, the client and the service, both have to be configured to
use an &ldquo;streamed&rdquo; as transfer mode. Otherwise, all the messages will be
buffered in memory.</p>

<p>&lt;basicHttpBinding></p>

<p>   &lt;binding name=&ldquo;basic&rdquo; transferMode=&ldquo;StreamedResponse&rdquo;
maxReceivedMessageSize=&ldquo;10000000&rdquo;></p>

<p>      &lt;security mode=&ldquo;None&rdquo;>&lt;/security></p>

<p>   &lt;/binding></p>

<p>&lt;/basicHttpBinding></p>

<p>The &ldquo;maxReceivedMessageSize&rdquo; setting is also important because it limits
the amount of data that the service can return. You should adjust it to
a value according to the amount of data you might return in the service
implementation.</p>

<p>You can download the complete sample from this
<a href="/images/legacy/StreamingObjects.zip">location</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/05/20/unit-tests-for-wcf-and-moq-part-ii/">Unit Tests for WCF (and Moq) Part II</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-05-20T00:00:00-03:00" pubdate data-updated="true">May 20<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/05/20/unit-tests-for-wcf-and-moq-part-ii/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p> </p>

<p>My latest post about &ldquo;creating wrapper classes&rdquo; for mocking the WCF
context has started generating some
<a href="http://weblogs.asp.net/rosherove/archive/2008/05/19/two-faced-commits-how-the-alt-net-community-is-becoming-more-and-more-dogmatic.aspx">controversies</a>.
I initially wrote those classes to decouple my service implementation
from the concrete implementation of the WCF context,  something that 
did not have anything to do with the static nature of the context. (I
can still pass the current instance as an argument to my service
implementation).</p>

<p>As I mentioned in my previous post, the WCF context is neither a base
class (with virtual methods) nor an interface, so it can not easily
mocked, that is main issue here.</p>

<p>I am not sure if TypeMock allows mocking this kind of class as well,
probably yes, I have never used that tool before so I do not know.  It
would be great to have a natural or easy support in C# for mocking
non-virtual methods or statics, but it is not there now. I personally
prefer writing some simple wrapper classes or <a href="http://www.elilopian.com/2008/05/19/mocking-frameworks-dream-feature/">&ldquo;utterly useless
wrappers&rdquo; as someone call
them</a> 
(In fact, it only took me 5 minutes to write them, and I do not think my
productive was affected by that) rather than creating code that can only
be tested by an specific tool. I am not saying that you should not use
TypeMock, anyone is free to use the tool that works best for his needs.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/19/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/17/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/20/do-not-version-urls/">Do Not Version Urls</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/23/selfhost-utilities/">SelfHost Utilities</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/23/appfabric-outputcaching/">AppFabric OutputCaching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/31/making-ajax-calls-with-hawk-authentication-to-asp-dot-net-web-api/">Making Ajax Calls With Hawk Authentication to ASP.NET Web API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/13/coordinating-async-work-in-node-dot-js/">Coordinating Async Work in Node.js</a>
      </li>
    
  </ul>
</section>
 <a href="http://feeds.feedburner.com/cibrax"><img src="http://feeds.feedburner.com/~fc/cibrax?bg=FF3300&amp;fg=000000&amp;anim=0" style="border:0" alt="" /></a>

 <script type="text/javascript" language="javascript" src="http://twittercounter.com/embed/?username=cibrax&style=white"></script>
<a href="https://mvp.microsoft.com/en-us/mvp/Pablo%20Cibraro-33800"><img src="/images/mvp.gif" border="0" /></a>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pcibraro">@pcibraro</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pcibraro',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Cibrax -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cibrax';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
