
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pablo Cibraro (Cibrax)</title>
  <meta name="author" content="Cibrax">

  
  <meta name="description" content="It&rsquo;s pretty interesting to see how useful workflow services can be
sometimes, specially for business applications that require
orchestrating &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cibrax.me/blog/page/17">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/cibrax" rel="alternate" title="Pablo Cibraro (Cibrax)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44468149-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pablo Cibraro (Cibrax)</a></h1>
  
    <h2>All about software development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/cibrax" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cibrax.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/12/03/wcf-workflow-services-in-business-applications/">WCF Workflow Services in Business Applications</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-12-03T00:00:00-03:00" pubdate data-updated="true">Dec 3<span>rd</span>, 2008</time>
        
         | <a href="/blog/2008/12/03/wcf-workflow-services-in-business-applications/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It&rsquo;s pretty interesting to see how useful workflow services can be
sometimes, specially for business applications that require
orchestrating several back-end services calls.</p>

<p>As one of the programmers involved in the development of the WS-I Sample
application for .NET, an application that demonstrates  how to build
interoperable web services in .NET using the WS-I Basic Profile 1.0
(Each vendor in the WS-I working group basically implemented the same
application using its development platform, more information can be
found
<a href="http://www.ws-i.org/deliverables/workinggroup.aspx?wg=sampleapps">here</a>),
it was a surprise to me to find another implementation as part of the
WCF SDK, made this time all declaratively through WCF workflow services
and just a few activities. To give you an idea, the original version of
the same application took us some days and hundred lines of code just to
have something complete and working.</p>

<p>The SDK version is available under the folder, [SDK
Folder]\WCF_WF_CardSpace_Samples\WCF\Scenario\WorkflowServices\Conversations</p>

<p>Workflow services, initially introduced in WCF 3.5 with the Receive and
Send activities, will now take a very important role as part of the Oslo
vision. We will have the opportunity to write pure declarative
long-running services with XAML, including all the WCF contracts for
receiving/sending messages. This will make possible to store the
complete workflow representation in the Oslo repository, and take later
full control of this workflow&rsquo;s instances from Dublin, the new hosting
environment for long-running services. David Chappell has written an
excellent article about WF 4.0, Dublin the oslo vision, you can find it
<a href="http://www.davidchappell.com/blog/2008/11/first-look-at-wf-40-dublin-and-oslo.html">here</a>,
this a must read for developers interested in this area.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/25/my-durable-wcf-restful-calculator/">My Durable WCF RESTful Calculator</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-25T00:00:00-03:00" pubdate data-updated="true">Nov 25<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/11/25/my-durable-wcf-restful-calculator/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A durable service in WCF is by a definition a service that can persist
all its internal state across calls in some durable storage. For every
operation, the service state is retrieved from the storage, the
operation is executed and finally the state is persisted again in the
storage. Therefore, there is not need to keep the service instance idle
in memory while waiting for client calls. It is equivalent to a long run
session, which make this feature something ideal for long-running
processes like workflows (In fact, workflow services are mount on top of
this feature),</p>

<p>In order to create a durable service, WCF provides a &ldquo;DurableService&rdquo;
attribute (It&rsquo;s a service behavior) that can be applied to a regular
service definition. The service itself has to be either serializable or
have members decorated with DataContract or DataMember attributes to be
serialized and stored in the persistent storage.</p>

<p>The service activation, as in workflow services, is managed by the WCF
context correlation mechanism. Once a service instance has been created,
the client application has to propagate some context information(which
includes the service instance id) in order to route all the new messages
to the right service instance. Jesus has already discussed how this
mechanism works more in detail in this
<a href="http://weblogs.asp.net/gsusx/archive/2007/06/14/orcas-durable-services.aspx">post</a>
(Although the post is bit old and some names have changed since then, it
is worth reading).</p>

<p>For purposes of this post, I decided to create a simple calculator
example that exposes different operations through the classic http
verbs,</p>

<p>[ServiceContract(Namespace =
&ldquo;<a href="http://Microsoft.WorkflowServices.Samples">http://Microsoft.WorkflowServices.Samples</a>&rdquo;)]</p>

<p>public interface ICalculator</p>

<p>{</p>

<p>    [OperationContract()]</p>

<p>    [WebInvoke(Method = &ldquo;POST&rdquo;)]</p>

<p>    int PowerOn();</p>

<p> </p>

<p>    [OperationContract()]</p>

<p>    [WebInvoke(Method = &ldquo;PUT&rdquo;, UriTemplate = &ldquo;add&rdquo;)]</p>

<p>    int Add(int value);</p>

<p> </p>

<p>    [OperationContract()]</p>

<p>    [WebInvoke(Method = &ldquo;PUT&rdquo;, UriTemplate = &ldquo;subtract&rdquo;)]</p>

<p>    int Subtract(int value);</p>

<p> </p>

<p>    [OperationContract()]</p>

<p>    [WebInvoke(Method = &ldquo;PUT&rdquo;, UriTemplate = &ldquo;multiply&rdquo;)]</p>

<p>    int Multiply(int value);</p>

<p> </p>

<p>    [OperationContract()]</p>

<p>    [WebInvoke(Method = &ldquo;PUT&rdquo;, UriTemplate = &ldquo;divide&rdquo;)]</p>

<p>    int Divide(int value);</p>

<p> </p>

<p>    [OperationContract()]</p>

<p>    [WebInvoke(Method = &ldquo;DELETE&rdquo;)]</p>

<p>    void PowerOff();</p>

<p>} </p>

<p>The implementation of this service is also quite straightforward.</p>

<p>[Serializable]</p>

<p>[DurableService]</p>

<p>public class DurableCalculator : ICalculator</p>

<p>{</p>

<p>    int _currentValue = 0;</p>

<p> </p>

<p>    [DurableOperation(CanCreateInstance=true)]</p>

<p>    public int PowerOn()</p>

<p>    {</p>

<p>        return _currentValue;</p>

<p>    }</p>

<p> </p>

<p>    [DurableOperation]</p>

<p>    public int Add(int value)</p>

<p>    {</p>

<p>        return (_currentValue += value);</p>

<p>    }</p>

<p> </p>

<p>    [DurableOperation]</p>

<p>    public int Subtract(int value)</p>

<p>    {</p>

<p>        return (_currentValue &ndash;= value);</p>

<p>    }</p>

<p> </p>

<p>    [DurableOperation]</p>

<p>    public int Multiply(int value)</p>

<p>    {</p>

<p>        return (_currentValue *= value);</p>

<p>    }</p>

<p> </p>

<p>    [DurableOperation]</p>

<p>    public int Divide(int value)</p>

<p>    {</p>

<p>        return (_currentValue /= value);</p>

<p>    }</p>

<p> </p>

<p>    [DurableOperation(CompletesInstance=true)]</p>

<p>    public void PowerOff()</p>

<p>    {</p>

<p>    }</p>

<p>}</p>

<p>As you can see, I decorated the service implementation with the
&ldquo;DurableService&rdquo; and &ldquo;DurableOperation&rdquo; attributes to make this simple
service a durable one.</p>

<p>WCF only comes with built-in support for transferring the context
information between the client and service with Http Cookies or Soap
Headers. While cookies would be the right mechanism for http REST
services, unfortunately they do not work as expected. The path that WCF
uses for creating the cookies is relative, so the context manager throws
the following exception on the client side,</p>

<p><strong><em>Unhandled Exception: System.Net.CookieException: An error occurred
when parsing the Cookie header for Uri
&lsquo;<a href="http://localhost:8080/DurableCalculator">http://localhost:8080/DurableCalculator</a>&rsquo;. &mdash;&ndash;>
System.Net.CookieException: The &lsquo;Path&rsquo;=&lsquo;/DurableCalculator/PowerOn&rsquo; part
of the cookie  is invalid.</em></strong></p>

<p>As workaround, we can use for this scenario the custom context binding I
created <a href="http://weblogs.asp.net/cibrax/archive/2008/10/30/rest-and-workflow-services-play-well-together-part-ii.aspx">some weeks
ago</a>
to exchange the context information as regular http headers.</p>

<p>&lt;connectionStrings></p>

<p>  &lt;add name=&ldquo;DurableService&rdquo; connectionString=&ldquo;Initial
Catalog=SQLWorkflows;Data Source=.\SQLEXPRESS;Integrated
Security=SSPI;&rdquo;/></p>

<p>&lt;/connectionStrings></p>

<p>&lt;system.serviceModel></p>

<p>  &lt;services></p>

<p>    &lt;service name=&ldquo;ServiceConsole.DurableCalculator&rdquo;
behaviorConfiguration=&ldquo;MyServiceBehavior&rdquo;></p>

<p>      &lt;endpoint address=&ldquo;&rdquo; behaviorConfiguration=&ldquo;MyServiceBehavior&rdquo;
<strong>binding=&ldquo;webHttpContext&rdquo;</strong> contract=&ldquo;ServiceConsole.ICalculator&rdquo; /></p>

<p>    &lt;/service></p>

<p>&lt;/services></p>

<p>&lt;behaviors></p>

<p>  &lt;endpointBehaviors></p>

<p>    &lt;behavior name=&ldquo;MyServiceBehavior&rdquo;></p>

<p>      &lt;webHttp /></p>

<p>    &lt;/behavior></p>

<p>  &lt;/endpointBehaviors></p>

<p>  &lt;serviceBehaviors></p>

<p>    &lt;behavior name=&ldquo;MyServiceBehavior&rdquo;></p>

<p>      &lt;persistenceProvider
type=&ldquo;System.ServiceModel.Persistence.SqlPersistenceProviderFactory,
System.WorkflowServices, Version=3.5.0.0, Culture=neutral,
PublicKeyToken=31bf3856ad364e35&rdquo;
connectionStringName=&ldquo;DurableService&rdquo;/></p>

<p>    &lt;/behavior></p>

<p>  &lt;/serviceBehaviors></p>

<p>&lt;/behaviors></p>

<p>&lt;extensions></p>

<p>  &lt;bindingExtensions></p>

<p>    &lt;add name=&ldquo;webHttpContext&rdquo;
type=&ldquo;Microsoft.ServiceModel.Samples.WebHttpContextBindingCollectionElement,
WebHttpContext, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&rdquo;
/></p>

<p>  &lt;/bindingExtensions></p>

<p>&lt;/extensions></p>

<p>&lt;/system.serviceModel></p>

<p>If you pay special attention to the configuration settings above, in
addition to the binding configuration, I also included the
&ldquo;persitenceProvider&rdquo; behavior for configuring the persistence provider
that will serialize and store the service instance (In this case, the
SQL server provider).</p>

<p>Now, thanks to this support, my calculator service will survive to
application and server restarts :). Download the complete code from this
<a href="/images/legacy/DurableRestCalculator.zip">location</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/19/open-source-alternatives-in-net-for-building-restful-services/">Open Source Alternatives in .NET for Building RESTful Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-19T00:00:00-03:00" pubdate data-updated="true">Nov 19<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/11/19/open-source-alternatives-in-net-for-building-restful-services/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Usually all my posts about REST are about WCF or mention this technology
in some parts. Today, I decided to take a different approach and discuss
some of the projects available today for building REST services, 
<a href="http://www.codeplex.com/resourceful">Resourceful</a> and <a href="http://wiki.developer.mindtouch.com/Dream">Dream
framework</a> (Both available
for mono as well).\
It is worth mentioning however that the WCF team has made an excellent
work introducing the new Web Model in .NET 3.5, it has definitively
helped a lot to adopt this kind of service in the .NET platform. In my
opinion, there are still some aspects in WCF that could be improved,</p>

<ol>
<li>WCF services are hard to unit test. It is possible but requires some
extra work. I already mentioned some techniques  based on
integration tests and mocks in this post <a href="http://weblogs.asp.net/cibrax/archive/2008/05/16/unit-tests-for-wcf.aspx">&ldquo;Unit tests for
WCF&rdquo;</a></li>
<li>Poor support for defining multiple resource representations/formats
within a single operation definition.</li>
<li>Any aspect you would like to add here ?</li>
</ol>


<p>Ok, I will try now to summarize some of available features or
implementation details in these two projects.</p>

<p><strong>Resourceful</strong></p>

<ul>
<li>Service definitions are totally imperative. Whereas a service
definition (and operations) in WCF is made declaratively through
attributes (annotating classes with WCF attributes), the service
definition in Resourceful is totally imperative, it has to be made
through several lines of code.</li>
</ul>


<blockquote><p>LocalApplicationDescription app = new LocalApplicationDescription();</p>

<p>// get-user</p>

<p>LocalApplicationMethod getUser = app.NewMethod(&ldquo;getUser&rdquo;,
HttpMethod.Get, _usersController.GetUser);</p>

<p>getUser.NewResponseRepresentation(MediaType.ApplicationXml);</p>

<p>getUser.NewResponseRepresentation(MediaType.ApplicationExWwwFormUrlencoded);</p>

<p> </p>

<p>ApplicationResource userResource = app.NewResource(&ldquo;users/{username}&rdquo;,
new TemplateParameter(&ldquo;username&rdquo;, &ldquo;xsd:string&rdquo;));</p>

<p>app.Bind(userResource, getUser);</p>

<p>The developer has to perform two things, first define the operation
itself specifying a friendly name along with the supported Http
methods and resource representations and afterwards, create a resource
mapping (&ldquo;users/{username}&rdquo; in this case). {username} is a URI
template hole, equivalent to the Uri Templates in WCF.</p>

<p>The method signature for the NewMethod is the following,</p>

<p>NewMethod(string id, string name,Action&lt;IRepresentationContext>
handler)</p>

<p>As you can see, the last argument is a delegate that points to the
operation implementation. IRepresentationContext is equivalent to the
WebOperationContext class in WCF, it contains all the runtime context
settings that a service can use. This actually better than WCF because
IRepresentationContext can be mocked for unit tests.</p>

<p>In the example above, _usersController is a simple class with the
service implementation (This separation of concerns definitively helps
a lot for unit testing). Some code for the GetUser operation
implementation looks as follow,</p>

<p>public void GetUser(IRepresentationContext context)</p>

<p>{</p>

<p>    string username = context.TemplateParameters[&ldquo;username&rdquo;];</p>

<p> </p>

<p>    UserAccount user = this.Engine.FindUser(username);</p>

<p> </p>

<p>    if (user == null)</p>

<p>    {</p>

<p>        this.RenderStatus(context, HttpStatus.NotFound);</p>

<p>        return;</p>

<p>    }</p>

<p> </p></blockquote>

<ul>
<li>Support for WADL. The framework uses the service definition (the
LocalApplicationDescription class in the example above) to publish
all the available operations in the service.</li>
</ul>


<blockquote><p> <img src="/images/legacy/wadl.jpg" alt="" /></p></blockquote>

<ul>
<li>Support for multiple resource representations in a single operation.
This is possible because the framework does not support the concept
of channels (Or aspects) that can be plugged into the service to
perform additional work, all the translation must be done in the
operation implementation itself. The service operation can only get
the resource representation as an stream from the
IRepresentationContext (Same thing can be done in WCF if the input
parameter for the operation method is an stream or a message),</li>
</ul>


<blockquote><p>public void CreateUser(IRepresentationContext context)</p>

<p>{</p>

<p>    if (context.Request.MediaType != MediaType.ApplicationXml)</p>

<p>    {</p>

<p>        this.RenderStatus(context, HttpStatus.UnsupportedMediaType);</p>

<p>        return;</p>

<p>    }</p></blockquote>

<p>     UserAccount user = UserAccount.FromXml(new
StreamReader(context.Request.GetEntityStream()));</p>

<blockquote><p>In the example above, CreateUser only supports POX (Plain old xml)
representation for the users, so it also makes the translation from
XML to an user entity.</p></blockquote>

<ul>
<li>There is not support for channels or aspects to perform additional
work before a message arrives/leaves a service. There is, however,
an special class for hosting service instances, it can be used from
a console application or IIS as an http handler.</li>
</ul>


<blockquote><p>Uri rootUri = new Uri(string.Format(&ldquo;<a href="http://localhost:3000/v1/">http://localhost:3000/v1/</a>&rdquo;,
address));</p>

<p> </p>

<p>BookmarkService service = new BookmarkService();</p>

<p> </p>

<p>HttpServer host = new HttpServer(rootUri);</p>

<p> </p>

<p>host.ReceiveWebRequest += delegate(HttpListenerContext context)</p>

<p>{</p>

<p>    service.Process(new HttpListenerContextAdapter(context, rootUri));</p>

<p>};</p>

<p> </p>

<p>host.Start();</p></blockquote>

<ul>
<li>Rich and fluent client API for consuming existing REST services.
This is probably one of the nicest things about this framework, a
lot of examples are provided for consuming well-know REST services
on the web such as Amazon S3,  ADO.NET services, Simple DB or
Delicious to name a few. This client API can be used from
Silverlight applications as well.</li>
</ul>


<p><strong>Dream Framework</strong> </p>

<ul>
<li>Service definitions are declarative as in WCF. Two attributes are
used, one for the service definition &ldquo;DreamService&rdquo; and another for
each operation in that service, &ldquo;DreamFeature&rdquo;.   </li>
</ul>


<blockquote><p>[DreamService(&ldquo;Dream Tutorial Address-Book&rdquo;, &ldquo;Copyright &copy; 2006, 2007
MindTouch, Inc.&rdquo;,</p>

<p>      Info =
&ldquo;<a href="http://doc.opengarden.org/Dream_SDK/Tutorials/Address_Book">http://doc.opengarden.org/Dream_SDK/Tutorials/Address_Book</a>&rdquo;,</p>

<p>      SID = new string[] {
&ldquo;<a href="http://services.mindtouch.com/dream/tutorial/2007/03/addressbook">http://services.mindtouch.com/dream/tutorial/2007/03/addressbook</a>&rdquo; }</p>

<p>    )]</p>

<p>    public class AddressBookService : DreamService {</p>

<p>        [DreamFeature(&ldquo;GET:firstname/{name}&rdquo;, &ldquo;Get list of all
addresses matching first name&rdquo;)]</p>

<p>        public Yield GetFirstName(DreamContext context, DreamMessage
request, Result&lt;DreamMessage> response) {</p>

<p> </p>

<p>I will not enter much in detail here, but the &ldquo;DreamFeature&rdquo; supports
almost the same things as WCF and Resourceful, an Http verb and the
URI template for the resource. For more information about how to
create an Dream service from scratch, take a look at <a href="http://wiki.developer.mindtouch.com/Dream/Tutorials/Creating_a_Magic_8-Ball_service">this
page</a>.</p></blockquote>

<ul>
<li>Every operation implementation should receive three arguments and
return an enumerator. The arguments are basically the runtime
context (Equivalent to WebOperationContext in WCF), the request
message and a handler to send responses to the client.</li>
</ul>


<blockquote><blockquote><p>using Yield = System.Collections.Generic.IEnumerator&lt;IYield>;</p>

<p>public Yield GetFirstName(DreamContext context, DreamMessage
request, Result&lt;DreamMessage> response) {</p></blockquote>

<p>They implement a weird mechanism based on custom enumerators to
execute callbacks on the service host. The service can basically
returns IYield objects representing callbacks with the C# keyword
&ldquo;yield&rdquo;. The response is automatically sent to the client application
when the service invokes &ldquo;yield break&rdquo;.</p>

<p>[DreamFeature(&ldquo;GET:addresses&rdquo;, &ldquo;Get all addresses&rdquo;)]</p>

<p>public Yield GetAddresses(DreamContext context, DreamMessage request,
Result&lt;DreamMessage> response) {</p>

<p> </p>

<p>    // send back the entire address book</p>

<p>    lock(_addresses) {</p>

<p>        response.Return(DreamMessage.Ok(_addresses));</p>

<p>    }</p>

<p>    yield break;</p>

<p>}</p></blockquote>

<ul>
<li>Supports for long running services with durable state, it&rsquo;s not
clear to me however how they restore that state between calls. The
fields must be annotated with the attribute &ldquo;DreamServiceState&rdquo; in
order to use this feature.</li>
</ul>


<blockquote><p>[DreamServiceState]private XDoc _addresses;</p>

<p> </p></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/14/using-the-wcf-oauth-channel-with-an-ado-net-service/">Using the WCF OAuth Channel With an ADO.NET Service</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-14T00:00:00-03:00" pubdate data-updated="true">Nov 14<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/11/14/using-the-wcf-oauth-channel-with-an-ado-net-service/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As I promised in my previous post &ldquo;OAuth Channel for WCF RESTful
services&rdquo;, it is now time to show this new channel in action with a real
service. To make this sample more interesting, I decided to base this
implementation on an ADO.NET service that provides information about
contacts.</p>

<p>This post will be a kind of walk-through to demonstrate all the steps
required to implement the ADO.NET service, and then, the final
integration with OAuth.</p>

<p><strong>1.Create a custom data source (IQueryable) implementation for using
with the ADO.NET data service</strong></p>

<p>[DataServiceKey(&ldquo;Id&rdquo;)]</p>

<p>public class Contact</p>

<p>{</p>

<p>    public int Id { get; set; }</p>

<p>    public string Name { get; set; }</p>

<p>    public string Email { get; set; }</p>

<p>    public string Owner { get; set; }</p>

<p>}</p>

<p> </p>

<p>public class ContactsData</p>

<p>{</p>

<p>    static Contact[] _contacts;</p>

<p> </p>

<p>    static ContactsData()</p>

<p>    {</p>

<p>        _contacts = new Contact[]{</p>

<p>          new Contact(){ Id=0, Name=&ldquo;Mike&rdquo;, Email=&ldquo;<a href="&#109;&#97;&#x69;&#x6c;&#116;&#111;&#x3a;&#x6d;&#x69;&#107;&#x65;&#64;&#99;&#111;&#x6e;&#x74;&#111;&#x73;&#111;&#x2e;&#99;&#111;&#x6d;">&#x6d;&#x69;&#107;&#101;&#x40;&#x63;&#x6f;&#110;&#x74;&#111;&#x73;&#x6f;&#46;&#x63;&#111;&#x6d;</a>&rdquo;,
Owner = &ldquo;jane&rdquo; },</p>

<p>          new Contact(){ Id=1, Name=&ldquo;Saaid&rdquo;, Email=&ldquo;<a href="&#x6d;&#x61;&#105;&#x6c;&#x74;&#x6f;&#x3a;&#83;&#97;&#x61;&#105;&#100;&#64;&#x68;&#x6f;&#116;&#x6d;&#97;&#x69;&#x6c;&#46;&#99;&#x6f;&#109;">&#x53;&#x61;&#97;&#x69;&#100;&#x40;&#x68;&#111;&#116;&#109;&#97;&#105;&#108;&#x2e;&#x63;&#x6f;&#x6d;</a>&rdquo;,
Owner = &ldquo;jane&rdquo;},</p>

<p>          new Contact(){ Id=2, Name=&ldquo;John&rdquo;, Email=&ldquo;<a href="&#x6d;&#97;&#x69;&#x6c;&#x74;&#x6f;&#58;&#106;&#x31;&#50;&#51;&#64;&#x6c;&#x69;&#x76;&#x65;&#46;&#x63;&#111;&#x6d;">&#x6a;&#49;&#50;&#x33;&#64;&#108;&#105;&#x76;&#101;&#x2e;&#99;&#x6f;&#x6d;</a>&rdquo;, Owner
= &ldquo;john&rdquo;},</p>

<p>          new Contact(){ Id=3, Name=&ldquo;Pablo&rdquo;, Email=&ldquo;<a href="&#x6d;&#x61;&#x69;&#108;&#x74;&#x6f;&#x3a;&#x50;&#x61;&#x62;&#108;&#111;&#x40;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#x63;&#111;&#109;">&#x50;&#97;&#98;&#108;&#x6f;&#64;&#109;&#97;&#105;&#108;&#46;&#x63;&#111;&#109;</a>&rdquo;,
Owner = &ldquo;john&rdquo;}};</p>

<p>    }</p>

<p> </p>

<p>    public IQueryable&lt;Contact> Contacts</p>

<p>    {</p>

<p>        get { return _contacts.AsQueryable&lt;Contact>(); }</p>

<p>    }</p>

<p> </p>

<p>}</p>

<p>What I defined here is a simple Contact class representing the contact
entity and a ContactsData for the ADO.NET service data source. The
service will automatically reflect the IQueryable properties in this
data source class. The &ldquo;DataServiceKey&rdquo; attribute on top of the contact
entity is required by ADO.NET services to define an artificial primary
key on custom classes (It took me some to figure this out).</p>

<p><strong>2. Implement the ADO.NET data service</strong></p>

<p>public class contacts : DataService&lt;ContactsData></p>

<p>{</p>

<p>    // This method is called only once to initialize service-wide
policies.</p>

<p>    public static void InitializeService(IDataServiceConfiguration
config)</p>

<p>    {</p>

<p>        config.SetEntitySetAccessRule(&ldquo;*&rdquo;, EntitySetRights.AllRead);</p>

<p>    }</p>

<p> </p>

<p>    [QueryInterceptor(&ldquo;Contacts&rdquo;)]</p>

<p>    public Expression&lt;Func&lt;Contact, bool>> OnQueryContact()</p>

<p>    {</p>

<p>        var name = Thread.CurrentPrincipal.Identity.Name;</p>

<p>        return c => c.Owner.Equals(name,
StringComparison.OrdinalIgnoreCase);</p>

<p>    }</p>

<p>}</p>

<p>The &ldquo;QueryInterceptor&rdquo; in this service implementation basically filters
the resulting contacts based on the authenticated user. As I showed in
my previous post, the authentication is performed by the OAuth channel.</p>

<p><strong>3. Configure the OAuth WCF channel for the ADO.NET data service</strong></p>

<p>&lt;%@ ServiceHost Language=&ldquo;C#&rdquo;
Factory=&ldquo;ExampleOAuthChannel.AppServiceHostFactory&rdquo;
Service=&ldquo;ADOServices.OAuth.contacts&rdquo; %></p>

<p>using System;\
using System.ServiceModel;\
using System.ServiceModel.Activation;\
using Microsoft.ServiceModel.Web;</p>

<p>namespace ExampleOAuthChannel \
{\
  class AppServiceHostFactory : ServiceHostFactory\
  {\
    protected override ServiceHost CreateServiceHost(Type serviceType,
Uri[] baseAddresses)\
    {\
        WebServiceHost2 result = new WebServiceHost2(serviceType, true,
baseAddresses);\
        result.Interceptors.Add(new OAuthChannel.OAuthInterceptor(\
   ADOServices.OAuth.OAuthServicesLocator.Provider,
ADOServices.OAuth.OAuthServicesLocator.AccessTokenRepository));\
        return result;\
    }\
  }\
}</p>

<p>Nothing new in this step, I only registered the OAuth interceptor in the
WCF service host for the ADO.NET service.</p>

<p><a href="/images/legacy/ADOServices_OAuth.zip">Download the complete
example</a>. (It
includes a client application implementation as well)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/14/oauth-channel-for-wcf-restful-services/">OAuth Channel for WCF RESTful Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-14T00:00:00-03:00" pubdate data-updated="true">Nov 14<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/11/14/oauth-channel-for-wcf-restful-services/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>While OpenID and WS-Federation focus on delegating user identity (or a
collection of identity claims), OAuth was designed to address a
different and complementary scenario, the delegation of user
authorization. In few words, OAuth allows a client application to obtain
user consent (as access tokens) for executing operations over private
resources on his behalf.</p>

<p>The analogy given by Eran Hammer Lahav in this post &ldquo;<a href="http://www.hueniverse.com/hueniverse/2007/09/explaining-oaut.html">Explaining
OAuth</a>&rdquo;
is very close to what the specification tries to address,</p>

<p><em>&ldquo;Many luxury cars today come with a valet key. It is a special key you
give the parking attendant and unlike your regular key, will not allow
the car to drive more than a mile or two. Some valet keys will not open
the trunk, while others will block access to your onboard cell phone
address book. Regardless of what restrictions the valet key imposes, the
idea is very clever. You give someone limited access to your car with a
special key, while using another key to unlock everything else.&rdquo;</em></p>

<p>Now, if we analyze the specification in more detail, we will see that
the real purpose behind OAuth is to create a network of collaboration 
between applications. It will not be necessary anymore to keep all our
stuff just in a single place, we can have for instance our pictures in a
website, our contacts in another place and a third application making
use of them, all these applications collaborating together.</p>

<p>If you want to know more about how OAuth works, you should read the
following posts</p>

<ul>
<li><a href="http://www.hueniverse.com/hueniverse/2007/10/beginners-guide.html">&ldquo;Begginer&rsquo;s Guide to OAuth &ndash; Part
I&rdquo;</a></li>
<li><a href="http://www.hueniverse.com/hueniverse/2007/10/beginners-gui-1.html">&ldquo;Begginer&rsquo;s Guide to OAuth &ndash; Part II &ndash; Protocol
Workflow&rdquo;</a></li>
<li><a href="http://www.hueniverse.com/hueniverse/2008/10/beginners-guide.html">&ldquo;Begginer&rsquo;s Guide to OAuth &ndash; Part III &ndash; Security
Architecture&rdquo;</a></li>
</ul>


<p>When I initially said that OpenID and OAuth complement each other, I
meant that the user can first authenticated by an OpenID provider, and
then redirected to the relying party to obtain his consent.
(Authorization for consuming a private resource).</p>

<p><a href="http://blog.bittercoder.com/">Alex Henderson (Aka Bittercoder)</a> has
written a pretty good OAuth library in .NET for implementing an OAuth
consumer and service provider. The library is available
<a href="http://code.google.com/p/devdefined-tools/wiki/OAuth">here</a> under a MIT
license (do wherever you want with it), and it is very easy to use. Alex
has definitively made a very good work.</p>

<p>My WCF channel implementation for OAuth mounts on top of his library and
it basically transforms a OAuth token into a .NET security principal
that can be used later within the service implementation. The channel is
implemented as a RequestInterceptor, one of new features introduced in
the REST WCF Starter Kit. This interceptor basically captures the
request at channel level and performs all the validations required by
OAuth. The following sample illustrates how the interceptors can be
plugged into an existing service host (service.svc),</p>

<p>&lt;%@ ServiceHost Language=&ldquo;C#&rdquo; Debug=&ldquo;true&rdquo;
Service=&ldquo;ExampleOAuthChannel.FeedService&rdquo;
Factory=&ldquo;ExampleOAuthChannel.AppServiceHostFactory&rdquo;%></p>

<p>using System;\
using System.ServiceModel;\
using System.ServiceModel.Activation;\
using Microsoft.ServiceModel.Web;</p>

<p>namespace ExampleOAuthChannel \
{\
  class AppServiceHostFactory : ServiceHostFactory\
  {\
    protected override ServiceHost CreateServiceHost(Type serviceType,
Uri[] baseAddresses)\
    {\
        WebServiceHost2 result = new WebServiceHost2(serviceType, true,
baseAddresses);\
        result.Interceptors.Add(new OAuthChannel.OAuthInterceptor(\
   OAuthServicesLocator.Provider,
OAuthServicesLocator.AccessTokenRepository));\
        return result;\
    }\
  }\
}</p>

<p>OAuthServicesLocator.Provider and
OAuthServiceLocator.AccessTokenRepository are just part of the OAuth
implementation.</p>

<p>The interaction (and all the messages interchanged) between the consumer
and the provider was very well summarized by Alex in this post <a href="http://blog.bittercoder.com/PermaLink,guid,83488336-290d-4c4b-a314-14fe255e5b4e.aspx">&ldquo;OAuth
for
beginners&rdquo;</a></p>

<p>The following code illustrates some of the functionality implemented in
the OAuth interceptor,</p>

<p>Message request = requestContext.RequestMessage;</p>

<p>HttpRequestMessageProperty requestProperty =
(HttpRequestMessageProperty)request.Properties[HttpRequestMessageProperty.Name];</p>

<p> </p>

<p>OAuthContext context = new
OAuthContextBuilder().FromUri(requestProperty.Method,
request.Headers.To);</p>

<p> </p>

<p>try</p>

<p>{</p>

<p>    _provider.AccessProtectedResourceRequest(context);</p>

<p> </p>

<p>    OAuthChannel.Models.AccessToken accessToken =
_repository.GetToken(context.Token);</p>

<p> </p>

<p>    TokenPrincipal principal = new TokenPrincipal(</p>

<p>        new GenericIdentity(accessToken.UserName, &ldquo;OAuth&rdquo;),</p>

<p>        accessToken.Roles,</p>

<p>        accessToken);</p>

<p> </p>

<p>    InitializeSecurityContext(request, principal);</p>

<p>}</p>

<p>catch (OAuthException authEx)</p>

<p>{</p>

<p>    XElement response = XElement.Load(new StringReader(&ldquo;&lt;?xml
version=&#34;1.0\&rdquo; encoding=\&ldquo;utf-8\&rdquo;?>&lt;html
xmlns=\&ldquo;<a href="http://www.w3.org/1999/xhtml\">http://www.w3.org/1999/xhtml\</a>&rdquo; version=\&ldquo;&ndash;//W3C//DTD XHTML
2.0//EN\&rdquo; xml:lang=\&ldquo;en\&rdquo;
xmlns:xsi=\&ldquo;<a href="http://www.w3.org/2001/XMLSchema-instance\">http://www.w3.org/2001/XMLSchema-instance\</a>&rdquo;
xsi:schemaLocation=\&ldquo;<a href="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</a>
<a href="http://www.w3.org/MarkUp/SCHEMA/xhtml2.xsd\">http://www.w3.org/MarkUp/SCHEMA/xhtml2.xsd\</a>&rdquo;>&lt;HEAD>&lt;TITLE>Request
Error&lt;/TITLE>&lt;/HEAD>&lt;BODY>&lt;DIV id=\&ldquo;content\&rdquo;>&lt;P
class=\&ldquo;heading1\&rdquo;>&lt;B>&ldquo; +
HttpUtility.HtmlEncode(authEx.Report.ToString()) +
&rdquo;&lt;/B>&lt;/P>&lt;/DIV>&lt;/BODY>&lt;/html>&ldquo;));</p>

<p>    Message reply = Message.CreateMessage(MessageVersion.None, null,
response);</p>

<p>    HttpResponseMessageProperty responseProperty = new
HttpResponseMessageProperty() { StatusCode = HttpStatusCode.Forbidden,
StatusDescription = authEx.Report.ToString() };</p>

<p>    responseProperty.Headers[HttpResponseHeader.ContentType] =
&ldquo;text/html&rdquo;;</p>

<p>    reply.Properties[HttpResponseMessageProperty.Name] =
responseProperty;</p>

<p>    requestContext.Reply(reply);</p>

<p> </p>

<p>    requestContext = null;</p>

<p>}</p>

<p>It basically validates the OAuth ticket using the library written by
Alex and initializes a new principal containing the ticket identity. If
the ticket can not be validated for some reason, it returns a friendly
exception to the consumer.</p>

<p>UPDATE: Alex has now include the channel as part of the OAuth Library.
It is available under the following links,</p>

<p><a href="http://devdefined-tools.googlecode.com/svn/trunk/projects/oauth/DevDefined.OAuth.Wcf/">http://devdefined-tools.googlecode.com/svn/trunk/projects/oauth/DevDefined.OAuth.Wcf/</a></p>

<p><a href="http://devdefined-tools.googlecode.com/svn/trunk/projects/oauth/ExampleOAuthChannel/">http://devdefined-tools.googlecode.com/svn/trunk/projects/oauth/ExampleOAuthChannel/</a></p>

<p>Coming next  &ldquo;Using the WCF OAuth channel with an ADO.NET service&rdquo; (The
complete source code will be available as part of that post)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/06/routing-to-the-right-workflow-service-instance-through-uri-templates-rest-workflows-part-iii/">Routing to the Right Workflow Service Instance Through URI Templates (REST Workflows Part III)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-06T00:00:00-03:00" pubdate data-updated="true">Nov 6<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/11/06/routing-to-the-right-workflow-service-instance-through-uri-templates-rest-workflows-part-iii/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Continuing from my previous posts &ldquo;<a href="http://weblogs.asp.net/cibrax/archive/2008/10/24/rest-and-workflow-services-play-well-together.aspx">REST and Workflow services play well
together
I</a>&rdquo;
and &ldquo;<a href="http://weblogs.asp.net/cibrax/archive/2008/10/30/rest-and-workflow-services-play-well-together-part-ii.aspx">REST and Workflow services play well together
II</a>&rdquo;,
in which I created a new binding to send the workflow context as an http
header, I&rsquo;ve applied some modifications to that sample to support also
routing through URI templates. This is very helpful for scenarios where
client applications are not necessarily aware of the existence of a
workflow services on the other end, so the context information is
reconstructed from the resource URI using Uri templates.</p>

<p>For example, the following Uri template &ldquo;/orders/{instanceId}&rdquo; applied
to the Uri
<a href="http://localhost:8000/orders/3C3DE415-71F4-4538-ADA6-87A735827DF6">http://localhost:8000/orders/3C3DE415-71F4-4538-ADA6-87A735827DF6</a>
will result in a match for the key &ldquo;instanceId&rdquo; with a value of
&ldquo;3C3DE415-71F4-4538-ADA6-87A735827DF6&rdquo;. We can now pass that instanceId
variable to the WF context correlation manager so it will be able to
locate and load the corresponding workflow service instance.</p>

<p>The configuration for the binding on the service side looks as follow,</p>

<p>&lt;webHttpContext></p>

<p>&lt;binding name=&ldquo;myServiceBinding&rdquo; contextMode=&ldquo;UriTemplate&rdquo;></p>

<p>  &lt;uriTemplates></p>

<p>    &lt;add name=&ldquo;orders&rdquo; value=&ldquo;order/{instanceId}&rdquo;>&lt;/add></p>

<p>    &lt;add name=&ldquo;payments&rdquo; value=&ldquo;payment/order/{instanceId}&rdquo;>&lt;/add></p>

<p>  &lt;/uriTemplates></p>

<p>&lt;/binding></p>

<p>&lt;/webHttpContext></p>

<p>UriTemplates is a collection, you can configure there all the possible
URIs that your workflow can handle. In that example, instanceId is the
name of the variable used by WF to locate the workflow instance, other
variable names can also be used. For example &ldquo;conversationId&rdquo; can be
used to continue the workflow in a specific ReceiveActivity (Usually
required when the workflow is waiting for some event in a parallel
branch activity)</p>

<p>We can now return the following links (representing the possible
branches in the workflow) to the client,</p>

<p>currentOrder.Next = new Next[] {</p>

<p>    new Next</p>

<p>    {</p>

<p>        Rel = &ldquo;<a href="http://starbucks.example.org/payment">http://starbucks.example.org/payment</a>&rdquo;,</p>

<p>        Uri = &ldquo;<a href="http://localhost:8000/payment/order/">http://localhost:8000/payment/order/</a>&rdquo; +
WorkflowEnvironment.WorkflowInstanceId.ToString(),</p>

<p>    },</p>

<p>    new Next</p>

<p>    {</p>

<p>        Rel = &ldquo;<a href="http://starbucks.example/order/update">http://starbucks.example/order/update</a>&rdquo;,</p>

<p>        Uri = &ldquo;<a href="http://localhost:8000/order/">http://localhost:8000/order/</a>&rdquo; +
WorkflowEnvironment.WorkflowInstanceId.ToString()</p>

<p>    }</p>

<p>};</p>

<p>The client application will not need to remember to send a context
header in the next execution to resume an existing workflow instance,
the Uri will be enough to parse the context information.</p>

<p>Download the complete sample from <a href="/images/legacy/RestWorkflowsIII.zip">this
location</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/05/conditional-puts-in-rest/">Conditional Puts in REST</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-05T00:00:00-03:00" pubdate data-updated="true">Nov 5<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/11/05/conditional-puts-in-rest/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Conditional puts is a technique generally used in a REST architecture to
inform clients about possible conflicts when multiple updates are
performed simultaneously over the same resource version. It basically
works as fist-write / first-win approach, a client can only commit an
operation only if the underline resource has not changed in the
meanwhile, otherwise it may receive a http conflict error.</p>

<p>As the &ldquo;<a href="http://weblogs.asp.net/cibrax/archive/2008/10/06/importance-of-conditional-gets-in-rest.aspx">conditional
get</a>&rdquo;
approach I discussed some weeks ago, conditional puts are also based on
the use of the headers &ldquo;Last-Modified&rdquo; and &ldquo;Etag&rdquo; (the If-Not-Modified
and If-None-Match request headers are their flip side). It is used
nowadays for example by the &ldquo;<a href="http://en.wikipedia.org/wiki/ATOM">ATOM publishing
protocol</a>&rdquo;, and there are some plans
to support it in <a href="http://aws.amazon.com/s3/">Amazon S3</a>.</p>

<p>Let&rsquo;s see how this approach works with a simple example of two clients
(A and B) trying to update a resource R1.</p>

<p>​1. Client A performs a GET over R1 (Version1). The response given by
the REST service will include the resource representation and a header
&ldquo;Etag&rdquo; with the resource version, &ldquo;1&rdquo; in this case (Last-Modified could
also be used).</p>

<p>​2. Client B performs a GET over R1 (Version1). It gets the same
representation as the client A</p>

<p>​3. Client B modifies R1 and invokes a PUT on the server. This
invocation includes the modified version of the resource and a header
&ldquo;If-None-Match&rdquo; with the current resource version (Version 1). As result
of this modification, the server returns a Http OK and increments the
resource version by one (Version 2).</p>

<p>​4. Client A modifies R1 and try to invoke a PUT on the server. (This
invocation also includes a &ldquo;If-None-Match&rdquo; header with the resource
version &ldquo;Version 1&rdquo;). The service detects that the resource changed
since the last get, so it throws a conflict error.</p>

<p>If you want to know more about how to implement this technique with WCF,
the new WCF REST Starter Kit includes a complete example &ldquo;ConditionPut&rdquo;
that illustrates all the steps involved in the implementation of this
scenario.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/04/adding-documentation-to-wcf-restful-services-with-the-rest-starter-kit/">Adding Documentation to WCF Restful Services With the REST Starter Kit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-04T00:00:00-03:00" pubdate data-updated="true">Nov 4<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/11/04/adding-documentation-to-wcf-restful-services-with-the-rest-starter-kit/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Automatic documentation is another cool feature introduced in the WCF
REST Starter kit. While documentation is an important aspect in the
development process, unfortunately there is not an standard mode or
guidance yet about how this should be done for REST services. This new
feature comes to help a little in this aspect of the process.</p>

<p>As part of the starter kit, the WCF team has created a new [WebHelp]
attribute that can be used to annotate existing web operations with
human-readable descriptions. The [WebHelp] attribute (as the WebCache
attribute) is an operation behavior implementation that receives a
simple string to describe the operation behavior. The operation
arguments are automatically reflected and shown as part of the service
documentation.</p>

<p>[WebInvoke(UriTemplate = &ldquo;DoWork?json&rdquo;, ResponseFormat =
WebMessageFormat.Json)]</p>

<p>[WebHelp(Comment=&ldquo;This method returns a HTTP status code Conflict with a
custom json error body&rdquo;)]</p>

<p>[OperationContract]</p>

<p> SampleResponseBody DoWorkJson(SampleRequestBody request)</p>

<p>Now, the question is, once we have this attribute applied to all the web
operations of an existing service, where is the documentation actually
published ?. Well, this feature also requires the use of a new service
host &ldquo;WebServiceHost2&rdquo; that comes with the starter kit, which among
other things publishes a new endpoint &ldquo;/help&rdquo; for the service.
Therefore, the final documentation for a service will be available at
&ldquo;ServiceUri&rdquo; + &ldquo;/help&rdquo;. For example,
<a href="http://localhost/MyService.svc/help">http://localhost/MyService.svc/help</a></p>

<p><img src="/images/legacy/ServiceHelpSmall.jpg" alt="" /></p>

<p> </p>

<p>As you can see in the image above, an Atom feed is created and published
in the /help endpoint. Each entry in the feed provides some
documentation about any of the available web operations.</p>

<p>The new service host can be configured in a existing service modifying
the .svc file (If the service runs on IIS),</p>

<p>&lt;%@ ServiceHost Language=&ldquo;C#&rdquo; Debug=&ldquo;true&rdquo; Service=&ldquo;Service.Service&rdquo;
Factory=&ldquo;Microsoft.ServiceModel.Web.WebServiceHost2Factory&rdquo;%></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/03/using-sqlcache-dependencies-with-the-new-wcf-webcache-attribute-rest-starter-kit/">Using SqlCache Dependencies With the New WCF WebCache Attribute (REST Starter KIT)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-03T00:00:00-03:00" pubdate data-updated="true">Nov 3<span>rd</span>, 2008</time>
        
         | <a href="/blog/2008/11/03/using-sqlcache-dependencies-with-the-new-wcf-webcache-attribute-rest-starter-kit/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Let&rsquo;s begin from a hypothetical example that we want to publish a simple
product catalog as an ATOM feed. The product table schema in our
database was initially designed as follows,</p>

<p><img src="/images/legacy/OrdersTable.jpg" alt="" /></p>

<p>The first step is to enable the SQL notification for the products
database, that can be done with the following commands:</p>

<p>​1. Enable cache notifications for the database: aspnet_regsql
[Credentials] -ed -d [DatabaseName] . For example, aspnet_regsql -S
.\SqlExpress -E -ed -d Northwind</p>

<p>​2. Enable cache notifications for an specific table in that database:
aspnet_regsql [Credentials] -et -d [DatabaseName] -t [TableName] . For
example, aspnet_regsql -S .\SqlExpress -E -et -d Northwind  -t
Products</p>

<p>Once we have enabled the ASP.NET SQL notification for the table we want
to use (Products in this example), the next step is to implement the
service and configure it correctly to use the new WebCache behavior.</p>

<p>The contract for the service is quite simple, it receives an optional
categoryId attribute just in case we want to filter the products.</p>

<p>[ServiceContract]</p>

<p>public interface IProductCatalog</p>

<p>{</p>

<p>  [WebCache(Location = OutputCacheLocation.ServerAndClient,
SqlDependency = &ldquo;myDatabase:Products&rdquo;, VaryByParam = &ldquo;categoryId&rdquo;)]</p>

<p>  [WebGet(UriTemplate = &ldquo;?category={categoryId}&rdquo;)]</p>

<p>  [OperationContract]</p>

<p>  Atom10FeedFormatter GetProducts(int categoryId);</p>

<p>}</p>

<p>As you can see in the code above, I defined the new WebCache behavior as
part of my operation contract. I also specified that I want to
invalidate the ASP.NET cache entries when two of the following
conditions are true,</p>

<p>​1. Some change is introduced in the products table (The ASP.NET Sql
Dependency)</p>

<p>​2. A different categoryId argument is specified in query string.</p>

<p>The caching preferences for this service are configured in the
application web configuration file,</p>

<p>&lt;connectionStrings></p>

<p>  &lt;add name=&ldquo;myDatabase&rdquo; connectionString=&ldquo;Data
source=.\SQLExpress;Initial
Catalog=Northwind;Trusted_Connection=yes&rdquo;/></p>

<p>&lt;/connectionStrings></p>

<p>&lt;system.web></p>

<p>  &lt;compilation debug=&ldquo;true&rdquo;>&lt;/compilation></p>

<p>&lt;caching></p>

<p>  &lt;sqlCacheDependency enabled=&ldquo;true&rdquo; pollTime=&ldquo;1000&rdquo; ></p>

<p>    &lt;databases></p>

<p>      &lt;add name=&ldquo;myDatabase&rdquo; connectionStringName=&ldquo;myDatabase&rdquo; /></p>

<p>    &lt;/databases></p>

<p>  &lt;/sqlCacheDependency></p>

<p>&lt;/caching></p>

<p>&lt;/system.web></p>

<p>&lt;system.serviceModel></p>

<p>    &lt;serviceHostingEnvironment aspNetCompatibilityEnabled=&ldquo;true&rdquo;/></p>

<p>&lt;/system.serviceModel></p>

<p>The ASP.NET compatibility mode is required in order to use this new
caching mechanism in our REST service. The service implementation is
quite normal, there was no need to add some extra code to support
caching, which is something great thanks to the new WebCache behavior.</p>

<p>[AspNetCompatibilityRequirements(RequirementsMode =
AspNetCompatibilityRequirementsMode.Allowed)]</p>

<p>public class ProductCatalog : IProductCatalog</p>

<p>{</p>

<p>    public Atom10FeedFormatter GetProducts(int categoryId)</p>

<p>    {</p>

<p>        var connectionString =
ConfigurationManager.ConnectionStrings[&ldquo;myDatabase&rdquo;].ConnectionString;</p>

<p> </p>

<p>        var items = new List&lt;SyndicationItem>();</p>

<p>        using (var connection = new SqlConnection(connectionString))</p>

<p>        {</p>

<p>            var command = new SqlCommand();</p>

<p>            if (categoryId == 0)</p>

<p>                command.CommandText = &ldquo;SELECT * FROM Products&rdquo;;</p>

<p>            else</p>

<p>            {</p>

<p>                command.CommandText = &ldquo;SELECT * FROM Products WHERE
CategoryId = @categoryId&rdquo;;</p>

<p>                command.Parameters.Add(new SqlParameter(&ldquo;@categoryId&rdquo;,
categoryId));</p>

<p>            }</p>

<p> </p>

<p>            command.Connection = connection;</p>

<p>            connection.Open();</p>

<p> </p>

<p>            using(var reader =
command.ExecuteReader(CommandBehavior.CloseConnection))</p>

<p>            {</p>

<p>                while(reader.Read())</p>

<p>                {</p>

<p>                    items.Add(new SyndicationItem()</p>

<p>                    {</p>

<p>                        Id = String.Format(CultureInfo.InvariantCulture,
&ldquo;<a href="http://products/">http://products/</a>{0}&rdquo;, (int)reader[&ldquo;ProductID&rdquo;]),</p>

<p>                        Title = new
TextSyndicationContent((string)reader[&ldquo;ProductName&rdquo;]),</p>

<p>                        LastUpdatedTime = new DateTime(2008, 7, 1, 0, 0,
0, DateTimeKind.Utc),</p>

<p>                        Authors =</p>

<p>                        {</p>

<p>                            new SyndicationPerson()</p>

<p>                            {</p>

<p>                                Name = &ldquo;cibrax&rdquo;</p>

<p>                            }</p>

<p>                        },</p>

<p>                        Content = new
TextSyndicationContent(string.Format(&ldquo;Category Id {0} &ndash; Price {1}&rdquo;,</p>

<p>                            (int)reader[&ldquo;CategoryId&rdquo;],
(decimal)reader[&ldquo;UnitPrice&rdquo;]))</p>

<p>                    });</p>

<p>                }</p>

<p>            }</p>

<p>        }</p>

<p> </p>

<p>        var feed = new SyndicationFeed()</p>

<p>        {</p>

<p>            Id = &ldquo;<a href="http://Products">http://Products</a>&rdquo;,</p>

<p>            Title = new TextSyndicationContent(&ldquo;Product catalog&rdquo;),</p>

<p>            Items = items</p>

<p>        };</p>

<p> </p>

<p>        WebOperationContext.Current.OutgoingResponse.ContentType =
&ldquo;application/atom+xml&rdquo;;</p>

<p>        return feed.GetAtom10Formatter();</p>

<p>    }</p>

<p>}</p>

<p>If you are interested in knowing more details about the WebCache
behavior implementation, my friend Jesus Rodriguez has written an
<a href="http://weblogs.asp.net/gsusx/archive/2008/10/29/adding-caching-to-wcf-restful-services-using-the-rest-starter-kit.aspx">excellent
post</a>
some days ago.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/10/30/rest-and-workflow-services-play-well-together-part-ii/">REST and Workflow Services Play Well Together - Part II</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-30T00:00:00-03:00" pubdate data-updated="true">Oct 30<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/10/30/rest-and-workflow-services-play-well-together-part-ii/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my previous post <a href="http://weblogs.asp.net/cibrax/archive/2008/10/24/rest-and-workflow-services-play-well-together.aspx">&ldquo;REST and Workflow services play well
together&rdquo;</a>,
I mentioned that Http Cookies were one of the built-in mechanisms for
transferring the workflow context across calls between the client and
the service. While cookies work well for http services, from my point of
view, simple Http Headers naturally fit better in a REST architecture.
As consequence, I decided to extend the WCF channel stack to support a
new a custom channel (Or custom binding) for transferring the workflow
context as a http header.</p>

<p>The configuration of this binding WebHttpContextBinding is quite
straightforward, I just created a new binding &ldquo;WebHttpContextBinding&rdquo;
that can easily configured for workflow service,</p>

<p>&lt;services></p>

<p>  &lt;service name=&ldquo;RestWorkflows.OrderWorkflow&rdquo;></p>

<p>    &lt;endpoint address=&ldquo;&rdquo; behaviorConfiguration=&ldquo;MyServiceBehavior&rdquo;
binding=&ldquo;webHttpContext&rdquo; bindingConfiguration=&ldquo;myServiceBinding&rdquo;
contract=&ldquo;RestWorkflows.IOrderService&rdquo; /></p>

<p>  &lt;/service></p>

<p>&lt;/services></p>

<p>&lt;bindings></p>

<p>  &lt;webHttpContext></p>

<p>    &lt;binding name=&ldquo;myServiceBinding&rdquo;>&lt;/binding></p>

<p>  &lt;/webHttpContext></p>

<p>&lt;/bindings></p>

<p>&lt;behaviors></p>

<p>  &lt;endpointBehaviors></p>

<p>     &lt;behavior name=&ldquo;MyServiceBehavior&rdquo;></p>

<p>       &lt;webHttp /></p>

<p>     &lt;/behavior></p>

<p>  &lt;/endpointBehaviors></p>

<p>&lt;/behaviors></p>

<p>&lt;extensions></p>

<p>  &lt;bindingExtensions></p>

<p>    &lt;add name=&ldquo;webHttpContext&rdquo;
type=&ldquo;Microsoft.ServiceModel.Samples.WebHttpContextBindingCollectionElement,
WebHttpContext, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&rdquo;
/></p>

<p>  &lt;/bindingExtensions></p>

<p>&lt;/extensions></p>

<p>The result of using this binding will be a new Http Header WscContext
(encoded as Base64) being transmitted between the client and the
service,</p>

<p>&lt;MessageLogTraceRecord Time=&ldquo;2008-10-29T14:22:59.5258021-02:00&rdquo;
Source=&ldquo;TransportSend&rdquo;
Type=&ldquo;System.ServiceModel.Channels.BodyWriterMessage&rdquo;
xmlns=&ldquo;<a href="http://schemas.microsoft.com/2004/06/ServiceModel/Management/MessageTrace%22">http://schemas.microsoft.com/2004/06/ServiceModel/Management/MessageTrace&#8221;</a>>\
   &lt;Addressing>\
     &lt;Action>&lt;/Action>\
   &lt;/Addressing>\
   &lt;HttpResponse>\
      &lt;StatusCode>Created&lt;/StatusCode>\
      &lt;WebHeaders>     
<strong>&lt;WscContext>77u/PENvbnRleHQgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwNi8wNS9jb250ZXh0Ij48UHJvcGVydHkgbmFtZT0iaW5zdGFuY2VJZCI+NDZkZGY3NTktMzdjNS00ZDZlLWI2ZTItNjVmMDNjMDVmYTAyPC9Qcm9wZXJ0eT48L0NvbnRleHQ+&lt;/WscContext>\
</strong>       &lt;/WebHeaders>\
    &lt;/HttpResponse>\
    &lt;order
xmlns=&rdquo;<a href="http://starbucks.example.org%22/">http://starbucks.example.org&#8221;</a>
xmlns:i=&ldquo;<a href="http://www.w3.org/2001/XMLSchema-instance%22">http://www.w3.org/2001/XMLSchema-instance&#8221;</a>>\
      &lt;cost>6&lt;/cost>\
      &lt;drink>latte&lt;/drink>\
      &lt;next
xmlns:a=&rdquo;<a href="http://example.org/state-machine%22">http://example.org/state-machine&#8221;</a>>\
         &lt;a:next></p>

<p>         
&lt;a:rel><a href="http://starbucks.example.org/payment">http://starbucks.example.org/payment</a>&lt;/a:rel>\
           &lt;a:type>application/xml&lt;/a:type>\
          
&lt;a:uri><a href="http://localhost:8000/payment/order/0b756654-161b-43d0-912f-4236552dc337">http://localhost:8000/payment/order/0b756654-161b-43d0-912f-4236552dc337</a>&lt;/a:uri>\
         &lt;/a:next>\
         &lt;a:next>\
            
&lt;a:rel><a href="http://starbucks.example/order/update">http://starbucks.example/order/update</a>&lt;/a:rel>\
             &lt;a:type>application/xml&lt;/a:type>\
            
&lt;a:uri><a href="http://localhost:8000/order/0b756654-161b-43d0-912f-4236552dc337">http://localhost:8000/order/0b756654-161b-43d0-912f-4236552dc337</a>&lt;/a:uri>\
         &lt;/a:next>\
       &lt;/next>\
     &lt;/order>\
&lt;/MessageLogTraceRecord></p>

<p>&lt;MessageLogTraceRecord Time=&ldquo;2008-10-29T14:22:59.5726021-02:00&rdquo;
Source=&ldquo;TransportReceive&rdquo;
Type=&ldquo;System.ServiceModel.Channels.BufferedMessage&rdquo;
xmlns=&ldquo;<a href="http://schemas.microsoft.com/2004/06/ServiceModel/Management/MessageTrace%22">http://schemas.microsoft.com/2004/06/ServiceModel/Management/MessageTrace&#8221;</a>>\
   &lt;HttpRequest>\
      &lt;Method>PUT&lt;/Method>\
       &lt;QueryString>&lt;/QueryString>\
       &lt;WebHeaders>\
     
<strong>&lt;WscContext>77u/PENvbnRleHQgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwNi8wNS9jb250ZXh0Ij48UHJvcGVydHkgbmFtZT0iaW5zdGFuY2VJZCI+NDZkZGY3NTktMzdjNS00ZDZlLWI2ZTItNjVmMDNjMDVmYTAyPC9Qcm9wZXJ0eT48L0NvbnRleHQ+&lt;/WscContext>\
</strong>        &lt;Content-Length>566&lt;/Content-Length>\
        &lt;Content-Type>application/xml&lt;/Content-Type>\
        &lt;Expect>100-continue&lt;/Expect>\
         &lt;Host>localhost:8000&lt;/Host>\
      &lt;/WebHeaders>\
    &lt;/HttpRequest>\
    &lt;order
xmlns=&rdquo;<a href="http://starbucks.example.org%22/">http://starbucks.example.org&#8221;</a>
xmlns:i=&ldquo;<a href="http://www.w3.org/2001/XMLSchema-instance%22">http://www.w3.org/2001/XMLSchema-instance&#8221;</a>>\
          &lt;cost>6&lt;/cost>\
          &lt;drink>cappuchino&lt;/drink>\
          &lt;next
xmlns:a=&rdquo;<a href="http://example.org/state-machine%22">http://example.org/state-machine&#8221;</a>>\
            &lt;a:next>\
             
&lt;a:rel><a href="http://starbucks.example.org/payment">http://starbucks.example.org/payment</a>&lt;/a:rel>\
              &lt;a:type>application/xml&lt;/a:type>\
             
&lt;a:uri><a href="http://localhost:8000/payment/order/0b756654-161b-43d0-912f-4236552dc337">http://localhost:8000/payment/order/0b756654-161b-43d0-912f-4236552dc337</a>&lt;/a:uri>\
             &lt;/a:next>\
             &lt;a:next>\
              
&lt;a:rel><a href="http://starbucks.example/order/update">http://starbucks.example/order/update</a>&lt;/a:rel>\
               &lt;a:type>application/xml&lt;/a:type>\
              
&lt;a:uri><a href="http://localhost:8000/order/0b756654-161b-43d0-912f-4236552dc337">http://localhost:8000/order/0b756654-161b-43d0-912f-4236552dc337</a>&lt;/a:uri>\
             &lt;/a:next>\
           &lt;/next>\
       &lt;/order>\
&lt;/MessageLogTraceRecord></p>

<p>The code for the custom binding is available to download from <a href="/images/legacy/RestWorkflowsII.zip">this
location</a>.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/18/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/16/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/20/do-not-version-urls/">Do Not Version Urls</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/23/selfhost-utilities/">SelfHost Utilities</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/23/appfabric-outputcaching/">AppFabric OutputCaching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/31/making-ajax-calls-with-hawk-authentication-to-asp-dot-net-web-api/">Making Ajax Calls With Hawk Authentication to ASP.NET Web API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/13/coordinating-async-work-in-node-dot-js/">Coordinating Async Work in Node.js</a>
      </li>
    
  </ul>
</section>
 <a href="http://feeds.feedburner.com/cibrax"><img src="http://feeds.feedburner.com/~fc/cibrax?bg=FF3300&amp;fg=000000&amp;anim=0" style="border:0" alt="" /></a>

 <script type="text/javascript" language="javascript" src="http://twittercounter.com/embed/?username=cibrax&style=white"></script>
<a href="https://mvp.microsoft.com/en-us/mvp/Pablo%20Cibraro-33800"><img src="/images/mvp.gif" border="0" /></a>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pcibraro">@pcibraro</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pcibraro',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Cibrax -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cibrax';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
