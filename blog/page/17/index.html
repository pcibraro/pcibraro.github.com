
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pablo Cibraro (Cibrax)</title>
  <meta name="author" content="Cibrax">

  
  <meta name="description" content="As I promised in my previous post &ldquo;OAuth Channel for WCF RESTful
services&rdquo;, it is now time to show this new channel in action with a real &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cibrax.me/blog/page/17">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/cibrax" rel="alternate" title="Pablo Cibraro (Cibrax)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44468149-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pablo Cibraro (Cibrax)</a></h1>
  
    <h2>All about software development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/cibrax" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cibrax.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/14/using-the-wcf-oauth-channel-with-an-ado-net-service/">Using the WCF OAuth Channel With an ADO.NET Service</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-14T00:00:00-03:00" pubdate data-updated="true">Nov 14<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/11/14/using-the-wcf-oauth-channel-with-an-ado-net-service/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As I promised in my previous post &ldquo;OAuth Channel for WCF RESTful
services&rdquo;, it is now time to show this new channel in action with a real
service. To make this sample more interesting, I decided to base this
implementation on an ADO.NET service that provides information about
contacts.</p>

<p>This post will be a kind of walk-through to demonstrate all the steps
required to implement the ADO.NET service, and then, the final
integration with OAuth.</p>

<p><strong>1.Create a custom data source (IQueryable) implementation for using
with the ADO.NET data service</strong></p>

<p>[DataServiceKey(&ldquo;Id&rdquo;)]</p>

<p>public class Contact</p>

<p>{</p>

<p>    public int Id { get; set; }</p>

<p>    public string Name { get; set; }</p>

<p>    public string Email { get; set; }</p>

<p>    public string Owner { get; set; }</p>

<p>}</p>

<p> </p>

<p>public class ContactsData</p>

<p>{</p>

<p>    static Contact[] _contacts;</p>

<p> </p>

<p>    static ContactsData()</p>

<p>    {</p>

<p>        _contacts = new Contact[]{</p>

<p>          new Contact(){ Id=0, Name=&ldquo;Mike&rdquo;, Email=&ldquo;<a href="&#109;&#x61;&#x69;&#x6c;&#116;&#111;&#58;&#x6d;&#x69;&#x6b;&#x65;&#64;&#99;&#111;&#110;&#116;&#111;&#115;&#x6f;&#x2e;&#x63;&#111;&#x6d;">&#109;&#105;&#x6b;&#x65;&#64;&#99;&#x6f;&#x6e;&#116;&#x6f;&#x73;&#x6f;&#46;&#99;&#x6f;&#x6d;</a>&rdquo;,
Owner = &ldquo;jane&rdquo; },</p>

<p>          new Contact(){ Id=1, Name=&ldquo;Saaid&rdquo;, Email=&ldquo;<a href="&#109;&#x61;&#105;&#x6c;&#x74;&#x6f;&#58;&#x53;&#97;&#97;&#105;&#x64;&#64;&#x68;&#x6f;&#116;&#x6d;&#x61;&#x69;&#108;&#46;&#99;&#111;&#x6d;">&#x53;&#x61;&#97;&#x69;&#100;&#x40;&#104;&#x6f;&#116;&#109;&#x61;&#105;&#x6c;&#x2e;&#99;&#x6f;&#x6d;</a>&rdquo;,
Owner = &ldquo;jane&rdquo;},</p>

<p>          new Contact(){ Id=2, Name=&ldquo;John&rdquo;, Email=&ldquo;<a href="&#109;&#97;&#105;&#108;&#x74;&#111;&#58;&#106;&#x31;&#50;&#x33;&#64;&#108;&#x69;&#x76;&#x65;&#x2e;&#99;&#x6f;&#109;">&#106;&#x31;&#50;&#x33;&#x40;&#108;&#x69;&#x76;&#x65;&#46;&#99;&#111;&#109;</a>&rdquo;, Owner
= &ldquo;john&rdquo;},</p>

<p>          new Contact(){ Id=3, Name=&ldquo;Pablo&rdquo;, Email=&ldquo;<a href="&#109;&#97;&#105;&#108;&#x74;&#x6f;&#58;&#x50;&#97;&#x62;&#x6c;&#x6f;&#64;&#x6d;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#x50;&#97;&#98;&#x6c;&#111;&#64;&#109;&#97;&#x69;&#108;&#x2e;&#x63;&#111;&#x6d;</a>&rdquo;,
Owner = &ldquo;john&rdquo;}};</p>

<p>    }</p>

<p> </p>

<p>    public IQueryable&lt;Contact> Contacts</p>

<p>    {</p>

<p>        get { return _contacts.AsQueryable&lt;Contact>(); }</p>

<p>    }</p>

<p> </p>

<p>}</p>

<p>What I defined here is a simple Contact class representing the contact
entity and a ContactsData for the ADO.NET service data source. The
service will automatically reflect the IQueryable properties in this
data source class. The &ldquo;DataServiceKey&rdquo; attribute on top of the contact
entity is required by ADO.NET services to define an artificial primary
key on custom classes (It took me some to figure this out).</p>

<p><strong>2. Implement the ADO.NET data service</strong></p>

<p>public class contacts : DataService&lt;ContactsData></p>

<p>{</p>

<p>    // This method is called only once to initialize service-wide
policies.</p>

<p>    public static void InitializeService(IDataServiceConfiguration
config)</p>

<p>    {</p>

<p>        config.SetEntitySetAccessRule(&ldquo;*&rdquo;, EntitySetRights.AllRead);</p>

<p>    }</p>

<p> </p>

<p>    [QueryInterceptor(&ldquo;Contacts&rdquo;)]</p>

<p>    public Expression&lt;Func&lt;Contact, bool>> OnQueryContact()</p>

<p>    {</p>

<p>        var name = Thread.CurrentPrincipal.Identity.Name;</p>

<p>        return c => c.Owner.Equals(name,
StringComparison.OrdinalIgnoreCase);</p>

<p>    }</p>

<p>}</p>

<p>The &ldquo;QueryInterceptor&rdquo; in this service implementation basically filters
the resulting contacts based on the authenticated user. As I showed in
my previous post, the authentication is performed by the OAuth channel.</p>

<p><strong>3. Configure the OAuth WCF channel for the ADO.NET data service</strong></p>

<p>&lt;%@ ServiceHost Language=&ldquo;C#&rdquo;
Factory=&ldquo;ExampleOAuthChannel.AppServiceHostFactory&rdquo;
Service=&ldquo;ADOServices.OAuth.contacts&rdquo; %></p>

<p>using System;\
using System.ServiceModel;\
using System.ServiceModel.Activation;\
using Microsoft.ServiceModel.Web;</p>

<p>namespace ExampleOAuthChannel \
{\
  class AppServiceHostFactory : ServiceHostFactory\
  {\
    protected override ServiceHost CreateServiceHost(Type serviceType,
Uri[] baseAddresses)\
    {\
        WebServiceHost2 result = new WebServiceHost2(serviceType, true,
baseAddresses);\
        result.Interceptors.Add(new OAuthChannel.OAuthInterceptor(\
   ADOServices.OAuth.OAuthServicesLocator.Provider,
ADOServices.OAuth.OAuthServicesLocator.AccessTokenRepository));\
        return result;\
    }\
  }\
}</p>

<p>Nothing new in this step, I only registered the OAuth interceptor in the
WCF service host for the ADO.NET service.</p>

<p><a href="/images/legacy/ADOServices_OAuth.zip">Download the complete
example</a>. (It
includes a client application implementation as well)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/14/oauth-channel-for-wcf-restful-services/">OAuth Channel for WCF RESTful Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-14T00:00:00-03:00" pubdate data-updated="true">Nov 14<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/11/14/oauth-channel-for-wcf-restful-services/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>While OpenID and WS-Federation focus on delegating user identity (or a
collection of identity claims), OAuth was designed to address a
different and complementary scenario, the delegation of user
authorization. In few words, OAuth allows a client application to obtain
user consent (as access tokens) for executing operations over private
resources on his behalf.</p>

<p>The analogy given by Eran Hammer Lahav in this post &ldquo;<a href="http://www.hueniverse.com/hueniverse/2007/09/explaining-oaut.html">Explaining
OAuth</a>&rdquo;
is very close to what the specification tries to address,</p>

<p><em>&ldquo;Many luxury cars today come with a valet key. It is a special key you
give the parking attendant and unlike your regular key, will not allow
the car to drive more than a mile or two. Some valet keys will not open
the trunk, while others will block access to your onboard cell phone
address book. Regardless of what restrictions the valet key imposes, the
idea is very clever. You give someone limited access to your car with a
special key, while using another key to unlock everything else.&rdquo;</em></p>

<p>Now, if we analyze the specification in more detail, we will see that
the real purpose behind OAuth is to create a network of collaboration 
between applications. It will not be necessary anymore to keep all our
stuff just in a single place, we can have for instance our pictures in a
website, our contacts in another place and a third application making
use of them, all these applications collaborating together.</p>

<p>If you want to know more about how OAuth works, you should read the
following posts</p>

<ul>
<li><a href="http://www.hueniverse.com/hueniverse/2007/10/beginners-guide.html">&ldquo;Begginer&rsquo;s Guide to OAuth &ndash; Part
I&rdquo;</a></li>
<li><a href="http://www.hueniverse.com/hueniverse/2007/10/beginners-gui-1.html">&ldquo;Begginer&rsquo;s Guide to OAuth &ndash; Part II &ndash; Protocol
Workflow&rdquo;</a></li>
<li><a href="http://www.hueniverse.com/hueniverse/2008/10/beginners-guide.html">&ldquo;Begginer&rsquo;s Guide to OAuth &ndash; Part III &ndash; Security
Architecture&rdquo;</a></li>
</ul>


<p>When I initially said that OpenID and OAuth complement each other, I
meant that the user can first authenticated by an OpenID provider, and
then redirected to the relying party to obtain his consent.
(Authorization for consuming a private resource).</p>

<p><a href="http://blog.bittercoder.com/">Alex Henderson (Aka Bittercoder)</a> has
written a pretty good OAuth library in .NET for implementing an OAuth
consumer and service provider. The library is available
<a href="http://code.google.com/p/devdefined-tools/wiki/OAuth">here</a> under a MIT
license (do wherever you want with it), and it is very easy to use. Alex
has definitively made a very good work.</p>

<p>My WCF channel implementation for OAuth mounts on top of his library and
it basically transforms a OAuth token into a .NET security principal
that can be used later within the service implementation. The channel is
implemented as a RequestInterceptor, one of new features introduced in
the REST WCF Starter Kit. This interceptor basically captures the
request at channel level and performs all the validations required by
OAuth. The following sample illustrates how the interceptors can be
plugged into an existing service host (service.svc),</p>

<p>&lt;%@ ServiceHost Language=&ldquo;C#&rdquo; Debug=&ldquo;true&rdquo;
Service=&ldquo;ExampleOAuthChannel.FeedService&rdquo;
Factory=&ldquo;ExampleOAuthChannel.AppServiceHostFactory&rdquo;%></p>

<p>using System;\
using System.ServiceModel;\
using System.ServiceModel.Activation;\
using Microsoft.ServiceModel.Web;</p>

<p>namespace ExampleOAuthChannel \
{\
  class AppServiceHostFactory : ServiceHostFactory\
  {\
    protected override ServiceHost CreateServiceHost(Type serviceType,
Uri[] baseAddresses)\
    {\
        WebServiceHost2 result = new WebServiceHost2(serviceType, true,
baseAddresses);\
        result.Interceptors.Add(new OAuthChannel.OAuthInterceptor(\
   OAuthServicesLocator.Provider,
OAuthServicesLocator.AccessTokenRepository));\
        return result;\
    }\
  }\
}</p>

<p>OAuthServicesLocator.Provider and
OAuthServiceLocator.AccessTokenRepository are just part of the OAuth
implementation.</p>

<p>The interaction (and all the messages interchanged) between the consumer
and the provider was very well summarized by Alex in this post <a href="http://blog.bittercoder.com/PermaLink,guid,83488336-290d-4c4b-a314-14fe255e5b4e.aspx">&ldquo;OAuth
for
beginners&rdquo;</a></p>

<p>The following code illustrates some of the functionality implemented in
the OAuth interceptor,</p>

<p>Message request = requestContext.RequestMessage;</p>

<p>HttpRequestMessageProperty requestProperty =
(HttpRequestMessageProperty)request.Properties[HttpRequestMessageProperty.Name];</p>

<p> </p>

<p>OAuthContext context = new
OAuthContextBuilder().FromUri(requestProperty.Method,
request.Headers.To);</p>

<p> </p>

<p>try</p>

<p>{</p>

<p>    _provider.AccessProtectedResourceRequest(context);</p>

<p> </p>

<p>    OAuthChannel.Models.AccessToken accessToken =
_repository.GetToken(context.Token);</p>

<p> </p>

<p>    TokenPrincipal principal = new TokenPrincipal(</p>

<p>        new GenericIdentity(accessToken.UserName, &ldquo;OAuth&rdquo;),</p>

<p>        accessToken.Roles,</p>

<p>        accessToken);</p>

<p> </p>

<p>    InitializeSecurityContext(request, principal);</p>

<p>}</p>

<p>catch (OAuthException authEx)</p>

<p>{</p>

<p>    XElement response = XElement.Load(new StringReader(&ldquo;&lt;?xml
version=&#34;1.0\&rdquo; encoding=\&ldquo;utf-8\&rdquo;?>&lt;html
xmlns=\&ldquo;<a href="http://www.w3.org/1999/xhtml\">http://www.w3.org/1999/xhtml\</a>&rdquo; version=\&ldquo;&ndash;//W3C//DTD XHTML
2.0//EN\&rdquo; xml:lang=\&ldquo;en\&rdquo;
xmlns:xsi=\&ldquo;<a href="http://www.w3.org/2001/XMLSchema-instance\">http://www.w3.org/2001/XMLSchema-instance\</a>&rdquo;
xsi:schemaLocation=\&ldquo;<a href="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</a>
<a href="http://www.w3.org/MarkUp/SCHEMA/xhtml2.xsd\">http://www.w3.org/MarkUp/SCHEMA/xhtml2.xsd\</a>&rdquo;>&lt;HEAD>&lt;TITLE>Request
Error&lt;/TITLE>&lt;/HEAD>&lt;BODY>&lt;DIV id=\&ldquo;content\&rdquo;>&lt;P
class=\&ldquo;heading1\&rdquo;>&lt;B>&ldquo; +
HttpUtility.HtmlEncode(authEx.Report.ToString()) +
&rdquo;&lt;/B>&lt;/P>&lt;/DIV>&lt;/BODY>&lt;/html>&ldquo;));</p>

<p>    Message reply = Message.CreateMessage(MessageVersion.None, null,
response);</p>

<p>    HttpResponseMessageProperty responseProperty = new
HttpResponseMessageProperty() { StatusCode = HttpStatusCode.Forbidden,
StatusDescription = authEx.Report.ToString() };</p>

<p>    responseProperty.Headers[HttpResponseHeader.ContentType] =
&ldquo;text/html&rdquo;;</p>

<p>    reply.Properties[HttpResponseMessageProperty.Name] =
responseProperty;</p>

<p>    requestContext.Reply(reply);</p>

<p> </p>

<p>    requestContext = null;</p>

<p>}</p>

<p>It basically validates the OAuth ticket using the library written by
Alex and initializes a new principal containing the ticket identity. If
the ticket can not be validated for some reason, it returns a friendly
exception to the consumer.</p>

<p>UPDATE: Alex has now include the channel as part of the OAuth Library.
It is available under the following links,</p>

<p><a href="http://devdefined-tools.googlecode.com/svn/trunk/projects/oauth/DevDefined.OAuth.Wcf/">http://devdefined-tools.googlecode.com/svn/trunk/projects/oauth/DevDefined.OAuth.Wcf/</a></p>

<p><a href="http://devdefined-tools.googlecode.com/svn/trunk/projects/oauth/ExampleOAuthChannel/">http://devdefined-tools.googlecode.com/svn/trunk/projects/oauth/ExampleOAuthChannel/</a></p>

<p>Coming next  &ldquo;Using the WCF OAuth channel with an ADO.NET service&rdquo; (The
complete source code will be available as part of that post)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/06/routing-to-the-right-workflow-service-instance-through-uri-templates-rest-workflows-part-iii/">Routing to the Right Workflow Service Instance Through URI Templates (REST Workflows Part III)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-06T00:00:00-03:00" pubdate data-updated="true">Nov 6<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/11/06/routing-to-the-right-workflow-service-instance-through-uri-templates-rest-workflows-part-iii/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Continuing from my previous posts &ldquo;<a href="http://weblogs.asp.net/cibrax/archive/2008/10/24/rest-and-workflow-services-play-well-together.aspx">REST and Workflow services play well
together
I</a>&rdquo;
and &ldquo;<a href="http://weblogs.asp.net/cibrax/archive/2008/10/30/rest-and-workflow-services-play-well-together-part-ii.aspx">REST and Workflow services play well together
II</a>&rdquo;,
in which I created a new binding to send the workflow context as an http
header, I&rsquo;ve applied some modifications to that sample to support also
routing through URI templates. This is very helpful for scenarios where
client applications are not necessarily aware of the existence of a
workflow services on the other end, so the context information is
reconstructed from the resource URI using Uri templates.</p>

<p>For example, the following Uri template &ldquo;/orders/{instanceId}&rdquo; applied
to the Uri
<a href="http://localhost:8000/orders/3C3DE415-71F4-4538-ADA6-87A735827DF6">http://localhost:8000/orders/3C3DE415-71F4-4538-ADA6-87A735827DF6</a>
will result in a match for the key &ldquo;instanceId&rdquo; with a value of
&ldquo;3C3DE415-71F4-4538-ADA6-87A735827DF6&rdquo;. We can now pass that instanceId
variable to the WF context correlation manager so it will be able to
locate and load the corresponding workflow service instance.</p>

<p>The configuration for the binding on the service side looks as follow,</p>

<p>&lt;webHttpContext></p>

<p>&lt;binding name=&ldquo;myServiceBinding&rdquo; contextMode=&ldquo;UriTemplate&rdquo;></p>

<p>  &lt;uriTemplates></p>

<p>    &lt;add name=&ldquo;orders&rdquo; value=&ldquo;order/{instanceId}&rdquo;>&lt;/add></p>

<p>    &lt;add name=&ldquo;payments&rdquo; value=&ldquo;payment/order/{instanceId}&rdquo;>&lt;/add></p>

<p>  &lt;/uriTemplates></p>

<p>&lt;/binding></p>

<p>&lt;/webHttpContext></p>

<p>UriTemplates is a collection, you can configure there all the possible
URIs that your workflow can handle. In that example, instanceId is the
name of the variable used by WF to locate the workflow instance, other
variable names can also be used. For example &ldquo;conversationId&rdquo; can be
used to continue the workflow in a specific ReceiveActivity (Usually
required when the workflow is waiting for some event in a parallel
branch activity)</p>

<p>We can now return the following links (representing the possible
branches in the workflow) to the client,</p>

<p>currentOrder.Next = new Next[] {</p>

<p>    new Next</p>

<p>    {</p>

<p>        Rel = &ldquo;<a href="http://starbucks.example.org/payment">http://starbucks.example.org/payment</a>&rdquo;,</p>

<p>        Uri = &ldquo;<a href="http://localhost:8000/payment/order/">http://localhost:8000/payment/order/</a>&rdquo; +
WorkflowEnvironment.WorkflowInstanceId.ToString(),</p>

<p>    },</p>

<p>    new Next</p>

<p>    {</p>

<p>        Rel = &ldquo;<a href="http://starbucks.example/order/update">http://starbucks.example/order/update</a>&rdquo;,</p>

<p>        Uri = &ldquo;<a href="http://localhost:8000/order/">http://localhost:8000/order/</a>&rdquo; +
WorkflowEnvironment.WorkflowInstanceId.ToString()</p>

<p>    }</p>

<p>};</p>

<p>The client application will not need to remember to send a context
header in the next execution to resume an existing workflow instance,
the Uri will be enough to parse the context information.</p>

<p>Download the complete sample from <a href="/images/legacy/RestWorkflowsIII.zip">this
location</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/05/conditional-puts-in-rest/">Conditional Puts in REST</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-05T00:00:00-03:00" pubdate data-updated="true">Nov 5<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/11/05/conditional-puts-in-rest/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Conditional puts is a technique generally used in a REST architecture to
inform clients about possible conflicts when multiple updates are
performed simultaneously over the same resource version. It basically
works as fist-write / first-win approach, a client can only commit an
operation only if the underline resource has not changed in the
meanwhile, otherwise it may receive a http conflict error.</p>

<p>As the &ldquo;<a href="http://weblogs.asp.net/cibrax/archive/2008/10/06/importance-of-conditional-gets-in-rest.aspx">conditional
get</a>&rdquo;
approach I discussed some weeks ago, conditional puts are also based on
the use of the headers &ldquo;Last-Modified&rdquo; and &ldquo;Etag&rdquo; (the If-Not-Modified
and If-None-Match request headers are their flip side). It is used
nowadays for example by the &ldquo;<a href="http://en.wikipedia.org/wiki/ATOM">ATOM publishing
protocol</a>&rdquo;, and there are some plans
to support it in <a href="http://aws.amazon.com/s3/">Amazon S3</a>.</p>

<p>Let&rsquo;s see how this approach works with a simple example of two clients
(A and B) trying to update a resource R1.</p>

<p>​1. Client A performs a GET over R1 (Version1). The response given by
the REST service will include the resource representation and a header
&ldquo;Etag&rdquo; with the resource version, &ldquo;1&rdquo; in this case (Last-Modified could
also be used).</p>

<p>​2. Client B performs a GET over R1 (Version1). It gets the same
representation as the client A</p>

<p>​3. Client B modifies R1 and invokes a PUT on the server. This
invocation includes the modified version of the resource and a header
&ldquo;If-None-Match&rdquo; with the current resource version (Version 1). As result
of this modification, the server returns a Http OK and increments the
resource version by one (Version 2).</p>

<p>​4. Client A modifies R1 and try to invoke a PUT on the server. (This
invocation also includes a &ldquo;If-None-Match&rdquo; header with the resource
version &ldquo;Version 1&rdquo;). The service detects that the resource changed
since the last get, so it throws a conflict error.</p>

<p>If you want to know more about how to implement this technique with WCF,
the new WCF REST Starter Kit includes a complete example &ldquo;ConditionPut&rdquo;
that illustrates all the steps involved in the implementation of this
scenario.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/04/adding-documentation-to-wcf-restful-services-with-the-rest-starter-kit/">Adding Documentation to WCF Restful Services With the REST Starter Kit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-04T00:00:00-03:00" pubdate data-updated="true">Nov 4<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/11/04/adding-documentation-to-wcf-restful-services-with-the-rest-starter-kit/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Automatic documentation is another cool feature introduced in the WCF
REST Starter kit. While documentation is an important aspect in the
development process, unfortunately there is not an standard mode or
guidance yet about how this should be done for REST services. This new
feature comes to help a little in this aspect of the process.</p>

<p>As part of the starter kit, the WCF team has created a new [WebHelp]
attribute that can be used to annotate existing web operations with
human-readable descriptions. The [WebHelp] attribute (as the WebCache
attribute) is an operation behavior implementation that receives a
simple string to describe the operation behavior. The operation
arguments are automatically reflected and shown as part of the service
documentation.</p>

<p>[WebInvoke(UriTemplate = &ldquo;DoWork?json&rdquo;, ResponseFormat =
WebMessageFormat.Json)]</p>

<p>[WebHelp(Comment=&ldquo;This method returns a HTTP status code Conflict with a
custom json error body&rdquo;)]</p>

<p>[OperationContract]</p>

<p> SampleResponseBody DoWorkJson(SampleRequestBody request)</p>

<p>Now, the question is, once we have this attribute applied to all the web
operations of an existing service, where is the documentation actually
published ?. Well, this feature also requires the use of a new service
host &ldquo;WebServiceHost2&rdquo; that comes with the starter kit, which among
other things publishes a new endpoint &ldquo;/help&rdquo; for the service.
Therefore, the final documentation for a service will be available at
&ldquo;ServiceUri&rdquo; + &ldquo;/help&rdquo;. For example,
<a href="http://localhost/MyService.svc/help">http://localhost/MyService.svc/help</a></p>

<p><img src="/images/legacy/ServiceHelpSmall.jpg" alt="" /></p>

<p> </p>

<p>As you can see in the image above, an Atom feed is created and published
in the /help endpoint. Each entry in the feed provides some
documentation about any of the available web operations.</p>

<p>The new service host can be configured in a existing service modifying
the .svc file (If the service runs on IIS),</p>

<p>&lt;%@ ServiceHost Language=&ldquo;C#&rdquo; Debug=&ldquo;true&rdquo; Service=&ldquo;Service.Service&rdquo;
Factory=&ldquo;Microsoft.ServiceModel.Web.WebServiceHost2Factory&rdquo;%></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/03/using-sqlcache-dependencies-with-the-new-wcf-webcache-attribute-rest-starter-kit/">Using SqlCache Dependencies With the New WCF WebCache Attribute (REST Starter KIT)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-03T00:00:00-03:00" pubdate data-updated="true">Nov 3<span>rd</span>, 2008</time>
        
         | <a href="/blog/2008/11/03/using-sqlcache-dependencies-with-the-new-wcf-webcache-attribute-rest-starter-kit/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Let&rsquo;s begin from a hypothetical example that we want to publish a simple
product catalog as an ATOM feed. The product table schema in our
database was initially designed as follows,</p>

<p><img src="/images/legacy/OrdersTable.jpg" alt="" /></p>

<p>The first step is to enable the SQL notification for the products
database, that can be done with the following commands:</p>

<p>​1. Enable cache notifications for the database: aspnet_regsql
[Credentials] -ed -d [DatabaseName] . For example, aspnet_regsql -S
.\SqlExpress -E -ed -d Northwind</p>

<p>​2. Enable cache notifications for an specific table in that database:
aspnet_regsql [Credentials] -et -d [DatabaseName] -t [TableName] . For
example, aspnet_regsql -S .\SqlExpress -E -et -d Northwind  -t
Products</p>

<p>Once we have enabled the ASP.NET SQL notification for the table we want
to use (Products in this example), the next step is to implement the
service and configure it correctly to use the new WebCache behavior.</p>

<p>The contract for the service is quite simple, it receives an optional
categoryId attribute just in case we want to filter the products.</p>

<p>[ServiceContract]</p>

<p>public interface IProductCatalog</p>

<p>{</p>

<p>  [WebCache(Location = OutputCacheLocation.ServerAndClient,
SqlDependency = &ldquo;myDatabase:Products&rdquo;, VaryByParam = &ldquo;categoryId&rdquo;)]</p>

<p>  [WebGet(UriTemplate = &ldquo;?category={categoryId}&rdquo;)]</p>

<p>  [OperationContract]</p>

<p>  Atom10FeedFormatter GetProducts(int categoryId);</p>

<p>}</p>

<p>As you can see in the code above, I defined the new WebCache behavior as
part of my operation contract. I also specified that I want to
invalidate the ASP.NET cache entries when two of the following
conditions are true,</p>

<p>​1. Some change is introduced in the products table (The ASP.NET Sql
Dependency)</p>

<p>​2. A different categoryId argument is specified in query string.</p>

<p>The caching preferences for this service are configured in the
application web configuration file,</p>

<p>&lt;connectionStrings></p>

<p>  &lt;add name=&ldquo;myDatabase&rdquo; connectionString=&ldquo;Data
source=.\SQLExpress;Initial
Catalog=Northwind;Trusted_Connection=yes&rdquo;/></p>

<p>&lt;/connectionStrings></p>

<p>&lt;system.web></p>

<p>  &lt;compilation debug=&ldquo;true&rdquo;>&lt;/compilation></p>

<p>&lt;caching></p>

<p>  &lt;sqlCacheDependency enabled=&ldquo;true&rdquo; pollTime=&ldquo;1000&rdquo; ></p>

<p>    &lt;databases></p>

<p>      &lt;add name=&ldquo;myDatabase&rdquo; connectionStringName=&ldquo;myDatabase&rdquo; /></p>

<p>    &lt;/databases></p>

<p>  &lt;/sqlCacheDependency></p>

<p>&lt;/caching></p>

<p>&lt;/system.web></p>

<p>&lt;system.serviceModel></p>

<p>    &lt;serviceHostingEnvironment aspNetCompatibilityEnabled=&ldquo;true&rdquo;/></p>

<p>&lt;/system.serviceModel></p>

<p>The ASP.NET compatibility mode is required in order to use this new
caching mechanism in our REST service. The service implementation is
quite normal, there was no need to add some extra code to support
caching, which is something great thanks to the new WebCache behavior.</p>

<p>[AspNetCompatibilityRequirements(RequirementsMode =
AspNetCompatibilityRequirementsMode.Allowed)]</p>

<p>public class ProductCatalog : IProductCatalog</p>

<p>{</p>

<p>    public Atom10FeedFormatter GetProducts(int categoryId)</p>

<p>    {</p>

<p>        var connectionString =
ConfigurationManager.ConnectionStrings[&ldquo;myDatabase&rdquo;].ConnectionString;</p>

<p> </p>

<p>        var items = new List&lt;SyndicationItem>();</p>

<p>        using (var connection = new SqlConnection(connectionString))</p>

<p>        {</p>

<p>            var command = new SqlCommand();</p>

<p>            if (categoryId == 0)</p>

<p>                command.CommandText = &ldquo;SELECT * FROM Products&rdquo;;</p>

<p>            else</p>

<p>            {</p>

<p>                command.CommandText = &ldquo;SELECT * FROM Products WHERE
CategoryId = @categoryId&rdquo;;</p>

<p>                command.Parameters.Add(new SqlParameter(&ldquo;@categoryId&rdquo;,
categoryId));</p>

<p>            }</p>

<p> </p>

<p>            command.Connection = connection;</p>

<p>            connection.Open();</p>

<p> </p>

<p>            using(var reader =
command.ExecuteReader(CommandBehavior.CloseConnection))</p>

<p>            {</p>

<p>                while(reader.Read())</p>

<p>                {</p>

<p>                    items.Add(new SyndicationItem()</p>

<p>                    {</p>

<p>                        Id = String.Format(CultureInfo.InvariantCulture,
&ldquo;<a href="http://products/">http://products/</a>{0}&rdquo;, (int)reader[&ldquo;ProductID&rdquo;]),</p>

<p>                        Title = new
TextSyndicationContent((string)reader[&ldquo;ProductName&rdquo;]),</p>

<p>                        LastUpdatedTime = new DateTime(2008, 7, 1, 0, 0,
0, DateTimeKind.Utc),</p>

<p>                        Authors =</p>

<p>                        {</p>

<p>                            new SyndicationPerson()</p>

<p>                            {</p>

<p>                                Name = &ldquo;cibrax&rdquo;</p>

<p>                            }</p>

<p>                        },</p>

<p>                        Content = new
TextSyndicationContent(string.Format(&ldquo;Category Id {0} &ndash; Price {1}&rdquo;,</p>

<p>                            (int)reader[&ldquo;CategoryId&rdquo;],
(decimal)reader[&ldquo;UnitPrice&rdquo;]))</p>

<p>                    });</p>

<p>                }</p>

<p>            }</p>

<p>        }</p>

<p> </p>

<p>        var feed = new SyndicationFeed()</p>

<p>        {</p>

<p>            Id = &ldquo;<a href="http://Products">http://Products</a>&rdquo;,</p>

<p>            Title = new TextSyndicationContent(&ldquo;Product catalog&rdquo;),</p>

<p>            Items = items</p>

<p>        };</p>

<p> </p>

<p>        WebOperationContext.Current.OutgoingResponse.ContentType =
&ldquo;application/atom+xml&rdquo;;</p>

<p>        return feed.GetAtom10Formatter();</p>

<p>    }</p>

<p>}</p>

<p>If you are interested in knowing more details about the WebCache
behavior implementation, my friend Jesus Rodriguez has written an
<a href="http://weblogs.asp.net/gsusx/archive/2008/10/29/adding-caching-to-wcf-restful-services-using-the-rest-starter-kit.aspx">excellent
post</a>
some days ago.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/10/30/rest-and-workflow-services-play-well-together-part-ii/">REST and Workflow Services Play Well Together - Part II</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-30T00:00:00-03:00" pubdate data-updated="true">Oct 30<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/10/30/rest-and-workflow-services-play-well-together-part-ii/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my previous post <a href="http://weblogs.asp.net/cibrax/archive/2008/10/24/rest-and-workflow-services-play-well-together.aspx">&ldquo;REST and Workflow services play well
together&rdquo;</a>,
I mentioned that Http Cookies were one of the built-in mechanisms for
transferring the workflow context across calls between the client and
the service. While cookies work well for http services, from my point of
view, simple Http Headers naturally fit better in a REST architecture.
As consequence, I decided to extend the WCF channel stack to support a
new a custom channel (Or custom binding) for transferring the workflow
context as a http header.</p>

<p>The configuration of this binding WebHttpContextBinding is quite
straightforward, I just created a new binding &ldquo;WebHttpContextBinding&rdquo;
that can easily configured for workflow service,</p>

<p>&lt;services></p>

<p>  &lt;service name=&ldquo;RestWorkflows.OrderWorkflow&rdquo;></p>

<p>    &lt;endpoint address=&ldquo;&rdquo; behaviorConfiguration=&ldquo;MyServiceBehavior&rdquo;
binding=&ldquo;webHttpContext&rdquo; bindingConfiguration=&ldquo;myServiceBinding&rdquo;
contract=&ldquo;RestWorkflows.IOrderService&rdquo; /></p>

<p>  &lt;/service></p>

<p>&lt;/services></p>

<p>&lt;bindings></p>

<p>  &lt;webHttpContext></p>

<p>    &lt;binding name=&ldquo;myServiceBinding&rdquo;>&lt;/binding></p>

<p>  &lt;/webHttpContext></p>

<p>&lt;/bindings></p>

<p>&lt;behaviors></p>

<p>  &lt;endpointBehaviors></p>

<p>     &lt;behavior name=&ldquo;MyServiceBehavior&rdquo;></p>

<p>       &lt;webHttp /></p>

<p>     &lt;/behavior></p>

<p>  &lt;/endpointBehaviors></p>

<p>&lt;/behaviors></p>

<p>&lt;extensions></p>

<p>  &lt;bindingExtensions></p>

<p>    &lt;add name=&ldquo;webHttpContext&rdquo;
type=&ldquo;Microsoft.ServiceModel.Samples.WebHttpContextBindingCollectionElement,
WebHttpContext, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&rdquo;
/></p>

<p>  &lt;/bindingExtensions></p>

<p>&lt;/extensions></p>

<p>The result of using this binding will be a new Http Header WscContext
(encoded as Base64) being transmitted between the client and the
service,</p>

<p>&lt;MessageLogTraceRecord Time=&ldquo;2008-10-29T14:22:59.5258021-02:00&rdquo;
Source=&ldquo;TransportSend&rdquo;
Type=&ldquo;System.ServiceModel.Channels.BodyWriterMessage&rdquo;
xmlns=&ldquo;<a href="http://schemas.microsoft.com/2004/06/ServiceModel/Management/MessageTrace%22">http://schemas.microsoft.com/2004/06/ServiceModel/Management/MessageTrace&#8221;</a>>\
   &lt;Addressing>\
     &lt;Action>&lt;/Action>\
   &lt;/Addressing>\
   &lt;HttpResponse>\
      &lt;StatusCode>Created&lt;/StatusCode>\
      &lt;WebHeaders>     
<strong>&lt;WscContext>77u/PENvbnRleHQgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwNi8wNS9jb250ZXh0Ij48UHJvcGVydHkgbmFtZT0iaW5zdGFuY2VJZCI+NDZkZGY3NTktMzdjNS00ZDZlLWI2ZTItNjVmMDNjMDVmYTAyPC9Qcm9wZXJ0eT48L0NvbnRleHQ+&lt;/WscContext>\
</strong>       &lt;/WebHeaders>\
    &lt;/HttpResponse>\
    &lt;order
xmlns=&rdquo;<a href="http://starbucks.example.org%22/">http://starbucks.example.org&#8221;</a>
xmlns:i=&ldquo;<a href="http://www.w3.org/2001/XMLSchema-instance%22">http://www.w3.org/2001/XMLSchema-instance&#8221;</a>>\
      &lt;cost>6&lt;/cost>\
      &lt;drink>latte&lt;/drink>\
      &lt;next
xmlns:a=&rdquo;<a href="http://example.org/state-machine%22">http://example.org/state-machine&#8221;</a>>\
         &lt;a:next></p>

<p>         
&lt;a:rel><a href="http://starbucks.example.org/payment">http://starbucks.example.org/payment</a>&lt;/a:rel>\
           &lt;a:type>application/xml&lt;/a:type>\
          
&lt;a:uri><a href="http://localhost:8000/payment/order/0b756654-161b-43d0-912f-4236552dc337">http://localhost:8000/payment/order/0b756654-161b-43d0-912f-4236552dc337</a>&lt;/a:uri>\
         &lt;/a:next>\
         &lt;a:next>\
            
&lt;a:rel><a href="http://starbucks.example/order/update">http://starbucks.example/order/update</a>&lt;/a:rel>\
             &lt;a:type>application/xml&lt;/a:type>\
            
&lt;a:uri><a href="http://localhost:8000/order/0b756654-161b-43d0-912f-4236552dc337">http://localhost:8000/order/0b756654-161b-43d0-912f-4236552dc337</a>&lt;/a:uri>\
         &lt;/a:next>\
       &lt;/next>\
     &lt;/order>\
&lt;/MessageLogTraceRecord></p>

<p>&lt;MessageLogTraceRecord Time=&ldquo;2008-10-29T14:22:59.5726021-02:00&rdquo;
Source=&ldquo;TransportReceive&rdquo;
Type=&ldquo;System.ServiceModel.Channels.BufferedMessage&rdquo;
xmlns=&ldquo;<a href="http://schemas.microsoft.com/2004/06/ServiceModel/Management/MessageTrace%22">http://schemas.microsoft.com/2004/06/ServiceModel/Management/MessageTrace&#8221;</a>>\
   &lt;HttpRequest>\
      &lt;Method>PUT&lt;/Method>\
       &lt;QueryString>&lt;/QueryString>\
       &lt;WebHeaders>\
     
<strong>&lt;WscContext>77u/PENvbnRleHQgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwNi8wNS9jb250ZXh0Ij48UHJvcGVydHkgbmFtZT0iaW5zdGFuY2VJZCI+NDZkZGY3NTktMzdjNS00ZDZlLWI2ZTItNjVmMDNjMDVmYTAyPC9Qcm9wZXJ0eT48L0NvbnRleHQ+&lt;/WscContext>\
</strong>        &lt;Content-Length>566&lt;/Content-Length>\
        &lt;Content-Type>application/xml&lt;/Content-Type>\
        &lt;Expect>100-continue&lt;/Expect>\
         &lt;Host>localhost:8000&lt;/Host>\
      &lt;/WebHeaders>\
    &lt;/HttpRequest>\
    &lt;order
xmlns=&rdquo;<a href="http://starbucks.example.org%22/">http://starbucks.example.org&#8221;</a>
xmlns:i=&ldquo;<a href="http://www.w3.org/2001/XMLSchema-instance%22">http://www.w3.org/2001/XMLSchema-instance&#8221;</a>>\
          &lt;cost>6&lt;/cost>\
          &lt;drink>cappuchino&lt;/drink>\
          &lt;next
xmlns:a=&rdquo;<a href="http://example.org/state-machine%22">http://example.org/state-machine&#8221;</a>>\
            &lt;a:next>\
             
&lt;a:rel><a href="http://starbucks.example.org/payment">http://starbucks.example.org/payment</a>&lt;/a:rel>\
              &lt;a:type>application/xml&lt;/a:type>\
             
&lt;a:uri><a href="http://localhost:8000/payment/order/0b756654-161b-43d0-912f-4236552dc337">http://localhost:8000/payment/order/0b756654-161b-43d0-912f-4236552dc337</a>&lt;/a:uri>\
             &lt;/a:next>\
             &lt;a:next>\
              
&lt;a:rel><a href="http://starbucks.example/order/update">http://starbucks.example/order/update</a>&lt;/a:rel>\
               &lt;a:type>application/xml&lt;/a:type>\
              
&lt;a:uri><a href="http://localhost:8000/order/0b756654-161b-43d0-912f-4236552dc337">http://localhost:8000/order/0b756654-161b-43d0-912f-4236552dc337</a>&lt;/a:uri>\
             &lt;/a:next>\
           &lt;/next>\
       &lt;/order>\
&lt;/MessageLogTraceRecord></p>

<p>The code for the custom binding is available to download from <a href="/images/legacy/RestWorkflowsII.zip">this
location</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/10/24/rest-and-workflow-services-play-well-together/">REST and Workflow Services Play Well Together</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-24T00:00:00-03:00" pubdate data-updated="true">Oct 24<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/10/24/rest-and-workflow-services-play-well-together/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>REST is not just about CRUD interfaces for your services, a complete
long-running workflow can be modeled through the basic verbs as well. As
my friend <a href="http://weblogs.asp.net/gsusx/archive/2008/10/03/new-rest-quot-must-read-quot-papers.aspx">Jesus
mentioned</a>,
the article &ldquo;<a href="http://www.infoq.com/articles/webber-rest-workflow">How to get a cup of
coffee</a>&rdquo; represents
an excellent source about this topic.</p>

<p>The example I will show here is based on that article, during the course
of this post I will try to illustrate all the steps required to
implement a workflow as the one mentioned there using WF services.
Unfortunately, no examples exist (or at least I could not find any)
about how to configure the WCF web model to use the new WF services, so
I decided to create a new one from scratch.</p>

<p>This example only illustrates the workflow from the customer point of
view, he can place an order, pay it and wait for his drink. He can also
modify the order in the middle before it is paid.</p>

<p> <img src="/images/legacy/OrderWorkflow.jpg" alt="" /></p>

<p>The interface for our REST service will looks like this:</p>

<p>[ServiceContract]</p>

<p>public interface IOrderService</p>

<p>{</p>

<p>  [OperationContract]</p>

<p>  [WebInvoke(Method=&ldquo;POST&rdquo;, UriTemplate=&ldquo;order&rdquo;)]</p>

<p>  Order PlaceOrder(Order order);</p>

<p> </p>

<p>  [OperationContract]</p>

<p>  [WebInvoke(Method = &ldquo;PUT&rdquo;, UriTemplate = &ldquo;order/{id}&rdquo;)]</p>

<p>  Order UpdateOrder(string id, Order order);</p>

<p> </p>

<p>  [OperationContract]</p>

<p>  [WebInvoke(Method=&ldquo;PUT&rdquo;, UriTemplate=&ldquo;payment/order/{id}&rdquo;)]</p>

<p>  void PayOrder(string id, Payment payment);</p>

<p>}</p>

<p>Only three operations available, each one maps exactly with one
ReceiveActivity in the workflow. For instance, the receive activity
OnOrderPlaced waits for a client call to the PlaceOrder operation and
then moves the workflow to the next state, which is &ldquo;OrderPlaced&rdquo; in
this case. While the workflow is in the state &ldquo;OrderPlaced&rdquo;, only the
operations UpdateOrder and PayOrder can be executed by the client (If he
try to execute PlaceOrder again, it will receive a 404 http error, &ldquo;Not
found&rdquo;).</p>

<p><img src="/images/legacy/OnOrderPlaced.jpg" alt="" /></p>

<p>The OnOrderPlacedCode is an simple code activity that contains the
actual operation implementation. I used a code activity for a sake of
simplicity, a custom activity for creating the order could also be used
there.</p>

<p>The code for this activity is quite simple, most of it is hard-coded,</p>

<p>private void OnOrderPlacedCode_ExecuteCode(object sender, EventArgs e)</p>

<p>{</p>

<p>  currentOrder = new Order();</p>

<p>  currentOrder.OrderId = Guid.NewGuid().ToString();</p>

<p>  currentOrder.Cost = (receivedOrder.Drink == &ldquo;latte&rdquo;) ? 6 : 10;</p>

<p>  currentOrder.Drink = receivedOrder.Drink;</p>

<p>  currentOrder.Next = new Next[] {</p>

<p>      new Next</p>

<p>      {</p>

<p>         Rel = &ldquo;<a href="http://starbucks.example.org/payment">http://starbucks.example.org/payment</a>&rdquo;,</p>

<p>         Uri = &ldquo;<a href="http://localhost:8000/payment/order/">http://localhost:8000/payment/order/</a>&rdquo; +
currentOrder.OrderId.ToString(),</p>

<p>      },</p>

<p>      new Next</p>

<p>      {</p>

<p>         Rel = &ldquo;<a href="http://starbucks.example/order/update">http://starbucks.example/order/update</a>&rdquo;,</p>

<p>         Uri = &ldquo;<a href="http://localhost:8000/order/">http://localhost:8000/order/</a>&rdquo; +
currentOrder.OrderId.ToString()</p>

<p>      }};</p>

<p> </p>

<p>  //Persist the order in some place&hellip;..</p>

<p> </p>

<p>  WebOperationContext.Current.OutgoingResponse.StatusCode =
System.Net.HttpStatusCode.Created;</p>

<p>}</p>

<p>currentOrder contains the instance of the order that will be returned by
the service operation whereas receivedOrder is the order sent by the
client application. This was map to the operation signature in the
receive activity,</p>

<p> <img src="/images/legacy/ReceiveOrderSettings.jpg" alt="" /></p>

<p>Once the workflow is ready to be used, all we need is to configure the
service host so the client application can start consuming the
operations. At this point, we will face three issues:</p>

<p>​1. If you want to host a WF service, a WorkflowServiceHost class has to
be used in the host program. Therefore, we will not have all the
automatic infrastructure configuration provided by WebServiceHost, all
the configuration must be done manually. It would be great to have here
a combination of both service hosts.</p>

<p>​2. There is not a context binding for WebHttpBinding, only
BasicHttpContextBinding, NetTcpContextBinding and WsHttpContextBinding
are supported. We will have to use a custom binding.</p>

<p>​3. A cookie must be used to transfer the context information between
the client and the service, it would much better to have support for
http headers here. According to this <a href="http://weblogs.asp.net/gsusx/archive/2008/06/27/combining-durable-messaging-and-workflow-services-building-a-custom-context-channel.aspx">post written by
Jesus</a>,
this should not be complex to do.</p>

<p>&lt;system.serviceModel></p>

<p>  &lt;serviceHostingEnvironment aspNetCompatibilityEnabled=&ldquo;true&rdquo; /></p>

<p>  &lt;services></p>

<p>    &lt;service name=&ldquo;RestWorkflows.OrderWorkflow&rdquo;></p>

<p>     &lt;endpoint address=&ldquo;&rdquo; behaviorConfiguration=&ldquo;MyServiceBehavior&rdquo;
binding=&ldquo;customBinding&rdquo; bindingConfiguration=&ldquo;myServiceBinding&rdquo;
contract=&ldquo;RestWorkflows.IOrderService&rdquo; /></p>

<p>  &lt;/service></p>

<p>&lt;/services></p>

<p>&lt;bindings></p>

<p>&lt;customBinding></p>

<p>  &lt;binding name=&ldquo;myServiceBinding&rdquo;></p>

<p>  &lt;webMessageEncoding>&lt;/webMessageEncoding></p>

<p>  &lt;context contextExchangeMechanism=&ldquo;HttpCookie&rdquo;
protectionLevel=&ldquo;None&rdquo;/></p>

<p>  &lt;httpTransport manualAddressing=&ldquo;true&rdquo;/></p>

<p>  &lt;/binding></p>

<p>&lt;/customBinding></p>

<p>&lt;/bindings></p>

<p>&lt;behaviors></p>

<p>&lt;endpointBehaviors></p>

<p>  &lt;behavior name=&ldquo;MyServiceBehavior&rdquo;></p>

<p>    &lt;webHttp /></p>

<p>  &lt;/behavior></p>

<p>&lt;/endpointBehaviors></p>

<p>&lt;/behaviors></p>

<p>&lt;/system.serviceModel></p>

<p>The code for the client application looks also quite simple, you only
have to remember to include the cookie with the context between calls,
otherwise WF will try to create a new instance of the workflow resulting
in a bad request error.</p>

<p>//Lets create a new order</p>

<p>Order order = new Order { Drink = &ldquo;latte&rdquo; };</p>

<p> </p>

<p>HttpWebRequest createOrderRequest = CreateRequest(new
Uri(&ldquo;<a href="http://localhost:8000/order">http://localhost:8000/order</a>&rdquo;), &ldquo;POST&rdquo;, null, order);</p>

<p>string context =
GetContext((HttpWebResponse)createOrderRequest.GetResponse());</p>

<p>order = Execute&lt;Order>(createOrderRequest.GetResponse());</p>

<p> </p>

<p>Console.WriteLine(&ldquo;Order Cost {0}&rdquo;, order.Cost);</p>

<p>foreach (Next next in order.Next)</p>

<p>{</p>

<p>  Console.WriteLine(&ldquo;Possible next step {0}&rdquo;, next.Uri);</p>

<p>}</p>

<p> </p>

<p>//Lets update the existing order&hellip;.</p>

<p>order.Drink = &ldquo;cappuchino&rdquo;;</p>

<p> </p>

<p>Uri updateOrderUri = new Uri(order.Next.Where(n => n.Rel ==
&ldquo;<a href="http://starbucks.example/order/update">http://starbucks.example/order/update</a>&rdquo;).Single().Uri);</p>

<p>HttpWebRequest updateOrderRequest = CreateRequest(updateOrderUri, &ldquo;PUT&rdquo;,
context, order);</p>

<p>Order updatedOrder = Execute&lt;Order>(updateOrderRequest.GetResponse());</p>

<p> </p>

<p>Console.WriteLine(&ldquo;Order Cost {0}&rdquo;, updatedOrder.Cost);</p>

<p>foreach (Next next in updatedOrder.Next)</p>

<p>{</p>

<p>  Console.WriteLine(&ldquo;Possible next step {0}&rdquo;, next.Uri);</p>

<p>}</p>

<p> </p>

<p>//Lets have our drink&hellip;</p>

<p>Payment payment = new Payment { Name = &ldquo;John Doe&rdquo;, CardNumber =
&ldquo;1234567&rdquo;, Expires = &ldquo;06/08&rdquo;, Amount =
updatedOrder.Cost.GetValueOrDefault() };</p>

<p> </p>

<p>Uri payOrderUri = new Uri(order.Next.Where(n => n.Rel ==
&ldquo;<a href="http://starbucks.example.org/payment">http://starbucks.example.org/payment</a>&rdquo;).Single().Uri);</p>

<p>HttpWebRequest payOrderRequest = CreateRequest(payOrderUri, &ldquo;PUT&rdquo;,
context, payment);</p>

<p> </p>

<p>int statusCode = Execute(payOrderRequest.GetResponse());</p>

<p> </p>

<p>if (statusCode == 201)</p>

<p>  Console.WriteLine(&ldquo;Here is your drink!!!&rdquo;);</p>

<p>else</p>

<p>  Console.WriteLine(&ldquo;Sorry, there was some error while trying to process
the payment&rdquo;);</p>

<p>As you can see in the code above, I used some helper methods to execute
the operations and retrieve the response/context information. These
methods only represent a few lines of code,</p>

<p>static HttpWebRequest CreateRequest(Uri address, string method, string
context, object contract)</p>

<p>{</p>

<p>  HttpWebRequest webRequest =
(HttpWebRequest)WebRequest.Create(address);</p>

<p>  webRequest.ContentType = &ldquo;application/xml&rdquo;;</p>

<p>  webRequest.Timeout = 30000;</p>

<p>  webRequest.Method = method;</p>

<p>  webRequest.CookieContainer = new CookieContainer();</p>

<p> </p>

<p>  if (context != null)</p>

<p>  {</p>

<p>    Cookie cookie = new Cookie(&ldquo;WscContext&rdquo;, context,
address.PathAndQuery, address.Authority);</p>

<p>    webRequest.CookieContainer.Add(cookie);</p>

<p>  }</p>

<p> </p>

<p>  DataContractSerializer serializer = new
DataContractSerializer(contract.GetType());</p>

<p>  using (Stream stream = webRequest.GetRequestStream())</p>

<p>  {</p>

<p>    serializer.WriteObject(stream, contract);</p>

<p>    stream.Flush();</p>

<p>  }</p>

<p> </p>

<p>  return webRequest;</p>

<p>}</p>

<p> </p>

<p>static string GetContext(HttpWebResponse response)</p>

<p>{</p>

<p>  if (response.Cookies[&ldquo;WscContext&rdquo;] != null)</p>

<p>  {</p>

<p>    return response.Cookies[&ldquo;WscContext&rdquo;].Value;</p>

<p>  }</p>

<p> </p>

<p>  return null;</p>

<p>}</p>

<p> </p>

<p>static T Execute&lt;T>(WebResponse response)</p>

<p>{</p>

<p>  DataContractSerializer serializer = new
DataContractSerializer(typeof(T));</p>

<p>  using (Stream stream = response.GetResponseStream())</p>

<p>  {</p>

<p>    return (T)serializer.ReadObject(stream);   </p>

<p>  }</p>

<p>}</p>

<p>The complete solution is available to download from
<a href="/images/legacy/RestWorkflows.zip">here</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/10/06/importance-of-conditional-gets-in-rest/">Conditional Gets in REST</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-06T00:00:00-03:00" pubdate data-updated="true">Oct 6<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/10/06/importance-of-conditional-gets-in-rest/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>According to the Http specification, any Http GET request should be
idempotent and safe. In this context, these principles have the
following meaning:</p>

<p>Idempotence: One or more calls with identical requests should return the
same resource representation (As long as the resource has not changed on
the server between calls).</p>

<p>Safety:  The only action produced by a GET request is to retrieve a
resource representation, no side-effects should be evident on the
service side after executing the request. An example that violates this
principle could be a GET request that also updates some info in the
resource.</p>

<p>As long as these principles are applied correctly by a service
implementation, the client will have more available mechanisms to cache
the resource representation on its side. This has a very positive
meaning from a scalability view point, which represents a better use of
the network bandwidth and an optimization in the utilization of server
resources.</p>

<p>Those caching mechanisms are based on what is commonly called Http
conditional gets. An Http conditional get involves the use of two
special headers generated by the service, ETag and Last-Modified.</p>

<p>An Etag represents an opaque value that only the server knows how to
recreate, it could represent anything, but it is usually a hash
representing the resource version (it can be generated hashing the whole
representation content or just some parts of it, like the timestamp). On
the other hand, the Last-Modified headers represents a datetime that the
service can use to determine whether the resource has changed since the
last time it was served. The following example illustrates the
request/response messages interchanged by the client/service for a
service that returns information about customers</p>

<p>First request, the client does not have anything on the cache.</p>

<p>GET <a href="http://foo/customers/1">http://foo/customers/1</a></p>

<p>Host foo\
Accept */*\
Accept-Language en-us,en;q=0.5\
Accept-Encoding gzip,deflate\
Accept-Charset ISO-8859-1,utf-8;q=0.7,*;q=0.7\
Connection close\
Referer <a href="http://foo/">http://foo/</a>\
Pragma no-cache\
Cache-Control no-cache</p>

<p>Response:</p>

<p>Connection close\
Date Thu, 02 Oct 2008 14:46:57 GMT\
Server Microsoft-IIS/6.0\
X-Powered-By ASP.NET\
X-AspNet-Version 2.0.50727\
Content-Encoding gzip\
Content-Length 1212\
Expires Sat, 01 Nov 2008 14:46:57 GMT\
<strong>Last-Modified Mon, 29 Sep 2008 15:40:27 GMT\
Etag a9331828c517ac5d97f93b3cfdbcc9bc</strong>\
Content-Type text/xml</p>

<p>The next time the client sends a new request for the same customer, some
extra information will be included in the request headers,</p>

<p>GET <a href="http://foo/customers/1">http://foo/customers/1</a></p>

<p>Host foo\
Accept */*\
Accept-Language en-us,en;q=0.5\
Accept-Encoding gzip,deflate\
Accept-Charset ISO-8859-1,utf-8;q=0.7,*;q=0.7\
Connection close\
Referer foo\
<strong>If-Modified-Since Mon, 29 Sep 2008 15:40:27 GMT\
If-None-Match a9331828c517ac5d97f93b3cfdbcc9bc\
</strong></p>

<p>With these two new headers, the service can now determine whether it has
to serve the resource representation again or the client can use the
cached version. If the resource has not changed according to the values
in those headers (If-Modified-Since for Last-Modified and If-None-Match
for Etag), the service can return an Http status code &ldquo;304 Not
Modified&rdquo;, which instructs the client to use the cached version.</p>

<p>This approach is widely used nowadays by syndication, RSS or Atom, that
usually use the Last-Modified/If-Modified-Since to determine which items
they have to send to the client.</p>

<p>Since I am a WCF fan, I will also include here some code snippets to get
the value in those headers and return a &ldquo;304&rdquo; http status code,</p>

<p>Code to get those values:</p>

<p>if
(WebOperationContext.IncomingRequest.Headers[HttpRequestHeader.IfNoneMatch]
!= null)</p>

<p>{</p>

<p>  // Do something with etag&hellip;</p>

<p>}</p>

<p>else if
(WebOperationContext.IncomingRequest.Headers[HttpRequestHeader.IfModifiedSince]
!= null)</p>

<p>{</p>

<p>  var date =
DateTime.Parse(context.IncomingRequest.Headers[HttpRequestHeader.IfModifiedSince]);</p>

<p>}</p>

<p> </p>

<p>Code to set those values:</p>

<p> </p>

<p>WebOperationContext.OutgoingResponse.LastModified = // sets the last
modified;</p>

<p>WebOperationContext.OutgoingResponse.ETag = // sets the Etag</p>

<p>Code to return an Http 304 status code:</p>

<p>WebOperationContext.OutgoingResponse.StatusCode =
HttpStatusCode.NotModified;</p>

<p>WebOperationContext.OutgoingResponse.SuppressEntityBody = true;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/09/12/codecamp-buenos-aires-2008/">Codecamp Buenos Aires 2008</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-12T00:00:00-03:00" pubdate data-updated="true">Sep 12<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/09/12/codecamp-buenos-aires-2008/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The next Microsoft Codecamp will take place in Buenos Aires on Saturday,
October 4th.</p>

<p>The agenda looks very promising, be sure to register if you want to
attend! (The complete agenda is available in the <a href="http://blogs.msdn.com/masaez/">Miguel Saenz&rsquo;s
blog</a> , almost 10 sessions in parallel,
WOW)</p>

<p>I will be presenting an introductory session about the ASP.NET MVC
framework and another a little more interesting about building RESTfull
services with WCF. </p>

<p>I hope to see there !!. Thanks</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/18/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/16/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/01/31/making-ajax-calls-with-hawk-authentication-to-asp-dot-net-web-api/">Making Ajax Calls With Hawk Authentication to ASP.NET Web API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/13/coordinating-async-work-in-node-dot-js/">Coordinating Async Work in Node.js</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/27/oauth-bridge-for-adfs-with-thinkteckture-authorization-server/">OAuth Bridge for ADFS With ThinkTecture Authorization Server</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/22/automatic-client-cert-detection-in-adfs-2-dot-0/">Automatic Client Cert Detection in ADFS 2.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/21/injecting-dynamic-content-in-windows-azure-package/">Injecting Dynamic Content in Windows Azure Packages</a>
      </li>
    
  </ul>
</section>
 <a href="http://feeds.feedburner.com/cibrax"><img src="http://feeds.feedburner.com/~fc/cibrax?bg=FF3300&amp;fg=000000&amp;anim=0" style="border:0" alt="" /></a>

 <script type="text/javascript" language="javascript" src="http://twittercounter.com/embed/?username=cibrax&style=white"></script>
<a href="https://mvp.microsoft.com/en-us/mvp/Pablo%20Cibraro-33800"><img src="/images/mvp.gif" border="0" /></a>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pcibraro">@pcibraro</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pcibraro',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Cibrax -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cibrax';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
