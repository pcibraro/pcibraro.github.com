
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pablo Cibraro (Cibrax)</title>
  <meta name="author" content="Cibrax">

  
  <meta name="description" content="The &ldquo;WS-I Basic Security Profile Sample Application&rdquo; preview for WSE
3.0 is out, you can get it in the GDN
workspace.\
This sample &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cibrax.me/blog/page/26">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/cibrax" rel="alternate" title="Pablo Cibraro (Cibrax)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44468149-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pablo Cibraro (Cibrax)</a></h1>
  
    <h2>All about software development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/cibrax" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cibrax.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/07/19/419921/">WS-I BSP Sample Application for WSE 3</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-07-19T00:00:00-03:00" pubdate data-updated="true">Jul 19<span>th</span>, 2005</time>
        
         | <a href="/blog/2005/07/19/419921/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The <strong>&ldquo;WS-I Basic Security Profile Sample Application&rdquo;</strong> preview for WSE
3.0 is out, you can get it in the <a href="http://practices.gotdotnet.com/projects/wsibsp">GDN
workspace</a>.\
This sample illustrates how to build secure and interoperable web
services based in the specification <a href="http://www.ws-i.org/Profiles/BasicProfile-1.1-2004-08-24.html">WS-I Basic Profile
1.1</a>. \
When we started to develop this application, we faced some challenges,
all of them related to the new policy framework shipped in WSE 3.0. \
Some parts of the policies used by the previous version of this
application weren&rsquo;t easy to migrate, so we had to develop some custom
assertions.\
In this post, I will give a brief description about the new WSE &ldquo;Policy
framework&rdquo;, and the custom assertion shipped in this preview.
(CustomX509Assertion)</p>

<h3>Policy framework</h3>

<p><img src="/images/legacy/ArchitectureWSE.gif" alt="" />\
\
<strong>Policies</strong>\
\
A policy allows to apply different claims for incoming and outgoing
messages on the client and the service (All messages to a particular
endpoint).\
It is used to describe the requirements for a service and as a factory
for runtime objects &ndash; Pipeline and Assertions. \
As you can see in the image, the policy is converted in a pipeline at
runtime. This pipeline contains an ordered list of assertions, \
each assertion performs different message transformations through the
use of Filters. \
\
Policy definition sample: \</p>

<p>&lt;policies>\
  &lt;extensions>\
    &lt;extension name=&ldquo;mutualX509Security&rdquo;
type=&ldquo;Microsoft.Web.Services3.Design.MutualX509Assertion,
Microsoft.Web.Services3, Version=3.0.0.0, Culture=neutral,
PublicKeyToken=31bf3856ad364e35&rdquo; />\
    &lt;extension name=&ldquo;x509&rdquo;
type=&ldquo;Microsoft.Web.Services3.Design.X509TokenProvider,
Microsoft.Web.Services3, Version=3.0.0.0, Culture=neutral,
PublicKeyToken=31bf3856ad364e35&rdquo; />\
  &lt;/extensions>\
  &lt;policy name=&ldquo;MyPolicy&rdquo;>\
    &lt;mutualX509Security establishSecurityContext=&ldquo;false&rdquo;
renewExpiredSecurityContext=&ldquo;true&rdquo; signatureConfirmation=&ldquo;true&rdquo;
protectionOrder=&ldquo;SignBeforeEncryptingAndEncryptSignature&rdquo;
deriveKeys=&ldquo;true&rdquo; actor=&ldquo;&rdquo;>\
      &lt;clientToken>\
        &lt;x509 storeLocation=&ldquo;CurrentUser&rdquo; storeName=&ldquo;My&rdquo;
findValue=&ldquo;CN=WSE2QuickStartClient&rdquo;
findType=&ldquo;FindBySubjectDistinguishedName&rdquo; />\
      &lt;/clientToken>\
      &lt;serviceToken>\
        &lt;x509 storeLocation=&ldquo;CurrentUser&rdquo; storeName=&ldquo;AddressBook&rdquo;
findValue=&ldquo;CN=WSE2QuickStartServer&rdquo;
findType=&ldquo;FindBySubjectDistinguishedName&rdquo; />\
      &lt;/serviceToken>\
      &lt;protection>\
        &lt;request signatureOptions=&ldquo;IncludeAddressing, IncludeTimestamp,
IncludeSoapBody&rdquo; encryptBody=&ldquo;true&rdquo; />\
        &lt;response signatureOptions=&ldquo;IncludeAddressing,
IncludeTimestamp, IncludeSoapBody&rdquo; encryptBody=&ldquo;true&rdquo; />\
        &lt;fault signatureOptions=&ldquo;IncludeAddressing, IncludeTimestamp,
IncludeSoapBody&rdquo; encryptBody=&ldquo;false&rdquo; />\
      &lt;/protection>\
    &lt;/mutualX509Security>\
  &lt;/policy>\
&lt;/policies>\
\</p>

<p>In this case, the policy specifies security requirements for the
service. ( Some parts of the message should be encrypted and signed with
X509 certificates) \
\
A policy can be assigned to a proxy or a service using a declarative or
imperative way. The following examples show how to assign a policy \
to a proxy and a service:\
\
<strong>Client proxy with PolicyAttribute:</strong> \
\</p>

<p>[PolicyAttribute(&ldquo;MyPolicy&rdquo;)]\
public partial class MyService :
Microsoft.Web.Services3.WebServicesClientProtocol \
{\
  public string HelloWorld() {\
    object[] results = this.Invoke(&ldquo;HelloWorld&rdquo;, new object[0]);\
    return ((string)(results[0]));\
  }\
}\</p>

<p>\
<strong>Imperative use of policy on the client</strong> \
\</p>

<p>MyService service = new MyService();\
service.SetPolicy(&ldquo;MyPolicy&rdquo;);</p>

<p>\
<strong>Web Service with PolicyAttribute:</strong> \
\</p>

<p>[PolicyAttribute(&ldquo;MyPolicy&rdquo;)]\
public class MyService : System.Web.Services.WebService \
{\
  [WebMethod]\
  public string HelloWorld() {\
    return &ldquo;Hello world&rdquo;;\
  }\
}\</p>

<p>\
<strong>Assertions</strong>\
\
An assertion uses filters to perform message processing in different
stages. Each assertion is capable of creating up to four soap filters: \
\</p>

<p><strong>ClientOutputFilter:</strong> for outgoing messages on the client</p>

<p><strong>ClientInputFilter:</strong> for incoming messages on the client</p>

<p><strong>ServiceOutputFilter:</strong> for outgoing messages on the service</p>

<p><strong>ServiceInputFilter:</strong> for incoming messages on the service \
\
An assertion may not create a filter in one of the four locations. In
that case, this assertion does not affect message processing in this
location.\
For example, a security assertion could use the output stages to protect
a soap document, and the input stages to validate that protection \
\
<strong>Assertion code sample :</strong> \
\</p>

<p>class MyAssertion : PolicyAssertion\
{\
  public override SoapFilter
CreateClientInputFilter(FilterCreationContext context)\
  {\
    return null;\
   }\
\
   public override SoapFilter
CreateClientOutputFilter(FilterCreationContext context)\
   {\
     return null;\
   }\
\
   public override SoapFilter
CreateServiceInputFilter(FilterCreationContext context)\
   {\
     return null;\
   }\
\
   public override SoapFilter
CreateServiceOutputFilter(FilterCreationContext context)\
   {\
     return null;\
   }\
}\</p>

<p>\
This assertion does not return any filter, it is useless in a real
scenario. \
\
WSE includes the following list of assertions:\
\</p>

<hr />

<p>  AnonymousOverCertificateAssertion                 The client is not authenticated and the security protection is via a server&rsquo;s X.509 certificate
  CertificateMutualAuthenticationProfileAssertion   X.509 certificates are used for authentication and message protection. It doesn&rsquo;t use the WS-Security 1.1 extensions
  KerberosAssertion                                 Kerberos tickets are used for authentication and message protection
  MutualCertificateAssertion                        X.509 certificates are used for authentication and message protection. It uses the WS-Security 1.1 extensions
  UsernameOverCertificateAssertion                  The client is authenticated via a suplied &ldquo;UsernameToken&rdquo; ( user and password ) and the security protection is performed by a X.509 certificate
  UsernameOverTransportAssertion                    The client is authenticated via a supplied &ldquo;UsernameToken&rdquo; and the security protection is performed at the transport level
  AuthorizationAssertion                            It performs authorization checks using the identity token. The identity token is determined after the client authentication</p>

<hr />

<p>\
<strong>Filters</strong>\
\
Soap filters use lower level mechanisms to perform different message
processing tasks. For example, a security filter could use signatures
and encryption tokens to protect a message.\
All filters inherit from the base class &ldquo;SoapFilter&rdquo; and implement the
abstract method &ldquo;ProcessMessage&rdquo;. \
\</p>

<p>public abstract class SoapFilter\
{\
  protected SoapFilter();\
  public virtual T GetBehavior();\
  public abstract SoapFilterResult ProcessMessage(SoapEnvelope
envelope);\
}</p>

<p>\
That method returns a &ldquo;SoapFilterResult&rdquo; class, which is used to control
the pipeline execution. It can take the following values:\
\</p>

<p>Continue: To keep executing the next filters in the pipeline</p>

<p>Terminate: To terminate the pipeline execution\
\
WSE also includes the classes &ldquo;SendSecurityFilter&rdquo; and
&ldquo;ReceiveSecurityFitler&rdquo; to build security filters. These classes inherit
from &ldquo;SoapFilter&rdquo;, but they implement the &ldquo;ProcessMessage&rdquo; method in
order to parse the security headers included in the soap document. \
\</p>

<p>public abstract class SendSecurityFilter : SoapFilter\
{\
  protected abstract void SecureMessage(SoapEnvelope envelope, Security
security);\
} \
\
public abstract class SendSecurityFilter : SoapFilter\
{\
  protected abstract void ValidateMessageSecurity(SoapEnvelope envelope,
Security security);\
}</p>

<h3>Custom Security Assertion</h3>

<p>The &ldquo;MutualCertificateAssertion&rdquo; did not solve some security aspects
required \
by the application, so we had to develop a custom security assertion (
&ldquo;X509CustomSecurityAssertion&rdquo; ) \
This assertion allows us to fulfill the following requeriments: \
\
1. Sign and encrypt the messages with different X509 certificates ( One
certificate to sign the message and \
another to encrypt it ). The &ldquo;MutualCertificateAssertion&rdquo; assertion only
signs and encrypts the messages with a key derived from\
the same certificate.\
2. Different certificates for requests and responses. The
&ldquo;MutualCertificateAssertion&rdquo; does not allow to specify that\
3. Custom headers encryption. The &ldquo;MutualCertificateAssertion&rdquo; only
signs custom headers, but it does not encrypt them.\
4. Different protection order for the request and response. The
&ldquo;MutualCertificateAssertion&rdquo; specifies the same protection order\
for the request and the response ( Protection order =
SignBeforeEncryptingAndEncryptSignature, SignBeforeEncrypting,
EncryptBeforeSigning).\
\
This policy is used by client application to consume the Retailer
services:\</p>

<p>&lt;policy name=&ldquo;RetailerServices&rdquo;>\
  &lt;customX509Security actor=&ldquo;&rdquo;>\
    <strong>&lt;request></strong>\
      &lt;clientToken>\
        &lt;!&mdash; WebClient Signing Certificate &mdash;>\
        &lt;x509 storeLocation=&ldquo;LocalMachine&rdquo; storeName=&ldquo;My&rdquo;
findValue=&ldquo;8d5f67d8991bc6517785b3266a333fb871cf2c6f&rdquo;
findType=&ldquo;FindBySubjectKeyIdentifier&rdquo; />\
      &lt;/clientToken>\
      &lt;serviceToken>\
        &lt;!&mdash; Retailer Encrypting Certificate &mdash;>\
        &lt;x509 storeLocation=&ldquo;LocalMachine&rdquo; storeName=&ldquo;My&rdquo;
findValue=&ldquo;944e5a12f31f6f8456ae6ad479581792af15eb6b&rdquo;
findType=&ldquo;FindBySubjectKeyIdentifier&rdquo; />\
      &lt;/serviceToken>\
    <strong>&lt;/request></strong>\
    <strong>&lt;response></strong>\
      &lt;clientToken>\
        &lt;!&mdash;Retailer Signing Certificate&mdash;> \
        &lt;x509 storeLocation=&ldquo;LocalMachine&rdquo; storeName=&ldquo;My&rdquo;
findValue=&ldquo;4cd379e9caff8759da99b17c85ffa15b66c60dcb&rdquo;
findType=&ldquo;FindBySubjectKeyIdentifier&rdquo; />\
      &lt;/clientToken>\
      &lt;serviceToken>\
        &lt;!&mdash; WebClient Encrypting Certificate &mdash;>\
        &lt;x509 storeLocation=&ldquo;LocalMachine&rdquo; storeName=&ldquo;My&rdquo;
findValue=&ldquo;399cb4ee8d3339c36618f667dfa03183948f145c&rdquo;
findType=&ldquo;FindBySubjectKeyIdentifier&rdquo; />\
      &lt;/serviceToken>\
    <strong>&lt;/response></strong>\
    &lt;!&mdash; getCatalog &mdash;>\
    &lt;protection requestAction=&ldquo;getCatalog&rdquo;>\
      &lt;request signatureOptions=&ldquo;IncludeAddressing, IncludeTimestamp,
IncludeSoapBody&rdquo; encryptBody=&ldquo;false&rdquo;
<strong>protectionOrder=&ldquo;SignBeforeEncrypting&rdquo;</strong>>\
        <strong>&lt;customHeader name=&ldquo;UsernameToken&rdquo;
ns=&ldquo;<a href="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd">http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd</a>&rdquo;
signed=&ldquo;true&rdquo; encrypted=&ldquo;false&rdquo;>&lt;/customHeader></strong>\
      &lt;/request>\
      &lt;response signatureOptions=&ldquo;IncludeTimestamp, IncludeSoapBody&rdquo;
encryptBody=&ldquo;true&rdquo;
<strong>protectionOrder=&ldquo;SignBeforeEncryptingAndEncryptSignature&rdquo;</strong> />\
    &lt;/protection>\
    &lt;!&mdash; submitOrder &mdash;>\
    &lt;protection requestAction=&ldquo;submitOrder&rdquo;>\
      &lt;request signatureOptions=&ldquo;IncludeAddressing, IncludeTimestamp,
IncludeSoapBody&rdquo; encryptBody=&ldquo;true&rdquo;
<strong>protectionOrder=&ldquo;SignBeforeEncryptingAndEncryptSignature&rdquo;</strong>>\
        <strong>&lt;customHeader name=&ldquo;Configuration&rdquo;
ns=&ldquo;<a href="http://www.ws-i.org/SampleApplications/SupplyChainManagement/2002-08/Configuration.xsd">http://www.ws-i.org/SampleApplications/SupplyChainManagement/2002-08/Configuration.xsd</a>&rdquo;
signed=&ldquo;true&rdquo; encrypted=&ldquo;false&rdquo;>&lt;/customHeader></strong>\
        <strong>&lt;customHeader name=&ldquo;UsernameToken&rdquo;
ns=&ldquo;<a href="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd">http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd</a>&rdquo;
signed=&ldquo;true&rdquo; encrypted=&ldquo;true&rdquo;>&lt;/customHeader></strong>\
      &lt;/request>\
      &lt;response signatureOptions=&ldquo;IncludeTimestamp, IncludeSoapBody&rdquo;
encryptBody=&ldquo;true&rdquo;
<strong>protectionOrder=&ldquo;SignBeforeEncryptingAndEncryptSignature&rdquo;</strong> />\
    &lt;/protection>\
  &lt;/customX509Security>\
&lt;/policy></p>

<p>\
Many changes were introduced to the policy. It supports different X509
certificates for requests and responses (&ldquo;Request&rdquo; and &ldquo;Response&rdquo;
elements ).\
Also, it specifies different protection requirements for custom headers
and different protection order for each message. \
\
If you are interested to build secure and interoperable web services,
then you should look this application, it is a good starting point.\
That is all for now, I will blog more about WSE and WSI soon.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/06/23/414787/">Creating a Virtual Directory With ASP.NET 2.0 Support</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-06-23T00:00:00-03:00" pubdate data-updated="true">Jun 23<span>rd</span>, 2005</time>
        
         | <a href="/blog/2005/06/23/414787/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This script is helpful when you have different versions of the .NET
framework running in your computer and you need to setup a virtual
directory in IIS targeting one of them.\
If you have the versions 1.1 and 2.0, when you create a virtual
directory in IIS, it takes a version by default, usually 1.1.</p>

<p>The script is very simple, it creates a virtual directory using WMI and
then it uses the tool &ldquo;aspnet_regiis.exe&rdquo; to setup the .NET framework
scriptmaps.</p>

<p><strong>Note</strong>: It is using the version 2.0, you should change the following
line to use another version:</p>

<p>netPath = fso.BuildPath( winPath, &ldquo;Microsoft.NET\Framework\v2.0.50215&rdquo;
)</p>

<p>The script looks as follow:</p>

<p>Sub CreateWebFolder( folderPath, folderName, createApp )\
   Dim vRoot, vDir, tempDir\
\
   Set vRoot = GetObject(&ldquo;IIS://localhost/W3svc/1/Root&rdquo; )\
\
   On Error Resume Next\
   Set vDir = GetObject( &ldquo;IIS://localhost/W3svc/1/Root/&rdquo; + folderName )\
\
   If( vDir is Nothing ) Then\
      Set vDir = vRoot.Create(&ldquo;IIsWebVirtualDir&rdquo;, folderName)\
   End If\
\
   vDir.AccessRead = true\
   vDir.Path = folderPath\
   vDir.AuthFlags = 5\
\
   vDir.DirBrowseFlags = &amp;H4000003E\
\
   vDir.EnableDirBrowsing = False\
   If createApp then vDir.AppCreate( true )\
   vDir.AccessScript = True\
\
   vDir.SetInfo\
\
   UpdateScriptMaps folderName\
End Sub\
\
Sub UpdateScriptMaps( folderName )\
\
   Dim winPath, netPath, toolPath\
   Dim wsShell\
   Dim fso\
\
   Set wsShell = CreateObject(&ldquo;WScript.Shell&rdquo;)\
   Set fso = CreateObject(&ldquo;Scripting.FileSystemObject&rdquo;)\
\
   winPath = wsShell.ExpandEnvironmentStrings( &ldquo;%windir%&rdquo; )\
   netPath = fso.BuildPath( winPath,
&ldquo;Microsoft.NET\Framework\v2.0.50215&rdquo; )\
   toolPath = fso.BuildPath( netPath, &ldquo;aspnet_regiis.exe&rdquo; )\
\
   wsShell.Run toolPath &amp; &ldquo; -sn W3SVC/1/Root/&rdquo;&ldquo;&rdquo; &amp; folderName &amp; &ldquo;&rdquo;&ldquo;&rdquo;, 1,
true\
End Sub</p>

<p>The following line shows how to use this script :</p>

<p>CreateWebFolder &ldquo;c:\temp\SampleVDir&rdquo;, &ldquo;SampleVDir&rdquo;, false</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/04/22/403868/">HTTP Endpoints in SQL Server 2005</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-04-22T00:00:00-03:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2005</time>
        
         | <a href="/blog/2005/04/22/403868/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>SQL Server 2005 ( Codenamed &ldquo;Yukon&rdquo; )  provides a new interesting
feature to execute stores procedures or Transact-SQL statements through
web services published in the server, without need to use IIS.\
This new feature exposes Http endpoints using the Http Api provided in
Windows XP SP2 and Windows 2003.\
These endpoints are published in a specific URI, and they listen for
incoming soap requests, so they facilitate interoperability because any
application, which talks soap, can communicate with SQL server without
requiring additional sql libraries or MDAC.</p>

<p>The syntax to create an endpoint is quite simple, and looks like this:</p>

<p>CREATE ENDPOINT MyEndpoint\
STATE = STARTED\
AS HTTP (\
  AUTHENTICATION = (INTEGRATED),\
  PATH = &lsquo;/sql/myendpoint&rsquo;,\
  PORTS = (CLEAR) )\
FOR SOAP (\
  BATCHES = ENABLED,\
  WSDL = DEFAULT\
)\</p>

<p>In this case I created a new endpoint called MyEndpoint, which listen
for Transact-SQL statements on <a href="http://localhost/sql/myendpoint.">http://localhost/sql/myendpoint.</a> You can
test it browsing to <a href="http://localhost/sql/myendpoint?wsdl.%0AThis">http://localhost/sql/myendpoint?wsdl.
This</a> sentence supports additional parameters, all of them are very well
described in the SQL online help.\</p>

<p>This sample shows how to execute a Transact-SQL statement from a simple
java script.</p>

<p>function SendBatchRequest( strServerName, strUrlPath, strQuery )\
{\
   var objXmlHttp = null;\
   var strRequest = &ldquo;&rdquo;;\
\
   objXmlHttp = new ActiveXObject( &ldquo;microsoft.xmlhttp&rdquo; );\
   objXmlHttp.open( &ldquo;POST&rdquo;, &ldquo;<a href="http://">http://</a>&rdquo; + strServerName + strUrlPath,
false );\
   objXmlHttp.setrequestheader( &ldquo;Content-Type&rdquo;, &ldquo;text/xml&rdquo; );\
   objXmlHttp.setRequestHeader( &ldquo;Host&rdquo;, strServerName );\
\
   strRequest = &ldquo;&lt;SOAP-ENV:Envelope\
                           xmlns:SOAP-ENV=&lsquo;<a href="http://schemas.xmlsoap.org/soap/envelope/">http://schemas.xmlsoap.org/soap/envelope/</a>&rsquo;\
                           xmlns:sql=&lsquo;<a href="http://schemas.microsoft.com/sqlserver/2004/SOAP">http://schemas.microsoft.com/sqlserver/2004/SOAP</a>&rsquo;>\
                              &lt;SOAP-ENV:Body>\
                                 &lt;sql:sqlbatch>\
                                    &lt;sql:BatchCommands>&rdquo; + strQuery +
&ldquo;&lt;/sql:BatchCommands>\
                                 &lt;/sql:sqlbatch>\
                              &lt;/SOAP-ENV:Body>\
                        &lt;/SOAP-ENV:Envelope>&rdquo;;\
\
   objXmlHttp.send( strRequest );\
\
   if( objXmlHttp.status == 200 )\
      return objXmlHttp.responseXML.xml;\
   else\
      return &ldquo;&rdquo;;\
}\
\
var response = SendBatchRequest( &lsquo;localhost&rsquo;, &lsquo;/sql/myendpoint&rsquo;, &lsquo;Select
* from sys.http_endpoints&rsquo; );\</p>

<p>Actually, I&rsquo;m writing a .NET managed data provider to consume these web
services, so I&rsquo;ll be blogging a lot more about this topic soon.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/04/14/400351/">Writing Managed Custom Actions in an Easy Way</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-04-14T00:00:00-03:00" pubdate data-updated="true">Apr 14<span>th</span>, 2005</time>
        
         | <a href="/blog/2005/04/14/400351/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my last post, I talked about hosting the CRL within a native custom
action. \
This week I found an easier way to execute a managed custom action, it
is based on a hack and not extra C++ code is required.\
Actually, you can&rsquo;t write a C# custom action because the compiler
doesn&rsquo;t allow you to create a __stdcall function to be  \
called from the outside. \
Well, take a look to this
<a href="http://www.c-sharpcorner.com/Code/2003/Aug/ExportManagedCodeasUnmanaged.asp">article</a>,
it shows how to overcome that problem.</p>

<p>Let&rsquo;s use this article to write our managed custom action, I&rsquo;ll start
writing the custom action&rsquo;s skeleton:</p>

<p>using System;\
\
namespace CustomActions\
{\
    public class MyCustomAction\
    {\
        public static int Execute( long handle )\
        {\
            System.Windows.Forms.MessageBox.Show( String.Format( &ldquo;Hello
World {0}&rdquo;, handle ) );\
\
            return 0;\
\
        }\
    }\
}</p>

<p>When the installer calls to this custom action, it will show a message
box with the current msi handler number. \
As next step, you will have to read that article and do the same things,
but changing the &ldquo;SayHello&rdquo; method by &ldquo;Execute&rdquo;.\
After finishing the last article step, you will have a managed assembly,
which exports an &ldquo;Execute&rdquo; method. \
You will able to use that method as &ldquo;DllEntry&rdquo; when you define the
custom action in the custom actions table. \</p>

<p>Using wix, the custom action definition should look like this:</p>

<p>&lt;CustomAction Id=&ldquo;CustomActions&rdquo; BinaryKey=&ldquo;CustomActions&rdquo;
DllEntry=&ldquo;Execute&rdquo; /></p>

<p>I hope this can help you to develop more custom actions in an easy way
:)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/04/11/399839/">Hosting the CLR Within a Custom Action</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-04-11T00:00:00-03:00" pubdate data-updated="true">Apr 11<span>th</span>, 2005</time>
        
         | <a href="/blog/2005/04/11/399839/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today, in order to develop a custom action for a Window Installer setup,
you can choose between two options:</p>

<p>  1. Writing a Native custom action using the C language\
  2. Writing a Managed custom action using any .NET compliant language</p>

<p>Both options have different pros and cons, so I will start enumerating
some of them:</p>

<p>Native custom actions</p>

<p>  Pros:</p>

<p>    1. Access to the installer context information.\
    2. Interop code not required.</p>

<p>  Cons:</p>

<p>    1. Require some understanding of Windows programming and C language
as well.\
    2. Lack of code protection and memory management, you are
responsible to acquire and release all used resources.\
    3. Find a problem can be a nightmare, for example, a memory leak
problem.\
    4. Hard to debug.\</p>

<p>Managed custom actions</p>

<p>  Pros:</p>

<p>    1. Extremely easy to develop in any CLR compliant language.\
    2. Easy to debug and find problems.</p>

<p>  Cons:</p>

<p>    1. Inability to get context information.\
    2. Only deferred custom actions ( They run at the end, you can&rsquo;t
change any condition or property during the install ).\</p>

<h3>A new option</h3>

<p>To overcome the disadvantages of both options, the last week I developed
a native custom action which hosts the CRL Runtime and executes a
managed custom action. This solution combines the best of both worlds,
and you can get many benefits of using it. \
It contains three parts, a native custom action, a managed custom
action, and a small msi framework to be used within the managed custom
action. I will describe each one in detail next.</p>

<h3>Native custom action project</h3>

<p>The native custom action is a normal custom action written in C, which
is responsible to host the CLR runtime and call to the managed custom
action. \
Basically, this custom action contains code to do the following things:</p>

<p>​1. Loads the CLR runtime\
2. Gets the managed custom action assembly from the msi binary table\
3. Copies the assembly to the user temp folder\
4. Loads the assembly within the CLR instance\
5. Executes the managed custom action\
6. Unloads the CLR runtime\</p>

<p>You can find all this code under the CLRHosting folder. This code is
always the same, and you won&rsquo;t have to change almost anything of it,
except some parameters located in the file &ldquo;String.h&rdquo;:</p>

<p>// CLR version\
static LPCWSTR szCLRVersion = L&#8221;v1.1.4322&#8221;;\
\
// CLR flavor, workstation or server\
static LPCWSTR szCLRFlavor = L&#8221;wks&#8221;;\
\
// Application domain name\
static LPCWSTR szApplicationName = L&#8221;MsiHosting&#8221;;\
\
// Configuration file assigned to the application domain. You can attach
this file to the binary table in the msi\
static TCHAR* szApplicationConfigFile = &ldquo;MsiHosting.config&rdquo;;\
\
// Entry point of the managed custom action\
static OLECHAR FAR* szCustomActionMember = L&#8221;RunActions&#8221;;\
\
// Managed custom action assembly\
static TCHAR* szAssemblyName = &ldquo;CustomActionRuntime&rdquo;;\
\
// Managed custom action class name\
static TCHAR* szClassName = &ldquo;CustomActionRuntime.Runtime&rdquo;;\
\
// Key used to locate the assembly file within the msi binary table\
static TCHAR* szCustomActionRuntimeBinaryKey = &ldquo;CustomActionRuntime&rdquo;;\
\
// Key used to locate the configuration file within the msi binary
table\
static TCHAR* szApplicationConfigFileBinaryKey = &ldquo;MsiHostingConfig&rdquo;;</p>

<h3>Managed custom action project</h3>

<p>I wrote the project using C#, it includes the managed custom action and
a small framework to manipulate the installer context.\
You can find this code under the CustomActionRuntime folder.\
The managed custom action should be implemented in &ldquo;CustomAction.cs&rdquo;,
and usually looks like this:</p>

<p>public class CustomAction\
{\
  #region Constructors\
\
  public CustomAction()\
  {\
  }\
\
  #endregion\
\
  public void Run( InstallerContext context )\
  {\
    // TODO: do something\
  }\
}\</p>

<p>The context parameter represents a facade to the msi framework, through
this framework you can query and modify different things of the
installer context, not to mention the fact of executing dynamic SQL
query against the msi tables.</p>

<p>This sample makes use of this framework to query all available
properties, it is a useless sample, but helps to show that
functionality:</p>

<p>public class CustomAction\
{\
  #region Constructors\
\
  public CustomAction()\
  {\
  }\
\
  #endregion\
\
  public void Run( InstallerContext context )\
  {\
    View view = context.OpenView( &ldquo;SELECT * FROM Property&rdquo; );\
    RecordCollection records = view.Execute();\
\
    foreach( Record record in records )\
    {\
      foreach( Field field in record.Fields )\
      {\
       string value = field.GetString();\
      }\
    }\
\
    view.Close();\
  }\
}</p>

<h3>Using this custom action within Wix</h3>

<p>Until here I described the different parts of this solution, now I will
describe how to integrate it in your installer using Wix.\
To start I picked up a sample provided in this
<a href="http://www.tramontana.co.hu/wix/lesson3.html#custom_actions">tutorial</a>,
by the way an excellent tutorial to learn Wix.\
This sample shows how to validate a PID using a custom action, so I&rsquo;ll
modify it a little bit to use this solution.</p>

<p><strong>1. &ldquo;Including the native custom action&rdquo;</strong>\</p>

<p>Go to the custom action definition section, and replace this line :</p>

<p>&lt;CustomAction Id=&ldquo;CheckingPID&rdquo; BinaryKey=&ldquo;CheckPID&rdquo; DllEntry=&ldquo;CheckPID&rdquo;
/></p>

<p>For</p>

<p>&lt;CustomAction Id=&ldquo;CheckingPID&rdquo; BinaryKey=&ldquo;CheckPID&rdquo; DllEntry=&ldquo;Execute&rdquo;
/></p>

<p>You have to change only the DllEntry attribute, because my solution
exports a different dll entry. ( &ldquo;Execute&rdquo; instead of &ldquo;CheckPID&rdquo; )</p>

<p><strong>2. &ldquo;Modifying the binary table&rdquo;</strong>\</p>

<p>Go to the binaries definition section, and replace this line :</p>

<p>&lt;Binary Id=&ldquo;CheckPID&rdquo; src=&ldquo;Binary\CheckPID.dll&rdquo; /></p>

<p>For</p>

<p>&lt;!&mdash; Files required to run the .NET custom action &mdash;>\
&lt;!&mdash; Native custom action &mdash;>\
&lt;Binary Id=&ldquo;CheckPID&rdquo; src=&ldquo;Binary\CLRHosting.dll&rdquo; />\
\
&lt;!&mdash; Managed custom action assembly file, this key can be changed from
Strings.h &mdash;>\
&lt;Binary Id=&ldquo;CustomActionRuntime&rdquo; src=&ldquo;Binary\CustomActionRuntime.dll&rdquo;
/>\
\
&lt;!&mdash; AppDomain config file, this key can be changed from Strings.h
&mdash;>\
&lt;Binary Id=&ldquo;MsiHostingConfig&rdquo; src=&ldquo;Binary\MsiHosting.config&rdquo; />\</p>

<p>This change includes the files required to run my solution.</p>

<p><strong>3. &ldquo;Compiling the solution&rdquo;</strong>\</p>

<p>Open the &ldquo;MSIHosting.sln&rdquo; solution file with visual studio and compile
it. This compilation will produce the binary files required to run the
custom action.</p>

<p><strong>4. &ldquo;Copying the binary files&rdquo;</strong>\</p>

<p>Copy the following files to the &ldquo;Binary&rdquo; folder:\
\
CLRHosting\Debug\CLRHosting.dll\
CustomActionRuntime\bin\debug\CustomActionRuntime.dll\
CustomActionRuntime\MsiHosting.config\</p>

<p>After all these steps, you will able to compile the wix source file to
get the final msi.\
\
<a href="/images/legacy/MSIHosting.zip">Download Source Code</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/03/30/396338/">Installing a SQL Database With WIX</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-03-30T00:00:00-03:00" pubdate data-updated="true">Mar 30<span>th</span>, 2005</time>
        
         | <a href="/blog/2005/03/30/396338/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I like to share a sample about how to install a Sql database using a
custom action shipped within WIX, it is an easy task and it can be
useful in many scenarios.\
Let&rsquo;s take a look to this source file &ldquo;sql.wxs&rdquo;:</p>

<p>\</p>

<p>&lt;Wix xmlns=&lsquo;<a href="http://schemas.microsoft.com/wix/2003/01/wi">http://schemas.microsoft.com/wix/2003/01/wi</a>&rsquo;>\
  &lt;Product Name=&lsquo;SQL app 1.0&rsquo; Id=&lsquo;DB501C18-86C7-4D14-AEC0-86416A69ABDE&rsquo;
Language=&lsquo;1033&rsquo; Codepage=&lsquo;1252&rsquo;\
     Version=&lsquo;1.0.0&rsquo; Manufacturer=&lsquo;Cibrax Ltd.&rsquo;>\
            &lt;Package Id=&lsquo;????????&ndash;????&ndash;????&ndash;????&ndash;????????????&rsquo;
Keywords=&lsquo;Installer&rsquo; Description=&ldquo;SQL App 1.0 Installer&rdquo;\
              Comments=&lsquo;SQL app is a registered trademark of Cibrax
Ltd.&rsquo; Manufacturer=&lsquo;Cibrax Ltd.&rsquo; InstallerVersion=&lsquo;100&rsquo;\
              Languages=&lsquo;1033&rsquo; Compressed=&lsquo;yes&rsquo; SummaryCodepage=&lsquo;1252&rsquo;
/>\
        &lt;Media Id=&lsquo;1&rsquo; Cabinet=&lsquo;Sample.cab&rsquo; EmbedCab=&lsquo;yes&rsquo; />\
        &lt;User Id=&ldquo;MySQLUser&rdquo; Name=&ldquo;[SQLUSER]&rdquo;
Password=&ldquo;[SQLUSERPASSWORD]&rdquo;>&lt;/User>\
        &lt;Directory Id=&lsquo;TARGETDIR&rsquo; Name=&lsquo;SourceDir&rsquo;>\
            &lt;Directory Id=&lsquo;ProgramFilesFolder&rsquo; Name=&lsquo;PFiles&rsquo;>\
                &lt;Directory Id=&lsquo;INSTALLDIR&rsquo; Name=&lsquo;TestSQL&rsquo;>\
                      &lt;Component Id=&ldquo;MySqlComponent&rdquo;
Guid=&ldquo;C50999A0-02FD-42d5-9F65-7375318DD328&rdquo;>\
                        &lt;SqlDatabase Id=&ldquo;MySqlDatabase&rdquo;
Database=&ldquo;MyDatabase&rdquo; Server=&ldquo;[SQLSERVER]&rdquo; Instance=&ldquo;[SQLINSTANCE]&rdquo;\
                            CreateOnInstall=&ldquo;yes&rdquo; DropOnUninstall=&ldquo;yes&rdquo;
User=&ldquo;MySQLUser&rdquo; ContinueOnError=&ldquo;yes&rdquo;>\
                              &lt;SqlScript Id=&ldquo;CreateTables&rdquo;
ExecuteOnInstall=&ldquo;yes&rdquo; BinaryKey=&ldquo;CreateTablesBin&rdquo;>&lt;/SqlScript>\
                        &lt;/SqlDatabase>\
                      &lt;/Component>\
                &lt;/Directory>\
             &lt;/Directory>\
         &lt;/Directory>\
        &lt;Binary Id=&ldquo;CreateTablesBin&rdquo;
src=&ldquo;CreateTables.sql&rdquo;>&lt;/Binary>\
        &lt;Feature Id=&lsquo;Complete&rsquo; Level=&lsquo;1&rsquo; Description=&ldquo;Full&rdquo; Title=&ldquo;Full
Installation&rdquo;>\
            &lt;ComponentRef Id=&lsquo;MySqlComponent&rsquo; />\
        &lt;/Feature>\
    &lt;/Product>\
&lt;/Wix>\</p>

<p>I&rsquo;ll start describing the most important elements in this script:</p>

<p><strong>&lt;User></strong> \</p>

<p>It contains authentication settings necessary to sign on against the Sql
database server. \
As you can see, the user and password are properties, so you can change
them later in runtime maybe using a user dialog or custom action. Other
point to consider, you can nest this element within the component, in
that case, the installer will create a windows user account user during
the install, and we don&rsquo;t need that in this sample.</p>

<p><strong>&lt;SqlDatabase></strong> \</p>

<p>Using this element we can specify some settings required to create the
database, such as database name, server, instance and user. The user
attribute contains a reference to the existing user element, in this
case, &ldquo;MySQLUser&rdquo;. \
It supports other conditional attributes, such as CreateOnInstall,
DropUnistall and ContinueOnError. These attributes specifies what to do
during the install, uninstall and when an error occurs. \
The properties will take default values if you do not provided them, for
example, the default value for Server is “localhost”.</p>

<p><strong>&lt;SqlScript></strong> \</p>

<p>I will use this element to execute a sql script because the previous
element only creates an empty database, but in this sample, I also want
to create some empty tables within the database.\
The BinaryKey contains a reference to the script file in the Binary
table.</p>

<p>The CreateTables.sql file is a simple script to create a new table, and
looks like this:</p>

<p>CREATE TABLE [dbo].[Test] (\
    [Test_Id] [int] NOT NULL \
) ON [PRIMARY]\</p>

<p>At this point, we have a simple wix script to install a new database,
but what is next? Obviously, we need to compile this file using
&ldquo;candle.exe&rdquo; and then, &ldquo;light.exe&rdquo;. \
We will start compiling this script in a wix object file using
&ldquo;candle.exe&rdquo; ( Replace &ldquo;[Wix Path]&rdquo; with the current wix path in your
machine ):\
\</p>

<p>[Wix path]\candle.exe sql.wxs</p>

<p>If everything goes fine, you will able to find a sql.wixobj file in the
same folder than sql.wxs. \
As next step, we will use &ldquo;light.exe&rdquo; to create the final msi file.</p>

<p>[Wix path]\light.exe sql.wixobj</p>

<p>Ughh, you will get a wix linker error after running this command, but
what is wrong with the script? Well, to install a sql database, wix uses
some custom actions, which will run along the msi, and we did not
specify any of these custom actions in our script. \
Do we need to include these custom actions in our script? Not exactly,
&ldquo;light.exe&rdquo; can include them automatically when the msi is generated. \
To do that, we need to provide some extra parameters:</p>

<p>[Wix path]\light.exe -out sql.msi sql.wixobj [Wix path]\ca\sca.wixlib</p>

<p>After running this command, you will find a new sql.msi file. Now, you
can use it to install your database in any machine.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/25/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/23/selfhost-utilities/">SelfHost Utilities</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/23/appfabric-outputcaching/">AppFabric OutputCaching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/31/making-ajax-calls-with-hawk-authentication-to-asp-dot-net-web-api/">Making Ajax Calls With Hawk Authentication to ASP.NET Web API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/13/coordinating-async-work-in-node-dot-js/">Coordinating Async Work in Node.js</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/27/oauth-bridge-for-adfs-with-thinkteckture-authorization-server/">OAuth Bridge for ADFS With ThinkTecture Authorization Server</a>
      </li>
    
  </ul>
</section>
 <a href="http://feeds.feedburner.com/cibrax"><img src="http://feeds.feedburner.com/~fc/cibrax?bg=FF3300&amp;fg=000000&amp;anim=0" style="border:0" alt="" /></a>

 <script type="text/javascript" language="javascript" src="http://twittercounter.com/embed/?username=cibrax&style=white"></script>
<a href="https://mvp.microsoft.com/en-us/mvp/Pablo%20Cibraro-33800"><img src="/images/mvp.gif" border="0" /></a>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pcibraro">@pcibraro</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pcibraro',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Cibrax -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cibrax';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
