
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pablo Cibraro (Cibrax)</title>
  <meta name="author" content="Cibrax">

  
  <meta name="description" content="As my friend Jesus mentioned in the post &ldquo;Using XAML serialization in
WCF
4.0&rdquo;,
WCF 4.0 introduces a new way to implement services that &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cibrax.me/blog/page/15">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/cibrax" rel="alternate" title="Pablo Cibraro (Cibrax)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44468149-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pablo Cibraro (Cibrax)</a></h1>
  
    <h2>All about software development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/cibrax" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cibrax.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/18/contract-projections-in-wcf-declarative-services/">Contract Projections in WCF Declarative Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-18T00:00:00-03:00" pubdate data-updated="true">Feb 18<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/18/contract-projections-in-wcf-declarative-services/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As my friend Jesus mentioned in the post &ldquo;<a href="http://weblogs.asp.net/gsusx/archive/2008/12/17/using-xaml-serialization-in-wcf-4-0.aspx">Using XAML serialization in
WCF
4.0</a>&rdquo;,
WCF 4.0 introduces a new way to implement services that are totally
defined in XAML, which receive the name of &ldquo;declarative services&rdquo;. In
the past, creating a simple service involved three basic steps,</p>

<ol>
<li>Define the service contract</li>
<li>Implement the service contract</li>
<li>Host the service implementation</li>
</ol>


<p>#1 and #2 were all done in an imperative .NET programming language
such as C# or VB.NET. Today, thanks to this new feature, we will able
to define the service interface (#1) using XAML and implement the
service (#2) using a declarative workflow (XAML too).</p>

<p>This was announced as part of the Microsoft&rsquo;s Oslo modeling vision in
the last PDC.</p>

<p>Aaron Skonnard has recently written an excellent article for the MSDN,
&ldquo;WCF and WF Services in the .NET framework 4.0, and Dublin&rdquo;, where he
discusses all these new features more in detail, and the role of dublin
in that vision. Something I found interesting in that article was the
fact that he mentioned &ldquo;Contract Projections&rdquo; as part of &ldquo;declarative
services&rdquo;.</p>

<p>A contract projection allows separating the logical contract definition
from the representation of the messages that are sent or received. We
will able to have a single contract definition and specify different
messaging styles like &ldquo;SOAP&rdquo; or &ldquo;REST/POX&rdquo; using a contract projection.</p>

<p>As in the example shown in the article, a regular WCF service definition
for a calculator service made in C# would look like this,</p>

<p>~~~~ {#ctl00_mainContentContainer_ctl15 .libCScode style=&ldquo;WORD-BREAK: break-all; WORD-WRAP: break-word&rdquo; space=&ldquo;preserve&rdquo;}
[ServiceContract]
public interface ICalculator
{</p>

<pre><code>[OperationContract]
int Add(int Op1, int Op2);
[OperationContract]
int Subtract(int Op1, int Op2);
</code></pre>

<p>};
~~~~</p>

<p>The equivalent representation in XAML (using declarative services) would
look like this,</p>

<p>~~~~ {#ctl00_mainContentContainer_ctl16 .libCScode style=&ldquo;WORD-BREAK: break-all; WORD-WRAP: break-word&rdquo; space=&ldquo;preserve&rdquo;}
<ServiceContract Name="ICalculator"></p>

<pre><code>&lt;OperationContract Name="Add"&gt;
    &lt;OperationArgument Name="Op1" Type="p:Int32" /&gt;
    &lt;OperationArgument Name="Op2" Type="p:Int32" /&gt;
    &lt;OperationArgument Direction="Out" Name="res1" Type="p:Int32" /&gt;
</code></pre>

<p>   </OperationContract>
   <OperationContract Name="Subtract"></p>

<pre><code>    &lt;OperationArgument Name="Op3" Type="p:Int32" /&gt;
    &lt;OperationArgument Name="Op4" Type="p:Int32" /&gt;
    &lt;OperationArgument Direction="Out" Name="res2" Type="p:Int32" /&gt;
</code></pre>

<p>   </OperationContract>
</ServiceContract>
~~~~</p>

<p>And finally, the projection of that contract at wire level like SOAP,</p>

<p>~~~~ {#ctl00_mainContentContainer_ctl17 .libCScode style=&ldquo;WORD-BREAK: break-all; WORD-WRAP: break-word&rdquo; space=&ldquo;preserve&rdquo;}
&lt;Service.KnownProjections></p>

<pre><code>&lt;SoapContractProjection Name="ICalculatorSoapProjection"&gt;
    &lt;!-- service contract definition goes here --&gt;
&lt;/SoapContractProjection&gt;
</code></pre>

<p>&lt;/Service.KnownProjections>
~~~~</p>

<p>As you can see, we will able to have a single service implementation (or
XAML workflow), and multiple contract projections or &ldquo;KnownProjections&rdquo;
(for the different messaging styles) to get access to that service.</p>

<p>With this new feature, it looks like REST/POX will be officially
supported for consuming declarative services. (I talked in <a href="http://weblogs.asp.net/cibrax/archive/2008/10/24/rest-and-workflow-services-play-well-together.aspx">the
past</a>
about exposing workflow services with REST).</p>

<p>As part of the PDC bits (The code that was distributed in a VPC), there
is a interface &ldquo;IContractProjection&rdquo; for defining new kind of
projections,</p>

<p>public interface IContractProjection \
{ \
    // Methods \
    void ApplyEndpointBehavior(ServiceEndpoint endpoint); \
    ContractDescription GetContractDescription();</p>

<p>    // Properties \
    string ConfigurationName { get; } \
    ServiceContract Contract { get; set; } \
}</p>

<p>For the moment, there is single implementation for Soap,
&ldquo;SoapContractProjection&rdquo;. I do not know, we will see if the WCF/WF team
provide more implementations in the future.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/17/issues-to-subdivide-an-entity-framework-model/">Issues to Subdivide an Entity Framework Model</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-17T00:00:00-03:00" pubdate data-updated="true">Feb 17<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/17/issues-to-subdivide-an-entity-framework-model/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The other day, my team and I ran into some design issues while trying to
split a big Entity Framework model into smaller pieces according to
areas of functionality. At first glance, it seemed to be a common design
problem, something easy to overcome, but it did not result that way. I
could not find much information about people having the same issue
either.</p>

<p>In the system we are currently designing, we use modules or packages to
group classes that belong to the same area of functionality. As you can
guess, these modules do not represent more than a set of use cases or
stories that are tightly coupled in design time.</p>

<p>We also have, however, some classes that are common for all those
modules, so we put them in a shared module. In few words, we have a
entity model shaped like a star, being the shared module the center of
the star, and the rest of the modules just leafs.</p>

<p>The problem appeared when we tried to assign a different entity
framework model to any of these modules for persisting the classes in a
store. We could not find an easy way to reference the model with the
shared entities from the rest of them, so we gave up after a while.</p>

<p>A single model with all the entities was not an option for us, because
it simple does not scale up. We took a similar approach in the past with
another project, the result was a huge model full of entities and really
hard to maintain. This solution also required having a extra service
layer on top of the entity model to encapsulate functionality specific
to each module, which made very difficult to have a rich domain model at
first glance.</p>

<p>After a search in several blogs, I came across this post &ldquo;<a href="http://blogs.msdn.com/adonet/archive/2008/11/25/working-with-large-models-in-entity-framework-part-2.aspx">Working with
large models in entity
framework</a>&rdquo;
from the Ado team, where they discuss some possible techniques or
workarounds for an scenario like this.</p>

<p>They basically proposed the following solutions,</p>

<p>​1. Reference one conceptual model (CSDL) from another. You create
different models, and manually modify each CSDL to reference the model
(CSDL) with the shared entities.</p>

<p>The CSDL model supports a clause &ldquo;using&rdquo; for including types defined in
another model, it is basically a simple way to reuse types. This sounds
good, however, it lacks of design time experience, which makes this
feature totally useless for the scenario we have (and really complicated
to implement according to <a href="http://www.thedatafarm.com/blog/2008/11/27/CSDLsUsingConstructForBigModels.aspx">this
post</a>
written by Julie Lerman)</p>

<p>​2. Duplicate metadata for the shared entities in each conceptual model
(CSDL). Again, this approach sucks from a point of view of
maintainability, typically you will have the same problems that you
would see with duplicated code. One change in an shared entity will
require changes in every model that reference it.</p>

<p>​3. Expose foreign keys as scalar properties because you do not want to
pull in all the shared entities into every Entity model. Not a good
solution either, the shared entities get out of the unit of work or
context (ObjectContext) generated by the designer. As result, you can
not execute queries that require joins between the two contexts. Unless
you include some helper methods to retrieve the shared entities using
the scalar properties, you also lost the possibility of having a rich
domain model.</p>

<p>As you can see, we could not find any workaround that totally met our
expectations, so we might stick to the solution #2 (Duplicating the
entities). The solution #1 would be perfect with some design time
support, I hope the ado team consider this for a future release.</p>

<p>Do you have any thought or experience to share ?. I would be more than
happy to hear your feedback regarding possible solutions for this
scenario.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/10/upcoming-msdn-webcast-quot-geneva-cardspace-quot-for-latin-america/">Upcoming MSDN WebCast &quot;Geneva Cardspace&quot; for Latin America</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-10T00:00:00-03:00" pubdate data-updated="true">Feb 10<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/10/upcoming-msdn-webcast-quot-geneva-cardspace-quot-for-latin-america/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I will be presenting a MSDN webcast about &ldquo;Geneva Cardspace&rdquo; next
Thursday 12th at 2 PM (GMT-05:00 Colombia, Panama). The event will be
conducted in Spanish for all the community in Latin America. \</p>

<p>You can register to this event following <a href="http://msevents.microsoft.com/CUI/WebCastEventDetails.aspx?EventID=1032400702&amp;EventCategory=4&amp;culture=es-R&amp;CountryCode=AR">this
link</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/10/some-thoughts-on-openid-and-oauth-for-desktop-clients/">Some Thoughts on OpenID and OAuth for Desktop Clients</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-10T00:00:00-03:00" pubdate data-updated="true">Feb 10<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/10/some-thoughts-on-openid-and-oauth-for-desktop-clients/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>OpenID and OAuth are today excellent solutions for &ldquo;Single Sign On&rdquo;
(SSO)  and &ldquo;Authorization Delegation&rdquo; respectively. They are, however,
based on Http Redirections and therefore, tied to passive clients or
commonly called web browsers.</p>

<p>An interesting research was made by google some time ago, it can be
found
<a href="http://sites.google.com/site/oauthgoog/UXFedLogin/desktopapps">here</a>.
After reading that article, it looks like they could not get rid of a
browser at all :(.</p>

<p>If that does not work for you, another solution could be WS-Federation
Active Profile. </p>

<p>&ldquo;SSO&rdquo; is an inherent feature of WS-Federation, not doubt about it.</p>

<p>&ldquo;Authorization Delegation&rdquo; can also be emulated with a combination of
&ldquo;SSO&rdquo; and authorization claims. In this scenario, we always give our
credentials to an identity provider we trust, there is no need to give
away our credentials to any site or service involved in a transaction.
The authorization claims also represent fine-granular permissions of
what we are allowed to do on the service side, and again, they can
provided by identity provider itself or a resource STS. I discussed this
approach in my last post, <a href="http://weblogs.asp.net/cibrax/archive/2009/02/06/addressing-authorization-with-oauth-or-the-net-access-control-service.aspx">&ldquo;Addressing Authorization with OAuth or the
.NET Access Control
Service&rdquo;</a>,
the resource STS in this case would be the ACS service.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/06/addressing-authorization-with-oauth-or-the-net-access-control-service/">Addressing Authorization With OAuth or the .NET Access Control Service</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-06T00:00:00-03:00" pubdate data-updated="true">Feb 6<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/06/addressing-authorization-with-oauth-or-the-net-access-control-service/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>OAuth</strong></p>

<p>As I mentioned in the post, <a href="http://weblogs.asp.net/cibrax/archive/2008/11/14/oauth-channel-for-wcf-restful-services.aspx">&ldquo;OAuth Channel for REST
services&rdquo;</a>,
OAuth allows a client application to obtain user consent (as access
tokens) for executing operations over private resources on his behalf.
Resources in this context represent anything from the user that the
service provider make public through services, they could be for
instance contacts, pictures or personal information to name a few.</p>

<p>The access token that the consumer gets from the service provider
represents in some way an Access Control List that maps directly with
permissions granted by the user over his resources. For example, John
provides read/write access to his contacts on Windows Live (Service
provider) to a third party service (consumer).</p>

<p>A previous direct trust relationship must exist between the consumer and
the service provider in order to make all this happen, that relationship
in OAuth also takes the form of a Request Token. If the consumer can not
get a request token from the service provider, the user is not even
redirected to this last one for negotiating the access token.</p>

<p>As more service providers get involved in a simple scenario, more access
tokens the consumer will have to negotiate. In addition, the user should
have registered in each one of those service provider prior to use the
consumer application, unless he was  lucky enough to have Open ID
authentication in some of those services.</p>

<p><img src="/images/legacy/OAuth1.jpg" alt="" /></p>

<p><img src="/images/legacy/OAuth2.jpg" alt="" /></p>

<p>In the image above, the user is authenticated by the service provider
during the request token/access token exchange.</p>

<p><strong>.NET Access Control Service</strong></p>

<p>The Microsoft .NET Access Control Service was recently announced in the
PDC as part of the Windows Azure platform. (It was formerly part of
Biztalk services). Today, it is complemented by two other services, the
Microsoft .NET Service Bus and Microsoft .NET Workflow Service.</p>

<p>This service in addition to be a valid Secure Token Service (WS-Trust)
that can participate in the identity metasystem, it is a claim
transformer. It was conceived with the idea of mapping some input claims
(Identity claims usually) into authorization claims that represent an
ACL for the service running on the relying party.</p>

<p>The SAML token containing these output claims would be equivalent to the
access token in OAuth. </p>

<p>As we saw in OAuth, a prior trust agreement must exist between the
relying party and the .NET Access Control Service. In this case, A X509
public key for the relying party must be registered on the .NET ACL
service (for encrypting the SAML token), and the relying party must have
a X509 public key coming from the .NET ACL for verifying the token
signature. As part of this agreement, also some control rules for
mapping claims must defined  in the .NET ACL service configuration (The
.NET ACL will use the appliesTo header in the WS-Trust RST message to
determine which rules have to be used).</p>

<p>If we analyze now the scenario discussed before with OAuth, a single
consumer and multiple service providers, the client always authenticates
against the same identity provider, no matter the number of the service
providers involved, which is a pretty good thing. OAuth depends on Open
ID for getting the same effect.</p>

<p>The picture below show the complete scenario with a single relying
party,</p>

<p> <img src="/images/legacy/ACL1.jpg" alt="" /></p>

<p> </p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/05/ws-trust-profiles-and-cardspace/">WS-TRUST Profiles and Cardspace</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-05T00:00:00-03:00" pubdate data-updated="true">Feb 5<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/05/ws-trust-profiles-and-cardspace/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Geneva framework supports today the two WS-Trust profiles, Active and
Passive.</p>

<p>The active profile deals specially with applications that are able to
make soap request to any WS-Trust endpoint. On other hand, the passive
profile is for clients that are unable to emit proper SOAP (a web
browser for instance) and therefore receive the name of &ldquo;passive
requestors&rdquo;. This last one involves browser-based communication with
several http redirects between the different parties (client, STS and
relying party).</p>

<p>Cardspace embedded in a web browser page however is not a Passive
client. Once the user decides to be authenticated in a website with an
information card, the Cardspace identity selector will negotiate and get
the issue token from the identity provider using the active profile.
Finally, the identity provider will pass the token to the browser using
some Inter-Process communication, and the browser can later submit the
token to the server using an standard http mechanism like a web post.</p>

<p>As you can see, Carspace in a browser is actually an hybrid between
Active and Passive.
<a href="http://blogs.msdn.com/vbertocci/archive/2008/06/05/active-passive-and-passive-aggressive.aspx">Vittorio</a>
has also discussed this scenario in the past, he called it
&ldquo;Passive-Aggressive&rdquo;.</p>

<p> </p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/04/security-token-handlers-in-geneva-framework/">Security Token Handlers in Geneva Framework</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-04T00:00:00-03:00" pubdate data-updated="true">Feb 4<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/04/security-token-handlers-in-geneva-framework/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>According to the Geneva documentation,</p>

<p><em>&ldquo;SecurityTokenHandler defines an interface for plugging custom token
handling functionality. Using the SecurityTokenHandler you can add
functionality to serialize, de-serialize, authenticate and create and
specific kind of token&rdquo;</em></p>

<p>I can see dead people &hellip;.. :)</p>

<p><img src="/images/legacy/Six.jpg" alt="Six" /></p>

<p>Haven&rsquo;t we seen this before ? Oh, yes, I think we did. The token
managers in WSE, they are pretty much the same thing. It looks like the
Geneva team came up with a solution that worked well in the past with
WSE. One token manager for each kind of token we want to consume in our
application. If your app needs to consume a custom token or customize an
existing one, just derive the SecurityTokenHandler base class or one of
the existing SecurityTokenHandler implementations and override some of
its methods with custom functionality. For instance, the Geneva
Framework now comes with two built-in token handlers for Username
tokens, a MembershipUsernameSecurityTokenHandler for validating users
against a membership provider and a WindowsUsernameSecurityTokenHandler
for doing the same against a windows account store.</p>

<p>Most of the code we had in the past as part of authorization policies
(IAuthorizationPolicy) for mapping claims or validating tokens in a
UsernamePasswordValidator or X509CertificateValidator has now moved to
token handlers in the Geneva framework.</p>

<p>I like this way of extending a custom handler for supporting new kind of
tokens, it is quite more straightforward to me than the model currently
supported by WCF.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/04/buenos-aires-msdn-and-technet-briefing-2009/">Buenos Aires MSDN and Technet Briefing 2009</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-04T00:00:00-03:00" pubdate data-updated="true">Feb 4<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/04/buenos-aires-msdn-and-technet-briefing-2009/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I just got an email from <a href="http://blogs.msdn.com/masaez">Miguel Angel
Saenz</a> confirming the date of the next
biggest Microsoft event in Buenos Aires Argentina, &ldquo;MSDN briefing&rdquo;,
which will take place on March 25th.</p>

<p>They are now accepting proposals or suggestions for possible sessions in
the event, or to give an specific name to event itself :).</p>

<p>If you are interested in participating, check out <a href="http://www.puertadeenlace.net/">this
website</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/02/some-thoughts-on-portable-sts-p-sts-and-geneva-cardspace/">Some Thoughts on Portable STS (P-STS) and Geneva Cardspace</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-02T00:00:00-03:00" pubdate data-updated="true">Feb 2<span>nd</span>, 2009</time>
        
         | <a href="/blog/2009/02/02/some-thoughts-on-portable-sts-p-sts-and-geneva-cardspace/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The other day and friend of mine asked me about portable STS
implementations, if I knew about any available solution that he could
use on his company. That reminded me of a conversation I had like two
years ago with another developer working on custom .NET CLR framework
version for portable devices (like smartcards). As part of that project,
his team was also working on a TCP/IP communication stack for the
device, and a http handler for accepting raw WS-TRUST messages. One goal
for that project was to have a P-STS that could be interoperable with
WCF. The idea seemed very promising at time.</p>

<p>So, what is a PSTS after all ?. In a few words, it is a service running
on a portable device that exposes WS-TRUST endpoints and can issue
security tokens of any kind (e.g, SAML tokens).</p>

<p>Making a search today on
<a href="http://www.google.com.ar/search?hl=en&amp;q=Portable+Security+Token+Service">google</a>
will drop several P-STS products or solutions,  some of them also claim
to be interoperable with WCF and Microsoft Cardspace V1.</p>

<p>In terms of identity management, A P-STS really makes a great different
over existing authentication mechanisms like username/password, X509
certificates or any other kind of two-factor authentication device. Most
of these authentication mechanisms are widely accepted and used today in
applications within corporate environments or applications that requires
off-line support. However, sometimes they lack of a truly identity
support, which means that they do not represent the user identity at all
in the context of those applications, they are just a way of identifying
returning users, or they are hard to extend with additional user&rsquo;s
identity claims.</p>

<p>I can not deny that X509 certificates have demonstrated to be a very
effective and secure way to authenticate users. In addition, X509
certificates can be extended with some custom attributes, the space is
limited, but at least there is a possibility. However, X509 certificates
represent hard tokens, the claims stored on a certificate can not be
changed once it has been issued. Therefore, they are a good solution as
long as their information do not change frequently over a period of
time.</p>

<p>Issue tokens (e.g SAML tokens) on other hand are more dynamic and
cheaper to create. They usually have a short expiration time, they can
issued and used  on the fly, but what is more important, they can carry
custom information or claims about the subject it has been issued for.</p>

<p>Some good news is that the Geneva Cardspace team has also announced some
support for roaming scenarios in Cardspace V2. There will be a way to
store our identity cards on a device (or somewhere in the cloud), which
will be great to combine with a P-STS, no need to export/import the
cards anymore. This scenario was not possible in Cardspace V1, and <a href="http://blogs.msdn.com/vbertocci/archive/2008/01/27/on-the-idea-of-portable-sts-p-sts.aspx">here
is the
explanation</a>.
According to what Rich Randall mentioned in the PDC talk &ldquo;BB44 Identity:
Windows CardSpace &#8220;Geneva&rdquo; Under the Hood &ldquo;, the future Cardspace
interface could look as follow,</p>

<p> <img src="/images/legacy/Infocard.jpg" alt="" /></p>

<p> </p>

<p>As you can see, it will not be long until we have complete and portable
identity solutions for roaming scenarios.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/01/28/claims-negotiation-between-a-consumer-sts-and-relying-party-in-wcf/">Claims Negotiation Between a Consumer, STS and Relying Party in WCF</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-28T00:00:00-03:00" pubdate data-updated="true">Jan 28<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/01/28/claims-negotiation-between-a-consumer-sts-and-relying-party-in-wcf/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>According to the WS-Trust specification, a service consumer has a way to
negotiate or ask for specific claims to the STS. Those claims (or some
of them) will be generally used by  the service implementation running
on the relying party.</p>

<p>They are negotiated through an &ldquo;claims&rdquo; element in the RST message,</p>

<p>&lt;wst:RequestSecurityToken xmlns:wst=&ldquo;&hellip;&rdquo;></p>

<p>        &lt;wst:TokenType>&hellip;&lt;/wst:TokenType></p>

<p>        &lt;wst:RequestType>&hellip;&lt;/wst:RequestType></p>

<p>        &hellip;</p>

<p>        &lt;wsp:AppliesTo>&hellip;&lt;/wsp:AppliesTo></p>

<p>        <strong>&lt;wst:Claims Dialect=&ldquo;&hellip;&rdquo;>&hellip;&lt;/wst:Claims></strong></p>

<p>        &lt;wst:Entropy></p>

<p>              &lt;wst:BinarySecret>&hellip;&lt;/wst:BinarySecret></p>

<p>         &lt;/wst:Entropy></p>

<p>        &lt;wst:Lifetime></p>

<p>            &lt;wsu:Created>&hellip;&lt;/wsu:Created></p>

<p>            &lt;wsu:Expires>&hellip;&lt;/wsu:Expires></p>

<p>        &lt;/wst:Lifetime></p>

<p>&lt;/wst:RequestSecurityToken></p>

<p><em>The &ldquo;wst:claims&rdquo; is an optional element for requesting a specific set
of claims. Typically, this element contains required and/or optional
claim information identified in a service&rsquo;s policy.</em></p>

<p>Based on these facts, we can elaborate some possible scenarios for
claims negotiation between these three parties.</p>

<p>​1. <strong>No negotiation at all</strong></p>

<p>The STS might just ignore these claims requirements in the RST message
and always returns a fixed claim set according to the consumer identity,
or the service might not express what claims it expects at all. This
scenario might be suitable for a local STS in small-sized or
medium-sized organizations, where the IT department has a complete
control over the client applications and services that interact with
that STS. This kind of solution is easier to implement, and quite rigid
too, a change in the claims required by the service will also require
changes in the STS implementation. As you see, this solution does not
scale at all for a high number of applications or relying party
services.</p>

<p>Many of the STS examples you will find today are implemented like this.</p>

<p>​2. <strong>Negotiation based on the AppliesTo header</strong>.</p>

<p>This solution present a subtle difference with the one discussed before,
the claims vary according the relying party that will make use of them.
The STS ignores the claims requirements in the RST messages and returns
a claim set based on the received AppliesTo header. An existing
agreement must exist between the STS and the relying party, which will
include in addition to the key for encrypting the tokens, a number of
expected claims.  Again, easy to implement, difficult to scale up.</p>

<p>​3. <strong>Manual negotiation based on the &ldquo;Claims&rdquo; header</strong>.</p>

<p>In this scenario, the consumer sends the expected claims in the &ldquo;claims&rdquo;
header and the STS makes use of them for generating the resulting token.
However, the negotiation of those claims between the consumer and the
relying party is manual, a previous agreement must exist, the service
does not express those requirements through metadata. This means that
the claims are hard-coded during development in the client
configuration.  If the service requires additional claims, only the
client configuration will have to be changed, the STS does not have to
be touched at all.</p>

<p>If you are implementing a custom STS with the latest Microsoft Geneva
bits, there is a property &ldquo;Claims&rdquo; in the RequestSecurityToken for
getting access to these values.</p>

<p>protected override IClaimsIdentity
GetOutputClaimsIdentity(IClaimsPrincipal principal, RequestSecurityToken
request, Scope scope)</p>

<p>{</p>

<p>    IClaimsIdentity outputIdentity = new ClaimsIdentity();</p>

<p> </p>

<p>    foreach (Claim claim in request.Claims)</p>

<p>    {</p>

<p>        //Do something&hellip;</p>

<p> </p>

<p>        outputIdentity.Claims.Add(&hellip;);</p>

<p>    }</p>

<p> </p>

<p>    return outputIdentity;</p>

<p>}</p>

<p>The client can specify those claims through configuration as well,</p>

<p>&lt;wsFederationHttpBinding></p>

<p>  &lt;binding name=&ldquo;ServiceBinding&rdquo;></p>

<p>    &lt;security mode=&ldquo;Message&rdquo;></p>

<p>      &lt;message
issuedTokenType=&ldquo;<a href="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1">http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1</a>&rdquo;
negotiateServiceCredential=&ldquo;false&rdquo;></p>

<p>        &lt;claimTypeRequirements></p>

<p>          &lt;add claimType
=&ldquo;<a href="http://schemas.microsoft.com/ws/2005/05/identity/claims/EmailAddress">http://schemas.microsoft.com/ws/2005/05/identity/claims/EmailAddress</a>&rdquo;/></p>

<p>          &lt;add claimType
=&ldquo;<a href="http://schemas.microsoft.com/ws/2005/05/identity/claims/GivenName">http://schemas.microsoft.com/ws/2005/05/identity/claims/GivenName</a>&rdquo;/></p>

<p>          &lt;add claimType
=&ldquo;<a href="http://schemas.microsoft.com/ws/2005/05/identity/claims/Surname">http://schemas.microsoft.com/ws/2005/05/identity/claims/Surname</a>&rdquo;
isOptional =&ldquo;true&rdquo;/></p>

<p>        &lt;/claimTypeRequirements></p>

<p>        &lt;issuer>&lt;/issuer></p>

<p>      &lt;/message></p>

<p>    &lt;/security></p>

<p>  &lt;/binding></p>

<p>&lt;/wsFederationHttpBinding></p>

<p>Once they are added to the binding configuration, WCF will automatically
include them as part of the RST message to the STS.</p>

<p>​4. <strong>Automatic negotiation based on the &ldquo;Claims&rdquo; header</strong>.</p>

<p>This is by far the best solution we can find. The three parties
automatically negotiates the claims at runtime,</p>

<ol type="a">
<li>The service exposes the claim requirements through metadata
(WS-Policy)</li>
</ol>


<p>​II. The client acquires the service&rsquo;s policy and requirements using
some mechanism that could be WS-MetatadaExchange.  Later,  the client
includes some claim requirements into the RST message that will be send
to the STS.</p>

<p>​III. The STS extracts those requirements from the RST message, and
then, it makes use of them for generating the resulting token.</p>

<p>The Cardspace identity selector on the consumer side works like this. It
first detects what claims are needed by the Relying Party, and then,
displays all the possible cards (From different Identity providers) that
satisfy those requirements to the user.</p>

<p>Exposing the claim requirements on the relying party through WCF is
equivalent to do it on the client side (same binding configuration),</p>

<p>&lt;wsFederationHttpBinding></p>

<p>  &lt;binding name=&ldquo;ServiceBinding&rdquo;></p>

<p>    &lt;security mode=&ldquo;Message&rdquo;></p>

<p>      &lt;message
issuedTokenType=&ldquo;<a href="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1">http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1</a>&rdquo;></p>

<p>        &lt;claimTypeRequirements></p>

<p>          &lt;add claimType
=&ldquo;<a href="http://schemas.microsoft.com/ws/2005/05/identity/claims/EmailAddress">http://schemas.microsoft.com/ws/2005/05/identity/claims/EmailAddress</a>&rdquo;/></p>

<p>          &lt;add claimType
=&ldquo;<a href="http://schemas.microsoft.com/ws/2005/05/identity/claims/GivenName">http://schemas.microsoft.com/ws/2005/05/identity/claims/GivenName</a>&rdquo;/></p>

<p>          &lt;add claimType
=&ldquo;<a href="http://schemas.microsoft.com/ws/2005/05/identity/claims/Surname">http://schemas.microsoft.com/ws/2005/05/identity/claims/Surname</a>&rdquo;
isOptional =&ldquo;true&rdquo;/></p>

<p>        &lt;/claimTypeRequirements></p>

<p>        &lt;issuer>&lt;/issuer></p>

<p>      &lt;/message></p>

<p>    &lt;/security></p>

<p>  &lt;/binding></p>

<p>&lt;/wsFederationHttpBinding></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/16/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/14/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/01/31/making-ajax-calls-with-hawk-authentication-to-asp-dot-net-web-api/">Making Ajax Calls With Hawk Authentication to ASP.NET Web API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/13/coordinating-async-work-in-node-dot-js/">Coordinating Async Work in Node.js</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/27/oauth-bridge-for-adfs-with-thinkteckture-authorization-server/">OAuth Bridge for ADFS With ThinkTecture Authorization Server</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/22/automatic-client-cert-detection-in-adfs-2-dot-0/">Automatic Client Cert Detection in ADFS 2.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/21/injecting-dynamic-content-in-windows-azure-package/">Injecting Dynamic Content in Windows Azure Packages</a>
      </li>
    
  </ul>
</section>
 <a href="http://feeds.feedburner.com/cibrax"><img src="http://feeds.feedburner.com/~fc/cibrax?bg=FF3300&amp;fg=000000&amp;anim=0" style="border:0" alt="" /></a>

 <script type="text/javascript" language="javascript" src="http://twittercounter.com/embed/?username=cibrax&style=white"></script>
<a href="https://mvp.microsoft.com/en-us/mvp/Pablo%20Cibraro-33800"><img src="/images/mvp.gif" border="0" /></a>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pcibraro">@pcibraro</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pcibraro',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Cibrax -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cibrax';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
