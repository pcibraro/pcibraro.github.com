
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pablo Cibraro (Cibrax)</title>
  <meta name="author" content="Cibrax">

  
  <meta name="description" content="I have been thinking for a while about what could be a good way to
support brokered authentication for active REST clients. Something I did
not want &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cibrax.me/blog/page/15">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/cibrax" rel="alternate" title="Pablo Cibraro (Cibrax)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44468149-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pablo Cibraro (Cibrax)</a></h1>
  
    <h2>All about software development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/cibrax" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cibrax.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/03/06/brokered-authentication-for-rest-active-clients-with-saml/">Brokered Authentication for REST Active Clients With SAML</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-03-06T00:00:00-03:00" pubdate data-updated="true">Mar 6<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/03/06/brokered-authentication-for-rest-active-clients-with-saml/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have been thinking for a while about what could be a good way to
support brokered authentication for active REST clients. Something I did
not want to do was to force the use of WS-Trust Active profile, which is
in essence SOAP based.</p>

<p>Some of the qualities attributes that are easy to reach with REST
services, such as simplicity, interoperability and scalability can
definitely be affected with the introduction of a additional SOAP stack
for negotiating an identity token. WS-Trust passive requestor profile,
on the other hand, was designed for dumb clients like web browsers,
clients that do not have capabilities to handle cryptographic materials
or the SOAP stack itself.  This profile basically hides most of the
WS-Trust details from client applications through a sequence of http
redirections, which could be helpful in this scenario for negotiating a
token and still keep simple REST clients. However, as some user
interaction is required, this profile is not suitable for consuming REST
services from desktop applications or other active client applications.</p>

<p>If we take a deep look at the functionality provided by a Secure Token
Service (STS), it is not more than a service that handle the lifecycle
of a identity token, it knows how to issue a token, renew it or finally
cancel it when it is not longer need it.  If we see all these scenarios
from a point of view of REST, an identity token is just a resource,
something that can be created, updated or even deleted. Of course, there
is not any spec available yet for this scenario, all I will show here is
just an possible implementation of a Restful STS.</p>

<p>The mapping of supported Ws-Trust actions to http verbs for my Restful
STS is defined below,</p>

<ul>
<li>Issue = POST, creates or issues a new token resource (A SAML token)</li>
<li>Renew = PUT, renew an existing token</li>
<li>Cancel = DELETE, cancel an existing token</li>
<li>GET, gets an existing token (There is not such thing in Ws-Trust)</li>
</ul>


<p>I leave out the &ldquo;Validate&rdquo; action as part of this implementation.</p>

<p>What I have created for this example is a REST facade layered on top of
a STS implementation with the Geneva Framework. The definition of
service contract for this Restful STS for supporting that mapping should
look like this,</p>

<p><del> {.c# name=&ldquo;code&rdquo;}
[ServiceContract]public interface IRestSts{    [OperationContract]    [WebInvoke(UriTemplate=&ldquo;Tokens&rdquo;, Method=&ldquo;POST&rdquo;, RequestFormat=WebMessageFormat.Xml, ResponseFormat=WebMessageFormat.Xml)]    RequestSecurityTokenResponse IssueToken(RequestSecurityToken request);     [OperationContract]    [WebInvoke(Method = &ldquo;PUT&rdquo;, UriTemplate = &ldquo;Tokens/{tokenId}&rdquo;, RequestFormat = WebMessageFormat.Xml, ResponseFormat = WebMessageFormat.Xml)]    RequestSecurityTokenResponse RenewToken(string tokenId);     [OperationContract]    [WebInvoke(Method = &ldquo;DELETE&rdquo;, UriTemplate = &ldquo;Tokens/{tokenId}&rdquo;, RequestFormat = WebMessageFormat.Xml, ResponseFormat = WebMessageFormat.Xml)]    void CancelToken(string tokenId);     [OperationContract]    [WebGet(UriTemplate = &ldquo;Tokens/{tokenId}&rdquo;, RequestFormat = WebMessageFormat.Xml, ResponseFormat = WebMessageFormat.Xml)]    RequestSecurityTokenResponse GetToken(string tokenId);    }
</del></p>

<p>As I mentioned before, the client has to first acquire a token from the
STS, that can be done with a regular Http POST containing a
RequestSecurityToken message.</p>

<p><a href="/images/legacy/FederatedidentityinRESTservices_A72D/Issue_REST.gif"><img src="/images/legacy/FederatedidentityinRESTservices_A72D/Issue_REST_thumb.gif" alt="Issue_REST" /></a></p>

<p>The message embedded in the request body to the STS looks like this,</p>

<p>~~~~ {.xml name=&ldquo;code&rdquo;}
<RequestSecurityToken xmlns="http://schemas.xmlsoap.org/ws/2005/02/trust"></p>

<pre><code>&lt;AppliesTo&gt;https://localhost/MyService&lt;/AppliesTo&gt;
&lt;TokenType&gt;http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1&lt;/TokenType&gt;
</code></pre>

<p></RequestSecurityToken>
~~~~</p>

<p>And the corresponding response like this,</p>

<p>~~~~ {.xml name=&ldquo;code&rdquo;}
<RequestSecurityTokenResponse xmlns="http://schemas.xmlsoap.org/ws/2005/02/trust" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"></p>

<pre><code>&lt;Links&gt;
    &lt;Link&gt;
        &lt;href&gt;http://localhost:7362/STSWindows/Service.svc/_8a6fc87b-7e6a-45c9-a479-20ea42113e40&lt;/href&gt;
        &lt;rel&gt;self&lt;/rel&gt;
        &lt;type&gt;application/xml&lt;/type&gt;
    &lt;/Link&gt;
&lt;/Links&gt;
&lt;RequestedSecurityToken&gt;....&lt;/RequestedSecurityToken&gt;
&lt;TokenType&gt;http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1&lt;/TokenType&gt;
</code></pre>

<p></RequestSecurityTokenResponse>
~~~~</p>

<p>Both calls, the first one to get the token from the STS, and the second
call to invoke the service in the Relying party should be protected with
transport security to avoid any middle in the man attack.</p>

<p>In this sample, the STS is using basic authentication to authenticate
the user trying to get access to the token. If the authentication
succeed, the STS implemented with Geneva will provide the necessary
claims associated with that user.</p>

<p>The code on the client side to ask for a new token is quite simple,</p>

<p>static string GetToken(string address, string appliesTo, string
username, string password)</p>

<p>{</p>

<p>    RequestSecurityToken request = new RequestSecurityToken</p>

<p>    {</p>

<p>        TokenType =
&ldquo;<a href="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1">http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1</a>&rdquo;,</p>

<p>        AppliesTo = appliesTo</p>

<p>    };</p>

<p>    DataContractSerializer requestSerializer = new
DataContractSerializer(typeof(RequestSecurityToken));</p>

<p>    WebRequest webRequest = HttpWebRequest.Create(address);</p>

<p>    webRequest.Method = &ldquo;POST&rdquo;;</p>

<p>    webRequest.ContentType = &ldquo;application/xml&rdquo;;</p>

<p>    webRequest.Credentials = new NetworkCredential(username, password);</p>

<p>    using (var st = webRequest.GetRequestStream())</p>

<p>    {</p>

<p>        requestSerializer.WriteObject(st, request);</p>

<p>        st.Flush();</p>

<p>    }</p>

<p>    WebResponse webResponse = webRequest.GetResponse();</p>

<p>    DataContractSerializer responseSerializer = new
DataContractSerializer(typeof(RequestSecurityTokenResponse));</p>

<p>    using (var st = webResponse.GetResponseStream())</p>

<p>    {</p>

<p>        var response =
(RequestSecurityTokenResponse)responseSerializer.ReadObject(st);</p>

<p>        return response.RequestedSecurityToken;</p>

<p>    }</p>

<p>}</p>

<p>It creates a new RequestSecurityToken message, provides the user
credentials and post that information to the STS. The response from the
STS is a RequestSecurityTokenResponse containing the issued token,
that&rsquo;s what this method returns in response.RequestedSecurityToken.</p>

<p>Once the client gets the issued token from the response, it can include
it as part of the request message to the relying party&rsquo;s service. For
this sample, I decided to include the token in the &ldquo;Authorization&rdquo;
header, which is a common mechanism to attach authentication credentials
in a request message to a REST service (Basic authentication, and other
authentication mechanisms use the same approach).</p>

<p>WebRequest webRequest = HttpWebRequest.Create(address);</p>

<p>webRequest.Method = &ldquo;GET&rdquo;;</p>

<p>webRequest.Headers[&ldquo;Authorization&rdquo;] = token;</p>

<p>Now, the hard part, the Relying Party needs a way to parse the token and
authenticate the user before calling the service implementation.
Fortunately, the guys from the WCF REST Starter kit have provide an
excellent solution for this kind of scenarios, message interceptors.
What I did here was to implement a message interceptor for SAML tokens,
which internally used the Geneva Framework for performing all the
validations and parsing the token.  An easy way to inject message
interceptors in a service implementation is through a custom service
factory (Zero config deployment),</p>

<p>class AppServiceHostFactory : ServiceHostFactory</p>

<p>{</p>

<p>    protected override ServiceHost CreateServiceHost(Type serviceType,
Uri[] baseAddresses)</p>

<p>    {</p>

<p>        WebServiceHost2 result = new WebServiceHost2(serviceType, true,
baseAddresses);</p>

<p>        result.Interceptors.Add(new
MessageInterceptors.SamlAuthenticationInterceptor(new
TrustedIssuerNameRegistry()));</p>

<p>        return result;</p>

<p>    }</p>

<p>}</p>

<p>The &ldquo;TrustedIssuerNameRegistry&rdquo; is a just a simple implementation of a
Geneva &ldquo;IssuerNameRegistry&rdquo; provider that validates the issuer of the
SAML token.</p>

<p>All this stuff is of course transparent to the service implementation,
it only receives a bunch of claims representing the user identity. Those
claims can be got accessed through the current user principal. In the
code below, the service generates a feed with all the received claims.</p>

<p>IClaimsIdentity identity =
(IClaimsIdentity)Thread.CurrentPrincipal.Identity;</p>

<p>var feed = new SyndicationFeed()</p>

<p>{</p>

<p>    Id = &ldquo;<a href="http://Claims">http://Claims</a>&rdquo;,</p>

<p>    Title = new TextSyndicationContent(&ldquo;My claims&rdquo;),</p>

<p>};</p>

<p>feed.Items = identity.Claims.Select(c =></p>

<p>    new SyndicationItem()</p>

<p>    {</p>

<p>        Id = Guid.NewGuid().ToString(),</p>

<p>        Title = new TextSyndicationContent(c.ClaimType),</p>

<p>        LastUpdatedTime = DateTime.UtcNow,</p>

<p>        Authors =</p>

<p>            {</p>

<p>                new SyndicationPerson()</p>

<p>                {</p>

<p>                    Name = c.Issuer</p>

<p>                }</p>

<p>            },</p>

<p>        Content = new TextSyndicationContent(c.Value)</p>

<p>    }</p>

<p>);</p>

<p>The complete sample is available to download from
<a href="/images/legacy/FederatedRest.zip">here</a>. Note, it uses
the latest Geneva Framework bits (And also the X509 certificates
included with the samples, just run the certificate setup file included
with the framework).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/24/carrying-sensitive-information-in-saml-assertions/">Carrying Sensitive Information in SAML Assertions</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-24T00:00:00-03:00" pubdate data-updated="true">Feb 24<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/24/carrying-sensitive-information-in-saml-assertions/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When SAML is used in conjunction with WS-Security, only an small piece
of the token is encrypted, the proof key for the relying party. The rest
of the token goes in plain text, that also includes the user&rsquo;s claims.</p>

<p>&lt;saml:Assertion> </p>

<p>  &lt;saml:Conditions NotBefore=&ldquo;2009-02-24T19:48:20.500Z&rdquo;
NotOnOrAfter=&ldquo;2009-02-24T19:53:20.500Z&rdquo;>&lt;/saml:Conditions></p>

<p>  &lt;saml:AttributeStatement></p>

<p>  &lt;saml:Subject></p>

<p>    &lt;saml:NameIdentifier>&lt;/saml:NameIdentifier></p>

<p>    &lt;saml:SubjectConfirmation></p>

<p>     
&lt;saml:ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:holder-of-key&lt;/saml:ConfirmationMethod></p>

<p>        &lt;KeyInfo
xmlns=&ldquo;<a href="http://www.w3.org/2000/09/xmldsig#">http://www.w3.org/2000/09/xmldsig#</a>&rdquo;>&hellip;&lt;/KeyInfo></p>

<p>   &lt;/saml:SubjectConfirmation></p>

<p>  &lt;/saml:Subject></p>

<p>  &lt;saml:Attribute AttributeName=&ldquo;displayName&rdquo;
AttributeNamespace=&ldquo;<a href="http://schemas.microsoft.com/xsi/2005/05/role">http://schemas.microsoft.com/xsi/2005/05/role</a>&rdquo;></p>

<p><strong>      &lt;</strong><strong>saml:AttributeValue>John Foo&lt;/saml:AttributeValue</strong><strong>>
&lt;&mdash;Attribute value&mdash;></strong></p>

<p>  &lt;/saml:Attribute></p>

<p>  &lt;/saml:AttributeStatement></p>

<p>  &lt;Signature
xmlns=&ldquo;<a href="http://www.w3.org/2000/09/xmldsig#">http://www.w3.org/2000/09/xmldsig#</a>&rdquo;>&hellip;&lt;/Signature></p>

<p>&lt;/saml:Assertion></p>

<p>Knowing this, you should never include sensitive information as claims
in a SAML token. This is also related to the <a href="http://www.identityblog.com/stories/2004/12/09/thelaws.html">identity law #2, &ldquo;Minimal
Disclosure for a Constrained
Use&rdquo;</a>. The
Identity provider should only disclose the least amount of identifiying
information for executing the operation on the relying party.</p>

<p>Some examples are,</p>

<ul>
<li><em>A winery only needs to know whether the customer is in a legal age
for buying alcohol according to the<strong>law, a claim like &ldquo;over21&rdquo;
should be enough for that purpose, there is not need to know the
customer birth</strong>date at all.</em></li>
<li><em>An online store that sells products does not necessary need to know
the number of every credit card owned by a customer, a friendly name
representing the card and optionally the available balance could be
enough for completing a purchase.</em></li>
</ul>


<p>SAML 2.0 introduces the concept of &ldquo;encrypted attribute&rdquo;, which clearly
states its purpose, encrypt individual assertions in a SAML token. In
this way, a token can now carry the encrypted proof key and optionally
one or more encrypted assertions with sensitive information.</p>

<p>You can take a look at <a href="https://spaces.internet2.edu/display/SHIB/SAMLDiffs">this
page</a> for more
information about the differences between SAML 1.1 and 2.0.</p>

<p>Geneva Framework Beta 1 already implements a subset of SAML 2.0,
however, it looks like this feature has been left out in the current
release. Not sure either whether this feature will be included as part
of the final release (Last quarter of 2009). I created <a href="http://social.msdn.microsoft.com/Forums/en-US/Geneva/thread/a63e31cb-a109-4e99-8538-2eb084ed3827">a
post</a>
in the forums some time ago, I haven&rsquo;t received any feedback yet.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/18/contract-projections-in-wcf-declarative-services/">Contract Projections in WCF Declarative Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-18T00:00:00-03:00" pubdate data-updated="true">Feb 18<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/18/contract-projections-in-wcf-declarative-services/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As my friend Jesus mentioned in the post &ldquo;<a href="http://weblogs.asp.net/gsusx/archive/2008/12/17/using-xaml-serialization-in-wcf-4-0.aspx">Using XAML serialization in
WCF
4.0</a>&rdquo;,
WCF 4.0 introduces a new way to implement services that are totally
defined in XAML, which receive the name of &ldquo;declarative services&rdquo;. In
the past, creating a simple service involved three basic steps,</p>

<ol>
<li>Define the service contract</li>
<li>Implement the service contract</li>
<li>Host the service implementation</li>
</ol>


<p>#1 and #2 were all done in an imperative .NET programming language
such as C# or VB.NET. Today, thanks to this new feature, we will able
to define the service interface (#1) using XAML and implement the
service (#2) using a declarative workflow (XAML too).</p>

<p>This was announced as part of the Microsoft&rsquo;s Oslo modeling vision in
the last PDC.</p>

<p>Aaron Skonnard has recently written an excellent article for the MSDN,
&ldquo;WCF and WF Services in the .NET framework 4.0, and Dublin&rdquo;, where he
discusses all these new features more in detail, and the role of dublin
in that vision. Something I found interesting in that article was the
fact that he mentioned &ldquo;Contract Projections&rdquo; as part of &ldquo;declarative
services&rdquo;.</p>

<p>A contract projection allows separating the logical contract definition
from the representation of the messages that are sent or received. We
will able to have a single contract definition and specify different
messaging styles like &ldquo;SOAP&rdquo; or &ldquo;REST/POX&rdquo; using a contract projection.</p>

<p>As in the example shown in the article, a regular WCF service definition
for a calculator service made in C# would look like this,</p>

<p>~~~~ {#ctl00_mainContentContainer_ctl15 .libCScode style=&ldquo;WORD-BREAK: break-all; WORD-WRAP: break-word&rdquo; space=&ldquo;preserve&rdquo;}
[ServiceContract]
public interface ICalculator
{</p>

<pre><code>[OperationContract]
int Add(int Op1, int Op2);
[OperationContract]
int Subtract(int Op1, int Op2);
</code></pre>

<p>};
~~~~</p>

<p>The equivalent representation in XAML (using declarative services) would
look like this,</p>

<p>~~~~ {#ctl00_mainContentContainer_ctl16 .libCScode style=&ldquo;WORD-BREAK: break-all; WORD-WRAP: break-word&rdquo; space=&ldquo;preserve&rdquo;}
<ServiceContract Name="ICalculator"></p>

<pre><code>&lt;OperationContract Name="Add"&gt;
    &lt;OperationArgument Name="Op1" Type="p:Int32" /&gt;
    &lt;OperationArgument Name="Op2" Type="p:Int32" /&gt;
    &lt;OperationArgument Direction="Out" Name="res1" Type="p:Int32" /&gt;
</code></pre>

<p>   </OperationContract>
   <OperationContract Name="Subtract"></p>

<pre><code>    &lt;OperationArgument Name="Op3" Type="p:Int32" /&gt;
    &lt;OperationArgument Name="Op4" Type="p:Int32" /&gt;
    &lt;OperationArgument Direction="Out" Name="res2" Type="p:Int32" /&gt;
</code></pre>

<p>   </OperationContract>
</ServiceContract>
~~~~</p>

<p>And finally, the projection of that contract at wire level like SOAP,</p>

<p>~~~~ {#ctl00_mainContentContainer_ctl17 .libCScode style=&ldquo;WORD-BREAK: break-all; WORD-WRAP: break-word&rdquo; space=&ldquo;preserve&rdquo;}
&lt;Service.KnownProjections></p>

<pre><code>&lt;SoapContractProjection Name="ICalculatorSoapProjection"&gt;
    &lt;!-- service contract definition goes here --&gt;
&lt;/SoapContractProjection&gt;
</code></pre>

<p>&lt;/Service.KnownProjections>
~~~~</p>

<p>As you can see, we will able to have a single service implementation (or
XAML workflow), and multiple contract projections or &ldquo;KnownProjections&rdquo;
(for the different messaging styles) to get access to that service.</p>

<p>With this new feature, it looks like REST/POX will be officially
supported for consuming declarative services. (I talked in <a href="http://weblogs.asp.net/cibrax/archive/2008/10/24/rest-and-workflow-services-play-well-together.aspx">the
past</a>
about exposing workflow services with REST).</p>

<p>As part of the PDC bits (The code that was distributed in a VPC), there
is a interface &ldquo;IContractProjection&rdquo; for defining new kind of
projections,</p>

<p>public interface IContractProjection \
{ \
    // Methods \
    void ApplyEndpointBehavior(ServiceEndpoint endpoint); \
    ContractDescription GetContractDescription();</p>

<p>    // Properties \
    string ConfigurationName { get; } \
    ServiceContract Contract { get; set; } \
}</p>

<p>For the moment, there is single implementation for Soap,
&ldquo;SoapContractProjection&rdquo;. I do not know, we will see if the WCF/WF team
provide more implementations in the future.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/17/issues-to-subdivide-an-entity-framework-model/">Issues to Subdivide an Entity Framework Model</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-17T00:00:00-03:00" pubdate data-updated="true">Feb 17<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/17/issues-to-subdivide-an-entity-framework-model/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The other day, my team and I ran into some design issues while trying to
split a big Entity Framework model into smaller pieces according to
areas of functionality. At first glance, it seemed to be a common design
problem, something easy to overcome, but it did not result that way. I
could not find much information about people having the same issue
either.</p>

<p>In the system we are currently designing, we use modules or packages to
group classes that belong to the same area of functionality. As you can
guess, these modules do not represent more than a set of use cases or
stories that are tightly coupled in design time.</p>

<p>We also have, however, some classes that are common for all those
modules, so we put them in a shared module. In few words, we have a
entity model shaped like a star, being the shared module the center of
the star, and the rest of the modules just leafs.</p>

<p>The problem appeared when we tried to assign a different entity
framework model to any of these modules for persisting the classes in a
store. We could not find an easy way to reference the model with the
shared entities from the rest of them, so we gave up after a while.</p>

<p>A single model with all the entities was not an option for us, because
it simple does not scale up. We took a similar approach in the past with
another project, the result was a huge model full of entities and really
hard to maintain. This solution also required having a extra service
layer on top of the entity model to encapsulate functionality specific
to each module, which made very difficult to have a rich domain model at
first glance.</p>

<p>After a search in several blogs, I came across this post &ldquo;<a href="http://blogs.msdn.com/adonet/archive/2008/11/25/working-with-large-models-in-entity-framework-part-2.aspx">Working with
large models in entity
framework</a>&rdquo;
from the Ado team, where they discuss some possible techniques or
workarounds for an scenario like this.</p>

<p>They basically proposed the following solutions,</p>

<p>​1. Reference one conceptual model (CSDL) from another. You create
different models, and manually modify each CSDL to reference the model
(CSDL) with the shared entities.</p>

<p>The CSDL model supports a clause &ldquo;using&rdquo; for including types defined in
another model, it is basically a simple way to reuse types. This sounds
good, however, it lacks of design time experience, which makes this
feature totally useless for the scenario we have (and really complicated
to implement according to <a href="http://www.thedatafarm.com/blog/2008/11/27/CSDLsUsingConstructForBigModels.aspx">this
post</a>
written by Julie Lerman)</p>

<p>​2. Duplicate metadata for the shared entities in each conceptual model
(CSDL). Again, this approach sucks from a point of view of
maintainability, typically you will have the same problems that you
would see with duplicated code. One change in an shared entity will
require changes in every model that reference it.</p>

<p>​3. Expose foreign keys as scalar properties because you do not want to
pull in all the shared entities into every Entity model. Not a good
solution either, the shared entities get out of the unit of work or
context (ObjectContext) generated by the designer. As result, you can
not execute queries that require joins between the two contexts. Unless
you include some helper methods to retrieve the shared entities using
the scalar properties, you also lost the possibility of having a rich
domain model.</p>

<p>As you can see, we could not find any workaround that totally met our
expectations, so we might stick to the solution #2 (Duplicating the
entities). The solution #1 would be perfect with some design time
support, I hope the ado team consider this for a future release.</p>

<p>Do you have any thought or experience to share ?. I would be more than
happy to hear your feedback regarding possible solutions for this
scenario.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/10/upcoming-msdn-webcast-quot-geneva-cardspace-quot-for-latin-america/">Upcoming MSDN WebCast &quot;Geneva Cardspace&quot; for Latin America</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-10T00:00:00-03:00" pubdate data-updated="true">Feb 10<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/10/upcoming-msdn-webcast-quot-geneva-cardspace-quot-for-latin-america/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I will be presenting a MSDN webcast about &ldquo;Geneva Cardspace&rdquo; next
Thursday 12th at 2 PM (GMT-05:00 Colombia, Panama). The event will be
conducted in Spanish for all the community in Latin America. \</p>

<p>You can register to this event following <a href="http://msevents.microsoft.com/CUI/WebCastEventDetails.aspx?EventID=1032400702&amp;EventCategory=4&amp;culture=es-R&amp;CountryCode=AR">this
link</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/10/some-thoughts-on-openid-and-oauth-for-desktop-clients/">Some Thoughts on OpenID and OAuth for Desktop Clients</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-10T00:00:00-03:00" pubdate data-updated="true">Feb 10<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/10/some-thoughts-on-openid-and-oauth-for-desktop-clients/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>OpenID and OAuth are today excellent solutions for &ldquo;Single Sign On&rdquo;
(SSO)  and &ldquo;Authorization Delegation&rdquo; respectively. They are, however,
based on Http Redirections and therefore, tied to passive clients or
commonly called web browsers.</p>

<p>An interesting research was made by google some time ago, it can be
found
<a href="http://sites.google.com/site/oauthgoog/UXFedLogin/desktopapps">here</a>.
After reading that article, it looks like they could not get rid of a
browser at all :(.</p>

<p>If that does not work for you, another solution could be WS-Federation
Active Profile. </p>

<p>&ldquo;SSO&rdquo; is an inherent feature of WS-Federation, not doubt about it.</p>

<p>&ldquo;Authorization Delegation&rdquo; can also be emulated with a combination of
&ldquo;SSO&rdquo; and authorization claims. In this scenario, we always give our
credentials to an identity provider we trust, there is no need to give
away our credentials to any site or service involved in a transaction.
The authorization claims also represent fine-granular permissions of
what we are allowed to do on the service side, and again, they can
provided by identity provider itself or a resource STS. I discussed this
approach in my last post, <a href="http://weblogs.asp.net/cibrax/archive/2009/02/06/addressing-authorization-with-oauth-or-the-net-access-control-service.aspx">&ldquo;Addressing Authorization with OAuth or the
.NET Access Control
Service&rdquo;</a>,
the resource STS in this case would be the ACS service.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/06/addressing-authorization-with-oauth-or-the-net-access-control-service/">Addressing Authorization With OAuth or the .NET Access Control Service</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-06T00:00:00-03:00" pubdate data-updated="true">Feb 6<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/06/addressing-authorization-with-oauth-or-the-net-access-control-service/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>OAuth</strong></p>

<p>As I mentioned in the post, <a href="http://weblogs.asp.net/cibrax/archive/2008/11/14/oauth-channel-for-wcf-restful-services.aspx">&ldquo;OAuth Channel for REST
services&rdquo;</a>,
OAuth allows a client application to obtain user consent (as access
tokens) for executing operations over private resources on his behalf.
Resources in this context represent anything from the user that the
service provider make public through services, they could be for
instance contacts, pictures or personal information to name a few.</p>

<p>The access token that the consumer gets from the service provider
represents in some way an Access Control List that maps directly with
permissions granted by the user over his resources. For example, John
provides read/write access to his contacts on Windows Live (Service
provider) to a third party service (consumer).</p>

<p>A previous direct trust relationship must exist between the consumer and
the service provider in order to make all this happen, that relationship
in OAuth also takes the form of a Request Token. If the consumer can not
get a request token from the service provider, the user is not even
redirected to this last one for negotiating the access token.</p>

<p>As more service providers get involved in a simple scenario, more access
tokens the consumer will have to negotiate. In addition, the user should
have registered in each one of those service provider prior to use the
consumer application, unless he was  lucky enough to have Open ID
authentication in some of those services.</p>

<p><img src="/images/legacy/OAuth1.jpg" alt="" /></p>

<p><img src="/images/legacy/OAuth2.jpg" alt="" /></p>

<p>In the image above, the user is authenticated by the service provider
during the request token/access token exchange.</p>

<p><strong>.NET Access Control Service</strong></p>

<p>The Microsoft .NET Access Control Service was recently announced in the
PDC as part of the Windows Azure platform. (It was formerly part of
Biztalk services). Today, it is complemented by two other services, the
Microsoft .NET Service Bus and Microsoft .NET Workflow Service.</p>

<p>This service in addition to be a valid Secure Token Service (WS-Trust)
that can participate in the identity metasystem, it is a claim
transformer. It was conceived with the idea of mapping some input claims
(Identity claims usually) into authorization claims that represent an
ACL for the service running on the relying party.</p>

<p>The SAML token containing these output claims would be equivalent to the
access token in OAuth. </p>

<p>As we saw in OAuth, a prior trust agreement must exist between the
relying party and the .NET Access Control Service. In this case, A X509
public key for the relying party must be registered on the .NET ACL
service (for encrypting the SAML token), and the relying party must have
a X509 public key coming from the .NET ACL for verifying the token
signature. As part of this agreement, also some control rules for
mapping claims must defined  in the .NET ACL service configuration (The
.NET ACL will use the appliesTo header in the WS-Trust RST message to
determine which rules have to be used).</p>

<p>If we analyze now the scenario discussed before with OAuth, a single
consumer and multiple service providers, the client always authenticates
against the same identity provider, no matter the number of the service
providers involved, which is a pretty good thing. OAuth depends on Open
ID for getting the same effect.</p>

<p>The picture below show the complete scenario with a single relying
party,</p>

<p> <img src="/images/legacy/ACL1.jpg" alt="" /></p>

<p> </p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/05/ws-trust-profiles-and-cardspace/">WS-TRUST Profiles and Cardspace</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-05T00:00:00-03:00" pubdate data-updated="true">Feb 5<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/05/ws-trust-profiles-and-cardspace/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Geneva framework supports today the two WS-Trust profiles, Active and
Passive.</p>

<p>The active profile deals specially with applications that are able to
make soap request to any WS-Trust endpoint. On other hand, the passive
profile is for clients that are unable to emit proper SOAP (a web
browser for instance) and therefore receive the name of &ldquo;passive
requestors&rdquo;. This last one involves browser-based communication with
several http redirects between the different parties (client, STS and
relying party).</p>

<p>Cardspace embedded in a web browser page however is not a Passive
client. Once the user decides to be authenticated in a website with an
information card, the Cardspace identity selector will negotiate and get
the issue token from the identity provider using the active profile.
Finally, the identity provider will pass the token to the browser using
some Inter-Process communication, and the browser can later submit the
token to the server using an standard http mechanism like a web post.</p>

<p>As you can see, Carspace in a browser is actually an hybrid between
Active and Passive.
<a href="http://blogs.msdn.com/vbertocci/archive/2008/06/05/active-passive-and-passive-aggressive.aspx">Vittorio</a>
has also discussed this scenario in the past, he called it
&ldquo;Passive-Aggressive&rdquo;.</p>

<p> </p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/04/security-token-handlers-in-geneva-framework/">Security Token Handlers in Geneva Framework</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-04T00:00:00-03:00" pubdate data-updated="true">Feb 4<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/04/security-token-handlers-in-geneva-framework/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>According to the Geneva documentation,</p>

<p><em>&ldquo;SecurityTokenHandler defines an interface for plugging custom token
handling functionality. Using the SecurityTokenHandler you can add
functionality to serialize, de-serialize, authenticate and create and
specific kind of token&rdquo;</em></p>

<p>I can see dead people &hellip;.. :)</p>

<p><img src="/images/legacy/Six.jpg" alt="Six" /></p>

<p>Haven&rsquo;t we seen this before ? Oh, yes, I think we did. The token
managers in WSE, they are pretty much the same thing. It looks like the
Geneva team came up with a solution that worked well in the past with
WSE. One token manager for each kind of token we want to consume in our
application. If your app needs to consume a custom token or customize an
existing one, just derive the SecurityTokenHandler base class or one of
the existing SecurityTokenHandler implementations and override some of
its methods with custom functionality. For instance, the Geneva
Framework now comes with two built-in token handlers for Username
tokens, a MembershipUsernameSecurityTokenHandler for validating users
against a membership provider and a WindowsUsernameSecurityTokenHandler
for doing the same against a windows account store.</p>

<p>Most of the code we had in the past as part of authorization policies
(IAuthorizationPolicy) for mapping claims or validating tokens in a
UsernamePasswordValidator or X509CertificateValidator has now moved to
token handlers in the Geneva framework.</p>

<p>I like this way of extending a custom handler for supporting new kind of
tokens, it is quite more straightforward to me than the model currently
supported by WCF.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/04/buenos-aires-msdn-and-technet-briefing-2009/">Buenos Aires MSDN and Technet Briefing 2009</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-04T00:00:00-03:00" pubdate data-updated="true">Feb 4<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/02/04/buenos-aires-msdn-and-technet-briefing-2009/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I just got an email from <a href="http://blogs.msdn.com/masaez">Miguel Angel
Saenz</a> confirming the date of the next
biggest Microsoft event in Buenos Aires Argentina, &ldquo;MSDN briefing&rdquo;,
which will take place on March 25th.</p>

<p>They are now accepting proposals or suggestions for possible sessions in
the event, or to give an specific name to event itself :).</p>

<p>If you are interested in participating, check out <a href="http://www.puertadeenlace.net/">this
website</a>.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/16/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/14/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/23/selfhost-utilities/">SelfHost Utilities</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/23/appfabric-outputcaching/">AppFabric OutputCaching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/31/making-ajax-calls-with-hawk-authentication-to-asp-dot-net-web-api/">Making Ajax Calls With Hawk Authentication to ASP.NET Web API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/13/coordinating-async-work-in-node-dot-js/">Coordinating Async Work in Node.js</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/27/oauth-bridge-for-adfs-with-thinkteckture-authorization-server/">OAuth Bridge for ADFS With ThinkTecture Authorization Server</a>
      </li>
    
  </ul>
</section>
 <a href="http://feeds.feedburner.com/cibrax"><img src="http://feeds.feedburner.com/~fc/cibrax?bg=FF3300&amp;fg=000000&amp;anim=0" style="border:0" alt="" /></a>

 <script type="text/javascript" language="javascript" src="http://twittercounter.com/embed/?username=cibrax&style=white"></script>
<a href="https://mvp.microsoft.com/en-us/mvp/Pablo%20Cibraro-33800"><img src="/images/mvp.gif" border="0" /></a>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pcibraro">@pcibraro</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pcibraro',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Cibrax -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cibrax';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
