
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pablo Cibraro (Cibrax)</title>
  <meta name="author" content="Cibrax">

  
  <meta name="description" content="WCF Data Services provides an specific operator “\$value” for retrieving
the underline value of any of the properties in exposed resources. Let’s
say &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cibrax.me/blog/page/11">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/cibrax" rel="alternate" title="Pablo Cibraro (Cibrax)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44468149-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pablo Cibraro (Cibrax)</a></h1>
  
    <h2>All about software development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/cibrax" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cibrax.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/06/25/specifying-mime-types-for-content-in-wcf-data-services/">Specifying Mime Types for Content in WCF Data Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-06-25T00:00:00-03:00" pubdate data-updated="true">Jun 25<span>th</span>, 2010</time>
        
         | <a href="/blog/2010/06/25/specifying-mime-types-for-content-in-wcf-data-services/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>WCF Data Services provides an specific operator “\$value” for retrieving
the underline value of any of the properties in exposed resources. Let’s
say you have a resource “Configuration” that exposes a field “Xml” whose
content should be treated as a mime type “text/xml”. When you execute a
query like this to retrieve the value of that field,
“myService.svc/Configurations(1)/Xml/\$value”, what you get is the
content of that field but expressed as plain text (text/plain). This
happens because the default behavior for WCF Data Services is to return
most of the primitive types as “text/plain” and some others like byte
arrays as “application/octet-stream”. So, how do you change that default
behavior to retrieve property content with other mime types ?. Here is
where the MimeTypeAttribute can be used to change that behavior.</p>

<p>The MimeTypeAttribute can actually only be used with the
ReflectionProvider, which is the default provider for exposing objects
that are not EF entities. If you want to change the mime type for the EF
Provider, you need to modify the underline CSDL model (This is the part
that is not well documented, and I only found some incomplete references
in some forums).</p>

<p>For the reflection provider, the attribute must be specified at class
level,</p>

<p>[MimeType(&ldquo;Xml&rdquo;, &ldquo;text/xml&rdquo;)] \
public class Configuration \
{ \
  public string Xml { get; set; } \
}</p>

<p>For the EF provider, a few additional changes are required in the CSDL
model. Edit the CSDL by opening the EDM model in Xml view, and adding a
reference to this namespace
&ldquo;xmlns:m1=&rdquo;<a href="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata">http://schemas.microsoft.com/ado/2007/08/dataservices/metadata</a>&ldquo;&rdquo;
in the &lt;edmx:ConceptualModels> node  of the CSDL section in the EDMX
file. Right after that, locate the entity that you want to modify and
add the MimeType definition in the property.</p>

<p>&lt;EntityType Name=&ldquo;Configuration&rdquo;> \
          &lt;Property Name=&ldquo;Xml&rdquo; m1:MimeType=&ldquo;text/xml&rdquo; Type=&ldquo;String&rdquo;
MaxLength=&ldquo;Max&rdquo; Unicode=&ldquo;true&rdquo; FixedLength=&ldquo;false&rdquo; /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/06/12/professional-wcf-4-0-windows-communication-foundation-with-net-4-0/">Professional WCF 4.0: Windows Communication Foundation With .NET 4.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-06-12T00:00:00-03:00" pubdate data-updated="true">Jun 12<span>th</span>, 2010</time>
        
         | <a href="/blog/2010/06/12/professional-wcf-4-0-windows-communication-foundation-with-net-4-0/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The book in which I been working on since last year finally went to the
light this week. It has been the result of hard work between me and
three other Connected Systems MVP, my friend <a href="http://weblogs.asp.net/fabio/">Fabio
Cozzolino</a>, <a href="http://geekswithblogs.net/claeyskurt/Default.aspx">Kurt
Claeys</a> and Johann
Grabner. If you are interested in learning the new features in WCF 4.0,
but also WCF in general and how to apply it in real world scenarios,
this book is for you. I dedicated three chapters of this book to one of
my favorites topics, Security, from the basics to more complicated
scenarios with Claim-Based security and Federated authentication using
WCF services with Windows Identity Foundation. You can find more
information about the book and the table of contents in the Wrox web
site
<a href="http://www.wrox.com/WileyCDA/WroxTitle/Professional-WCF-4-Windows-Communication-Foundation-with-NET-4.productCd-0470563141,descCd-tableOfContents.html">here</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/05/31/implementing-a-generic-repository-for-wcf-data-services/">Implementing a Generic Repository for WCF Data Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-31T00:00:00-03:00" pubdate data-updated="true">May 31<span>st</span>, 2010</time>
        
         | <a href="/blog/2010/05/31/implementing-a-generic-repository-for-wcf-data-services/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The repository implementation I am going to discuss here is not exactly
what someone would call repository in terms of DDD, but it is an
abstraction layer that becomes handy at the moment of unit testing the
code around this repository. In other words, you can easily create a
mock to replace the real repository implementation.</p>

<p>The WCF Data Services update for .NET 3.5 introduced a nice feature to
support two way data bindings, which is very helpful for developing WPF
or Silverlight based application but also for implementing the
repository I am going to talk about. As part of this feature, the WCF
Data Services Client library introduced a new collection
DataServiceCollection&lt;T> that implements INotifyPropertyChanged to
notify the data context (DataServiceContext) about any change in the
association links. This means that it is not longer necessary to
manually set or remove the links in the data context when an item is
added or removed from a collection.</p>

<p>Before having this new collection, you basically used the following code
to add a new item to a collection.</p>

<p>Order order = new Order \
{ \
  Name = &ldquo;Foo&rdquo; \
};</p>

<p>OrderItem item = new OrderItem \
{ \
  Name = &ldquo;bar&rdquo;, \
  UnitPrice = 10, \
  Qty = 1 \
};</p>

<p>var context = new OrderContext(); \
context.AddToOrders(order); \
context.AddToOrderItems(item);</p>

<p>context.SetLink(item, &ldquo;Order&rdquo;, order);</p>

<p>context.SaveChanges();</p>

<p>Now, thanks to this new collection, everything is much simpler and
similar to what you have in other ORMs like Entity Framework or L2S.</p>

<p>Order order = new Order \
{ \
  Name = &ldquo;Foo&rdquo; \
};</p>

<p>OrderItem item = new OrderItem \
{ \
  Name = &ldquo;bar&rdquo;, \
  UnitPrice = 10, \
  Qty = 1 \
};</p>

<p>order.Items.Add(item);</p>

<p>var context = new OrderContext(); \
context.AddToOrders(order);</p>

<p>context.SaveChanges();</p>

<p>In order to use this new feature, you first need to enable V2 in the
data service, and then use some specific arguments in the datasvcutil
tool (You can find more information about this new feature and how to
use it in this
<a href="http://blogs.msdn.com/b/astoriateam/archive/2009/09/01/introduction-to-data-binding-in-ctp2.aspx">post</a>).</p>

<p>DataSvcUtil
/uri:&ldquo;<a href="http://localhost:3655/MyDataService.svc/">http://localhost:3655/MyDataService.svc/</a>&rdquo;
/out:Reference.cs /dataservicecollection /version:2.0</p>

<p>Once you use those two arguments, the generated proxy classes will use
DataServiceCollection&lt;T> rather than a simple ObjectCollection&lt;T>,
which was the default collection in V1.</p>

<p>There are some aspects that you need to know to use this feature
correctly.</p>

<p>​1. All the entities retrieved directly from the data context with a
query track the changes and report those to the data context
automatically.</p>

<p>​2. A entity created with “new” does not track any change in the
properties or associations. In order to enable change tracking in this
entity, you need to do the following trick.</p>

<p>public Order CreateOrder() \
{ \
  var collection = new DataServiceCollection&lt;Order>(this.context); \
  var order = new Order();</p>

<p>  collection.Add(order);</p>

<p>  return order; \
}</p>

<p>You basically need to create a collection, and add the entity to that
collection with the “Add” method to enable change tracking on that
entity.</p>

<p>​3. If you need to attach an existing entity (For example, if you
created the entity with the “new” operator rather than retrieving it
from the data context with a query) to a data context for tracking
changes, you can use the “Load” method in the DataServiceCollection.</p>

<p>var order = new Order \
{ \
  Id = 1 \
};</p>

<p>var collection = new DataServiceCollection&lt;Order>(this.context); \
collection.Load(order);</p>

<p>In this case, the order with Id = 1 must exist on the data source
exposed by the Data service. Otherwise, you will get an error because
the entity did not exist.</p>

<p>These cool extensions methods discussed by Stuart Leeks in this
<a href="http://blogs.msdn.com/b/stuartleeks/archive/2008/09/15/dataservicequery-t-expand.aspx">post</a>
to replace all the magic strings in the “Expand” operation with
Expression Trees represent another feature I am going to use to
implement this generic repository.</p>

<p>Thanks to these extension methods, you could replace the following query
with magic strings by a piece of code that only uses expressions.</p>

<p>Magic strings,</p>

<p>var customers = dataContext.Customers \
.Expand(&ldquo;Orders&rdquo;) \
        .Expand(&ldquo;Orders/Items&rdquo;)</p>

<p>Expressions,</p>

<p>var customers = dataContext.Customers \
.Expand(c => c.Orders.SubExpand(o => o.Items))</p>

<p>That query basically returns all the customers with their orders and
order items.</p>

<p>Ok, now that we have the automatic change tracking support and the
expression support for explicitly loading entity associations, we are
ready to create the repository.</p>

<p>The interface for this repository looks like this,</p>

<p><del> {.code}
public interface IRepository
{
  T Create<T>() where T : new();
  void Update<T>(T entity);
  void Delete<T>(T entity);
  IQueryable<T> RetrieveAll<T>(params Expression&lt;Func&lt;T, object>>[] eagerProperties);
  IQueryable<T> Retrieve<T>(Expression&lt;Func&lt;T, bool>> predicate,
</del></p>

<p><del> {.code}
params Expression&lt;Func&lt;T, object>>[] eagerProperties);
  void Attach<T>(T entity);
  void SaveChanges();
}
</del></p>

<p><a href="http://11011.net/software/vspaste"></a></p>

<p>The Retrieve and RetrieveAll methods are used to execute queries against
the data service context. While both methods receive an array of
expressions to load associations explicitly, only the Retrieve method
receives a predicate representing the “where” clause.</p>

<p>The following code represents the final implementation of this
repository.</p>

<p>~~~~ {.code}
public class DataServiceRepository: IRepository
{
  ResourceRepositoryContext context;</p>

<p>  public DataServiceRepository()</p>

<pre><code>  : this (new DataServiceContext())
</code></pre>

<p>  {
  }</p>

<p>  public DataServiceRepository(DataServiceContext context)
  {</p>

<pre><code>        this.context = context;
</code></pre>

<p>  }</p>

<p>  private static string ResolveEntitySet(Type type)
  {</p>

<pre><code>var entitySetAttribute = (EntitySetAttribute)type
</code></pre>

<p>~~~~</p>

<p>~~~~ {.code}
.GetCustomAttributes(typeof(EntitySetAttribute), true).FirstOrDefault();</p>

<p>   if (entitySetAttribute != null)</p>

<pre><code>  return entitySetAttribute.EntitySet;
</code></pre>

<p>   return null;
  }</p>

<p>  public T Create<T>() where T : new()
  {</p>

<pre><code>var collection = new DataServiceCollection&lt;T&gt;(this.context);
var entity = new T();

collection.Add(entity);

return entity;
</code></pre>

<p>  }</p>

<p>  public void Update<T>(T entity)
  {</p>

<pre><code>this.context.UpdateObject(entity);
</code></pre>

<p>  }</p>

<p>  public void Delete<T>(T entity)
  {</p>

<pre><code>this.context.DeleteObject(entity);
</code></pre>

<p>  }</p>

<p>  public void Attach<T>(T entity)
  {</p>

<pre><code>var collection = new DataServiceCollection&lt;T&gt;(this.context);
collection.Load(entity);
</code></pre>

<p>  }</p>

<p>  public IQueryable<T> Retrieve<T>(Expression&lt;Func&lt;T, bool>> predicate,
~~~~</p>

<p>~~~~ {.code}
  params Expression&lt;Func&lt;T, object>>[] eagerProperties)
  {</p>

<pre><code>var entitySet = ResolveEntitySet(typeof(T));
var query = context.CreateQuery&lt;T&gt;(entitySet);

foreach (var e in eagerProperties)
{
  query = query.Expand(e);
}

return query.Where(predicate);
</code></pre>

<p>  }</p>

<p>  public IQueryable<T> RetrieveAll<T>(params Expression&lt;Func&lt;T, object>>[] eagerProperties)
  {</p>

<pre><code>var entitySet = ResolveEntitySet(typeof(T));
var query = context.CreateQuery&lt;T&gt;(entitySet);

foreach (var e in eagerProperties)
{
  query = query.Expand(e);
}

return query;
</code></pre>

<p>  }</p>

<p>  public void SaveChanges()
  {</p>

<pre><code>this.context.SaveChanges(SaveChangesOptions.Batch);
</code></pre>

<p>  }</p>

<p> }
~~~~</p>

<p><a href="http://11011.net/software/vspaste"></a></p>

<p>For instance, you can use the following code to retrieve customers with
First name equal to “John”, and all their orders in a single call.</p>

<p>repository.Retrieve&lt;Customer>( \
   c => c.FirstName == “John”, //Where \
   c => c.Orders.SubExpand(o => o.Items));</p>

<p>In case, you want to have some pre-defined queries that you are going to
use across several places, you can put them in an specific class.</p>

<p>public static class CustomerQueries \
{ \
  public static Expression&lt;Func&lt;Customer, bool>>
LastNameEqualsTo(string lastName) \
  { \
    return c => c.LastName == lastName; \
  } \
}</p>

<p>And then, use it with the repository.</p>

<p>repository.Retrieve&lt;Customer>( \
   CustomerQueries.LastNameEqualsTo(&ldquo;foo&rdquo;), \
   c => c.Orders.SubExpand(o => o.Items));</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/05/17/enabling-service-availability-in-wcf-services/">Enabling Service Availability in WCF Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-17T00:00:00-03:00" pubdate data-updated="true">May 17<span>th</span>, 2010</time>
        
         | <a href="/blog/2010/05/17/enabling-service-availability-in-wcf-services/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It is very important for the enterprise to know which services are
operational at any given point. There are many factors that can affect
the availability of the services, some of them are external like a
database not responding or any dependant service not working. However,
in some cases, you only want to know whether a service is up or down, so
a simple heart-beat mechanism with “Ping” messages would do the trick.
Unfortunately, WCF does not provide a built-in mechanism to support this
functionality, and you probably don’t to implement a “Ping” operation in
any service that you have out there. For solving this in a generic way,
there is a WCF extensibility point that comes to help us, the “Operation
Invokers”. In a nutshell, an operation invoker is the class responsible
invoking the service method with a set of parameters and generate the
output parameters with the return value.</p>

<p>What I am going to do here is to implement a custom operation invoker
that intercepts any call to the service, and detects whether a “Ping”
header was attached to the message. If the “Ping” header is detected,
the operation invoker returns a new header to tell the client that the
service is alive, and the real operation execution is omitted. In that
way, we have a simple heart beat mechanism based on the messages that
include a &ldquo;Ping” header, so the client application can determine at any
point whether the service is up or down.</p>

<p>My operation invoker wraps the default implementation attached by
default to any operation by WCF.</p>

<p>~~~~ {.code}
internal class PingOperationInvoker : IOperationInvoker
{
  IOperationInvoker innerInvoker;
  object[] outputs = null;
  object returnValue = null;</p>

<p>  public const string PingHeaderName = &ldquo;Ping&rdquo;;
  public const string PingHeaderNamespace = &ldquo;<a href="http://tellago.serviceModel">http://tellago.serviceModel</a>&rdquo;;</p>

<p>  public PingOperationInvoker(IOperationInvoker innerInvoker, OperationDescription description)
  {</p>

<pre><code>this.innerInvoker = innerInvoker;
outputs = description.SyncMethod.GetParameters()
      .Where(p =&gt; p.IsOut)
      .Select(p =&gt; DefaultForType(p.ParameterType)).ToArray();

var returnValue = DefaultForType(description.SyncMethod.ReturnType);
</code></pre>

<p>  }</p>

<p>  private static object DefaultForType(Type targetType)
  {</p>

<pre><code>return targetType.IsValueType ? Activator.CreateInstance(targetType) : null;
</code></pre>

<p>  }</p>

<p>  public object Invoke(object instance, object[] inputs, out object[] outputs)
  {</p>

<pre><code>object returnValue;

if (Invoke(out returnValue, out outputs))
{
  return returnValue;
}
else
{
  return this.innerInvoker.Invoke(instance, inputs, out outputs);
}
</code></pre>

<p>  }</p>

<p>  private bool Invoke(out object returnValue, out object[] outputs)
  {</p>

<pre><code>object untypedProperty = null;
if (OperationContext.Current
</code></pre>

<p>~~~~</p>

<p>~~~~ {.code}
.IncomingMessageProperties.TryGetValue(HttpRequestMessageProperty.Name, out untypedProperty))</p>

<pre><code>{
  var httpRequestProperty = untypedProperty as HttpRequestMessageProperty;
  if (httpRequestProperty != null)
  {
    if (httpRequestProperty.Headers[PingHeaderName] != null)
    {
      outputs = this.outputs;

      if (OperationContext.Current
</code></pre>

<p>~~~~</p>

<p>~~~~ {.code}
.IncomingMessageProperties.TryGetValue(HttpRequestMessageProperty.Name, out untypedProperty))</p>

<pre><code>      {
         var httpResponseProperty = untypedProperty as HttpResponseMessageProperty;

         httpResponseProperty.Headers.Add(PingHeaderName, "Ok");
      }

      returnValue = this.returnValue;

      return true;
   }
}
</code></pre>

<p>   }</p>

<p>   var headers = OperationContext.Current.IncomingMessageHeaders;
   if (headers.FindHeader(PingHeaderName, PingHeaderNamespace) > -1)
   {</p>

<pre><code> outputs = this.outputs;

 MessageHeader&lt;string&gt; header = new MessageHeader&lt;string&gt;("Ok");
 var untyped = header.GetUntypedHeader(PingHeaderName, PingHeaderNamespace);

 OperationContext.Current.OutgoingMessageHeaders.Add(untyped);

 returnValue = this.returnValue;

 return true;
</code></pre>

<p>   }</p>

<p>   returnValue = null;
   outputs = null;</p>

<p>   return false;
 }
}
~~~~</p>

<p><a href="http://11011.net/software/vspaste"></a></p>

<p>The implementation above looks for the “Ping” header either in the Http
Request or the Soap message. \
The next step is to implement a behavior for attaching this operation
invoker to the services we want to monitor.</p>

<p>~~~~ {.code}
[AttributeUsage(AttributeTargets.Method
  | AttributeTargets.Class, AllowMultiple = false, Inherited = true)]
 public class PingBehavior : Attribute, IServiceBehavior, IOperationBehavior
 {
   public void AddBindingParameters(ServiceDescription serviceDescription,</p>

<pre><code>   ServiceHostBase serviceHostBase, Collection&lt;ServiceEndpoint&gt; endpoints, 
   BindingParameterCollection bindingParameters)
</code></pre>

<p>   {
   }</p>

<p>   public void ApplyDispatchBehavior(ServiceDescription serviceDescription,</p>

<pre><code>    ServiceHostBase serviceHostBase)
</code></pre>

<p>   {
   }</p>

<p>   public void Validate(ServiceDescription serviceDescription,</p>

<pre><code>    ServiceHostBase serviceHostBase)
</code></pre>

<p>   {</p>

<pre><code> foreach (var endpoint in serviceDescription.Endpoints)
 {
   foreach (var operation in endpoint.Contract.Operations)
   {
     if (operation.Behaviors.Find&lt;PingBehavior&gt;() == null)
          operation.Behaviors.Add(this);
   }
 }
</code></pre>

<p>   }</p>

<p>   public void AddBindingParameters(OperationDescription operationDescription,</p>

<pre><code>    BindingParameterCollection bindingParameters)
</code></pre>

<p>   {
   }</p>

<p>   public void ApplyClientBehavior(OperationDescription operationDescription,</p>

<pre><code>      ClientOperation clientOperation)
</code></pre>

<p>   {
   }</p>

<p>   public void ApplyDispatchBehavior(OperationDescription operationDescription,</p>

<pre><code>    DispatchOperation dispatchOperation)
</code></pre>

<p>   {</p>

<pre><code>  dispatchOperation.Invoker = 
      new PingOperationInvoker(dispatchOperation.Invoker, operationDescription);
</code></pre>

<p>   }</p>

<p>   public void Validate(OperationDescription operationDescription)
   {</p>

<p>   }
 }
~~~~</p>

<p>As an operation invoker can only be added in an “operation behavior”, a
trick I learned in the past is that you can implement a service behavior
as well and use the “Validate” method to inject it in all the
operations, so the final configuration is much easier and cleaner. You
only need to decorate the service with a simple attribute to enable the
“Ping” functionality.</p>

<p>~~~~ {.code}
[PingBehavior]
public class HelloWorldService : IHelloWorld
{
  public string Hello(string name)
  {</p>

<pre><code>return "Hello " + name;
</code></pre>

<p>  }
}
~~~~</p>

<p><a href="http://11011.net/software/vspaste"></a></p>

<p>On the other hand, the client application needs to send a dummy message
with a “Ping” header to detect whether the service is available or not.
In order to simplify this task, I created a extension method in the WCF
client channel to do this work.</p>

<p>~~~~ {.code}
public static class ClientChannelExtensions
{
  const string PingNamespace = &ldquo;<a href="http://tellago.serviceModel">http://tellago.serviceModel</a>&rdquo;;
  const string PingName = &ldquo;Ping&rdquo;;</p>

<p>  public static bool IsAvailable<TChannel>(this IClientChannel channel,</p>

<pre><code>   Action&lt;TChannel&gt; operation)
</code></pre>

<p>  {</p>

<pre><code>try
{
  using (OperationContextScope scope = new OperationContextScope(channel))
  {
    MessageHeader&lt;string&gt; header = new MessageHeader&lt;string&gt;(PingName);
    var untyped = header.GetUntypedHeader(PingName, PingNamespace);
    OperationContext.Current.OutgoingMessageHeaders.Add(untyped);

    try
    {
      operation((TChannel)channel);
      var headers = OperationContext.Current.IncomingMessageHeaders;
      if (headers.Any(h =&gt; h.Name == PingName &amp;&amp; h.Namespace == PingNamespace))
      {
        return true;
      }
      else
      {
        return false;
      }
    }
    catch (CommunicationException)
    {
      return false;
    }
   }
 }
 catch (Exception)
 {
   return false;
 }
</code></pre>

<p>   }
  }
~~~~</p>

<p><a href="http://11011.net/software/vspaste"></a></p>

<p>This extension method basically adds a “Ping” header to the request
message, executes the operation passed as argument (Action&lt;TChannel>
operation), and looks for the corresponding “Ping” header in the
response to see the results.</p>

<p>The client application can use this extension with a single line of
code,</p>

<p><del> {.code}
var client = new ServiceReference.HelloWorldClient();
var isAvailable = client.InnerChannel.IsAvailable<IHelloWorld>(&copy; => c.Hello(null));
</del></p>

<p><a href="http://11011.net/software/vspaste"></a></p>

<p>The “isAvailable” variable will tell the client application whether the
service is available or not.</p>

<p>You can download the complete implementation from this
<a href="/images/legacy/Ping.zip">location</a>.</p>

<p> </p>

<p><a href="http://11011.net/software/vspaste"> </a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/05/11/getting-wcf-bindings-and-behaviors-from-any-config-source/">Getting WCF Bindings and Behaviors From Any Config Source</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-11T00:00:00-03:00" pubdate data-updated="true">May 11<span>th</span>, 2010</time>
        
         | <a href="/blog/2010/05/11/getting-wcf-bindings-and-behaviors-from-any-config-source/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The need of loading WCF bindings or behaviors from different sources
such as files in a disk or databases is a common requirement when
dealing with configuration either on the client side or the service
side.</p>

<p>The traditional way to accomplish this in WCF is loading everything from
the standard configuration section (serviceModel section) or creating
all the bindings and behaviors by hand in code. However, there is a
solution in the middle that becomes handy when more flexibility is
needed. This solution involves getting the configuration from any place,
and use that configuration to automatically configure any existing
binding or behavior instance created with code. </p>

<p>In order to configure a binding instance
(System.ServiceModel.Channels.Binding) that you later inject in any
endpoint on the client channel or the service host, you first need to
get a binding configuration section from any configuration file (you can
generate a temp file on the fly if you are using any other source for
storing the configuration).</p>

<p> </p>

<p><del> {.code}
private BindingsSection GetBindingsSection(string path)
{
  System.Configuration.Configuration config =
</del></p>

<p>~~~~ {.code}
System.Configuration.ConfigurationManager.OpenMappedExeConfiguration(</p>

<pre><code>new System.Configuration.ExeConfigurationFileMap() { ExeConfigFilename = path },
  System.Configuration.ConfigurationUserLevel.None);
</code></pre>

<p>  var serviceModel = ServiceModelSectionGroup.GetSectionGroup(config);
  return serviceModel.Bindings;
}
~~~~</p>

<p><a href="http://11011.net/software/vspaste"></a></p>

<p> </p>

<p>The BindingsSection contains a list of all the configured bindings in
the serviceModel configuration section, so you can iterate through all
the configured binding that get the one you need (You don’t need to have
a complete serviceModel section, a section with the bindings only
works).</p>

<p> </p>

<p>~~~~ {.code}
public Binding ResolveBinding(string name)
{
  BindingsSection section = GetBindingsSection(path);</p>

<p>  foreach (var bindingCollection in section.BindingCollections)
  {</p>

<pre><code>if (bindingCollection.ConfiguredBindings.Count &gt; 0 
</code></pre>

<p>~~~~</p>

<p>~~~~ {.code}
&amp;&amp; bindingCollection.ConfiguredBindings[0].Name == name)</p>

<pre><code>{
  var bindingElement = bindingCollection.ConfiguredBindings[0];
  var binding = (Binding)Activator.CreateInstance(bindingCollection.BindingType);
  binding.Name = bindingElement.Name;
  bindingElement.ApplyConfiguration(binding);

  return binding;
}
</code></pre>

<p>  }</p>

<p>  return null;
}
~~~~</p>

<p><a href="http://11011.net/software/vspaste"></a></p>

<p> </p>

<p>The code above does just that, and also instantiates and configures the
Binding object (System.ServiceModel.Channels.Binding) you are looking
for. As you can see, the binding configuration element contains a method
“ApplyConfiguration” that receives the binding instance that needs to be
configured.</p>

<p>A similar thing can be done for instance with the “Endpoint” behaviors.
You first get the BehaviorsSection, and then, the behavior you want to
use.</p>

<p> </p>

<p><del> {.code}
private BehaviorsSection GetBehaviorsSection(string path)
{
  System.Configuration.Configuration config =
</del></p>

<p>~~~~ {.code}
System.Configuration.ConfigurationManager.OpenMappedExeConfiguration(</p>

<pre><code>   new System.Configuration.ExeConfigurationFileMap() { ExeConfigFilename = path },
      System.Configuration.ConfigurationUserLevel.None);
</code></pre>

<p>  var serviceModel = ServiceModelSectionGroup.GetSectionGroup(config);
  return serviceModel.Behaviors;</p>

<p>}
~~~~</p>

<p>~~~~ {.code}
public List<IEndpointBehavior> ResolveEndpointBehavior(string name)
{
  BehaviorsSection section = GetBehaviorsSection(path);
  List<IEndpointBehavior> endpointBehaviors = new List<IEndpointBehavior>();</p>

<p>  if (section.EndpointBehaviors.Count > 0
~~~~</p>

<p>~~~~ {.code}
&amp;&amp; section.EndpointBehaviors[0].Name == name)
  {</p>

<pre><code>var behaviorCollectionElement = section.EndpointBehaviors[0];

foreach (BehaviorExtensionElement behaviorExtension in behaviorCollectionElement)
{
  object extension = behaviorExtension.GetType().InvokeMember("CreateBehavior",
        BindingFlags.InvokeMethod | BindingFlags.NonPublic | BindingFlags.Instance,
        null, behaviorExtension, null);

  endpointBehaviors.Add((IEndpointBehavior)extension);
}
</code></pre>

<p>   return endpointBehaviors;
 }</p>

<p> return null;
}
~~~~</p>

<p><a href="http://11011.net/software/vspaste"></a></p>

<p> </p>

<p>In this case, the code for creating the behavior instance is more
tricky. First of all, a behavior in the configuration section actually
represents a set of “IEndpoint” behaviors, and the behavior element you
get from the configuration does not have any public method to configure
an existing behavior instance. This last one only contains a protected
method “CreateBehavior” that you can use for that purpose.</p>

<p>Once you get this code implemented, a client channel can be easily
configured as follows</p>

<p> </p>

<p>~~~~ {.code}
var binding = resolver.ResolveBinding(&ldquo;MyBinding&rdquo;);
var behaviors = resolver.ResolveEndpointBehavior(&ldquo;MyBehavior&rdquo;);</p>

<p>SampleServiceClient client = new SampleServiceClient(binding,</p>

<pre><code>   new EndpointAddress(new Uri("http://localhost:13749/SampleService.svc"),
   new DnsEndpointIdentity("localhost")));
</code></pre>

<p>foreach (var behavior in behaviors)
{
   if(client.Endpoint.Behaviors.Contains(behavior.GetType()))
   {</p>

<pre><code> client.Endpoint.Behaviors.Remove(behavior.GetType());
</code></pre>

<p>   }
   client.Endpoint.Behaviors.Add(behavior);
}
~~~~</p>

<p> </p>

<p>The code above assumes that a configuration file (in any place) with a
binding “MyBinding” and a behavior “MyBehavior” exists. That file can
look like this,</p>

<p> </p>

<p>~~~~ {.code}
&lt;system.serviceModel>
   <bindings></p>

<pre><code> &lt;basicHttpBinding&gt;
   &lt;binding name="MyBinding"&gt;
     &lt;security mode="Transport"&gt;&lt;/security&gt;
   &lt;/binding&gt;
 &lt;/basicHttpBinding&gt;
</code></pre>

<p>   </bindings>
   <behaviors></p>

<pre><code> &lt;endpointBehaviors&gt;
   &lt;behavior name="MyBehavior"&gt;
     &lt;clientCredentials&gt;
       &lt;windows/&gt;
     &lt;/clientCredentials&gt;
   &lt;/behavior&gt;
 &lt;/endpointBehaviors&gt;
</code></pre>

<p>   </behaviors>
 &lt;/system.serviceModel>
~~~~</p>

<p><a href="http://11011.net/software/vspaste"></a></p>

<p> </p>

<p>The same thing can be done of course in the service host if you want to
manually configure the bindings and behaviors.</p>

<p><a href="http://11011.net/software/vspaste"></a> </p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/04/15/integrating-wif-with-wcf-data-services/">Integrating WIF With WCF Data Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-04-15T00:00:00-03:00" pubdate data-updated="true">Apr 15<span>th</span>, 2010</time>
        
         | <a href="/blog/2010/04/15/integrating-wif-with-wcf-data-services/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A time ago I
<a href="http://weblogs.asp.net/cibrax/archive/2009/03.aspx">discussed</a> how a
custom REST Starter kit interceptor could be used to parse a SAML token
in the Http Authorization header and wrap that into a ClaimsPrincipal
that the WCF services could use. The thing is that code was initially
created for Geneva framework, so it got deprecated quickly. I recently
needed that piece of code for one of projects where I am currently
working on so I decided to update it for WIF. As this interceptor can be
injected in any host for WCF REST services, also represents an excellent
solution for integrating claim-based security into WCF Data Services
(previously known as ADO.NET Data Services).</p>

<p>The interceptor basically expects a SAML token in the Authorization
header. If a token is found, it is parsed and a new ClaimsPrincipal is
initialized and injected in the WCF authorization context.</p>

<p>public class SamlAuthenticationInterceptor : RequestInterceptor \
{ \
  SecurityTokenHandlerCollection handlers;</p>

<p>  public SamlAuthenticationInterceptor() \
    : base(false) \
  { \
    this.handlers =
FederatedAuthentication.ServiceConfiguration.SecurityTokenHandlers; \
  }</p>

<p>  public override void ProcessRequest(ref RequestContext requestContext)
\
  { \
    SecurityToken token =
ExtractCredentials(requestContext.RequestMessage);</p>

<p>    if (token != null) \
    { \
      ClaimsIdentityCollection claims = handlers.ValidateToken(token);</p>

<p>      var principal = new ClaimsPrincipal(claims); \
      InitializeSecurityContext(requestContext.RequestMessage,
principal); \
    } \
    else \
    { \
      DenyAccess(ref requestContext); \
    } \
  }</p>

<p>  private void DenyAccess(ref RequestContext requestContext) \
  { \
    Message reply = Message.CreateMessage(MessageVersion.None, null); \
    HttpResponseMessageProperty responseProperty = new
HttpResponseMessageProperty() { StatusCode = HttpStatusCode.Unauthorized
};</p>

<p>    responseProperty.Headers.Add(&ldquo;WWW-Authenticate&rdquo;, \
          String.Format(&ldquo;Basic realm=\&rdquo;{0}\&ldquo;&rdquo;, &ldquo;&rdquo;));</p>

<p>    reply.Properties[HttpResponseMessageProperty.Name] =
responseProperty; \
    requestContext.Reply(reply);</p>

<p>    requestContext = null; \
  }</p>

<p>  private SecurityToken ExtractCredentials(Message requestMessage) \
  { \
    HttpRequestMessageProperty request = (HttpRequestMessageProperty) 
requestMessage.Properties[HttpRequestMessageProperty.Name];</p>

<p>    string authHeader = request.Headers[&ldquo;Authorization&rdquo;];</p>

<p>    if (authHeader != null &amp;&amp; authHeader.Contains(&ldquo;&lt;saml&rdquo;)) \
    { \
      XmlTextReader xmlReader = new XmlTextReader(new
StringReader(authHeader));</p>

<p>      var col =
SecurityTokenHandlerCollection.CreateDefaultSecurityTokenHandlerCollection();
\
      SecurityToken token = col.ReadToken(xmlReader); \
                                 \
      return token; \
    }</p>

<p>    return null; \
  }</p>

<p>  private void InitializeSecurityContext(Message request, IPrincipal
principal) \
  { \
    List&lt;IAuthorizationPolicy> policies = new
List&lt;IAuthorizationPolicy>(); \
    policies.Add(new PrincipalAuthorizationPolicy(principal)); \
    ServiceSecurityContext securityContext = new
ServiceSecurityContext(policies.AsReadOnly());</p>

<p>    if (request.Properties.Security != null) \
    { \
      request.Properties.Security.ServiceSecurityContext =
securityContext; \
    } \
    else \
    { \
      request.Properties.Security = new SecurityMessageProperty() {
ServiceSecurityContext = securityContext }; \
     } \
   }</p>

<p>   class PrincipalAuthorizationPolicy : IAuthorizationPolicy \
   { \
     string id = Guid.NewGuid().ToString(); \
     IPrincipal user;</p>

<p>     public PrincipalAuthorizationPolicy(IPrincipal user) \
     { \
       this.user = user; \
     }</p>

<p>     public ClaimSet Issuer \
     { \
       get { return ClaimSet.System; } \
     }</p>

<p>     public string Id \
     { \
       get { return this.id; } \
     }</p>

<p>     public bool Evaluate(EvaluationContext evaluationContext, ref
object state) \
     { \
       evaluationContext.AddClaimSet(this, new
DefaultClaimSet(System.IdentityModel.Claims.Claim.CreateNameClaim(user.Identity.Name)));
\
       evaluationContext.Properties[&ldquo;Identities&rdquo;] = new
List&lt;IIdentity>(new IIdentity[] { user.Identity }); \
       evaluationContext.Properties[&ldquo;Principal&rdquo;] = user; \
       return true; \
     } \
   } \</p>

<p>A WCF Data Service, as any other WCF Service, contains a service host
where this interceptor can be injected. The following code illustrates
how that can be done in the “svc” file.</p>

<p>&lt;%@ ServiceHost Language=&ldquo;C#&rdquo; Debug=&ldquo;true&rdquo;
Service=&ldquo;ContactsDataService&rdquo; \
                Factory=&ldquo;AppServiceHostFactory&rdquo; %></p>

<p>using System; \
 using System.ServiceModel; \
 using System.ServiceModel.Activation; \
 using Microsoft.ServiceModel.Web;</p>

<p>class AppServiceHostFactory : ServiceHostFactory \
 { \
   protected override ServiceHost CreateServiceHost(Type serviceType,
Uri[] baseAddresses) \
  { \
    WebServiceHost2 result = new WebServiceHost2(serviceType, true,
baseAddresses);</p>

<p>    result.Interceptors.Add(new SamlAuthenticationInterceptor()); \
            \
    return result; \
  } \
}</p>

<p>WCF Data Services includes an specific WCF host of out the box
(DataServiceHost). However, the service is not affected at all if you
replace it with a custom one as I am doing in the code above
(WebServiceHost2 is part of the REST Starter kit).</p>

<p>Finally, the client application needs to pass the SAML token somehow to
the data service. In case you are using any Http client library for
consuming the data service, that’s easy to do, you only need to include
the SAML token as part of the “Authorization” header. If you are using
the auto-generated data service proxy, a little piece of code is needed
to inject a SAML token into the DataServiceContext instance. That class
provides an event “SendingRequest” that any client application can
leverage to include custom code that modified the Http request before it
is sent to the service. So, you can easily create an extension method
for the DataServiceContext that negotiates the SAML token with an
existing STS, and adds that token as part of the “Authorization” header.</p>

<p>public static class DataServiceContextExtensions \
 {     </p>

<p>  public static void ConfigureFederatedCredentials(this
DataServiceContext context, string baseStsAddress, string realm) \
  { \
    string address = string.Format(STSAddressFormat, baseStsAddress,
realm); \
             \
    string token = NegotiateSecurityToken(address); \
    context.SendingRequest += (source, args) => \
    { \
      args.RequestHeaders.Add(&ldquo;Authorization&rdquo;, token); \
    }; \
  }</p>

<p>private string NegotiateSecurityToken(string address) \
 { \
 }</p>

<p>}</p>

<p>I left the NegociateSecurityToken method empty for this extension as it
depends pretty much on how you are negotiating tokens from an existing
STS. In case you want to end-to-end REST solution that involves an Http
endpoint for the STS, you should definitely take a look at the
<a href="http://startersts.codeplex.com/">Thinktecture starter STS project</a> in
codeplex.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/04/06/actas-and-onbehalfof-support-in-wif/">ActAs and OnBehalfOf Support in WIF</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-04-06T00:00:00-03:00" pubdate data-updated="true">Apr 6<span>th</span>, 2010</time>
        
         | <a href="/blog/2010/04/06/actas-and-onbehalfof-support-in-wif/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I
<a href="http://weblogs.asp.net/cibrax/archive/2010/01/04/actas-in-ws-trust-1-4.aspx">discussed</a>
a time ago how WIF supported a new WS-Trust 1.4 element, “ActAs”, and
how that element could be used for authentication delegation.  The thing
is that there is another feature in WS-Trust 1.4 that also becomes handy
for this kind of scenario, and I did not mention in that last post,
“OnBehalfOf”.</p>

<p>Shiung Yong wrote an excellent summary about the difference of these two
new features in this forum
<a href="http://social.msdn.microsoft.com/Forums/en-US/Geneva/thread/78e3e93f-0e59-4236-a174-484212b66554">thread</a>.
He basically commented the following,</p>

<p><em>“An ActAs RST element indicates that the requestor wants a token that
contains claims about two distinct entities: the requestor, and an
external entity represented by the token in the ActAs element.</em></p>

<p><em>An OnBehalfOf RST element indicates that the requestor wants a token
that contains claims only about one entity: the external entity
represented by the token in the OnBehalfOf element.</em></p>

<p><em>In short, ActAs feature is typically used in scenarios that require
composite delegation, where the final recipient of the issued token can
inspect the entire delegation chain and see not just the client, but all
intermediaries to perform access control, auditing and other related
activities based on the whole identity delegation chain. The ActAs
feature is commonly used in multi-tiered systems to authenticate and
pass information about identities between the tiers without having to
pass this information at the application/business logic layer.</em></p>

<p><em>OnBehalfOf feature is used in scenarios where only the identity of the
original client is important and is effectively the same as identity
impersonation feature available in the Windows OS today. When the
OnBehalfOf is used the final recipient of the issued token can only see
claims about the original client, and the information about
intermediaries is not preserved. One common pattern where OnBehalfOf
feature is used is the proxy pattern where the client cannot access the
STS directly but is instead communicating through a proxy gateway. The
proxy gateway authenticates the caller and puts information about him
into the OnBehalfOf element of the RST message that it then sends to the
real STS for processing. The resulting token is going to contain only
claims related to the client of the proxy, making the proxy completely
transparent and not visible to the receiver of the issued token.”</em></p>

<p>Going back to WIF, “ActAs” and “OnBehalfOf” are both supported as
extensions methods in the WCF client channel.</p>

<p>public static class ChannelFactoryOperations \
{ \
  public static T CreateChannelActingAs&lt;T>(this ChannelFactory&lt;T>
factory, \
    SecurityToken actAs); \
  \
  public static T CreateChannelOnBehalfOf&lt;T>(this ChannelFactory&lt;T>
factory, \
    SecurityToken onBehalfOf); \
}</p>

<p>Both methods receive the security token with the identity of the
original caller.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/03/15/odata-to-the-rescue-exposing-the-eventlog-as-a-data-feed/">OData to the Rescue. Exposing the Eventlog as a Data Feed</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-03-15T00:00:00-03:00" pubdate data-updated="true">Mar 15<span>th</span>, 2010</time>
        
         | <a href="/blog/2010/03/15/odata-to-the-rescue-exposing-the-eventlog-as-a-data-feed/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In one of the project where I was working one, we used the <a href="http://msdn.microsoft.com/en-us/library/cc309212.aspx">Microsoft
Enterprise Library Exception Application
Block</a>
integration with WCF for logging all the technical issues on the
services/backend in Windows Event Log. This application block worked
like a charm, all the errors were correctly logged on the Event Log
without even needing to modify the service code. However, we also needed
to provide a quick way to expose all those events to the different
system users so they could get access to all the them remotely. In just
a couple of minutes I came up with a simple solution based on ADO.NET
Data Services. ADO.NET data services is very powerful in this sense, you
only need to provide a IQueryable implementation, and that’s all. You
get a RESTful service with rich query support for free.</p>

<p>In this sample, I used Linq to Objects to get the latest entries from
the Event Log, and I also filter the entries by the category used by the
Application Block to avoid loading unnecessary entries in memory.</p>

<p>public class LogDataSource \
    { \
        string source;</p>

<p>        public LogDataSource(string source) \
        { \
            this.source = source; \
        }</p>

<p>        public LogDataSource() \
        { \
        }</p>

<p>        public IQueryable&lt;LogEntry> LogEntries \
        { \
            get { return GetEntries().AsQueryable().OrderBy(e =>
e.TimeGenerated); } \
        }</p>

<p>        private IEnumerable&lt;LogEntry> GetEntries() \
        { \
            var applicationLog =
System.Diagnostics.EventLog.GetEventLogs().Where(e => e.Log ==
&ldquo;Application&rdquo;) \
                .FirstOrDefault();</p>

<p>            var entries = new List&lt;LogEntry>();</p>

<p>            if (applicationLog != null) \
            { \
                foreach (EventLogEntry entry in applicationLog.Entries)
\
                { \
                    if (source == null || entry.Source.Equals(source,
StringComparison.InvariantCultureIgnoreCase)) \
                    { \
                        entries.Add(new LogEntry \
                        { \
                            Category = entry.Category, \
                            EventID = entry.InstanceId, \
                            Message = entry.Message, \
                            TimeGenerated = entry.TimeGenerated, \
                            Source = entry.Source, \
                        }); \
                    } \
                } \
            }</p>

<p>            return entries.OrderByDescending(e => e.TimeGenerated) \
                        .Take(200); \
        } \
    }</p>

<p>LogEntry is class I created for this service to expose an Event Log
Entry.</p>

<p>    [EntityPropertyMappingAttribute(&ldquo;Source&rdquo;, \
        SyndicationItemProperty.Title, \
        SyndicationTextContentKind.Plaintext, true)] \
    [EntityPropertyMapping(&ldquo;Message&rdquo;, \
        SyndicationItemProperty.Summary, \
        SyndicationTextContentKind.Plaintext, true)] \
    [EntityPropertyMapping(&ldquo;TimeGenerated&rdquo;, \
        SyndicationItemProperty.Updated, \
        SyndicationTextContentKind.Plaintext, true)] \
    [DataServiceKey(&ldquo;EventID&rdquo;)] \
    public class LogEntry \
    { \
        public long EventID \
        { \
            get; \
            set; \
        }</p>

<p>        public string Category \
        { \
            get; \
            set; \
        }</p>

<p>        public string Message \
        { \
            get; \
            set; \
        }</p>

<p>        public DateTime TimeGenerated \
        { \
            get; \
            set; \
        }</p>

<p>        public string Source \
        { \
            get; \
            set; \
        }</p>

<p>    }</p>

<p>As you can see, I used the new feature <a href="http://blogs.msdn.com/phaniraj/archive/2009/03/28/ado-net-data-services-friendly-feeds-mapping-edm-types-i.aspx">“Friendly
feeds”</a>
to map several properties in the entries with standard ATOM elements.
The “DataServiceKey” is only necessary because I am using the Reflection
Provider (the exposed IQueryable implementation is just Linq to Objects)
rather than the default Entity Framework Provider.</p>

<p>The data service implementation is also quite simple, just a couple of
lines were needed to expose the data source created previously.</p>

<p>public class LogDataService : DataService&lt;LogDataSource> \
    { \
        public static void InitializeService(IDataServiceConfiguration
config) \
        { \
            config.SetEntitySetAccessRule(&ldquo;*&rdquo;,
EntitySetRights.AllRead); \
        }</p>

<p>        protected override LogDataSource CreateDataSource() \
        { \
            string source =
ConfigurationManager.AppSettings[&ldquo;EventLogSource&rdquo;]; \
            if (source == null) \
            { \
                throw new ApplicationException(&ldquo;The EventLogSource
appsetting is missing in the configuration file&rdquo;); \
            }</p>

<p>            return new LogDataSource(source); \
        } \
    }</p>

<p>With this implementation in place, the final users not only get a feed
with all the latest errors in the event log, but also support for
performing queries against that data. This is one of the great things
about ADO.NET Data services.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/02/18/a-good-way-to-handle-claim-based-security-in-restful-services/">A Good Way to Handle Claim Based Security in RESTful Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-02-18T00:00:00-03:00" pubdate data-updated="true">Feb 18<span>th</span>, 2010</time>
        
         | <a href="/blog/2010/02/18/a-good-way-to-handle-claim-based-security-in-restful-services/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Dominick just
<a href="http://www.leastprivilege.com/SecuringWCFDataServicesUsingWIF.aspx">blogged</a>
what I think is one of the best ways to provide claim based security for
RESTful services at the moment. The idea of using simple web tokens for
RESTful services I’ve been in my head for a while, but I was not able to
find enough the time to implement it. Fortunately, Dominick already did
it for us, so it’s really great to have a sample with that.</p>

<p>One piece that is still missing in this architecture is the possibility
to run an in-house STS for issuing simple web tokens rather than using
the ACL service available as part of Windows Azure AppFabric. It would
be great if we could have some built-in support in WIF to issue simple
web tokens, in other words, a built-in security handler for simple web
tokens, and a RESTful endpoint for requesting those. </p>

<p>The OAuth Wrap specification (the place where the simple web tokens are
defined) also supports the typical ActAs scenario, where a client
application can request a token on behalf of the logged user. This would
be ideal for example, in a web application that want to consume a
RESTful service on behalf of the logged user.    </p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/02/17/the-system-cannot-find-the-file-specified-error-in-the-wif-fam-module/">“the System Cannot Find the File Specified” Error in the WIF FAM Module</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-02-17T00:00:00-03:00" pubdate data-updated="true">Feb 17<span>th</span>, 2010</time>
        
         | <a href="/blog/2010/02/17/the-system-cannot-find-the-file-specified-error-in-the-wif-fam-module/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The Federation Authentication Module (FAM) shipped as part of WIF
protects by the default the session cookies from being tampered with in
passive scenarios using DPAPI. As I mentioned in the past, this
technique simplifies a lot the initial deployment for the whole solution
as nothing extra needs to configured, the automatically generated DPAPI
key is used to protect the cookies, so this might be reason to have that
as default protection mechanism in WSE, WCF and now WIF.</p>

<p>However, this technique has some serious drawbacks from my point of view
that makes it useless for real enterprise scenarios.</p>

<p>If web application that relies on FAM for authenticating the users is
hosted in IIS. The account running the IIS process needs to have a
profile created in order to use DPAPI. A workaround for this is to log
into the machine with that account to create the initial profile or run
some script to do it automatically.</p>

<p>DPAPI is not suitable for web farm scenarios, as the machine key is used
to protect the cookies. If the cookie is protected with one key, the
following requests must be sent to the same machine. A workaround for
this could be to use sticky sessions, so all the user requests from the
same machine are handled by the same machine on the farm.</p>

<p>Fortunately, WIF already provides some built-in classes to replace this
default mechanism by a protection mechanism based on RSA keys with X509
certificates.</p>

<p>The “SecuritySessionHandler” is the handler in WIF that is responsible
for tracking the authentication sessions into a cookie. That handler
receives by default some built-in classes that applies transformations
to the cookie content, such as the DeflatCookieTransform and the
ProtectedDataCookieTransform (for protecting the content with DPAPI).
There are also two other CookieTransform derived classes that are not
used at all, and becomes very handy to enable enterprise scenarios, the
RSAEncryptionCookieTransform and RSASignatureCookieTransform classes.
Both classes receives either a RSA key or X509 certificate that is used
to encrypt or sign the cookie content.</p>

<p>Therefore, you can put the following code in the global.asax file to
replace the default cookie transformations by the ones that use a X509
certificate.</p>

<p>protected void Application_Start(object sender, EventArgs e) \
        { \
            FederatedAuthentication.ServiceConfigurationCreated += new
EventHandler&lt;Microsoft.IdentityModel.Web.Configuration.ServiceConfigurationCreatedEventArgs>(FederatedAuthentication_ServiceConfigurationCreated);
\
            \
        }</p>

<p>        void FederatedAuthentication_ServiceConfigurationCreated(object
sender,
Microsoft.IdentityModel.Web.Configuration.ServiceConfigurationCreatedEventArgs
e) \
        { \
            var cookieProtectionCertificate =
CertificateUtil.GetCertificate(StoreName.My, \
                StoreLocation.LocalMachine, &ldquo;CN=myTestCert&rdquo;); \
             \
            e.ServiceConfiguration.SecurityTokenHandlers.AddOrReplace( \
                new SessionSecurityTokenHandler(new
System.Collections.ObjectModel.ReadOnlyCollection&lt;CookieTransform> ( \
                    new List&lt;CookieTransform> \
                    { \
                        new DeflateCookieTransform(), \
                        new
RsaEncryptionCookieTransform(cookieProtectionCertificate), \
                        new
RsaSignatureCookieTransform(cookieProtectionCertificate) \
                    }) \
                )); \
        }</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/12/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/10/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/20/do-not-version-urls/">Do Not Version Urls</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/23/selfhost-utilities/">SelfHost Utilities</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/23/appfabric-outputcaching/">AppFabric OutputCaching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/31/making-ajax-calls-with-hawk-authentication-to-asp-dot-net-web-api/">Making Ajax Calls With Hawk Authentication to ASP.NET Web API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/13/coordinating-async-work-in-node-dot-js/">Coordinating Async Work in Node.js</a>
      </li>
    
  </ul>
</section>
 <a href="http://feeds.feedburner.com/cibrax"><img src="http://feeds.feedburner.com/~fc/cibrax?bg=FF3300&amp;fg=000000&amp;anim=0" style="border:0" alt="" /></a>

 <script type="text/javascript" language="javascript" src="http://twittercounter.com/embed/?username=cibrax&style=white"></script>
<a href="https://mvp.microsoft.com/en-us/mvp/Pablo%20Cibraro-33800"><img src="/images/mvp.gif" border="0" /></a>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pcibraro">@pcibraro</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pcibraro',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Cibrax -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cibrax';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
