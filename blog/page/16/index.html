
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pablo Cibraro (Cibrax)</title>
  <meta name="author" content="Cibrax">

  
  <meta name="description" content="The other day and friend of mine asked me about portable STS
implementations, if I knew about any available solution that he could
use on his company &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cibrax.me/blog/page/16">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/cibrax" rel="alternate" title="Pablo Cibraro (Cibrax)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44468149-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pablo Cibraro (Cibrax)</a></h1>
  
    <h2>All about software development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/cibrax" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cibrax.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/02/some-thoughts-on-portable-sts-p-sts-and-geneva-cardspace/">Some Thoughts on Portable STS (P-STS) and Geneva Cardspace</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-02T00:00:00-03:00" pubdate data-updated="true">Feb 2<span>nd</span>, 2009</time>
        
         | <a href="/blog/2009/02/02/some-thoughts-on-portable-sts-p-sts-and-geneva-cardspace/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The other day and friend of mine asked me about portable STS
implementations, if I knew about any available solution that he could
use on his company. That reminded me of a conversation I had like two
years ago with another developer working on custom .NET CLR framework
version for portable devices (like smartcards). As part of that project,
his team was also working on a TCP/IP communication stack for the
device, and a http handler for accepting raw WS-TRUST messages. One goal
for that project was to have a P-STS that could be interoperable with
WCF. The idea seemed very promising at time.</p>

<p>So, what is a PSTS after all ?. In a few words, it is a service running
on a portable device that exposes WS-TRUST endpoints and can issue
security tokens of any kind (e.g, SAML tokens).</p>

<p>Making a search today on
<a href="http://www.google.com.ar/search?hl=en&amp;q=Portable+Security+Token+Service">google</a>
will drop several P-STS products or solutions,  some of them also claim
to be interoperable with WCF and Microsoft Cardspace V1.</p>

<p>In terms of identity management, A P-STS really makes a great different
over existing authentication mechanisms like username/password, X509
certificates or any other kind of two-factor authentication device. Most
of these authentication mechanisms are widely accepted and used today in
applications within corporate environments or applications that requires
off-line support. However, sometimes they lack of a truly identity
support, which means that they do not represent the user identity at all
in the context of those applications, they are just a way of identifying
returning users, or they are hard to extend with additional user&rsquo;s
identity claims.</p>

<p>I can not deny that X509 certificates have demonstrated to be a very
effective and secure way to authenticate users. In addition, X509
certificates can be extended with some custom attributes, the space is
limited, but at least there is a possibility. However, X509 certificates
represent hard tokens, the claims stored on a certificate can not be
changed once it has been issued. Therefore, they are a good solution as
long as their information do not change frequently over a period of
time.</p>

<p>Issue tokens (e.g SAML tokens) on other hand are more dynamic and
cheaper to create. They usually have a short expiration time, they can
issued and used  on the fly, but what is more important, they can carry
custom information or claims about the subject it has been issued for.</p>

<p>Some good news is that the Geneva Cardspace team has also announced some
support for roaming scenarios in Cardspace V2. There will be a way to
store our identity cards on a device (or somewhere in the cloud), which
will be great to combine with a P-STS, no need to export/import the
cards anymore. This scenario was not possible in Cardspace V1, and <a href="http://blogs.msdn.com/vbertocci/archive/2008/01/27/on-the-idea-of-portable-sts-p-sts.aspx">here
is the
explanation</a>.
According to what Rich Randall mentioned in the PDC talk &ldquo;BB44 Identity:
Windows CardSpace &#8220;Geneva&rdquo; Under the Hood &ldquo;, the future Cardspace
interface could look as follow,</p>

<p> <img src="/images/legacy/Infocard.jpg" alt="" /></p>

<p> </p>

<p>As you can see, it will not be long until we have complete and portable
identity solutions for roaming scenarios.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/01/28/claims-negotiation-between-a-consumer-sts-and-relying-party-in-wcf/">Claims Negotiation Between a Consumer, STS and Relying Party in WCF</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-28T00:00:00-03:00" pubdate data-updated="true">Jan 28<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/01/28/claims-negotiation-between-a-consumer-sts-and-relying-party-in-wcf/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>According to the WS-Trust specification, a service consumer has a way to
negotiate or ask for specific claims to the STS. Those claims (or some
of them) will be generally used by  the service implementation running
on the relying party.</p>

<p>They are negotiated through an &ldquo;claims&rdquo; element in the RST message,</p>

<p>&lt;wst:RequestSecurityToken xmlns:wst=&ldquo;&hellip;&rdquo;></p>

<p>        &lt;wst:TokenType>&hellip;&lt;/wst:TokenType></p>

<p>        &lt;wst:RequestType>&hellip;&lt;/wst:RequestType></p>

<p>        &hellip;</p>

<p>        &lt;wsp:AppliesTo>&hellip;&lt;/wsp:AppliesTo></p>

<p>        <strong>&lt;wst:Claims Dialect=&ldquo;&hellip;&rdquo;>&hellip;&lt;/wst:Claims></strong></p>

<p>        &lt;wst:Entropy></p>

<p>              &lt;wst:BinarySecret>&hellip;&lt;/wst:BinarySecret></p>

<p>         &lt;/wst:Entropy></p>

<p>        &lt;wst:Lifetime></p>

<p>            &lt;wsu:Created>&hellip;&lt;/wsu:Created></p>

<p>            &lt;wsu:Expires>&hellip;&lt;/wsu:Expires></p>

<p>        &lt;/wst:Lifetime></p>

<p>&lt;/wst:RequestSecurityToken></p>

<p><em>The &ldquo;wst:claims&rdquo; is an optional element for requesting a specific set
of claims. Typically, this element contains required and/or optional
claim information identified in a service&rsquo;s policy.</em></p>

<p>Based on these facts, we can elaborate some possible scenarios for
claims negotiation between these three parties.</p>

<p>​1. <strong>No negotiation at all</strong></p>

<p>The STS might just ignore these claims requirements in the RST message
and always returns a fixed claim set according to the consumer identity,
or the service might not express what claims it expects at all. This
scenario might be suitable for a local STS in small-sized or
medium-sized organizations, where the IT department has a complete
control over the client applications and services that interact with
that STS. This kind of solution is easier to implement, and quite rigid
too, a change in the claims required by the service will also require
changes in the STS implementation. As you see, this solution does not
scale at all for a high number of applications or relying party
services.</p>

<p>Many of the STS examples you will find today are implemented like this.</p>

<p>​2. <strong>Negotiation based on the AppliesTo header</strong>.</p>

<p>This solution present a subtle difference with the one discussed before,
the claims vary according the relying party that will make use of them.
The STS ignores the claims requirements in the RST messages and returns
a claim set based on the received AppliesTo header. An existing
agreement must exist between the STS and the relying party, which will
include in addition to the key for encrypting the tokens, a number of
expected claims.  Again, easy to implement, difficult to scale up.</p>

<p>​3. <strong>Manual negotiation based on the &ldquo;Claims&rdquo; header</strong>.</p>

<p>In this scenario, the consumer sends the expected claims in the &ldquo;claims&rdquo;
header and the STS makes use of them for generating the resulting token.
However, the negotiation of those claims between the consumer and the
relying party is manual, a previous agreement must exist, the service
does not express those requirements through metadata. This means that
the claims are hard-coded during development in the client
configuration.  If the service requires additional claims, only the
client configuration will have to be changed, the STS does not have to
be touched at all.</p>

<p>If you are implementing a custom STS with the latest Microsoft Geneva
bits, there is a property &ldquo;Claims&rdquo; in the RequestSecurityToken for
getting access to these values.</p>

<p>protected override IClaimsIdentity
GetOutputClaimsIdentity(IClaimsPrincipal principal, RequestSecurityToken
request, Scope scope)</p>

<p>{</p>

<p>    IClaimsIdentity outputIdentity = new ClaimsIdentity();</p>

<p> </p>

<p>    foreach (Claim claim in request.Claims)</p>

<p>    {</p>

<p>        //Do something&hellip;</p>

<p> </p>

<p>        outputIdentity.Claims.Add(&hellip;);</p>

<p>    }</p>

<p> </p>

<p>    return outputIdentity;</p>

<p>}</p>

<p>The client can specify those claims through configuration as well,</p>

<p>&lt;wsFederationHttpBinding></p>

<p>  &lt;binding name=&ldquo;ServiceBinding&rdquo;></p>

<p>    &lt;security mode=&ldquo;Message&rdquo;></p>

<p>      &lt;message
issuedTokenType=&ldquo;<a href="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1">http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1</a>&rdquo;
negotiateServiceCredential=&ldquo;false&rdquo;></p>

<p>        &lt;claimTypeRequirements></p>

<p>          &lt;add claimType
=&ldquo;<a href="http://schemas.microsoft.com/ws/2005/05/identity/claims/EmailAddress">http://schemas.microsoft.com/ws/2005/05/identity/claims/EmailAddress</a>&rdquo;/></p>

<p>          &lt;add claimType
=&ldquo;<a href="http://schemas.microsoft.com/ws/2005/05/identity/claims/GivenName">http://schemas.microsoft.com/ws/2005/05/identity/claims/GivenName</a>&rdquo;/></p>

<p>          &lt;add claimType
=&ldquo;<a href="http://schemas.microsoft.com/ws/2005/05/identity/claims/Surname">http://schemas.microsoft.com/ws/2005/05/identity/claims/Surname</a>&rdquo;
isOptional =&ldquo;true&rdquo;/></p>

<p>        &lt;/claimTypeRequirements></p>

<p>        &lt;issuer>&lt;/issuer></p>

<p>      &lt;/message></p>

<p>    &lt;/security></p>

<p>  &lt;/binding></p>

<p>&lt;/wsFederationHttpBinding></p>

<p>Once they are added to the binding configuration, WCF will automatically
include them as part of the RST message to the STS.</p>

<p>​4. <strong>Automatic negotiation based on the &ldquo;Claims&rdquo; header</strong>.</p>

<p>This is by far the best solution we can find. The three parties
automatically negotiates the claims at runtime,</p>

<ol type="a">
<li>The service exposes the claim requirements through metadata
(WS-Policy)</li>
</ol>


<p>​II. The client acquires the service&rsquo;s policy and requirements using
some mechanism that could be WS-MetatadaExchange.  Later,  the client
includes some claim requirements into the RST message that will be send
to the STS.</p>

<p>​III. The STS extracts those requirements from the RST message, and
then, it makes use of them for generating the resulting token.</p>

<p>The Cardspace identity selector on the consumer side works like this. It
first detects what claims are needed by the Relying Party, and then,
displays all the possible cards (From different Identity providers) that
satisfy those requirements to the user.</p>

<p>Exposing the claim requirements on the relying party through WCF is
equivalent to do it on the client side (same binding configuration),</p>

<p>&lt;wsFederationHttpBinding></p>

<p>  &lt;binding name=&ldquo;ServiceBinding&rdquo;></p>

<p>    &lt;security mode=&ldquo;Message&rdquo;></p>

<p>      &lt;message
issuedTokenType=&ldquo;<a href="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1">http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1</a>&rdquo;></p>

<p>        &lt;claimTypeRequirements></p>

<p>          &lt;add claimType
=&ldquo;<a href="http://schemas.microsoft.com/ws/2005/05/identity/claims/EmailAddress">http://schemas.microsoft.com/ws/2005/05/identity/claims/EmailAddress</a>&rdquo;/></p>

<p>          &lt;add claimType
=&ldquo;<a href="http://schemas.microsoft.com/ws/2005/05/identity/claims/GivenName">http://schemas.microsoft.com/ws/2005/05/identity/claims/GivenName</a>&rdquo;/></p>

<p>          &lt;add claimType
=&ldquo;<a href="http://schemas.microsoft.com/ws/2005/05/identity/claims/Surname">http://schemas.microsoft.com/ws/2005/05/identity/claims/Surname</a>&rdquo;
isOptional =&ldquo;true&rdquo;/></p>

<p>        &lt;/claimTypeRequirements></p>

<p>        &lt;issuer>&lt;/issuer></p>

<p>      &lt;/message></p>

<p>    &lt;/security></p>

<p>  &lt;/binding></p>

<p>&lt;/wsFederationHttpBinding></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/01/19/running-a-partial-ssl-website-in-asp-net-mvc/">Running a Partial SSL Website With ASP.NET MVC</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-19T00:00:00-03:00" pubdate data-updated="true">Jan 19<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/01/19/running-a-partial-ssl-website-in-asp-net-mvc/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.pluralsight.com/community/blogs/keith/archive/2009/01/17/sslhelper-get-help-running-a-partial-ssl-website-in-asp-net.aspx">Keith
Brown</a>
has just released a helper class (Based on an <a href="http://www.leastprivilege.com/CommentView.aspx?guid=50a39e64-caab-4fbd-b8e1-2be06b2e6081">original
implementation</a>
made by Dominick Baier) with very useful methods for mixing Http and
Https in a regular asp.net application. Before jumping in this post,
make sure to read his post (And Dominick&rsquo;s) to understand all the
problems you may have to deal with when implementing a partial SSL
website.</p>

<p>Running a partial SSL website in ASP.NET MVC is not much different,
however, in MVC, we can leverage the existing and powerful routing
mechanism to implement similar features.</p>

<p><strong>Switching to SSL through an ASP.NET Module</strong></p>

<p>This module  basically inspects the URL and does a redirect based on
some configuration where you specify routes that should be SSL
protected.</p>

<p>public void ProcessRequest(HttpContext context)</p>

<p>{</p>

<p>    if(Authentication.IsSslRequired() &amp;&amp;
context.Request.HttpMethod.Equals(&ldquo;get&rdquo;,
StringComparison.OrdinalIgnoreCase))</p>

<p>    {</p>

<p>        var data = RouteTable.Routes.GetRouteData(new
HttpContextWrapper(context));</p>

<p>        if (data != null)</p>

<p>        {</p>

<p>            if (!context.Request.IsSecureConnection)</p>

<p>            {</p>

<p>                if(data.DataTokens[&ldquo;isSecure&rdquo;] != null &amp;&amp;
(bool)data.DataTokens[&ldquo;isSecure&rdquo;])</p>

<p>                {</p>

<p>                    //Do redirect to https</p>

<p>                    var secureUrl =
context.Request.Url.ToString().ToSslUrl();</p>

<p>                    context.Response.Redirect(secureUrl, true);</p>

<p>                }</p>

<p>            }</p>

<p>            else</p>

<p>            {</p>

<p>                if (data.DataTokens[&ldquo;isSecure&rdquo;] == null ||
!((bool)data.DataTokens[&ldquo;isSecure&rdquo;]))</p>

<p>                {</p>

<p>                    //Do redirect to http</p>

<p>                    var unsecureUrl =
context.Request.Url.ToString().ToUnsecureUrl();</p>

<p>                    context.Response.Redirect(unsecureUrl, true);</p>

<p>                }</p>

<p>            }</p>

<p>        }</p>

<p>    }</p>

<p>}</p>

<p>As you can see in the code above, the module checks whether the page
should be ssl protected using a custom data token (IsSecure) that was
previously configured for the route, and afterwards, it redirects the
request according to that setting. For instance, if the route requires
to be the secure (IsSecure = true), and the request was actually made
through http, the module will redirect the request to https.</p>

<p>The absolute URLs are built using some extensions methods (ToSslUrl and
ToUnsecureUrl) that I will show later in this post.</p>

<p>Authentication.IsSslRequired is just an configuration setting that we
can use to skip all these checks during development.</p>

<p>public class Authentication</p>

<p>{</p>

<p>    public static bool IsSslRequired()</p>

<p>    {</p>

<p>        var setting = ConfigurationManager.AppSettings[&ldquo;RequireSSL&rdquo;];</p>

<p>        if (setting != null)</p>

<p>        {</p>

<p>            return bool.Parse(setting);</p>

<p>        }</p>

<p> </p>

<p>        return false;</p>

<p>    }</p>

<p>}</p>

<p> </p>

<p>&lt;appSettings></p>

<p>  &lt;add key=&ldquo;RequireSSL&rdquo; value=&ldquo;True&rdquo;/></p>

<p>&lt;/appSettings></p>

<p>The code for setting the custom data token in the MVC route looks as
follow,</p>

<p>routes.MapRoute(</p>

<p>    &ldquo;MyAccount/PasswordChange&rdquo;,</p>

<p>    &ldquo;MyAccount/PasswordChange&rdquo;,</p>

<p>    new { controller = &ldquo;Accounts&rdquo;, action = &ldquo;PasswordChange&rdquo; }</p>

<p>).DataTokens = new RouteValueDictionary(new { isSecure = true });</p>

<p>**** </p>

<p><strong>Extension methods for generating absolute URLs</strong></p>

<p>As I showed before in the ASP.NET Module, two extensions methods were
used to generate absolute URLs. I just based their implementation on
some code originally written by Troy Goode in this
<a href="http://www.squaredroot.com/post/2008/06/MVC-and-SSL.aspx">post</a>. \</p>

<p>/// &lt;summary></p>

<p>/// Provides helper extensions for turning strings into fully-qualified
and SSL-enabled Urls.</p>

<p>/// &lt;/summary></p>

<p>public static class UrlStringExtensions</p>

<p>{</p>

<p>    /// &lt;summary></p>

<p>    /// Takes a relative or absolute url and returns the fully-qualified
url path.</p>

<p>    /// &lt;/summary></p>

<p>    /// &lt;param name=&ldquo;text&rdquo;>The url to make fully-qualified. Ex:
Home/About&lt;/param></p>

<p>    /// &lt;returns>The absolute url plus protocol, server, &amp; port. Ex:
<a href="http://localhost:1234/Home/About&lt;/returns>&#8220;>http://localhost:1234/Home/About&lt;/returns></a></p>

<p>    public static string ToFullyQualifiedUrl( this string text )</p>

<p>    {</p>

<p>        var oldUrl = text;</p>

<p>        var oldUrlArray = ( oldUrl.Contains( &ldquo;?&rdquo; ) ? oldUrl.Split( &lsquo;?&rsquo; )
: new[]{ oldUrl, &ldquo;&rdquo; } );</p>

<p> </p>

<p>        var requestUri = HttpContext.Current.Request.Url;</p>

<p>        var localPathAndQuery = requestUri.LocalPath + requestUri.Query;</p>

<p>        var urlBase = requestUri.AbsoluteUri.Substring( 0,
requestUri.AbsoluteUri.Length &ndash; localPathAndQuery.Length );</p>

<p> </p>

<p>        var newUrl = VirtualPathUtility.ToAbsolute( oldUrlArray[0] );</p>

<p>        if( !string.IsNullOrEmpty( oldUrlArray[1] ) )</p>

<p>            newUrl += &ldquo;?&rdquo; + oldUrlArray[1];</p>

<p> </p>

<p>        return urlBase + newUrl;</p>

<p>    }</p>

<p> </p>

<p>    /// &lt;summary></p>

<p>    /// Looks for Html links in the passed string and turns each
relative or absolute url and returns the fully-qualified url path.</p>

<p>    /// &lt;/summary></p>

<p>    /// &lt;param name=&ldquo;text&rdquo;>The url to make fully-qualified. Ex: &lt;a
href=&ldquo;Home/About&rdquo;>Blah&lt;/a>&lt;/param></p>

<p>    /// &lt;returns>The absolute url plus protocol, server, &amp; port. Ex:
&lt;a href=&ldquo;<a href="http://localhost:1234/Home/About">http://localhost:1234/Home/About</a>&rdquo;>Blah&lt;/a>&lt;/returns></p>

<p>    public static string ToFullyQualifiedLink( this string text )</p>

<p>    {</p>

<p>        var regex = new Regex(</p>

<p>           
&ldquo;(?&lt;Before>&lt;a.*href=\&rdquo;)(?!http)(?&lt;Url>.*?)(?&lt;After>\&ldquo;.+>)&rdquo;,</p>

<p>            RegexOptions.Multiline | RegexOptions.IgnoreCase</p>

<p>            );</p>

<p> </p>

<p>        return regex.Replace( text, ( Match m ) =></p>

<p>                                    m.Groups[&ldquo;Before&rdquo;].Value +</p>

<p>                                    ToFullyQualifiedUrl(
m.Groups[&ldquo;Url&rdquo;].Value ) +</p>

<p>                                    m.Groups[&ldquo;After&rdquo;].Value</p>

<p>            );</p>

<p>    }</p>

<p> </p>

<p>    /// &lt;summary></p>

<p>    /// Takes a relative or absolute url and returns the fully-qualified
url path using the Https protocol.</p>

<p>    /// &lt;/summary></p>

<p>    /// &lt;param name=&ldquo;text&rdquo;>The url to make fully-qualified. Ex:
Home/About&lt;/param></p>

<p>    /// &lt;returns>The absolute url plus server, &amp; port using the Https
protocol. Ex: <a href="https://localhost:1234/Home/About&lt;/returns>&#8220;>https://localhost:1234/Home/About&lt;/returns></a></p>

<p>    public static string ToSslUrl( this string text )</p>

<p>    {</p>

<p>        if (IsSslRequired())</p>

<p>        {</p>

<p>            string absoluteUrl = null;</p>

<p>            if (text.StartsWith(&ldquo;<a href="http://">http://</a>&rdquo;,
StringComparison.OrdinalIgnoreCase) || text.StartsWith(&ldquo;<a href="https://">https://</a>&rdquo;,
StringComparison.OrdinalIgnoreCase))</p>

<p>                absoluteUrl = text;</p>

<p>            else</p>

<p>                absoluteUrl = ToFullyQualifiedUrl(text);</p>

<p> </p>

<p>            return absoluteUrl.Replace(&ldquo;<a href="http:">http:</a>&rdquo;, &ldquo;<a href="https:">https:</a>&rdquo;);</p>

<p>        }</p>

<p>        else</p>

<p>        {</p>

<p>            return text;</p>

<p>        }</p>

<p>    }</p>

<p> </p>

<p>    /// &lt;summary></p>

<p>    /// Takes a relative or absolute url and returns the fully-qualified
url path using the Http protocol.</p>

<p>    /// &lt;/summary></p>

<p>    /// &lt;param name=&ldquo;text&rdquo;>The url to make fully-qualified. Ex:
Home/About&lt;/param></p>

<p>    /// &lt;returns>The absolute url plus server, &amp; port using the Http
protocol. Ex: <a href="http://localhost:1234/Home/About&lt;/returns>&#8220;>http://localhost:1234/Home/About&lt;/returns></a></p>

<p>    public static string ToUnsecureUrl(this string text)</p>

<p>    {</p>

<p>        string absoluteUrl = null;</p>

<p>        if (text.StartsWith(&ldquo;<a href="http://">http://</a>&rdquo;,
StringComparison.OrdinalIgnoreCase) || text.StartsWith(&ldquo;<a href="https://">https://</a>&rdquo;,
StringComparison.OrdinalIgnoreCase))</p>

<p>            absoluteUrl = text;</p>

<p>        else</p>

<p>            absoluteUrl = ToFullyQualifiedUrl(text);</p>

<p> </p>

<p>        return absoluteUrl.Replace(&ldquo;<a href="https:">https:</a>&rdquo;, &ldquo;<a href="http:">http:</a>&rdquo;);</p>

<p>    }</p>

<p> </p>

<p>    /// &lt;summary></p>

<p>    /// Looks for Html links in the passed string and turns each
relative or absolute url into a fully-qualified url path using the Https
protocol.</p>

<p>    /// &lt;/summary></p>

<p>    /// &lt;param name=&ldquo;text&rdquo;>The url to make fully-qualified. Ex: &lt;a
href=&ldquo;Home/About&rdquo;>Blah&lt;/a>&lt;/param></p>

<p>    /// &lt;returns>The absolute url plus server, &amp; port using the Https
protocol. Ex: &lt;a
href=&ldquo;<a href="https://localhost:1234/Home/About">https://localhost:1234/Home/About</a>&rdquo;>Blah&lt;/a>&lt;/returns></p>

<p>    public static string ToSslLink( this string text )</p>

<p>    {</p>

<p>        if (IsSslRequired())</p>

<p>        {</p>

<p>            return ToFullyQualifiedLink(text).Replace(&ldquo;<a href="http:">http:</a>&rdquo;,
&ldquo;<a href="https:">https:</a>&rdquo;);</p>

<p>        }</p>

<p>        else</p>

<p>        {</p>

<p>            return ToFullyQualifiedLink(text);</p>

<p>        }</p>

<p>    }</p>

<p> </p>

<p>    private static bool IsSslRequired()</p>

<p>    {</p>

<p>        return Authentication.IsSslRequired();</p>

<p>    }</p>

<p>}</p>

<p>\
They can be used from a view as well to generate links with complete
Urls,</p>

<p>&lt;a href=&lsquo;&lt;% =Url.Action(&ldquo;PasswordChange&rdquo;, &ldquo;Accounts&rdquo;).ToSslUrl()
%>&rsquo;>Change your password&lt;/a></p>

<p><strong>Gettting an absolute URL within a controller</strong></p>

<p>For some scenarios, we might need to redirect the user from a secure
route to a regular route or viceversa within a controller. In those
cases, we should have a way to generate a complete URL from a controller
method and used it later with a RedirectResult (This is also useful when
you want to include a link to a web page in an email sent by your
website).</p>

<p>For instance, it would be very helpful to have something like this,</p>

<p>return new RedirectResult(this.FullActionUrl&lt;MyController>(c =>
c.SecureMethod(), &ldquo;https&rdquo;));</p>

<p>Where &ldquo;FullActionUrl&rdquo; is an extension method for the Controller class.
In addition to the controller method we want to use to get the absolute
route (&ldquo;SecureMethod&rdquo;), we can also specify the scheme to be used with
that route.</p>

<p>The code for doing that is shown bellow (They are part of the .NETfx
project,
<a href="http://code.google.com/p/netfx/">http://code.google.com/p/netfx/</a>)</p>

<p>/// &lt;summary></p>

<p>/// Returns the full URL for performing an invocation to an action based</p>

<p>/// on an expression representing an invocation to a controller method</p>

<p>/// that may include arguments.</p>

<p>/// &lt;/summary></p>

<p>/// &lt;typeparam name=&ldquo;T&rdquo;>Type of the controller to call to. Can be
omitted as it can be inferred from the action type.&lt;/typeparam></p>

<p>/// &lt;param name=&ldquo;controller&rdquo;>The controller performing the
call.&lt;/param></p>

<p>/// &lt;param name=&ldquo;action&rdquo;>The action containing the call.&lt;/param></p>

<p>public static string FullActionUrl&lt;T>(this Controller controller,
Expression&lt;Action&lt;T>> action, string scheme)</p>

<p>    where T : Controller</p>

<p>{</p>

<p>    string host = controller.HttpContext.Request.Url.Authority;</p>

<p>    string virtualPath = ActionUrl(controller, action);</p>

<p> </p>

<p>    return string.Format(&ldquo;{0}://{1}{2}&rdquo;, scheme, host, virtualPath);</p>

<p>}</p>

<p> </p>

<p>/// &lt;summary></p>

<p>/// Returns the URL for performing an invokation to an action based</p>

<p>/// on an expression representing an invocation to a controller method</p>

<p>/// that may include arguments.</p>

<p>/// &lt;/summary></p>

<p>/// &lt;typeparam name=&ldquo;T&rdquo;>Type of the controller to call to. Can be
omitted as it can be inferred from the action type.&lt;/typeparam></p>

<p>/// &lt;param name=&ldquo;controller&rdquo;>The controller performing the
call.&lt;/param></p>

<p>/// &lt;param name=&ldquo;action&rdquo;>The action containing the call.&lt;/param></p>

<p>public static string ActionUrl&lt;T>(this ControllerBase controller,
Expression&lt;Action&lt;T>> action)</p>

<p>    where T : Controller</p>

<p>{</p>

<p>    var call = ControllerExpression.GetMethodCall&lt;T>(action);</p>

<p> </p>

<p>    string actionName = call.Method.Name;</p>

<p>    string controllerName =
ControllerExpression.GetControllerName&lt;T>();</p>

<p> </p>

<p>    var values = LinkBuilder.BuildParameterValuesFromExpression(call);</p>

<p>    values.Add(&ldquo;action&rdquo;, actionName);</p>

<p>    values.Add(&ldquo;controller&rdquo;, controllerName);</p>

<p> </p>

<p>    var vpd =
RouteTable.Routes.GetVirtualPath(controller.ControllerContext, values);</p>

<p>    string target = null;</p>

<p>    if (vpd != null)</p>

<p>    {</p>

<p>        target = vpd.VirtualPath;</p>

<p>    }</p>

<p> </p>

<p>    return target;</p>

<p>}</p>

<p>The complete code is available to download from
<a href="/images/legacy/MVC.SSL.zip">here</a>. </p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/01/08/describing-restful-applications/">Describing RESTful Applications</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-08T00:00:00-03:00" pubdate data-updated="true">Jan 8<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/01/08/describing-restful-applications/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The other day I came across <a href="http://www.infoq.com/articles/subbu-allamaraju-rest">this interesting
article</a> written by
<a href="http://www.subbu.org/">Subbu Allamaraju</a>, where he discusses some of
the aspects that drive the design of a pure and self-describing RESTful
interface for a service (Or service contract in other words).</p>

<p>He points out three main pieces that every service contract should have:</p>

<p>​1. An uniform interface. An uniform interface is probably one the
aspects that we best know about REST, or we may heard often when a REST
service is described. This refers to the fact that each service exposes
the same interface, which is a good thing for eliminating ad hoc
messages and focusing primarily on an standard API that defines pieces
of information that can be retrieved and manipulated. Instead of adding
special function calls or interfaces to the architecture, new services
add new pieces of information can be manipulated using standard
requests. For instance, in Http RESTful services, this point involves
using standard http verbs, headers and status codes.</p>

<p>​2. Resource representations based on media types. This is quite
interesting, what he proposes is to use a more specialized
&ldquo;content-type&rdquo; for any of the xml schemas that a service may return. He
confirms that generic media types such as &ldquo;application/xml&rdquo; are not
enough to distinguish resource representations. We might want to know if
the resource represents an account or a customer without making any
assumptions about the resource&rsquo;s URI. In those cases, content types like
&ldquo;application/vnd.bank.org.accounts+xml&rdquo; or
&ldquo;application/vnd.bank.org.customers+xml&rdquo; would be more helpful and still
being valid according to the spec  &ldquo;rfc3023, XML media types&rdquo;.</p>

<p>200 OK \
<strong>Content-Type: application/vnd.bank.org.account+xml</strong></p>

<p>&lt;accounts xmlns=&ldquo;urn:org:bank:accounts&rdquo;> \
    &lt;account> \
        &lt;id>AZA12093&lt;/id>        \
        &lt;balance currency=&ldquo;USD&rdquo;>993.95&lt;/balance> \
    &lt;/account> \
&lt;/accounts></p>

<p>​3. Contextual links to resources. In addition to the resource
representation, the client should also receive links representing what
it can do next (Taking the form of a workflow). As Subbu concludes, this
aspect decouples the client from the actual URIs of resources, and the
client does not need to know the rest of the URIs until run-time.</p>

<p>200 OK \
Content-Type: application/vnd.bank.org.account+xml;charset=UTF-8</p>

<p>&lt;accounts xmlns=&ldquo;urn:org:bank:accounts&rdquo;> \
    &lt;account> \
        &lt;id>AZA12093&lt;/id> \
        <strong>&lt;link
href=&ldquo;</strong><a href="http://bank.org/account/AZA12093"><strong>http://bank.org/account/AZA12093</strong></a><strong>&rdquo;
rel=&ldquo;self&rdquo;/> \
        &lt;link
rel=&ldquo;</strong><a href="http://bank.org/rel/transfer"><strong>http://bank.org/rel/transfer</strong></a><strong>edit&rdquo;
\
              type=&ldquo;application/vnd.bank.org.transfer+xml&rdquo; \
             
href=&ldquo;</strong><a href="http://bank.org/transfers%22/"><strong>http://bank.org/transfers&#8221;/</strong></a><strong>>
\
        &lt;link
rel=&rdquo;</strong><a href="http://bank.org/rel/customer"><strong>http://bank.org/rel/customer</strong></a><strong>&ldquo;
\
              type=&#8221;application/vnd.bank.org.customer+xml&rdquo; \
             
href=&ldquo;</strong><a href="http://bank.org/customer/7t676323a%22/"><strong>http://bank.org/customer/7t676323a&#8221;/</strong></a><strong>>
\
</strong>        &lt;balance currency=&#8221;USD&rdquo;>993.95&lt;/balance> \
    &lt;/account> \
    &hellip;..</p>

<p>As you can see in the example above, the account representation contains
links to itself (Self link) and other resources. The operations that can
be performed over those resources are expressed by the &ldquo;rel&rdquo; attribute.</p>

<p>Altough there is not built-in support in WCF to enforce these aspects
automatically, it can be easily done in the service implementation using
specific data contracts and the WebOperationContext. </p>

<p>Setting up the content type before returning the service response:</p>

<p>public Account GetAccount(string id)</p>

<p>{</p>

<p>  WebOperationContext.Current.OutgoingResponse.ContentType =
&ldquo;application/vnd.bank.org.account+xml&rdquo;;</p>

<p>  return repository.Accounts.Where(a => a.Id == id).FirstOrDefault();</p>

<p>}</p>

<p>A link can be modeled as a regular data contract:</p>

<p>[DataContract(Name=&ldquo;link&rdquo;)]</p>

<p>public class Link</p>

<p>{</p>

<p>   [DataMember(Name=&ldquo;href&rdquo;)]</p>

<p>   public string Href { get; set; }</p>

<p> </p>

<p>   [DataMember(Name = &ldquo;rel&rdquo;)]</p>

<p>   public string Rel { get; set; }</p>

<p> </p>

<p>   [DataMember(Name = &ldquo;type&rdquo;)]</p>

<p>   public string Type { get; set; }</p>

<p>}</p>

<p>Read the <a href="http://www.infoq.com/articles/subbu-allamaraju-rest">article</a>
for more information.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/12/23/sticky-notes-pluggin-for-visual-studio-2008/">Sticky Notes Plugin for Visual Studio 2008</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-12-23T00:00:00-03:00" pubdate data-updated="true">Dec 23<span>rd</span>, 2008</time>
        
         | <a href="/blog/2008/12/23/sticky-notes-pluggin-for-visual-studio-2008/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>My good friend <a href="http://www.clariusconsulting.net/blogs/pga/">Pablo
Galiano</a> has released a
pretty cool plug-in for Visual Studio 2008, <a href="http://stickynotes4code.com/">Sticky
Notes</a>. In a few words, this extension
allows you to attach <a href="http://stickynotes4code.com/Screenshots.aspx">sticky notes to your
code</a>, which can be
personal notes (Only visible to you) or team notes (visible to the
entire team).</p>

<p>Give it a try!!.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/12/11/testing-wcf-rest-services/">Testing WCF REST Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-12-11T00:00:00-03:00" pubdate data-updated="true">Dec 11<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/12/11/testing-wcf-rest-services/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Many of the WCF services that we build today rely on the WCF context
(OperationContext and WebOperationContext) for performing different
things, specially REST services where the context is necessary for
settings and getting Http status codes or headers. The fact that the WCF
context does not expose interfaces or base classes complicates the unit
testing a lot. In this sense, I like the approach taken by the ASP.NET
MVC team, all the classes exposed by the HttpContext as properties are
base classes, so they can be easily mocked. \
In order to test a WCF service with what we have today, we have to
either test the service as a black box (integration tests, which
requires a lot of plumbing code to setup all the WCF infrastructure for
the test, channels, host, client, etc) or create some wrappers to
encapsulate the WCF context behavior, as I mentioned in this post <a href="http://weblogs.asp.net/cibrax/archive/2008/05/16/unit-tests-for-wcf.aspx">&ldquo;Unit
tests for WCF
services&rdquo;</a></p>

<p>Today I will discuss both approaches more in detail with some sample
code. The service implementation I will use here is a simple service
that given a category returns a feed with products associated to that
specific category.</p>

<p>[ServiceContract]</p>

<p>public interface IProductCatalog</p>

<p>{</p>

<p>    [WebGet(UriTemplate = &ldquo;?category={category}&rdquo;)]</p>

<p>    [OperationContract]</p>

<p>    Atom10FeedFormatter GetProducts(string category);</p>

<p>}</p>

<p> </p>

<p>public Atom10FeedFormatter GetProducts(string category)</p>

<p>{</p>

<p>    var items = new List&lt;SyndicationItem>();</p>

<p>    foreach(var product in repository.GetProducts(category))</p>

<p>    {</p>

<p>        items.Add(new SyndicationItem()</p>

<p>        {</p>

<p>            Id = String.Format(CultureInfo.InvariantCulture,
&ldquo;<a href="http://products/">http://products/</a>{0}&rdquo;, product.Id),</p>

<p>            Title = new TextSyndicationContent(product.Name),</p>

<p>            LastUpdatedTime = new DateTime(2008, 7, 1, 0, 0, 0,
DateTimeKind.Utc),</p>

<p>            Authors =</p>

<p>            {</p>

<p>                new SyndicationPerson()</p>

<p>                {</p>

<p>                    Name = &ldquo;cibrax&rdquo;</p>

<p>                }</p>

<p>            },</p>

<p>            Content = new TextSyndicationContent(string.Format(&ldquo;Category
Id {0} &ndash; Price {1}&rdquo;,</p>

<p>                product.Category, product.UnitPrice))</p>

<p>        });</p>

<p>    }</p>

<p> </p>

<p>    var feed = new SyndicationFeed()</p>

<p>    {</p>

<p>        Id = &ldquo;<a href="http://Products">http://Products</a>&rdquo;,</p>

<p>        Title = new TextSyndicationContent(&ldquo;Product catalog&rdquo;),</p>

<p>        Items = items</p>

<p>    };</p>

<p> </p>

<p>    MyWebContext.Current.OutgoingResponse.ContentType =
&ldquo;application/atom+xml&rdquo;;</p>

<p>    return feed.GetAtom10Formatter();</p>

<p>}</p>

<p>As you can see, this is a regular WCF service with the following
characteristics,</p>

<p>​1. The products are queried from a product repository, a class that
implements IProductRepository so it can be mocked.</p>

<p>public interface IProductRepository</p>

<p>{</p>

<p>    IQueryable&lt;Product> GetProducts(string category);</p>

<p>}</p>

<p>​2. It is not using the WCF context (WebOperationContext), it is using
MyWebContext instead. This is a custom class I created for wrapping the
WCF context behavior. As we will see later, this class will help us to
mock the WCF context in the unit tests.</p>

<p>public class MyWebContext : IDisposable</p>

<p>{</p>

<p>    private const string TlsName = &ldquo;webContext&rdquo;;</p>

<p> </p>

<p>    public MyWebContext(IWebOperationContext context)</p>

<p>    {</p>

<p>        var tls = Thread.GetNamedDataSlot(TlsName);</p>

<p>        Thread.SetData(tls, context);</p>

<p>    }</p>

<p> </p>

<p>    public static IWebOperationContext Current</p>

<p>    {</p>

<p>        get</p>

<p>        {</p>

<p>            var tls = Thread.GetNamedDataSlot(TlsName);</p>

<p>            var context = Thread.GetData(tls);</p>

<p> </p>

<p>            if (context != null)</p>

<p>            {</p>

<p>                return (IWebOperationContext)context;</p>

<p>            }</p>

<p>            else</p>

<p>            {</p>

<p>                return new
WebOperationContextWrapper(WebOperationContext.Current);</p>

<p>            }</p>

<p>        }</p>

<p>    }</p>

<p> </p>

<p>    public void Dispose()</p>

<p>    {</p>

<p>        var tls = Thread.GetNamedDataSlot(TlsName);</p>

<p>        Thread.SetData(tls, null);</p>

<p>    }</p>

<p>}</p>

<p>The Current property of this class first tries to get an
IWebOperationContext from the thread local storage (That could be set by
the unit tests), and if none is available, it returns a wrapper to the
original WCF context.</p>

<p><strong>Integration Tests</strong></p>

<p>Integration tests focus more on testing the service as a whole, checking
not only the service behavior but also extensions in the WCF channel
stack and any other external dependency referenced by the service
itself. Integration tests are preferred over unit tests for certain
scenarios, if I want to test for instance how a service behaves with an
built-in extension for &ldquo;conditional gets&rdquo; in the WCF channel stack, that
can be easily done with an integration test.</p>

<p>Integration tests usually have the following structure:</p>

<p>​1. Some code to setup the WCF host, usually located at the beginning of
the test or as part of the test fixture initializer.</p>

<p>​2. The service invocation itself using a previously initialized web
http request or an specific WCF channel.</p>

<p>[TestMethod]</p>

<p>public void ShouldGetProductsFeed()</p>

<p>{</p>

<p>    ProductCatalog catalog = new ProductCatalog(</p>

<p>        new InMemoryProductRepository(</p>

<p>            new List&lt;Product>{</p>

<p>            new Product { Id = &ldquo;1&rdquo;, Category = &ldquo;foo&rdquo;, Name = &ldquo;Foo1&rdquo;,
UnitPrice = 1 },</p>

<p>            new Product { Id = &ldquo;2&rdquo;, Category = &ldquo;bar&rdquo;, Name = &ldquo;bar2&rdquo;,
UnitPrice = 2 }</p>

<p>        }));</p>

<p> </p>

<p>    WebServiceHost host = new WebServiceHost(catalog, new
Uri(&ldquo;<a href="http://localhost:7777/Products">http://localhost:7777/Products</a>&rdquo;));</p>

<p> </p>

<p>    IEnumerable&lt;SyndicationItem> items;</p>

<p> </p>

<p>    try</p>

<p>    {</p>

<p>        host.Open();</p>

<p> </p>

<p>        items = Consume(new
Uri(&ldquo;<a href="http://localhost:7777/Products?category=foo">http://localhost:7777/Products?category=foo</a>&rdquo;));</p>

<p>    }</p>

<p>    finally</p>

<p>    {</p>

<p>        if (host.State == System.ServiceModel.CommunicationState.Opened)</p>

<p>            host.Close();</p>

<p>        else</p>

<p>            host.Abort();</p>

<p>    }</p>

<p> </p>

<p>    Assert.AreEqual(1, items.Count());</p>

<p>    Assert.IsTrue(items.Any(i => i.Id == &ldquo;<a href="http://products/1">http://products/1</a>&rdquo; &amp;&amp;
i.Title.Text == &ldquo;Foo1&rdquo;));</p>

<p>}</p>

<p>&ldquo;Consume&rdquo; in the code above is a helper method that internally uses
WebHttpRequest for sending a http get to the WCF service.</p>

<p>private IEnumerable&lt;SyndicationItem> Consume(Uri feedUri)</p>

<p>{</p>

<p>    WebRequest request = CreateWebRequest(feedUri);</p>

<p>    XmlReaderSettings settings = new XmlReaderSettings { CloseInput =
true };</p>

<p>    using (XmlReader reader =
XmlReader.Create(request.GetResponse().GetResponseStream(), settings))</p>

<p>    {</p>

<p>        SyndicationFeed feed = SyndicationFeed.Load(reader);</p>

<p>        return feed.Items;</p>

<p>    }</p>

<p>}</p>

<p> </p>

<p>private WebRequest CreateWebRequest(Uri feedUri)</p>

<p>{</p>

<p>    HttpWebRequest webRequest =
(HttpWebRequest)WebRequest.Create(feedUri);</p>

<p>    webRequest.ContentType = &ldquo;application/rss+xml&rdquo;;</p>

<p> </p>

<p>    webRequest.Timeout = 60 * 1000;</p>

<p> </p>

<p>    webRequest.Method = &ldquo;GET&rdquo;;</p>

<p> </p>

<p>    return webRequest;</p>

<p>}</p>

<p><strong>Unit Tests</strong></p>

<p>Unit tests focus on the service implementation only, leaving out most of
the external dependencies and any additional processing made by the WCF
channel stack. The IWebOperationContext interface I mentioned before
will help us to mock many of the properties provided by the WCF context.
This is a good thing for getting/setting expectations that we want to
verify in the test itself. This interface and the wrappers are available
as part of the project Netfx,
<a href="http://code.google.com/p/netfx/">http://code.google.com/p/netfx/</a></p>

<p>[TestClass]</p>

<p>public class UnitTests</p>

<p>{</p>

<p>    [TestMethod]</p>

<p>    public void ShouldGetProductsFeed()</p>

<p>    {</p>

<p>        ProductCatalog catalog = new ProductCatalog(</p>

<p>            new InMemoryProductRepository(</p>

<p>                new List&lt;Product>{</p>

<p>                new Product { Id = &ldquo;1&rdquo;, Category = &ldquo;foo&rdquo;, Name = &ldquo;Foo1&rdquo;,
UnitPrice = 1 },</p>

<p>                new Product { Id = &ldquo;2&rdquo;, Category = &ldquo;bar&rdquo;, Name = &ldquo;bar2&rdquo;,
UnitPrice = 2 }</p>

<p>            }));</p>

<p> </p>

<p>        Mock&lt;IWebOperationContext> mockContext = new
Mock&lt;IWebOperationContext> { DefaultValue = DefaultValue.Mock };</p>

<p>        IEnumerable&lt;SyndicationItem> items;</p>

<p> </p>

<p>        <strong>using (new MyWebContext(mockContext.Object))</strong></p>

<p><strong>        {</strong></p>

<p><strong>            var formatter = catalog.GetProducts(&ldquo;foo&rdquo;);</strong></p>

<p><strong>            items = formatter.Feed.Items;</strong></p>

<p><strong>        }</strong></p>

<p> </p>

<p>        mockContext.VerifySet(c => c.OutgoingResponse.ContentType,
&ldquo;application/atom+xml&rdquo;);</p>

<p> </p>

<p>        Assert.AreEqual(1, items.Count());</p>

<p>        Assert.IsTrue(items.Any(i => i.Id == &ldquo;<a href="http://products/1">http://products/1</a>&rdquo; &amp;&amp;
i.Title.Text == &ldquo;Foo1&rdquo;));</p>

<p>    }</p>

<p>}</p>

<p>What&rsquo;s deserve some attention in the unit test above is the code for
creating the mocked WebContext and the code required for verifying the
expectations.</p>

<p>using (new MyWebContext(mockContext.Object))</p>

<p>{</p>

<p>    var formatter = catalog.GetProducts(&ldquo;foo&rdquo;);</p>

<p>    items = formatter.Feed.Items;</p>

<p>}</p>

<p>That will insert the mockContext object in the Thread Local Storage so
it can be accessed later in the service implementation by
MyWebContext.Current (The &ldquo;using&rdquo; clause here makes an explicit call to
IDispose as well, so the mockContext is removed from that storage after
the operation is called).  </p>

<p>The test also verifies that the ContentType header was set with the
correct value in the operation,</p>

<p>mockContext.VerifySet(c => c.OutgoingResponse.ContentType,
&ldquo;application/atom+xml&rdquo;);</p>

<p><a href="/images/legacy/WCF.Tests.zip">Complete code available to download from
here</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/12/11/some-issues-added-in-codeplex-for-the-wcf-rest-starter-kit/">Some Issues Added in Codeplex for the WCF REST Starter Kit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-12-11T00:00:00-03:00" pubdate data-updated="true">Dec 11<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/12/11/some-issues-added-in-codeplex-for-the-wcf-rest-starter-kit/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I just created some issues in codeplex for the features I discussed last
week in these two posts:</p>

<p><strong>Add support for switching the content type dynamically</strong></p>

<p><a href="http://www.codeplex.com/aspnet/WorkItem/View.aspx?WorkItemId=2846">http://www.codeplex.com/aspnet/WorkItem/View.aspx?WorkItemId=2846</a></p>

<p>Related Post:
<a href="http://weblogs.asp.net/cibrax/archive/2008/12/05/dynamic-content-type-a-nice-to-have-feature-for-the-rest-starter-kit.aspx">http://weblogs.asp.net/cibrax/archive/2008/12/05/dynamic-content-type-a-nice-to-have-feature-for-the-rest-starter-kit.aspx</a></p>

<p><strong>Add support for conditional get in WebCache behavior</strong></p>

<p><a href="http://www.codeplex.com/aspnet/WorkItem/View.aspx?WorkItemId=2847">http://www.codeplex.com/aspnet/WorkItem/View.aspx?WorkItemId=2847</a></p>

<p>Related Post:
<a href="http://weblogs.asp.net/cibrax/archive/2008/12/08/adding-conditional-get-support-to-the-wcf-rest-starter-kit.aspx">http://weblogs.asp.net/cibrax/archive/2008/12/08/adding-conditional-get-support-to-the-wcf-rest-starter-kit.aspx</a></p>

<p>Feel free to vote any of them :)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/12/08/adding-conditional-get-support-to-the-wcf-rest-starter-kit/">Adding Conditional Get Support to the WCF REST Starter Kit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-12-08T00:00:00-03:00" pubdate data-updated="true">Dec 8<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/12/08/adding-conditional-get-support-to-the-wcf-rest-starter-kit/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://weblogs.asp.net/cibrax/archive/2008/10/06/importance-of-conditional-gets-in-rest.aspx">Some weeks
ago</a>,
I discussed how important &ldquo;Conditional Get&rdquo; can be for some scenarios,
specially when we want to make a better use of the network traffic.</p>

<p>The WCF REST Starter kit introduced a new extension &ldquo;WebCache&rdquo;,
implemented as an operation behavior, to automatically add caching
support to any &ldquo;Get&rdquo; operation in a service contract. Using this new
feature is a simple as annotating an existing service operation with a
&ldquo;WebCache&rdquo; attribute, as it is shown below:</p>

<p>[WebCache(CacheProfileName = &ldquo;CacheFor1Min&rdquo;)]</p>

<p>[WebGet(UriTemplate = &ldquo;customer/{id}&rdquo;)]</p>

<p>[OperationContract]</p>

<p>public Customer GetCustomer(string id)</p>

<p>The underline implementation of this new behavior relies on the existing
ASP.NET web cache. For more details about this new feature, Jesus
Rodriguez has written a very <a href="http://weblogs.asp.net/gsusx/">good summary
here</a>. I also mentioned how to enable Sql
dependencies with this feature <a href="http://weblogs.asp.net/cibrax/archive/2008/11/03/using-sqlcache-dependencies-with-the-new-wcf-webcache-attribute-rest-starter-kit.aspx">in this
post.</a></p>

<p>Unfortunately, this implementation does not support Conditional Get out
of the box, which means that the client always receive a complete
response, no matter if the response was served directly from the cache
or not. For instance, if one operation returns a feed with one hundred
items, and the client application does not have a way to specify when
was the last time it got access to that feed, it will have to download
the complete feed all the times.</p>

<p>Although the ASP.NET does provide support for conditional gets through
the public methods &ldquo;SetLastModified&rdquo; (for date times) and &ldquo;SetETag&rdquo; (for
entity representations), the web cache behavior does not make use of
them.</p>

<p>If we just modified the Web cache behavior to include the following line
at the end, the additional LastModified header will be included in the
response</p>

<p>if (!string.IsNullOrEmpty(cacheProfile.VaryByCustom))</p>

<p>{</p>

<p>   
HttpContext.Current.Response.Cache.SetVaryByCustom(cacheProfile.VaryByCustom);</p>

<p>}</p>

<p> </p>

<p><strong>HttpContext.Current.Response.Cache.SetLastModified(DateTime.Now);
//Line Added for Conditional Get support</strong></p>

<p>It is a simple as that. After enabling some trace to the service, we
will see</p>

<p>Server ASP.NET Development Server/9.0.0.0\
Date Mon, 08 Dec 2008 15:41:54 GMT\
X-AspNet-Version 2.0.50727\
Cache-Control public, max-age=44\
Expires Mon, 08 Dec 2008 15:42:42 GMT\
<strong>Last-Modified Mon, 08 Dec 2008 15:41:43 GMT\
</strong>Vary *\
Content-Type application/xml; charset=utf-8\
Content-Length 195\
Connection Close</p>

<p>However, setting DateTime.Now for every operation is not efficient for
every scenario because it will be tied to the item lifetime in the
cache. For instance, if our service operation is returning a feed, we
might want to use the feed&rsquo;s last update time.</p>

<p>It will be much better if have a configurable way to set up this date
for every entry in the cache. For that reason, I came up with a solution
based on a simple strategy pattern through a pluggeable interface
&ldquo;ILastModified&rdquo;,</p>

<p>public interface ILastModified</p>

<p>{</p>

<p>    DateTime? GetLastModifiedForOutput(object[] outputs, object
returnValue);</p>

<p>}</p>

<p>The method &ldquo;GetLastModifiedForOutput&rdquo; basically determines the
&ldquo;LastModified&rdquo; date for the given outputs parameters and return value of
the service operation. Given this simple interface, we could have
default implementations for feeds or the current date time.</p>

<p>public class SyndicationLastModified : ILastModified</p>

<p>{</p>

<p>    public DateTime? GetLastModifiedForOutput(object[] outputs, object
returnValue)</p>

<p>    {</p>

<p>        if(returnValue is SyndicationFeedFormatter)</p>

<p>        {</p>

<p>            var formatter = (SyndicationFeedFormatter)returnValue;</p>

<p>            return formatter.Feed.LastUpdatedTime.UtcDateTime;</p>

<p>        }</p>

<p> </p>

<p>        return null;</p>

<p> </p>

<p>    }</p>

<p>}</p>

<p> </p>

<p>public class CurrentDateLastModified : ILastModified</p>

<p>{</p>

<p>    public DateTime? GetLastModifiedForOutput(object[] outputs, object
returnValue)</p>

<p>    {</p>

<p>        return DateTime.Now;</p>

<p>    }</p>

<p>}</p>

<p>And finally configure these classes as part of the WebCache attribute.</p>

<p>[WebCache(CacheProfileName = &ldquo;CacheFor1Min&rdquo;,
<strong>LastModifiedType=typeof(CurrentDateLastModified)</strong>)]</p>

<p>[WebGet(UriTemplate = &ldquo;customer/{id}&rdquo;)]</p>

<p>[OperationContract]</p>

<p>public Customer GetCustomer(string id)</p>

<p>{</p>

<p>    if (id == &ldquo;foo&rdquo;)</p>

<p>        return new Customer { Id = id, FullName = &ldquo;John Foo&rdquo; };</p>

<p>    else if (id == &ldquo;bar&rdquo;)</p>

<p>        return new Customer { Id = id, FullName = &ldquo;John Bar&rdquo; };</p>

<p> </p>

<p>    return new Customer { Id = id, FullName = &ldquo;Unknow&rdquo; };</p>

<p>}</p>

<p>If no LastModifiedType is specified as argument for the &ldquo;WebCache&rdquo;
attribute, the default behavior is used,  resulting in a complete
response message served to the client all the times. Otherwise, the
server will evaluate the &ldquo;If-Modified-Since&rdquo; header first to know if the
valid response for that request should be &ldquo;serving all the content&rdquo; vs
returning a &ldquo;Http 304 &ndash; Not Modified&rdquo; status code.</p>

<p><a href="/images/legacy/WebCache.zip">The sample code is available
here</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/12/05/dynamic-content-type-a-nice-to-have-feature-for-the-rest-starter-kit/">Dynamic Content Type - a Nice to Have Feature for the WCF REST Starter Kit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-12-05T00:00:00-03:00" pubdate data-updated="true">Dec 5<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/12/05/dynamic-content-type-a-nice-to-have-feature-for-the-rest-starter-kit/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the missing features in the WCF web model is the ability to have
a single operation definition and switch the content type for the
response according to some runtime setting (Which could be the Accept or
Content-Type request header for instance).</p>

<p>Today, I came across this post &ldquo;<a href="http://damianblog.com/2008/10/31/wcf-rest-dynamic-response/">WCF REST Services: Setting the response
format based on request&rsquo;s expected
type</a>&rdquo; that
shows exactly that. The solution is very clean and based on some
extensions to the existing WebHttpBehavior and WebHttpHost classes.</p>

<p>Kyle Beyer took a similar approach to switch the context type of the
request messages as well. His implementation was layered on top of
existing classes in the REST Starter kit, and it can find
<a href="http://daptivate.com/archive/2008/11/16/wcf-and-rest-an-approach-to-using-the-content-type-and-accept-http-headers-for-object-serialization.aspx">here</a>.</p>

<p>Both implementations inspect the &ldquo;Content-Type&rdquo; header of the request
messages to determine the WCF formatter to use. What it would very nice
to have in the Starter kit is the possibility to switch the content type
dynamically not only by the &ldquo;Content-Type&rdquo; header, but also by some
other settings like UriTemplates or QueryString arguments.</p>

<p>It wouldn&rsquo;t be nice to have an attribute with the following syntax:</p>

<p>[WebHelp(Comment = &ldquo;Returns the items in the collection in the format
specified by the Accept header, along with URI links to each item.&rdquo;)]</p>

<p>[WebGet(UriTemplate = CollectionServiceBase&lt;TItem>.ItemsUriTemplate)]</p>

<p>[OperationContract]</p>

<p>[DynamicContentType(Direction=DynamicDirection.Both,
Resolution=DynamicResolution.QueryString,
QueryStringArgument=&ldquo;content&rdquo;)]</p>

<p>ItemInfoList&lt;TItem> GetItems();</p>

<p>Where Direction and Resolution could support some of these values,</p>

<p>public enum Direction</p>

<p>{</p>

<p>    RequestOnly,</p>

<p>    ResponseOnly,</p>

<p>    Both</p>

<p>}</p>

<p> </p>

<p>public enum Resolution</p>

<p>{</p>

<p>    ContentTypeHeader,</p>

<p>    UriTemplate,</p>

<p>    QueryString</p>

<p>}</p>

<p> </p>

<p>With that attribute in place, it will not be necessary anymore to
redefine the same operation many times just to change the content type.
For instance, the following service contract can be simplified with the
use of this new attribute,</p>

<p>[OperationContract]</p>

<p>ItemInfoList&lt;TItem> GetItemsInXml();</p>

<p> </p>

<p>[WebGet(UriTemplate = CollectionServiceBase&lt;TItem>.JsonItemsTemplate,
ResponseFormat = WebMessageFormat.Json)]</p>

<p>[OperationContract]</p>

<p>ItemInfoList&lt;TItem> GetItemsInJson();</p>

<p>I will see if I have some time to implement a prototype using that
syntax for the DynamicContentType attribute.</p>

<p>In the meantime, I think it would be great to have support out of the
box for a feature like this in the WCF REST Starter kit, what&rsquo;s your
opinion ?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/12/03/wcf-workflow-services-in-business-applications/">WCF Workflow Services in Business Applications</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-12-03T00:00:00-03:00" pubdate data-updated="true">Dec 3<span>rd</span>, 2008</time>
        
         | <a href="/blog/2008/12/03/wcf-workflow-services-in-business-applications/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It&rsquo;s pretty interesting to see how useful workflow services can be
sometimes, specially for business applications that require
orchestrating several back-end services calls.</p>

<p>As one of the programmers involved in the development of the WS-I Sample
application for .NET, an application that demonstrates  how to build
interoperable web services in .NET using the WS-I Basic Profile 1.0
(Each vendor in the WS-I working group basically implemented the same
application using its development platform, more information can be
found
<a href="http://www.ws-i.org/deliverables/workinggroup.aspx?wg=sampleapps">here</a>),
it was a surprise to me to find another implementation as part of the
WCF SDK, made this time all declaratively through WCF workflow services
and just a few activities. To give you an idea, the original version of
the same application took us some days and hundred lines of code just to
have something complete and working.</p>

<p>The SDK version is available under the folder, [SDK
Folder]\WCF_WF_CardSpace_Samples\WCF\Scenario\WorkflowServices\Conversations</p>

<p>Workflow services, initially introduced in WCF 3.5 with the Receive and
Send activities, will now take a very important role as part of the Oslo
vision. We will have the opportunity to write pure declarative
long-running services with XAML, including all the WCF contracts for
receiving/sending messages. This will make possible to store the
complete workflow representation in the Oslo repository, and take later
full control of this workflow&rsquo;s instances from Dublin, the new hosting
environment for long-running services. David Chappell has written an
excellent article about WF 4.0, Dublin the oslo vision, you can find it
<a href="http://www.davidchappell.com/blog/2008/11/first-look-at-wf-40-dublin-and-oslo.html">here</a>,
this a must read for developers interested in this area.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/17/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/15/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/23/selfhost-utilities/">SelfHost Utilities</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/23/appfabric-outputcaching/">AppFabric OutputCaching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/31/making-ajax-calls-with-hawk-authentication-to-asp-dot-net-web-api/">Making Ajax Calls With Hawk Authentication to ASP.NET Web API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/13/coordinating-async-work-in-node-dot-js/">Coordinating Async Work in Node.js</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/27/oauth-bridge-for-adfs-with-thinkteckture-authorization-server/">OAuth Bridge for ADFS With ThinkTecture Authorization Server</a>
      </li>
    
  </ul>
</section>
 <a href="http://feeds.feedburner.com/cibrax"><img src="http://feeds.feedburner.com/~fc/cibrax?bg=FF3300&amp;fg=000000&amp;anim=0" style="border:0" alt="" /></a>

 <script type="text/javascript" language="javascript" src="http://twittercounter.com/embed/?username=cibrax&style=white"></script>
<a href="https://mvp.microsoft.com/en-us/mvp/Pablo%20Cibraro-33800"><img src="/images/mvp.gif" border="0" /></a>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pcibraro">@pcibraro</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pcibraro',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Cibrax -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cibrax';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
