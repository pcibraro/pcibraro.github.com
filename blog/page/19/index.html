
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pablo Cibraro (Cibrax)</title>
  <meta name="author" content="Cibrax">

  
  <meta name="description" content="What is FeedSync ? If you have not heard about &ldquo;FeedSync&rdquo; yet, it is the official name of
an open and interoperable standard for &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cibrax.me/blog/page/19">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/cibrax" rel="alternate" title="Pablo Cibraro (Cibrax)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44468149-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pablo Cibraro (Cibrax)</a></h1>
  
    <h2>All about software development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/cibrax" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cibrax.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/04/22/overview-of-feedsync-support-in-the-microsoft-sync-framework/">Overview of FeedSync Support in the Microsoft Sync Framework</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-04-22T00:00:00-03:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2008</time>
        
         | <a href="/blog/2008/04/22/overview-of-feedsync-support-in-the-microsoft-sync-framework/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3></h3>

<h3>What is FeedSync ?</h3>

<p>If you have not heard about &ldquo;FeedSync&rdquo; yet, it is the official name of
an open and interoperable standard for representing synchronization
metadata in a XML format. This specification was formerly called by
Microsoft as &ldquo;SSE&rdquo; (Simple Sharing Extensions), and its name was changed
to &ldquo;FeedSync&rdquo; prior to the first release version.</p>

<p>The fact that the &ldquo;FeedSync&rdquo; model is completely based on XML and it is
quite simple to represent, makes this specification a good candidate to
guarantee interoperability with other platforms.</p>

<p>The complete specification is based on two fundamental aspects,</p>

<p>​1. A way to represent the &ldquo;FeedSync&rdquo; model as XML extensions that can
be easily attached to any existing document. The most common use
nowadays is to include them as part of a syndication feed like RSS or
ATOM to keep synchronization metadata about each available item. Many
people have started proving parsers for this specification as part of
their Syndication libraries, some examples are <a href="http://www.codeplex.com/sse">Simple Sharing
Extensions For .NET</a>, <a href="https://rome.dev.java.net/">Rome for
Java</a>, or <a href="http://www.codeplex.com/Argotic">Argotic
(.NET)</a></p>

<p>Let&rsquo;s take a quick look at the metadata attached to some items in a RSS
feed.</p>

<p>&lt;feed xmlns:sx=&lsquo;<a href="http://feedsync.org/2007/feedsync">http://feedsync.org/2007/feedsync</a>&rsquo;></p>

<p>  &lt;title>Hello World&lt;/title></p>

<p>  &lt;link><a href="http://weblogs.asp.net/cibrax&lt;/link>&#8220;>http://weblogs.asp.net/cibrax&lt;/link></a></p>

<p>  &lt;description>this is my feed&lt;/description></p>

<p>  &lt;sx:sharing since=&lsquo;11-05-2007T19:33:27Z&rsquo;
until=&lsquo;14-05-2007T19:33:27Z&rsquo;></p>

<p>    &lt;sx:related link=&lsquo;<a href="http://kzu/full">http://kzu/full</a>&rsquo; type=&lsquo;complete&rsquo; /></p>

<p>  &lt;/sx:sharing></p>

<p>  &lt;item></p>

<p>   &lt;title>Foo Title&lt;/title></p>

<p>   &lt;description>Foo Description&lt;/description></p>

<p>   &lt;Foo Title=&lsquo;Foo&rsquo; /></p>

<p>   &lt;sx:sync id=&lsquo;d92d64f5-c006-4086-a35a-c5195448d3ad&rsquo; updates=&lsquo;2&rsquo;
deleted=&lsquo;false&rsquo; noconflicts=&lsquo;false&rsquo;></p>

<p>     &lt;sx:history sequence=&lsquo;2&rsquo; when=&lsquo;18-05-2007T19:33:27Z&rsquo; by=&lsquo;Cibrax&rsquo;
/></p>

<p>     &lt;sx:history sequence=&lsquo;1&rsquo; when=&lsquo;14-05-2007T19:33:27Z&rsquo; by=&lsquo;JohnFoo&rsquo;
/></p>

<p>    &lt;/sx:sync>  &lt;/item></p>

<p> </p>

<p>&lt;/feed></p>

<p>First of all, it adds optional metadata at feed level through the
&ldquo;sharing&rdquo; element to include aggregated information about related feeds
or sources. (The since and until attributes in that element represents
the lower and upper bounds of the items contained within the feed).</p>

<p>Secondly, it includes synchronization metadata at item level with the
&ldquo;sync&rdquo; element. This element contains the following information:</p>

<p>​a. An identifier to represent the item (Id attribute), this identifier
must be unique across all the synchronization peers.</p>

<p>​b. An history of updates that includes the person that made a change to
the item, and the date/time of that change. As you can see, this
information is quite simple, it does not say anything about what were
the changes made to the item (We will see later that this information is
actually not important for the merging algorithm).</p>

<p>​c. Flags to indicate if the item was deleted or contains conflicts.
(The same item version or sequence number was modified in one or more
replicas at the same time).</p>

<p>The rest of the information not mentioned here is part of the RSS
specification itself and it does not have anything to do with
&ldquo;FeedSync&rdquo;.</p>

<p>​2. An algorithm that use the synchronization metadata to merge the
items across several peers. For instance, to perform a bidirectional
synchronization of local information between two peers. The algorithm
also uses the metadata to detect conflicts at the moment of doing the
merge operation.</p>

<p>For example, if we have the following information in two different
replicas</p>

<p>+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
| REPLICA A                            | REPLICA B                            |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemA-Sequence1                    | ItemC-Sequence1                      |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemB-Sequence1                    |                                      |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+</p>

<p>After the first synchronization, the resulting information will be:</p>

<p>+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
| REPLICA A                            | REPLICA B                            |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemA-Sequence1                    | ItemC-Sequence1                      |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemB-Sequence1                    |  ItemA-Sequence1                     |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemC-Sequence1                    |  ItemB-Sequence1                     |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+</p>

<p>Now, Let&rsquo;s say the replica B changes the item A and B( The sequence or
version is incremented)</p>

<p>+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
| REPLICA A                            | REPLICA B                            |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemA-Sequence1                    | ItemC-Sequence1                      |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemB-Sequence1                    |  ItemA-Sequence2                     |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemC-Sequence1                    |  ItemB-Sequence2                     |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+</p>

<p>If they synchronize again, the resulting information will be:</p>

<p>+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
| REPLICA A                            | REPLICA B                            |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemA-Sequence2                    | ItemC-Sequence1                      |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemB-Sequence2                    | ItemA-Sequence2                      |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemC-Sequence1                    | ItemB-Sequence2                      |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+</p>

<p>Now, if both replicas change the same item before synchronizing, for
instance ItemC. At the moment of synchronizing the information, they
will have the same sequence for ItemC, and therefore a conflict will
exist. (The algorithm to detect conflicts is more complex than this, I
am just giving an example)</p>

<p>+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
| REPLICA A                            | REPLICA B                            |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemA-Sequence2                    |  ItemC-Sequence2                     |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemB-Sequence2                    | ItemA-Sequence2                      |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|   ItemC-Sequence2                    | ItemB-Sequence2                      |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+</p>

<p>Having these two important aspects, a developer wanting to synchronize
information with other applications only has to represent that
information as a FeedSync feed (A normal feed that includes &ldquo;FeedSync&rdquo;
metadata) and expose it somewhere. Another application can later on
combine that feed with its own feed using the merging algorithm, which
will result in a full biredirectional synchronization between those two
application.</p>

<p>As you can see, both aspects complement each other, an bidirectional
synchronization can not be done with just one of them.</p>

<h3></h3>

<h3>How to expose your information in a FeedSync feed with the Sync Framework</h3>

<p>​1. The first thing you have to do is to determine which information you
will want to expose in the final feed. Let&rsquo;s say that you have several
copies of a database with customer information spread across several
locations (Different company&rsquo;s branches perhaps), and you want to keep
all those copies synchronized. You will have to expose that information
as part of a feed, so people in other locations can synchronize their
data against that feed (This example assumes that one central feed is
used, but you can actually have multiple feeds that synchronize each
other having a kind of tree structure, this is one of the goodness about
FeedSync, no central replica is required).</p>

<p>If you want to represent the customer&rsquo;s full name, address and phone
number as an entry in a RSS feed, the entry will look as follow:</p>

<p>&lt;item></p>

<p>  &lt;title>John Doe&lt;/title></p>

<p>  &lt;description>John Doe&rsquo;s Information&lt;/description></p>

<p>  &lt;Customer></p>

<p>    &lt;FullName>John Doe&lt;/FullName></p>

<p>    &lt;Address>Test Adress&lt;/Address></p>

<p>    &lt;PhoneNumber>xxx-xxxx-xxxx&lt;/PhoneNumber>   &lt;/Customer></p>

<p>&lt;/item></p>

<p>This mapping between the real data and a XML payload (The RSS&rsquo;s entry
data) can be done in the Sync Framework by having a concrete
implementation of &ldquo;FeedItemConverter&rdquo; class. The implementation of this
class will know how to map custom data to a XML payload and vice versa.</p>

<p>public abstract class FeedItemConverter</p>

<p>{</p>

<p>  protected FeedItemConverter();</p>

<p>  public abstract string ConvertItemDataToXmlText(object itemData);
//Method to convert the actual item data into XML</p>

<p>  public abstract object ConvertXmlToItemData(string itemXml); //Method
to convert the XML data into the item data</p>

<p>}</p>

<p>I personally do not like much the signature of those methods, an string
could be anything (itemXml), not just XML and that can not be enforced
by the current API design. I would prefer to have something like this:</p>

<p>public abstract class FeedItemConverter</p>

<p>{</p>

<p>  protected FeedItemConverter();</p>

<p>  public abstract void WriteItemDataToXml(object itemData, XmlWriter
xmlWriter); //Method to convert the actual item data into XML</p>

<p>  public abstract object ReadItemDataFromXml(XmlReader xmlReader);
//Method to convert the XML data into the item data</p>

<p>}</p>

<p>In the sample above, you should implement a &ldquo;CustomerFeedItemConverter&rdquo;
to convert a customer instance into XML the xml representation and vice
versa.</p>

<p>​2. Secondly, you have to provide a mapping between your internal
identifiers and the identifiers used in the synchronization metadata.
From the MSDN documentation &#8221;</p>

<p><em>&ldquo;A FeedIdConverter can convert replica IDs and item IDs from the
flexible-length format of the provider to strings, and vice versa. Also,
the ID converter must be able to generate a replica ID for an anonymous
change. The FeedSync history for a change contains three potential
attributes: sequence, when, and by. The by attribute represents the
replica that made the change, but it is not required by the FeedSync
schema and so might be absent. If a change does not include a by value,
a replica ID must be generated for the change by combining the sequence
and when values&rdquo;</em></p>

<p>public abstract class FeedIdConverter</p>

<p>{</p>

<p>  protected FeedIdConverter();</p>

<p>  public abstract SyncIdFormatGroup IdFormats { get; }</p>

<p>  public abstract string ConvertItemIdToString(SyncId itemId);</p>

<p>  public abstract string ConvertReplicaIdToString(SyncId replicaId);</p>

<p>  public abstract SyncId ConvertStringToItemId(string value);</p>

<p>  public abstract SyncId ConvertStringToReplicaId(string value);</p>

<p>  public abstract SyncId GenerateAnonymousReplicaId(string when, uint
sequence);</p>

<p>}</p>

<p>Since the implementation of this provider will be the same most of the
times, I think it would be a good idea to provide a default
implementation of this provider as part of the Sync framework (It could
provide extensibility points through virtual methods).</p>

<p>​3. Once you have the item and id converters, they should be enough to
start consuming or publishing FeedSync feeds with your custom
information. The framework comes with two classes for that purpose,
FeedConsumer and FeedProducer.</p>

<p>public class FeedProducer</p>

<p>{</p>

<p>  public FeedProducer(KnowledgeSyncProvider storeProvider,
FeedIdConverter idConverter, FeedItemConverter itemConverter);</p>

<p>public FeedIdConverter IdConverter { get; set; }</p>

<p>  public EndpointState IncrementalFeedBaseline { get; set; }</p>

<p>  public FeedItemConverter ItemConverter { get; set; }</p>

<p>  public KnowledgeSyncProvider StoreProvider { get; set; }</p>

<p>  public void ProduceFeed(Stream feedStream);</p>

<p>}</p>

<p>public class FeedConsumer</p>

<p>{</p>

<p>  public FeedConsumer(KnowledgeSyncProvider storeProvider,
FeedIdConverter idConverter, FeedItemConverter itemConverter);</p>

<p>  public FeedItemConverter FeedItemConverter { get; set; }</p>

<p>  public FeedIdConverter IdConverter { get; set; }</p>

<p>  public KnowledgeSyncProvider StoreProvider { get; set; }</p>

<p>  public EndpointState ConsumeFeed(Stream feedStream);</p>

<p>}</p>

<p>As you can see, those classes basically receive in the constructor the
converters along with a sync repository (KnowledgeSyncProvider), the one
that knows specific details about the underline data source. (for this
example, it should know about the customers data in the database). All
the magic is done by the methods ProduceFeed and ConsumeFeed, which
reads/saves a feed from/to an existing stream. Again, I have three ideas
to improve these classes,</p>

<p>​a. They are tied to Rss/Atom, it should be extensible enough to support
any document payload.</p>

<p>​b. The underline stream must contain an existing Rss/Atom feed in order
to save/read items on it. This is how these classes determine the format
of the items. It would be great to have a way to specify a formatter for
the items at the moment to save/read them. A approach very similar to
the one taken by the Syndication API in WCF.</p>

<p>​c. I would like to have a better integration with the WCF syndication
API. I mean, a direct way to expose a REST endpoint for a feedsync feed,
the consumer/producer classes could accept a SyndicationFeedFormatter as
input to generate/consume the feed.</p>

<p>Once the data have been read from the underline stream into a sync
repository, it can be used with the
&ldquo;<a href="http://msdn2.microsoft.com/en-us/library/microsoft.synchronization.syncorchestrator(SQL.100">SyncOrchestrator</a>.aspx)&rdquo;
(Part of the Sync Framework) to initiate a new synchronization session.</p>

<h3>Complete Example &ldquo;Browser Favorites&rdquo;</h3>

<p>A complete example that illustrates all the steps to implement a custom
sync provider and expose its data as a FeedSync feed can be found here,
<a href="http://blogs.msdn.com/sync/archive/2008/04/08/synchronization-of-browser-favorites-using-feedsync-and-the-microsoft-sync-framework.aspx">http://blogs.msdn.com/sync/archive/2008/04/08/synchronization-of-browser-favorites-using-feedsync-and-the-microsoft-sync-framework.aspx</a></p>

<p>It basically shows how to synchronize the browser favorites information
using FeedSync as the underline synchronization protocol.</p>

<h3>Do you want to synchronize FeedSync data with clients behind a firewall and NAT ?</h3>

<p>Now, that is possible thanks to WCF and the Relay service provided in
<a href="http://labs.biztalk.net/">Biztalk services</a>. Imagine a WCF service that
exposes feedsync items through the Relay service, if we use a WCF duplex
contract for that service, it will be able to start a bidirectional
synchronization with any client behind NAT and Firewalls. I will try to
show this functionality any time soon.</p>

<p>In the meantime, If you want to know more about WCF duplex callbacks
through NAT and Firewalls, I recommend <a href="http://blogs.thinktecture.com/cweyer/archive/2007/04/27/414819.aspx">this
post</a>
written by <a href="http://blogs.thinktecture.com/cweyer">Christian Weyer</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/04/21/my-first-mvp-summit/">My First MVP Summit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-04-21T00:00:00-03:00" pubdate data-updated="true">Apr 21<span>st</span>, 2008</time>
        
         | <a href="/blog/2008/04/21/my-first-mvp-summit/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As a MVP rookie, the only thing I can say is that the event met all the
expectations I had before traveling to Seattle, the wait was worth it. I
could attend a lot of interesting sessions about WCF, WWF, and OSLO
among others, which gave me a complete picture about where Microsoft is
headed in the future with respect to Service oriented applications.</p>

<p>Another interesting aspect of the summit was the opportunity to meet
other MVPs in person, very smart people and community leaders like Scott
Hanselman, Roy Osherove (IXMLSerializable), Sam Gentile, Jesus Rodriguez
or Roman Kiss (The brain behind many of the cool WSE, WWF and WCF cool
samples that you can find around) to name a few.  </p>

<p>I look forward to attending the summit again next year :).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/04/21/federation-over-tcp-with-wcf/">Federation Over TCP With WCF</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-04-21T00:00:00-03:00" pubdate data-updated="true">Apr 21<span>st</span>, 2008</time>
        
         | <a href="/blog/2008/04/21/federation-over-tcp-with-wcf/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the discussions that we had during the last summit with the rest
of &ldquo;Connected Systems&rdquo; MVPs was the possibility of supporting a
Federation Scenario over TCP in WCF. For many of us that scenario was
possible in theory, but unfortunately no documentation or samples
existed to support it. In fact, WCF only comes with pre-built binding
for federation scenarios, the &ldquo;WsFederationHttpBinding&rdquo; binding, which
is completely tied to Http.</p>

<p>For that reason, I decided to give it a shot and try to manipulate some
custom bindings to use tcp instead of the common used http transport.
One curios thing about TCP is that it requires security sessions
(SecureConversation with requireSecurityContextCancellation equals to
&ldquo;True&rdquo;) in order to work fine. If you do not configure the binding with
those security settings, WCF will throw a nice error message saying that
the order of the binding elements is not correct. At the beginning I did
not configure it in that way, and it took me sometime to figure out what
the problem was, I would save some time with a better error
description. </p>

<p>The resulting bindings for client, STS and the sample service were the
following (In this sample, the client is authenticating against the
service with a client certificate).</p>

<p>​1. Client</p>

<p>&lt;bindings></p>

<p>  &lt;customBinding></p>

<p>    &lt;binding name=&ldquo;STSBinding&rdquo;></p>

<p>      &lt;security authenticationMode=&ldquo;SecureConversation&rdquo;
requireSecurityContextCancellation=&ldquo;true&rdquo;></p>

<p>        &lt;secureConversationBootstrap
authenticationMode=&ldquo;MutualCertificate&rdquo;/></p>

<p>      &lt;/security></p>

<p>      &lt;binaryMessageEncoding/></p>

<p>      &lt;tcpTransport /></p>

<p>    &lt;/binding></p>

<p>    &lt;binding name=&ldquo;ServiceBinding&rdquo;></p>

<p>       &lt;security authenticationMode=&ldquo;SecureConversation&rdquo;></p>

<p>         &lt;secureConversationBootstrap
authenticationMode=&ldquo;IssuedToken&rdquo;></p>

<p>           &lt;issuedTokenParameters
tokenType=<a href="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1">http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1</a>></p>

<p>             &lt;issuer address=&ldquo;net.tcp://localhost:8000/sts&rdquo;
bindingConfiguration=&ldquo;STSBinding&rdquo; binding=&ldquo;customBinding&rdquo;></p>

<p>               &lt;identity></p>

<p>                 &lt;dns value=&ldquo;STSAuthority&rdquo;/> &lt;!&mdash;Sample Cert for the
STS &mdash;></p>

<p>               &lt;/identity></p>

<p>             &lt;/issuer></p>

<p>           &lt;/issuedTokenParameters></p>

<p>        &lt;/secureConversationBootstrap></p>

<p>      &lt;/security></p>

<p>      &lt;binaryMessageEncoding/></p>

<p>      &lt;tcpTransport /></p>

<p>    &lt;/binding></p>

<p>  &lt;/customBinding></p>

<p>&lt;/bindings></p>

<p>​2. STS</p>

<p>&lt;bindings></p>

<p>  &lt;customBinding></p>

<p>    &lt;binding name=&ldquo;MutualCertificateBinding&rdquo;></p>

<p>      &lt;security authenticationMode=&ldquo;SecureConversation&rdquo;
requireSecurityContextCancellation=&ldquo;true&rdquo;></p>

<p>        &lt;secureConversationBootstrap
authenticationMode=&ldquo;MutualCertificate&rdquo;/></p>

<p>      &lt;/security></p>

<p>      &lt;binaryMessageEncoding/></p>

<p>      &lt;tcpTransport /></p>

<p>    &lt;/binding>    &lt;/customBinding></p>

<p>&lt;/bindings></p>

<p>​3. Sample Service</p>

<p>&lt;bindings></p>

<p>  &lt;customBinding></p>

<p>    &lt;binding name=&ldquo;SampleService&rdquo;></p>

<p>      &lt;security authenticationMode=&ldquo;SecureConversation&rdquo;
requireSecurityContextCancellation=&ldquo;true&rdquo;></p>

<p>        &lt;secureConversationBootstrap authenticationMode=&ldquo;IssuedToken&rdquo;></p>

<p>           &lt;issuedTokenParameters
tokenType=<a href="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1">http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1</a>></p>

<p>        &lt;/issuedTokenParameters></p>

<p>       &lt;/secureConversationBootstrap></p>

<p>     &lt;/security></p>

<p>     &lt;binaryMessageEncoding/></p>

<p>    &lt;tcpTransport /></p>

<p>   &lt;/binding></p>

<p>  &lt;/customBinding></p>

<p>&lt;/bindings></p>

<p>It is not required that the STS and service use both TCP transport for
communicating with the client, which is a cool thing because now we can
combine different transports in a whole federation scenario. For
instance, we can have a Http communication between the client and the
STS, and a TCP communication with between the client and the final
service.</p>

<p>The complete sample is available to download from
<a href="/images/legacy/FederationOverTcp.zip">here</a>.</p>

<p> </p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/04/09/windows-live-contacts/">Windows Live Contacts API</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-04-09T00:00:00-03:00" pubdate data-updated="true">Apr 9<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/04/09/windows-live-contacts/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>With the boom in social networking, many web sites have started offering
new tools for building or expanding your initial network of contacts.</p>

<p>For instance, sites like Facebook or Linkedin provide a tool to get your
Windows Live contacts and use them to more easily find or invite those
people into your social networks.</p>

<p>Although the idea is very good, the current implementation contains some
serious security issues from my point of view.  The user has to enter in
some way his Windows LiveID credentials into those sites (using a custom
http form), so they can log into Windows Live and get the user&rsquo;s
contacts.</p>

<p>There is not any particular difference between this approach and a
phising web site created by a malicious user only with the intention of
getting your personal information.</p>

<p>Not all people (including me) trust these sites enough to provide them
with valuable Windows LiveID credentials. These sites are very
well-known, but we are not certainly sure which will be the final user
of our credentials. (or even, if they are keeping them somewhere).</p>

<p>This security issue could be basically solved if Windows Live provided
two fundamental things:</p>

<p>1.  Http REST Services to get the user contacts or other personal
information.</p>

<p>​2. An authentication mechanism for those services based on security
tokens. Something similar to what <a href="http://oauth.net/">OAuth</a> provides,
so the user will never have to enter his credentials in a site different
from Microsoft again. Another advantage of this protocol is that the
user will finally decide whether he authorize third party sites to get
his personal information or not. If you are curious about how OAuth
works behind scene,  an excellent &ldquo;Begginer&rsquo;s guide&rdquo; is available
<a href="http://www.hueniverse.com/hueniverse/2007/10/beginners-gui-1.html">here</a>.</p>

<p>Fortunately, the Windows Live team has made an excellent progress in
these two aspects. One one hand, they have developed an &ldquo;<a href="http://msdn2.microsoft.com/en-us/library/cc287637.aspx">Windows Live
ID Delegated Authentication
SDK</a>&rdquo; to
integrate Application providers through a protocol pretty similar to
OAuth (I haven&rsquo;t had enough time yet to take a more detailed look at
this SDK)</p>

<p>From the MSDN site,</p>

<p>&ldquo;<em>Delegated Authentication is based on a block of information, called a
consent token, that is provided to your Web site by the Windows Live ID
service for a given resource provider (such as contacts and photos). To
obtain a consent token for use at a particular resource provider, you
must first request it from the user by means of the Windows Live ID
consent service. Your application must then manage the authentication
data that is returned. For detailed information about how to request and
manage consent, see the</em><a href="http://msdn.microsoft.com/en-us/library/cc287637.aspx"><em>Windows Live Delegated Authentication
SDK</em></a>.&rdquo;</p>

<p>On other hand, as part of &ldquo;<a href="http://msdn2.microsoft.com/en-us/library/cc305075.aspx">Windows Live User Data
APIs</a>&rdquo;, they
have started providing REST services to allow Windows Live users to
safely and securely share their information stored in Windows Live
services. One of this services is what they have called &ldquo;<a href="http://msdn2.microsoft.com/en-us/library/bb463989.aspx">Windows Live
Contacts API</a>&rdquo;,
a REST service that enables developers to programmatically submit
queries to, and retrieve results from, the Windows Live Contacts Address
Book database service.</p>

<p>Hopefully, it will be a matter of time until <a href="http://dev.live.com/blogs/devlive/archive/2008/03/25/237.aspx">Facebook or Linkedin start
integrating</a>
services like these into their sites for the benefit of all :).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/04/07/mvp-again/">MVP Again 2008!!!</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-04-07T00:00:00-03:00" pubdate data-updated="true">Apr 7<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/04/07/mvp-again/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I am so excited, this is third time I received the Microsoft MVP award.
Thanks to all people involved in the evaluation process and my MVP lead
<a href="http://blogs.msdn.com/mvplead">Fernando Garcia Loera</a>.</p>

<p>I am looking forward to continue that collaborating throughout this
year.</p>

<p>Thanks again Microsoft!!!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/03/26/authenticating-users-with-supporting-tokens-in-wcf-binding-extension/">Authenticating Users With Supporting Tokens in WCF - Binding Extension</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-03-26T00:00:00-03:00" pubdate data-updated="true">Mar 26<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/03/26/authenticating-users-with-supporting-tokens-in-wcf-binding-extension/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A couple of months ago I described a useful authentication pattern for
Web applications based on supporting tokens, one of features provided by
WCF. After that, Dominick Baier wrote  a nice and intuitive
<a href="http://www.leastprivilege.com/UserNameSupportingTokenInWCF.aspx">article</a>
showing this pattern in practice with real code examples, something I
could not include in my last post for time reasons :(.</p>

<p>A bad thing about supporting tokens is that they can only be configured
through code, there is no configuration support for this, which it means
that the security binding element has to be modified at some point to
include the supporting token requirements on the client and service side
(e.g, token type, encryption and signature requirements). If IIS is
being used as service host, this will eventually require a custom
service factory just to plug in those requirements. </p>

<p>Fortunately, WCF supports configuration extension points to allow
developers to extend specific points of the configuration schema and
object model.</p>

<p>The &lt;extensions> section provides a centralized location for the
registration of custom configuration objects required for creating a
relatively open extensibility point to the WCF configuration system. 
Each configuration extensibility point connects to one of three
collections within this section:  behaviorExtensions,
bindingElementExtensions, and bindingExtensions.</p>

<p>A really good thing about the configuration extensions is that the
developer does not have use any custom code like custom proxies or
service factories to load those security settings (All that work is done
by the extensions).</p>

<p>During this post I will show how to write a custom binding extension to
specify supporting token requirements for an endpoint through
configuration. This sample will be specific to the web application
scenario described by the pattern.</p>

<p>Let&rsquo;s first discuss the configuration schema we want to have for the
client and the service side. What we initially need is a custom binding
to support the mutual X509 authentication scenario,</p>

<p>&lt;customBinding></p>

<p>  &lt;binding name=&ldquo;MutualCertificateBinding&rdquo;></p>

<p>    &lt;security authenticationMode=&ldquo;MutualCertificate&rdquo;/></p>

<p>    &lt;httpTransport/></p>

<p>  &lt;/binding></p>

<p>&lt;/customBinding></p>

<p>Simple enough, this binding should be configured on the client and
service side. Secondly, we have to specify the X509 certificates that
will be used as client and service credentials for this binding.</p>

<p>On the client side, those credentials are specified by means of a
endpoint behavior,</p>

<p>&lt;behavior name=&ldquo;ClientBehavior&rdquo;></p>

<p>  &lt;clientCredentials></p>

<p>    &lt;serviceCertificate></p>

<p>       &lt;defaultCertificate findValue=&ldquo;CN=SampleService&rdquo;
storeLocation=&ldquo;LocalMachine&rdquo; storeName=&ldquo;My&rdquo;
x509FindType=&ldquo;FindBySubjectDistinguishedName&rdquo;/></p>

<p>       &lt;authentication revocationMode=&ldquo;NoCheck&rdquo;
certificateValidationMode=&ldquo;None&rdquo;>&lt;/authentication></p>

<p>    &lt;/serviceCertificate>   &lt;/clientCredentials></p>

<p>&lt;/behavior></p>

<p>The equivalent configuration settings will be set  on the server side,
the same binding and a service behavior to specify the service
certificate.</p>

<p>&lt;behavior name=&ldquo;ServiceBehavior&rdquo;></p>

<p>  &lt;serviceCredentials></p>

<p>    &lt;serviceCertificate findValue=&ldquo;CN=SampleService&rdquo;
storeLocation=&ldquo;LocalMachine&rdquo; storeName=&ldquo;My&rdquo;
x509FindType=&ldquo;FindBySubjectDistinguishedName&rdquo;/></p>

<p>    &lt;clientCertificate></p>

<p>      &lt;authentication revocationMode=&ldquo;NoCheck&rdquo;/></p>

<p>    &lt;/clientCertificate></p>

<p>  &lt;/serviceCredentials> &lt;/behavior></p>

<p>Once we have these standard configuration, the next step is to add the
custom extension (On both sides, the client and the service) and
reference the existing &ldquo;MutualCertificate&rdquo; binding from there (The one
that we previously defined). The custom extension will basically add the
supporting token requirements to that binding.</p>

<p>&lt;extensions>     &lt;bindingExtensions>           &lt;add
name=&ldquo;trustedWeb&rdquo; type=&ldquo;Samples.TrustedWeb, Samples&rdquo;/>    
&lt;/bindingExtensions></p>

<p>&lt;/extensions></p>

<p>&lt;bindings></p>

<p>    &lt;trustedWeb></p>

<p>     &lt;binding name=&ldquo;MyTrustedWeb&#8221; 
bindingReference=&#8221;MutualCertificateBinding&rdquo; /></p>

<p>    &lt;/trustedWeb></p>

<p>    &lt;customBinding></p>

<p>      &lt;binding name=&ldquo;MutualCertificateBinding&rdquo;></p>

<p>        &lt;security authenticationMode=&ldquo;MutualCertificate&rdquo;/></p>

<p>        &lt;httpTransport/></p>

<p>      &lt;/binding></p>

<p>    &lt;/customBinding></p>

<p>&lt;/bindings></p>

<p>The client and service will have to use this binding instead of the
original mutual certificate binding (The one configured in the
originalBinding attribute).</p>

<p>Client configuration:</p>

<p>&lt;client></p>

<p>  &lt;endpoint address=&ldquo;<a href="http://localhost/SampleService/Service.svc">http://localhost/SampleService/Service.svc</a>&rdquo;</p>

<p>    binding=&ldquo;trustedWeb&rdquo; bindingConfiguration=&ldquo;MyTrustedWeb&rdquo;
behaviorConfiguration=&ldquo;ClientBehavior&rdquo;</p>

<p>   contract=&ldquo;Client.ISampleService&rdquo;></p>

<p>  &lt;/endpoint></p>

<p>&lt;/client></p>

<p>Service configuration:</p>

<p> &lt;services></p>

<p>   &lt;service name=&ldquo;SampleService&rdquo;
behaviorConfiguration=&ldquo;ServiceBehavior&rdquo;></p>

<p>     &lt;endpoint binding=&ldquo;trustedWeb&rdquo; address=&ldquo;&rdquo;
bindingConfiguration=&ldquo;MyTrustedWeb&rdquo; contract=&ldquo;ISampleService&rdquo;></p>

<p>&lt;/endpoint></p>

<p>&lt;/service></p>

<p>&lt;/services></p>

<p>The trustedWeb custom extension performs two things:</p>

<p>​1. Load the binding referenced by the attribute &ldquo;bindingReference&rdquo;</p>

<p>protected override void OnApplyConfiguration(Binding binding)</p>

<p>{</p>

<p>  TrustedWebClientBinding trustedWebClient =
(TrustedWebClientBinding)binding;</p>

<p>  BindingsSection bindings =
(BindingsSection)ConfigurationManager.GetSection(&ldquo;system.serviceModel/bindings&rdquo;);</p>

<p>  if (bindings == null)</p>

<p>  {</p>

<p>    throw new ConfigurationErrorsException(&ldquo;Unexisting bindings
section&rdquo;);</p>

<p>  }</p>

<p> 
if(!bindings.CustomBinding.Bindings.ContainsKey(this.BindingReference))</p>

<p>    throw new ConfigurationErrorsException(string.Format(&ldquo;Unexisting
binding configuration {0}&rdquo;, this.BindingReference));</p>

<p>  CustomBindingElement element =
bindings.CustomBinding.Bindings[this.BindingReference];</p>

<p>  trustedWebClient.Binding = new CustomBinding();</p>

<p>  element.ApplyConfiguration(trustedWebClient.Binding);</p>

<p>}</p>

<p>​2. Creates the binding elements used by the referenced binding and adds
the Supporting tokens requirements for an username.</p>

<p>public override BindingElementCollection CreateBindingElements()</p>

<p>{</p>

<p>    return AddUserNameSupportingTokenToBinding(Binding);</p>

<p>}</p>

<p>private BindingElementCollection
AddUserNameSupportingTokenToBinding(Binding binding)</p>

<p>{</p>

<p>  BindingElementCollection elements = binding.CreateBindingElements();</p>

<p>  SecurityBindingElement security =
elements.Find&lt;SecurityBindingElement>();</p>

<p>  if (security != null)</p>

<p>  {</p>

<p>    UserNameSecurityTokenParameters tokenParameters = new
UserNameSecurityTokenParameters();</p>

<p>    tokenParameters.InclusionMode =
SecurityTokenInclusionMode.AlwaysToRecipient;</p>

<p>    tokenParameters.RequireDerivedKeys = false;</p>

<p>   
security.EndpointSupportingTokenParameters.SignedEncrypted.Add(tokenParameters);</p>

<p>    return elements;</p>

<p>  }</p>

<p>  throw new ArgumentException(&ldquo;Unexisting security binding element&rdquo;);</p>

<p>}</p>

<p>The complete code is available to download from
<a href="/images/legacy/TrustedWeb.zip">here</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/02/11/single-sign-on-scenarios-with-federation/">Single Sign-On Scenarios With Federation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-02-11T00:00:00-03:00" pubdate data-updated="true">Feb 11<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/02/11/single-sign-on-scenarios-with-federation/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Before reading this post, if you know the basic concepts and ideas
behind the implementation of an STS with WCF, go ahead and jump to the
next paragraph. Otherwise, I recommend you to read the following post
<a href="http://weblogs.asp.net/cibrax/archive/2006/03/14/440222.aspx">Implementing a Secure Token Service with
WCF</a>
first.</p>

<h3></h3>

<h3>Informal definition of Federation</h3>

<p><img src="/images/legacy/SimpleFederation.jpg" alt="" /></p>

<p>The image above illustrates a very simple view of a federation scenario.
In the first block, we have a realm or security domain. A realm is a
trust boundary that that can expand across several networks and it is
basically composed by client applications, an STS and a collection of
services (they essentially provide the business value to the client
applications). A group of connected realms  conform a federation
scenario (The trust boundary is around the STSs, each STS trust each
other).</p>

<p>You can read this article for a more formal definition of Federation,
<a href="http://msdn2.microsoft.com/en-us/library/bb498017.aspx">http://msdn2.microsoft.com/en-us/library/bb498017.aspx</a></p>

<h3>Key Interchange Process</h3>

<p><strong>1. The client sends the RST message to the STS</strong></p>

<p>As part of the initial negotiation of the token with the STS through the
RST/RRST (Request Security Token / Response Request Security Token)
messages, the client application also negotiates with the STS a
cryptographic key that will be used later to secure the communication
with the final service.</p>

<p>This key can be symmetric or asymmetric, and the client application will
decide which kind of type it wants in the initial RST message.</p>

<p>This can be done in WCF by configuration:</p>

<p>&lt;wsFederationHttpBinding></p>

<p>  &lt;binding name=&ldquo;ServiceBinding&rdquo;></p>

<p>  &lt;security mode=&ldquo;Message&rdquo;></p>

<p>    &lt;message
issuedTokenType=&ldquo;<a href="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1">http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1</a>&rdquo;
<strong>issuedKeyType=&ldquo;SymmetricKey&rdquo;</strong>></p>

<p>If the STS only supports one type of key (Symmetric or Asymmetric), that
is another story, the client should know that beforehand. The STS can
assume a default key type and always return that type or in the worst
case, return an exception message.</p>

<p>After generating the right key, the STS wraps it in an encrypted key
token
(<a href="http://www.ws-i.org/Profiles/BasicSecurityProfile-1.1.html#EncryptedKeyToken">http://www.ws-i.org/Profiles/BasicSecurityProfile-1.1.html#EncryptedKeyToken</a>)
using the public X509 key of the destination service (This is determined
by the AppliesTo element in the RST message), and adds the encrypted
token in the issued SAML token (This token is signed by the private X509
private key of the STS).</p>

<p>The plain key is also added in the RRST message so the client
application can get it from there (This assumes that the communication
with the STS is also secure).</p>

<p><strong>2. The client receives the RRST message and creates the request
message for the final service</strong></p>

<p>The client application receives the RRST message, and afterwards, it
extracts the SAML token and the generated key. Finally, it adds the SAML
token to the request message for the final service and secures the
channel (Encrypts the request) using the plain key received from the
STS.</p>

<p><strong>3. The service receives the request message from the client</strong></p>

<p>The service on the other side, receives the encrypted message and the
SAML token. After that, it unwraps the encrypted key token included in
the SAML token with its X509 private key. This key is used later to
decrypts the request message sent by the client application.</p>

<h3>Share a SAML token between several services</h3>

<p>Ok, everything looks ok so far, the problems start here :).  If you go
back to the step 1, the STS will wrap the key into the SAML token using
a public key of a X509 certificate. Does this means that a SAML token
will only be useful for the service that possess the corresponding
private key ?. In other words, is the SAML token only valid for one
service ?. Ok, the answer will depend on a specific factor, is the
private X509 key shared among all the services ?. If the answer is YES,
the SAML token will be reusable for any of those services.</p>

<p>Now, is that a correct approach for implementing Single Sign-On ?. From
my point of view, it is not, it just a security hole in the system. If
one SAML token gets compromised by an attacker, this person will also
get access to any service that share the same key. On other hand, if we
have one key per service, if the SAML token gets compromised, only the
service associated with that token is compromised. Clear enough, isn&rsquo;t
it ? Single Sign-On here does not mean &ldquo;Get a token once, use it
everywhere &hellip;&rdquo;. It means, &ldquo;use always the same set of credentials
against the STS to get the correponding token&rdquo;.</p>

<h3>Single Sign-On in Federation</h3>

<p>In this section I will try to describe with my words what &ldquo;Single
Sign-On&rdquo; means in a federation scenario. If we have a client application
that wants to consume a service in another security realm, do we need to
have another set of credentials to log into that realm and consume the
service ?. The answer is &ldquo;NO&rdquo;, if a trust relationship exists between
the Realms where the client application and the services are located, an
automatic negotiation of credentials can happen on behalf of the client
application between the STSs, and therefore the Single-Sign On is
archived.</p>

<p>If the STS in the second realm trusts the first realm, it can accepts
SAML tokens from the first STS (Since the SAML token is signed, it can
verify the origin with a X509 public key) and transform them to tokens
valid for the second realm. This is how federation works behind stage,
the trust relationship is delegated to the STSs.</p>

<p>Of course, I do not have the last word and any feedback is always
welcome :).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/02/08/wcf-syndication-extensions/">WCF - Syndication Extensions</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-02-08T00:00:00-03:00" pubdate data-updated="true">Feb 8<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/02/08/wcf-syndication-extensions/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Syndication support was one of the nice features introduced in the
latest WCF drop (3.5).  At first glance, I can say the APIs are great,
allowing you to write a syndication feed in matter of minutes without
worrying much of some underline implementation details pertinent to RSS
or ATOM.</p>

<p>Another aspect that makes these APIs very powerful is the extensibility
support through what the WCF team called &ldquo;Syndication Extensions&rdquo;. As
its name clearly states, a syndication extension is a mechanism to
extend a normal RSS or ATOM feed with custom elements or attributes,
which is a good thing to implement many of the specifications available
nowadays, for instance, FeedSync or GeoRss to name a few.</p>

<p>WCF particularly supports two kinds of extensions, loose-typed and typed
extensions.</p>

<p>In the first one, the extensions are accessed in a loosely-typed way
through the AttributeExtensions (for xml attribute extensions) and
ElementExtensions (for xml element extensions) properties in the
syndication item. The only requirement for this type of extension is
that the referenced type should be a valid data contract or xml
serializable type.</p>

<p>On the other hand, a typed extension  requires a bit more of code since
the SyndicationItem class must be extended to parse the corresponding
attribute or element extensions. A good thing about this type of
extension is that the developer gets access to a Syndication Item
instance with typed support for each one of the extensions, for
instance, the developer can have a typed class FeedSyncItem, which
essentially represents a SyndicationItem with FeedSync metadata to
support synchronization through RSS or ATOM.</p>

<p>The base class SyndicationItem for representing  simple items (which
internally can be ATOM or RSS) contains four methods that can be
overridden by the developer to support the corresponding extensions,</p>

<p>TryParseElement and WriteElementExtension to read and write element
extensions.</p>

<p>TryParseAttribute and WriteAttributeExtension to read and write
attribute extensions.</p>

<p>Let&rsquo;s discuss both approaches with a simple implementation of FeedSync,
(By the way, FeedSync is the final name for what was formerly called
SSE, I already discussed SSE in previous posts).  The latest FeedSync
specification is available at this URL,
<a href="http://dev.live.com/feedsync/spec/">http://dev.live.com/feedsync/spec/</a></p>

<p>A simple XML serializable class representing the FeedSync metadata
should looks like this:</p>

<p>[XmlRoot(ElementName = &ldquo;sync&rdquo;, Namespace =
&ldquo;<a href="http://feedsync.org/2007/feedsync">http://feedsync.org/2007/feedsync</a>&rdquo;, IsNullable = false)]</p>

<p>public class Sync</p>

<p>{</p>

<p>  [XmlElement(&ldquo;history&rdquo;)]</p>

<p>  public List&lt;History> history { get; set; }</p>

<p>  [XmlAttribute(AttributeName = &ldquo;id&rdquo;)]</p>

<p>  public string Id { get; set; }</p>

<p>  [XmlAttribute(AttributeName = &ldquo;updates&rdquo;)]</p>

<p>  public int Updates { get; set; }</p>

<p>  [XmlAttribute(AttributeName = &ldquo;deleted&rdquo;)]</p>

<p>  public bool Deleted { get; set; }</p>

<p>  [XmlAttribute(AttributeName = &ldquo;noconflicts&rdquo;)]</p>

<p>  public bool NoConflicts { get; set; }</p>

<p>}</p>

<p>In the loose-typed approach, our FeedSync element can be accessed
through the following code:</p>

<p>// .. Read feed</p>

<p>XmlSerializer serializer = new XmlSerializer(typeof(Sync));</p>

<p>foreach (SyndicationItem item in feed.Items)</p>

<p>{</p>

<p>  foreach (SyndicationElementExtension extension in
item.ElementExtensions)</p>

<p>  {</p>

<p>    if (extension.OuterName == &ldquo;sync&rdquo; &amp;&amp; extension.OuterNamespace == 
&ldquo;<a href="http://feedsync.org/2007/feedsync">http://feedsync.org/2007/feedsync</a>&rdquo;)</p>

<p>    {</p>

<p>      Sync sync = extension.GetObject&lt;Sync>(serializer);</p>

<p>    }</p>

<p>  }</p>

<p>}</p>

<p>Quite simple, we have to look up the right extension with some help of
the OuterName and OuterNamespace properties, and then, deserialize the
extension using the right formatter (For the example above, a
XmlSerializer).</p>

<p>The second approach requires more code on our side, two new classes have
to be created, one for the feedsync items and another one for the feed.</p>

<p>public class FeedSyncSyndicationItem : SyndicationItem</p>

<p>{</p>

<p>  public FeedSyncSyndicationItem()</p>

<p>  : base()</p>

<p>  {</p>

<p>  }</p>

<p>  private Sync sync;</p>

<p>  public Sync Sync</p>

<p>  {</p>

<p>    get { return sync; }</p>

<p>  }</p>

<p>  protected override bool TryParseElement(System.Xml.XmlReader reader,
string version)</p>

<p>  {</p>

<p>    if (reader.LocalName == &ldquo;sync&rdquo; &amp;&amp; reader.NamespaceURI ==
&ldquo;<a href="http://feedsync.org/2007/feedsync">http://feedsync.org/2007/feedsync</a>&rdquo;)</p>

<p>    {</p>

<p>      XmlSerializer serializer = new XmlSerializer(typeof(Sync));</p>

<p>      this.sync = (Sync)serializer.Deserialize(reader);</p>

<p>      return true;</p>

<p>    }</p>

<p>    return base.TryParseElement(reader, version);</p>

<p>  }</p>

<p>}</p>

<p>In this case, I only implemented the TryParseElement since the FeedSync
metadata is just an element (Other extension may be attributes)</p>

<p>The feed implementation is only needed to specify the concrete class for
the items,</p>

<p>public class FeedSyncSyndicationFeed : SyndicationFeed</p>

<p>{</p>

<p>  public FeedSyncSyndicationFeed()</p>

<p>  : base()</p>

<p>  {</p>

<p>  }</p>

<p>  protected override SyndicationItem CreateItem()</p>

<p>  {</p>

<p>  return new FeedSyncSyndicationItem();</p>

<p>}</p>

<p>}</p>

<p>Finally, we can create an instance of our typed feed (or item) using the
static method .Load&lt;> available in the SyndicationItem and
SyndicationFeed classes.</p>

<p>FeedSyncSyndicationFeed feed =
SyndicationFeed.Load&lt;FeedSyncSyndicationFeed>(reader);</p>

<p>The reader in the example above points to an xml stream containing a
valid feed with FeedSync metadata.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/01/22/authenticating-users-with-supporting-tokens-in-wcf/">Authenticating Users With Supporting Tokens in WCF</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-01-22T00:00:00-03:00" pubdate data-updated="true">Jan 22<span>nd</span>, 2008</time>
        
         | <a href="/blog/2008/01/22/authenticating-users-with-supporting-tokens-in-wcf/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Context</h3>

<p>A web application used by a great number of users calls a Web service by
sending messages across a network, sometimes through one or more
intermediaries. The web service needs to identify the user logged in the
web application somehow to update data or initiate a business processes.
Some of the data within the messages is considered to be sensitive in
nature so it need to be protected.</p>

<p>The ideal scenario here is to use message security with a username token
to identify the logged user. Identify the user with a X509 certificate
is not practical due to the high number of users.</p>

<h3>Problem</h3>

<p>How do you authenticate the user without sending the password on every
web service call ?</p>

<h3>Forces</h3>

<p>Any of the following conditions justifies using the solution described
in this pattern:</p>

<p><strong>Keeping the username/password in memory on the web application is not
secure</strong>. An attacker can gain access to that sensitive data whenever it
leaves a secure area (such as a protected memory space).</p>

<p><strong>Sending a username without password:</strong>An attacker could pose as a
legitimate sender and send falsified messages, the message recipient can
not verify that incoming messages originated from a legitimate sender.</p>

<h3>Solution</h3>

<p>Use a combination of a Mutual X509 Binding with a Usernametoken (Without
password) as supporting token. The mutual X509 binding allows message
signing and encryption using X.509 certificates. This binding accesses
the client&rsquo;s private key, which is used to sign the message, and the
service&rsquo;s public key to encrypts the message. The service decrypts the
message using its private key and verifies the signature using the
public key of the client. The public key is in the client&rsquo;s X.509
certificate, which is included with the message.\
The service&rsquo;s public key can be obtained out-of-band from a X509
certificate installed on the client machine or through a negotiation
with the service.</p>

<p>Each token has a different purpose:</p>

<p>​1. A Client X509 token for the web application, it used for data origin
authentication, which enables the recipient to verify that messages have
not been tampered with in transit (data integrity) and that they
originate from the expected sender (In this case, the trusted web site).</p>

<p>​2. Service X509 token, it is used to encrypt and protect sensitive data
that is contained in a message</p>

<p>​3. Username token, it is used identify the user that originally make
the service call.</p>

<h3>Implementation</h3>

<p>Fortunately, the WCF SDK comes with examples that demonstrates the
following:</p>

<ul>
<li>How to pass additional security tokens to a service through
Supporting Tokens,
<a href="http://msdn2.microsoft.com/en-us/library/ms751480.aspx">http://msdn2.microsoft.com/en-us/library/ms751480.aspx</a></li>
<li>How to implement a custom username password validator. Since the
username token does not contain a password, the validator should not
authenticate anything.
<a href="http://msdn2.microsoft.com/en-us/library/aa354513.aspx">http://msdn2.microsoft.com/en-us/library/aa354513.aspx</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/12/24/configuration-merge-for-wcf/">Configuration Merge for WCF</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-12-24T00:00:00-03:00" pubdate data-updated="true">Dec 24<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/12/24/configuration-merge-for-wcf/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the blog&rsquo;s readers from Italy, <a href="http://dotnetside.org/blogs/fabio/">Fabio
Cozzolino</a> has written a interesting
host for WCF that gets and merges configuration from different
configuration files. You can download the code from <a href="http://dotnetside.org/blogs/fabio/archive/2007/12/15/Merge-di-file-di-configurazione-in-WCF.aspx">his
post</a>,
which is completely in Italian. (Anyway, the code is not, it is
English).</p>

<p>This could be a good solution to separate the configuration in logical
partitions or divisions, and then, have a central host that consolidates
all the configuration (It is a server side solution).  </p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/20/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/18/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/23/selfhost-utilities/">SelfHost Utilities</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/23/appfabric-outputcaching/">AppFabric OutputCaching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/31/making-ajax-calls-with-hawk-authentication-to-asp-dot-net-web-api/">Making Ajax Calls With Hawk Authentication to ASP.NET Web API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/13/coordinating-async-work-in-node-dot-js/">Coordinating Async Work in Node.js</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/27/oauth-bridge-for-adfs-with-thinkteckture-authorization-server/">OAuth Bridge for ADFS With ThinkTecture Authorization Server</a>
      </li>
    
  </ul>
</section>
 <a href="http://feeds.feedburner.com/cibrax"><img src="http://feeds.feedburner.com/~fc/cibrax?bg=FF3300&amp;fg=000000&amp;anim=0" style="border:0" alt="" /></a>

 <script type="text/javascript" language="javascript" src="http://twittercounter.com/embed/?username=cibrax&style=white"></script>
<a href="https://mvp.microsoft.com/en-us/mvp/Pablo%20Cibraro-33800"><img src="/images/mvp.gif" border="0" /></a>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pcibraro">@pcibraro</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pcibraro',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Cibrax -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cibrax';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
