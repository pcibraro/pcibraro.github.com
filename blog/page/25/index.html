
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pablo Cibraro (Cibrax)</title>
  <meta name="author" content="Cibrax">

  
  <meta name="description" content="This post describes how to implement a behavior to route messages by
means of the body element in the soap envelope. Routing messages in this way is &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cibrax.me/blog/page/25">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/cibrax" rel="alternate" title="Pablo Cibraro (Cibrax)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44468149-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pablo Cibraro (Cibrax)</a></h1>
  
    <h2>All about software development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/cibrax" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cibrax.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/01/31/436973/">Routing Messages by Means of the Body Element in WCF</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2006-01-31T00:00:00-03:00" pubdate data-updated="true">Jan 31<span>st</span>, 2006</time>
        
         | <a href="/blog/2006/01/31/436973/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post describes how to implement a behavior to route messages by
means of the body element in the soap envelope.</p>

<p>Routing messages in this way is useful in some scenarios where
the action is not available in the addressing headers or the SoapAction
http header.</p>

<p>The WCF SDK contains a sample that shows how to do something like that
but I don&rsquo;t like it very much since it depends on the service contract.
 </p>

<p>In that sample, the service itself is responsible to dispatch the
message to the right method.</p>

<p>\</p>

<p>[ServiceContract(Namespace = &ldquo;<a href="http://Microsoft.ServiceModel.Samples">http://Microsoft.ServiceModel.Samples</a>&rdquo;),
XmlSerializerFormat]</p>

<p>public interface IUntypedCalculator</p>

<p>{</p>

<p>   [OperationContract(Action=&ldquo;*&rdquo;)]</p>

<p>   Message Calculate(Message request);</p>

<p>}</p>

<p>\</p>

<p>That operation accepts any message and dispatch according to the body
element in that message.</p>

<p>This implementation is mainly based on the interface
&ldquo;IDispathOperationSelector&rdquo;. This interface allows you to optionally
inspect the message and return the name for the operation that will be
executed.</p>

<p>It contains the following methods:</p>

<p>\</p>

<p>public interface IDispatchOperationSelector</p>

<p>{</p>

<p>  string SelectOperation(ref Message message);</p>

<p>}</p>

<p>\</p>

<p>You can specify the name for the operation in the contract definition.  </p>

<p>\</p>

<p>[ServiceContract()]</p>

<p>interface IHelloWorld</p>

<p>{</p>

<p>  [OperationContract(Name=&ldquo;helloWorld&rdquo;), XmlSerializerFormat()]</p>

<p>  HelloWorldResponseMessage HelloWorld(HelloWorldRequestMessage
message);</p>

<p>}</p>

<p>\</p>

<p>In the sample above, the operation name is &ldquo;helloWorld&rdquo;. If you don&rsquo;t
specify the Name parameter for the OperationContract attribute, it takes
the method name as default name (&ldquo;HelloWorld&rdquo;).</p>

<p>\</p>

<p>The IServiceBehavior implementation provides an opportunity to set the
operation selector in the service processing pipeline. The easiest way
to add a behavior to service is via code as shown below. The service can
have more than one endpoint. This example sets the
IDispatchOperationSelector on all those endpoints.</p>

<p>\</p>

<p>/// &lt;summary></p>

<p>/// Sets this class as operation selector for all dispatch behaviors in
the service</p>

<p>/// &lt;/summary></p>

<p>public void ApplyBehavior(ServiceDescription description,
ServiceHostBase serviceHostBase,
System.Collections.ObjectModel.Collection&lt;DispatchBehavior> behaviors,
System.Collections.ObjectModel.Collection&lt;BindingParameterCollection>
parameters)</p>

<p>{</p>

<p>  foreach (DispatchBehavior dispatchBehavior in behaviors)</p>

<p>    dispatchBehavior.OperationSelector = this;</p>

<p>}</p>

<p>\</p>

<p><strong>Complete code</strong></p>

<p>\</p>

<hr />

<p>+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
| <strong>HelloWorld.cs</strong>                                                        |
|                                                                          |
| \                                                                        |
|                                                                          |
| ****                                                                     |
|                                                                          |
| using System;                                                            |
|                                                                          |
| using System.Collections.Generic;                                        |
|                                                                          |
| using System.Text;                                                       |
|                                                                          |
| using System.Xml.Serialization;                                          |
|                                                                          |
| using System.Runtime.Serialization;                                      |
|                                                                          |
| using System.ServiceModel;                                               |
|                                                                          |
| \                                                                        |
| namespace Service                                                        |
|                                                                          |
| {                                                                        |
|                                                                          |
|   [XmlRoot(ElementName=&ldquo;helloWorld&rdquo;)]                                    |
|                                                                          |
|   public class HelloWorldRequest                                         |
|                                                                          |
|   {                                                                      |
|                                                                          |
|     [XmlElement(&ldquo;value&rdquo;)]                                                |
|                                                                          |
|     public string Value;                                                 |
|                                                                          |
|   }                                                                      |
|                                                                          |
| \                                                                        |
|   [XmlRoot(ElementName = &ldquo;helloWorldResponse&rdquo;)]                          |
|                                                                          |
|   public class HelloWorldResponse                                        |
|                                                                          |
|   {                                                                      |
|                                                                          |
|     [XmlElement(&ldquo;value&rdquo;)]                                                |
|                                                                          |
|     public string Value;                                                 |
|                                                                          |
|   }                                                                      |
|                                                                          |
| \                                                                        |
|   [MessageContract()]                                                    |
|                                                                          |
|   public class HelloWorldRequestMessage                                  |
|                                                                          |
|   {                                                                      |
|                                                                          |
|     [MessageBody(Name=&ldquo;helloWorld&rdquo;)]                                     |
|                                                                          |
|     public HelloWorldRequest request;                                    |
|                                                                          |
|   }                                                                      |
|                                                                          |
| \                                                                        |
|   [MessageContract()]                                                    |
|                                                                          |
|   public class HelloWorldResponseMessage                                 |
|                                                                          |
|   {                                                                      |
|                                                                          |
|     [MessageBody(Name=&ldquo;helloWorldResponse&rdquo;)]                             |
|                                                                          |
|     public HelloWorldResponse response;                                  |
|                                                                          |
|   }                                                                      |
|                                                                          |
| \                                                                        |
|   [ServiceContract()]                                                    |
|                                                                          |
|   interface IHelloWorld                                                  |
|                                                                          |
|   {                                                                      |
|                                                                          |
|     [OperationContract(Name=&ldquo;helloWorld&rdquo;), XmlSerializerFormat()]        |
|                                                                          |
|     HelloWorldResponseMessage HelloWorld(HelloWorldRequestMessage        |
| message);                                                                |
|                                                                          |
|   }                                                                      |
|                                                                          |
| \                                                                        |
|   [RouteByBodyElementBehavior()]                                         |
|                                                                          |
|   class HelloWorldService : IHelloWorld                                  |
|                                                                          |
|   {                                                                      |
|                                                                          |
|     #region IHelloWorld Members                                         |
|                                                                          |
|                                                                          |
|                                                                          |
|     public HelloWorldResponseMessage HelloWorld(HelloWorldRequestMessage |
| message)                                                                 |
|                                                                          |
|     {                                                                    |
|                                                                          |
|       HelloWorldResponse response = new HelloWorldResponse();            |
|                                                                          |
|       response.Value = &ldquo;Hello World &rdquo; + message.request.Value;           |
|                                                                          |
|                                                                          |
|                                                                          |
|       HelloWorldResponseMessage responseMessage = new                    |
| HelloWorldResponseMessage();                                             |
|                                                                          |
|       responseMessage.response = response;                               |
|                                                                          |
|       return responseMessage;                                            |
|                                                                          |
|    }                                                                     |
|                                                                          |
|    #endregion                                                           |
|                                                                          |
|   }                                                                      |
|                                                                          |
| }                                                                        |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+</p>

<p>\</p>

<p>+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
| <strong>RouteByBodyElementBehavior.cs</strong>                                        |
|                                                                          |
| \                                                                        |
|                                                                          |
| ****                                                                     |
|                                                                          |
| using System;                                                            |
|                                                                          |
| using System.Collections.Generic;                                        |
|                                                                          |
| using System.Text;                                                       |
|                                                                          |
| using System.Xml;                                                        |
|                                                                          |
| using System.Reflection;                                                 |
|                                                                          |
| using System.IO;                                                         |
|                                                                          |
| using System.ServiceModel;                                               |
|                                                                          |
| \                                                                        |
| namespace Service                                                        |
|                                                                          |
| {                                                                        |
|                                                                          |
|   /// &lt;summary>                                                        |
|                                                                          |
|   /// This behavior routes messages by means of the body element         |
|                                                                          |
|   /// &lt;/summary>                                                       |
|                                                                          |
|   [AttributeUsage(AttributeTargets.Class, AllowMultiple=false)]          |
|                                                                          |
|   class RouteByBodyElementBehavior : Attribute, IServiceBehavior,        |
| IDispatchOperationSelector                                               |
|                                                                          |
|   {                                                                      |
|                                                                          |
|     #region IDispatchOperationSelector Members                          |
|                                                                          |
|     /// &lt;summary>                                                      |
|                                                                          |
|     /// Selects the operation according to first element in the body     |
| element                                                                  |
|                                                                          |
|     /// &lt;/summary>                                                     |
|                                                                          |
|     /// &lt;param name=&ldquo;message&rdquo;>&lt;/param>                               |
|                                                                          |
|     /// &lt;returns>&lt;/returns>                                          |
|                                                                          |
|     public string SelectOperation(ref Message message)                   |
|                                                                          |
|     {                                                                    |
|                                                                          |
|       XmlDocument document = new XmlDocument();                          |
|                                                                          |
|       document.Load(message.GetReaderAtBodyContents());                  |
|                                                                          |
|                                                                          |
|                                                                          |
|       //Get the body element operation                                   |
|                                                                          |
|       string bodyElement = document.DocumentElement.LocalName;           |
|                                                                          |
|                                                                          |
|                                                                          |
|      // Create new message                                               |
|                                                                          |
|      XmlNodeReader reader = new XmlNodeReader(document.DocumentElement); |
|                                                                          |
|      Message newMsg = Message.CreateMessage(message.Version, null,       |
| reader);                                                                 |
|                                                                          |
| \                                                                        |
|      // Preserve the headers of the original message                     |
|                                                                          |
|      newMsg.Headers.CopyHeadersFrom(message);                            |
|                                                                          |
|      foreach (string propertyKey in message.Properties.Keys)             |
|                                                                          |
|        newMsg.Properties.Add(propertyKey,                                |
| message.Properties[propertyKey]);                                        |
|                                                                          |
| \                                                                        |
|      // Close the original message and return new message                |
|                                                                          |
|      message.Close();                                                    |
|                                                                          |
|      message = newMsg;                                                   |
|                                                                          |
| \                                                                        |
|      return bodyElement;                                                 |
|                                                                          |
|    }                                                                     |
|                                                                          |
|    #endregion                                                           |
|                                                                          |
| \                                                                        |
|                                                                          |
|    #region IServiceBehavior Members                                     |
|                                                                          |
|    /// &lt;summary>                                                       |
|                                                                          |
|    /// Sets this class as operation selector for all dispatch behaviors  |
| in the service                                                           |
|                                                                          |
|    /// &lt;/summary>                                                      |
|                                                                          |
|    public void ApplyBehavior(ServiceDescription description,             |
| ServiceHostBase serviceHostBase,                                         |
| System.Collections.ObjectModel.Collection&lt;DispatchBehavior>            |
| behaviors,                                                               |
| System.Collections.ObjectModel.Collection&lt;BindingParameterCollection>  |
| parameters)                                                              |
|                                                                          |
|    {                                                                     |
|                                                                          |
|      foreach (DispatchBehavior dispatchBehavior in behaviors)            |
|                                                                          |
|        dispatchBehavior.OperationSelector = this;                        |
|                                                                          |
|    }                                                                     |
|                                                                          |
|    #endregion                                                           |
|                                                                          |
|  }                                                                       |
|                                                                          |
| }                                                                        |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/01/24/436334/">WS-Polling Implementation for WSE</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2006-01-24T00:00:00-03:00" pubdate data-updated="true">Jan 24<span>th</span>, 2006</time>
        
         | <a href="/blog/2006/01/24/436334/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I used some of free time last week to write a prototype of
<a href="http://www.w3.org/Submission/ws-polling/">WS-Polling</a> for WSE 3.0. \
Unfortunately, I couldn&rsquo;t finish the complete specification but it is
enough to execute web services asynchronously.\
If you haven&rsquo;t read anything about WS-Polling before, it is basically a
specification to execute web services asynchronously and poll to the
server later in order to get the response.\
If you take a look to this specification, you probably will able to see
three main parts:\
\
1. A mechanism to execute web services and store the response for later
retrieval\
2. Some headers to query information about the status of an execution\
3. A mailbox implementation\
\
For the moment, I only implemented the first part and I&rsquo;m trying to
finish the second one.\
\</p>

<h3>Implementation structure</h3>

<p>The diagram below illustrates the classes used by this implementation. \
\
<img src="/images/legacy/Classes.gif" alt="" /> \
\
I defined a abstract class PollingService that declares a method to get
messages. This class also uses an IMessageStore provider to store and
retrieve the request and response messages for the concrete service. \
The concrete service is a normal service that implements different
business methods and inherits from the base class PollingService. e.g.
MyHelloWorldService\
The IMessageStore is an interface that declares methods to store and
retrieve messages from an specific store such as Database, MSMQ or a
file. \
PollingClient and ConcreteProxy are both proxies to invoke methods in
the Concrete service, but the last one was created by the tool
WSEWsdl3.exe and it doesn&rsquo;t know how to invoke the service
asynchronously.\
I had to develop a custom PollingClient since the proxy created with
WSEWsdl3.exe does not offer the following features:\
\
1. Access to the WS-Addressing headers. For this implementation, the
client must change the wsa:ReplyTo header and get access to others
headers\
such as wsa:MessageID and wsa:To. \
2. Make a one-way call. The proxy created by the tool waits for an
answer from the service in most of the cases.</p>

<h3>How this solution works</h3>

<p><img src="/images/legacy/Sequence.gif" alt="" /></p>

<p>​1. The client application wants to invoke a asynchronous method on the
webservice so it creates a PollingClient instance and calls to the
method &ldquo;InvokeService&rdquo;.\
2. The PollingClient instance sets the value
&ldquo;<a href="http://www.w3.org/2005/08/ws-polling/HoldResponse">http://www.w3.org/2005/08/ws-polling/HoldResponse</a>&rdquo; for the header
wsa:ReplyTo and uses the WSE infrastructure to send the request message
to the server.\
3. The concrete service receives the request message and checks the
value for the wsa:ReplyTo header. \
If this value is &ldquo;<a href="http://www.w3.org/2005/08/ws-polling/HoldResponse">http://www.w3.org/2005/08/ws-polling/HoldResponse</a>&rdquo;, it
executes the concrete method asynchronously, otherwise it executes the
concrete method in the usual way.\
4. If the concrete method was executed asynchronously, the service
stores the request and response messages by means of the configured
IStoreProvider. Otherwise, it returns the response message to the
client.\
5. The client application can ask later for the response message using
the GetMessages method on the PollingClient instance. \
(The GetMessages method will receive the wsa:MessageID for the original
request message as parameter)</p>

<h3>Some code</h3>

<p>​1. Creating the Concrete service\</p>

<p>[WebService(Namespace = &ldquo;<a href="http://tempuri.org/">http://tempuri.org/</a>&rdquo;)]\
[WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]\
[Policy(&ldquo;ServicePolicy&rdquo;)]\
public class Service : WSEPolling.PollingService\
{\
\
  public Service()\
  {\
\
  }\
\
\
  [SoapMethod(&ldquo;HelloWorld&rdquo;)]\
  public string HelloWorld(string name)\
  {\
    return &ldquo;Hello World &rdquo; + name;\
  }\
\
}\</p>

<p>This class looks like a normal web service but it inherits from the base
class PollingService.</p>

<p>​2. Creating the client application\</p>

<p>class Program\
{\
    static void Main(string[] args)\
    {\
      PollingClient client = new PollingClient(new
Uri(&ldquo;<a href="http://localhost/WSEPollingService/Service.ashx">http://localhost/WSEPollingService/Service.ashx</a>&rdquo;));\
\
      client.SetPolicy(&ldquo;ClientPolicy&rdquo;); \
\
      string s = &ldquo;Test&rdquo;;\
\
      Uri id = client.InvokeService(&ldquo;HelloWorld&rdquo;, s,
&ldquo;<a href="http://tempuri.org/">http://tempuri.org/</a>&rdquo;);\
\
      System.Threading.Thread.Sleep(1000);\
\
      WSEPolling.GetMessageRequest request = new
WSEPolling.GetMessageRequest();\
      request.MessageID = id.ToString();\
\
      //Gets the entire soap envelope\
      SoapEnvelope response = client.GetMessage(request);\
\
      //Gets only the body of the soap envelope\
      //string message = (string)client.GetMessageBody(request,
typeof(string), &ldquo;<a href="http://tempuri.org/">http://tempuri.org/</a>&rdquo;);\
\
      string message = response.OuterXml;\
\
       Console.WriteLine(message);\
    }\
}</p>

<p>In the code below, I created a PollingClient instance to invoke the
&ldquo;HelloWorld&rdquo; service. The InvokeService method returns the wsa:MessageId
value for the request message, which I keep in the variable &ldquo;id&rdquo;. \
At the end, I retrieve the response message from the server passing the
value of the variable &ldquo;id&rdquo; to the GetMessage method.\</p>

<p>​3. The PollingService class</p>

<p>public class PollingService : SoapService\
{\
  static IMessageStore _store;\
\
  static PollingService()\
  {\
    _store = new DatabaseMessageStore();\
    _store.Init(null);\
  }\
\
  [SoapMethod(WSPolling.Actions.GetMessage)]\
  public virtual SoapEnvelope GetMessage(GetMessageRequest request)\
  {\
    SoapEnvelope envelope = _store.GetResponse(request);\
\
    RelatesTo relatesTo = new
RelatesTo(RequestSoapContext.Current.Addressing.MessageID.Value);\
    envelope.Context.Addressing.RelatesTo = relatesTo;\
\
    return envelope;\
  }\
\
  protected override SoapMethodInvoker RouteRequest(SoapEnvelope
request)\
  {\
    return new AsyncSoapMethodInvoker(this,
base.RouteRequest(request));\
  }\
\
  protected virtual void StoreResponse(SoapEnvelope response)\
  {\
    _store.StoreResponse (response); \
  }\
\
  protected virtual void StoreRequest(SoapEnvelope request)\
  {\
     _store.StoreRequest(request);\
  }\
\
  class AsyncSoapMethodInvoker : SoapMethodInvoker\
  {\
    private SoapMethodInvoker _invoker;\
    private PollingService _service;\
\
    public AsyncSoapMethodInvoker(PollingService service,
SoapMethodInvoker invoker)\
    {\
      this._invoker = invoker;\
      this._service = service;\
    }\
\
    public override SoapEnvelope Invoke(SoapEnvelope message)\
    {\
      if (message.Context.Addressing.Action !=
WSPolling.Actions.GetMessage &amp;&amp;\
        message.Context.Addressing.ReplyTo != null &amp;&amp;\
        message.Context.Addressing.ReplyTo.Address.Value.ToString() ==
WSPolling.HoldResponseURI)\
      {\
        this._service.StoreRequest(message);\
        WaitCallback callBack = new WaitCallback(this.Invoke);\
        ThreadPool.QueueUserWorkItem(callBack, message);\
        return new SoapEnvelope();\
      }\
      else\
      {\
        SoapEnvelope response = _invoker.Invoke(message);\
        return response;\
      }\
    }\
\
    public override bool OneWay\
    {\
      get { return _invoker.OneWay; }\
    }\
\
    private void Invoke(object state)\
    {\
      SoapEnvelope request = (SoapEnvelope)state;\
      SoapEnvelope response = _invoker.Invoke(request);\
\
      _service.StoreResponse(response);\
    }\
  }\
}</p>

<p>The RouteRequest is the key method in this implementation. \
This method returns a SoapMethodInvoker instance, which knows how to
call a specific method in the concrete service. (WSE provides a default
implementation of this class)\
In this case, I developed my own class AsyncSoapMethodInvoker, which
calls to the SoapMethod synchronously or asynchronously depending on the
value of wsa:ReplyTo header.\
As you can see in the code, I used the Thread pool provided by .NET to
execute the web method asynchronously.</p>

<p>​4. The Database message store implementation</p>

<p>class DatabaseMessageStore : IMessageStore\
{\
  private string _connectionString = null;\
\
  public void Init(XmlElement configuration)\
  {\
    ConnectionStringSettings settings =
ConfigurationManager.ConnectionStrings[&ldquo;Messages&rdquo;];\
\
    if(settings == null)\
      throw new ConfigurationErrorsException(&ldquo;The connection string
&lsquo;Messages&rsquo; is not configured&rdquo;);\
\
    if(settings.ConnectionString == null)\
      throw new ConfigurationErrorsException(&ldquo;Invalid value for the
connection string &lsquo;Messages&rsquo;&rdquo;);\
\
    this._connectionString = settings.ConnectionString;\
  }\
\
  public void StoreRequest(SoapEnvelope request)\
  {\
    using (SqlConnection connection = new
SqlConnection(this._connectionString))\
    {\
      connection.Open();\
      using (SqlCommand command = new SqlCommand(&ldquo;InsertMessage&rdquo;,
connection))\
      {\
        command.CommandType = System.Data.CommandType.StoredProcedure;\
        command.Parameters.Add(new SqlParameter(&ldquo;@MessageID&rdquo;,
request.Context.Addressing.MessageID.Value.ToString()));\
        command.Parameters.Add(new SqlParameter(&ldquo;@To&rdquo;,
request.Context.Addressing.To.Value.ToString()));\
\
        command.ExecuteNonQuery();\
      }\
      connection.Close();\
    }\
  }\
\
  public void StoreResponse(SoapEnvelope response)\
  {\
    response.Context.Addressing.GetXml(response);\
    using (SqlConnection connection = new
SqlConnection(this._connectionString))\
    {\
      connection.Open();\
      using (SqlCommand command = new SqlCommand(&ldquo;UpdateMessage&rdquo;,
connection))\
      {\
        command.CommandType = System.Data.CommandType.StoredProcedure;\
        command.Parameters.Add(new SqlParameter(&ldquo;@MessageID&rdquo;,
response.Context.Addressing.RelatesTo.Value.ToString()));\
        command.Parameters.Add(new SqlParameter(&ldquo;@Message&rdquo;,
response.OuterXml));\
        command.ExecuteNonQuery();\
      }\
      connection.Close();\
    }\
  }\
\
  public SoapEnvelope GetResponse(GetMessageRequest request)\
  {\
    SoapEnvelope response = new SoapEnvelope();\
    using (SqlConnection connection = new
SqlConnection(this._connectionString))\
    {\
      connection.Open();\
      using (SqlCommand command = new SqlCommand(&ldquo;GetMessage&rdquo;,
connection))\
      {\
        command.CommandType = System.Data.CommandType.StoredProcedure;\
        command.Parameters.Add(new SqlParameter(&ldquo;@MessageID&rdquo;,
request.MessageID.ToString()));\
\
        using (SqlDataReader reader =
command.ExecuteReader(System.Data.CommandBehavior.CloseConnection))\
        {\
          if (reader.Read())\
          {\
            if (reader[&ldquo;Message&rdquo;] == DBNull.Value )\
            {\
              NoMessageAvailable noMessage = new
NoMessageAvailable(Reason.ResponseNotReady);\
              response.Context.Addressing.Action =
WSPolling.Actions.NoMessageAvailable; \
              response.SetBodyObject(noMessage);\
            }\
            else\
            {\
              string message = (string)reader[&ldquo;Message&rdquo;];\
\
              response.Load(new StringReader(message));\
              response.Context.Addressing.RemoveXml(response);\
            }\
          }\
          else\
          {\
            NoMessageAvailable noMessage = new
NoMessageAvailable(Reason.NoMessageFound);\
            response.Context.Addressing.Action =
WSPolling.Actions.NoMessageAvailable; \
            response.SetBodyObject(noMessage);\
          }\
\
          reader.Close();\
\
        }\
      }\
\
      connection.Close();\
    }\
\
    return response;\
  }\
}</p>

<p>This class is quite simple. It implements the interface IMessageStore
and contains code to store and query messages from a SQL database. \
\
Well, this is all I have for the moment. You can download the code from
the following <a href="/images/legacy/WSPolling.zip">location</a>.\
This is a prototype and it should not be used in production
environments.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/12/14/433118/">Web Service Security Patterns Released</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-12-14T00:00:00-03:00" pubdate data-updated="true">Dec 14<span>th</span>, 2005</time>
        
         | <a href="/blog/2005/12/14/433118/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The Patterns &amp; Practices team has released the web service security
patterns in the MSDN.\
This guide provides excellent material about many security patterns and
how they can be applied in different scenarios. For example, to
authenticate a client or to validate a message as well.</p>

<p>The patterns are grouped under the following categories:</p>

<p>Authentication patterns</p>

<p>Message protection patterns</p>

<p>Implementing Transport and Message Layer Security</p>

<p>Resource Access Patterns</p>

<p>Service Boundary Protection Patterns</p>

<p>Service Deployment Patterns</p>

<p>If are looking for good security practices or &ldquo;security&rdquo; is one of your
main concerns, I recommend you to take a look. \
\
You can find them under the following link
<a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnpag2/html/wssp.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnpag2/html/wssp.asp</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/11/25/431528/">Interoperability Between WSE 2.0 and WSE 3.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-11-25T00:00:00-03:00" pubdate data-updated="true">Nov 25<span>th</span>, 2005</time>
        
         | <a href="/blog/2005/11/25/431528/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is probably one of the main concerns for people involved in the
development of web services using WSE. \
Unfortunately, WSE 3.0 was designed from the beginning to be compatible
at wire level with Indigo and therefore it doesn&rsquo;t interoperate well
with WSE 2.0.\
To be clear, &ldquo;Wire compatible&rdquo; means equivalent messages. \
I wrote this post to provide some necessary points to obtain
interoperability between both versions.\</p>

<h3>WS-Security xx specs</h3>

<p>At this moment, there are two available versions of this specification,
1.0 and 1.1 (Also called WS-Security extensions). \
WSE 2.0 only implements the first version whereas WSE 3.0 uses features
of both versions (such as signature confirmation and key derivation). \
Both endpoints, the client and the server should use features provided
only by WS-Security 1.0.\</p>

<h3>Secure conversation</h3>

<p>Secure Conversation is a special feature provided by WSE, in which
client and server negotiate a session token to protect the communication
for a specific period of time. This feature decrease the response time
because the token negotiation happens once compared to other turn-key
scenarios where the negotiation is done for each message. (This feature
is really important when the client and the server interchange many
messages during a period of time). \
The SecureContext token used in WSE 3.0 is not compatible with WSE 2.0
since it was modified to support new features like &ldquo;Stateful secure
context tokens&rdquo;.\</p>

<h3>WS-Addressing xx specs</h3>

<p>WSE 3.0 uses a newer version of this specification (The same as Indigo)
and therefore the messages produced by both versions are not
compatible.\
There is not a good way to fix this problem, but probably a SoapFilter
to update the addressing headers can be a solution.\</p>

<h3>Algorithm suite</h3>

<p>WSE 3.0 uses by default the same algorithm suite as Indigo, AES256 for
symmetric encryption and RSA-OAEP for key wrap. On the other hand, WSE
2.0 uses AES128 and RSA-15.\
You will have to update the configuration settings in both endpoints in
order to use the same algorithm suite.\
I explained how to change this setting in a previous
<a href="http://weblogs.asp.net/cibrax/archive/2005/09/19/425555.aspx">post</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/10/04/426585/">X509 Turn-Key Scenarios for WSE 3.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-10-04T00:00:00-03:00" pubdate data-updated="true">Oct 4<span>th</span>, 2005</time>
        
         | <a href="/blog/2005/10/04/426585/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you got the chance to look into the WSE 3.0 code, maybe you noticed
that it comes with two turn-key scenarios for X509 tokens,
“CertificateMutualAuthenticationProfileAssertion” and
“MutualCertficateAssertion” (This assertion adds some new features from
WS 1.1). \
Both scenarios are completely different, so I decided to write this post
to describe how they work and how the keys are interchanged in each
one.\
First of all, I will give a brief description about a new class
“EncryptedKeyToken” introduced in this version of WSE.\
This introduction is really important since this token is used in many
places for the assertions to encrypt messages.\</p>

<h3>What is an “EncryptedKeyToken” ?</h3>

<p>Asymmetric keys require more CPU cycles than symmetric keys to encrypt
data.\
Therefore, when a SOAP message is encrypted or digitally signed using an
X509SecurityToken security token, an EncryptedKeyToken containing a
symmetric session key is generated to encrypt the SOAP message. That
session key is encrypted using the public key of the asymmetric key pair
associated with the X509SecurityToken.\
This token also existed in the previous versions of WSE, but it was
something internal and the developer could not use it as he can do now.\</p>

<h3>Turn-key scenarios for X509 tokens</h3>

<p><strong>CertificateMutualAuthenticationProfileAssertion</strong>\
\</p>

<p>1.  <strong>Client Output Filter</strong>\
  a.  Signs the message with the client token, which is an X509 token
containing the client private key. Adds the client token to the message\
  b.  Creates an EncryptedKeyToken with a session key using the X509
service token (Public key). This token is used to encrypt the message,
and after that, it is added to the message.\
\
2.  <strong>Service Input Filter</strong>\
  a.  Gets the EncryptedKeyToken and the X509 client token from the
message.\
  b.  Validates the EncryptedKeyToken with the X509 service token
configured in the server.\
  c.  Decrypts the message using the EncryptedKeyToken received in the
message.\
  d.  Verifies the message signature using the X509 client token
received in the message.\
\
3.  <strong>Service Output Filter</strong>\
  a.  Creates an EncryptedKeyToken with a session key using the X509
client token received in the request message. Encrypts the message with
that token. The token is added to the response message.\
  b.  Signs the message using the X509 service token (Private key). This
token is not added to the message since the client has the service
public key.\
\
4.  <strong>Client Input Filter</strong>\
  a.   Gets the EncryptedKeyToken from the response message.\
  b.  Validates the EncryptedKeyToken with the X509 client token
configured in the client.\
  c.  Decrypts the response message using the EncryptedKeyToken\
  d.  Verifies the signature using the X509 service token configured in
the client. (Public key).\</p>

<p><strong>MutualCertificateAssertion</strong>\
\</p>

<p>1.  <strong>Client Output Filter</strong>\
  a.  Creates an EncryptedKeyToken with a session key using the X509
service token (Public key).\
  b.  Adds the configured X509 client token in the message.\
  c.  Signs and encrypts the request message using the
EncryptedKeyToken. (Including the X509 client token).\
\
2.  <strong>Service Input Filter</strong>\
  a.  Gets the EncryptedKeyToken and the X509 client token from the
message.\
  b.  Validates the EncryptedKeyToken with the X509 service token
configured in the server. \
  c.  Decrypts the message using the EncryptedKeyToken.\
  d.  Verifies the signature using the EncryptedKeyToken.\
\
3.  <strong>Service Output filter</strong>\
  a.  Signs and encrypts the message using the EncryptedKeyToken
received in the request message.\
\
4.  <strong>Client Input filter</strong>\
  a.  Decrypts the message and verifies the signature using the
EncryptedKeyToken created in the Client output filter.\</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/09/28/426136/">Binding an ADAM Principal to Azman</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-09-28T00:00:00-03:00" pubdate data-updated="true">Sep 28<span>th</span>, 2005</time>
        
         | <a href="/blog/2005/09/28/426136/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As I mentioned in a previous post, I had a lot of problems last
week trying to bind an ADAM principal to Azman.\
I found a way to do that using the Azman PIA but unfortunately it is not
supported by the Azman Role provider shipped within ASP.NET 2.0.\
There are two available versions of Azman PIA, 1.0 and 1.2. The latest
version was released within the W2k3 SP 1 and contains some improvements
compared with the version 1.0.\
The only way I found to bind an ADAM principal to Azman was through the
user’s SID\</p>

<p>//ADAM Provider was configured in the Web.Config file\
MembershipUser user = Membership.GetUser(&ldquo;<a href="&#x6d;&#x61;&#105;&#x6c;&#x74;&#x6f;&#58;&#x6d;&#121;&#x75;&#x73;&#x65;&#x72;&#x40;&#x4d;&#121;&#x44;&#x6f;&#x6d;&#97;&#105;&#110;&#x2e;&#x63;&#111;&#x6d;">&#109;&#x79;&#x75;&#x73;&#101;&#114;&#x40;&#77;&#121;&#68;&#x6f;&#109;&#x61;&#x69;&#110;&#x2e;&#x63;&#111;&#x6d;</a>&rdquo;);\
\
AzAuthorizationStoreClass store = new AzAuthorizationStoreClass();\
\
store.Initialize(0,
&ldquo;msldap://localhost:389/CN=AzManADAMStore,CN=Users,DC=MyDomain,DC=Com&rdquo;,
null); \
\
IAzApplication2 azApp = store.OpenApplication2(&ldquo;MyApp&rdquo;, null);\
\
//We need to use the SID instead of the user name, so the
ProviderUserKey is used.\
IAzClientContext context =
azApp.InitializeClientContextFromStringSid(user.ProviderUserKey.ToString(),
1, null);\
\
object roles = context.GetRoles(&ldquo;&rdquo;);\</p>

<p>Some notes about this code:\
\
1. The ADAM membership provider was configured in the application. \
2. The code is using the AzMan PIA directly. \
3. The method InitializeClientContextFromStringSid must be used instead
of InitializeClientContextFromName. The last method only works for
Windows principals and it is the one used by the
AuthorizationRoleProvider class in ASP.NET. That&rsquo;s why it only works for
windows principals. \
4. A SID is required instead of a user-friendly name (We can get the SID
from the ProviderUserKey property).\</p>

<p>As far I know the only possible solution is to develop a custom Role
Provider, which is not a good one because a SID is required instead of a
friendly-name.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/09/19/425566/">Problems With Azman and ADAM</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-09-19T00:00:00-03:00" pubdate data-updated="true">Sep 19<span>th</span>, 2005</time>
        
         | <a href="/blog/2005/09/19/425566/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Configuring both products to work together can be a nightmare. \
I&rsquo;ve spent almost three days trying to configure Azman and ADAM
membership providers in a normal ASP.NET application, but I couldn&rsquo;t.\
I wanted to use ADAM as user/group repository and Azman as authorization
repository (to have fine grained access control and manage roles). \
This
<a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnpag2/html/paght000018.asp">article</a>
from MSDN has helped me a lot to configure both products, but it&rsquo;s a
little tricky. It shows how to use ADAM as a repository for the Azman
schema, but not as authentication server. Instead it uses a windows user
to get the azman roles.\</p>

<p>Has anybody configured both products?. I would appreciate any help or
comments on this.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/09/19/425555/">Default Algorithms in WSE 3.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-09-19T00:00:00-03:00" pubdate data-updated="true">Sep 19<span>th</span>, 2005</time>
        
         | <a href="/blog/2005/09/19/425555/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>WSE 2.0 and 3.0, both provide AES128 + RSA 1.5 as default algorithms for
symmetric encryption and key-wrap.\
However, AES256 + RSA-OAEP are always recommended for these purposes,
and Indigo will ship with that combination as default.</p>

<p>In WSE 2.0, these algorithms could be changed adding some settings in
the configuration file:</p>

<p>&lt;microsoft.web.services2>\
&hellip;\
  &lt;security>\
  &hellip;. \
    &lt;binarySecurityTokenManager\
      valueType=&ldquo;<a href="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-x509-token-profile-1.0#X509v3">http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-x509-token-profile-1.0#X509v3</a>&rdquo;>\
      &lt;sessionKeyAlgorithm name=&ldquo;TripleDES&rdquo;/>   &lt;!&mdash; add this to
switch to TripleDes from default AES128 &mdash;>\
      &lt;keyAlgorithm name=&ldquo;RSAOAEP&rdquo;/>  &lt;!&mdash; add this to switch to
RSA-OEAP from default RSA15 &mdash;>\
    &lt;/binarySecurityTokenManager>\
  &lt;/securityç>\
&hellip;\
&lt;microsoft.web.services2>\</p>

<p>These settings don&rsquo;t affect in the same way to WSE 3.0 because it
implements some changes in the code used to secure messages. The
security assertions\
shipped within WSE 3.0 use different tokens to secure messages, they
don&rsquo;t use an X509 security token anymore, instead they use derived
tokens.\</p>

<p><strong>EncryptedToken</strong>: Usually, this token is used by the security
assertions to sign and encrypt messages.</p>

<p><strong>DerivedKeyToken</strong>: Only used when the flag &ldquo;DeriveKeys&rdquo; is on.</p>

<p><strong>SecureContextToken</strong>: Only used in secure conversations. (When the
flag &ldquo;establishSecurityContext&rdquo; is on)</p>

<p>The following configuration shows how to override the default algorithm
used by these tokens: \</p>

<p>&lt;microsoft.web.services3>\
  &lt;security>\
&lt;binarySecurityTokenManager>\
  &lt;add \
    type=&ldquo;Microsoft.Web.Services3.Security.Tokens.X509SecurityTokenManager,
Microsoft.Web.Services3, Version=3.0.0.0, Culture=neutral,
PublicKeyToken=31BF3856AD364E35&rdquo;\
   valueType=&ldquo;<a href="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-x509-token-profile-1.0#X509v3">http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-x509-token-profile-1.0#X509v3</a>&rdquo;>\
    &lt;keyAlgorithm name=&ldquo;RSAOAEP&rdquo;/>\
  &lt;/add>\
&lt;/binarySecurityTokenManager>\
&lt;securityTokenManager>\
  &lt;add localName=&ldquo;EncryptedKey&rdquo;\
   type=&ldquo;Microsoft.Web.Services3.Security.Tokens.EncryptedKeyTokenManager,
Microsoft.Web.Services3, Version=3.0.0.0, Culture=neutral,
PublicKeyToken=31BF3856AD364E35&rdquo;\
    namespace=&ldquo;<a href="http://www.w3.org/2001/04/xmlenc#">http://www.w3.org/2001/04/xmlenc#</a>&rdquo;>\
    &lt;keyAlgorithm name=&ldquo;AES256&rdquo;/>\
  &lt;/add>\
  &lt;add localName=&ldquo;DerivedKeyToken&rdquo;>\
    type=&ldquo;Microsoft.Web.Services3.Security.Tokens.DerivedKeyTokenManager,
Microsoft.Web.Services3, Version=3.0.0.0, Culture=neutral,
PublicKeyToken=31BF3856AD364E35&rdquo;\
    namespace=&ldquo;<a href="http://schemas.xmlsoap.org/ws/2005/02/sc">http://schemas.xmlsoap.org/ws/2005/02/sc</a>&rdquo;>\
    &lt;keyAlgorithm name=&ldquo;AES256&rdquo;/>\
  &lt;/add>\
  &lt;add localName=&ldquo;SecurityContextToken&rdquo; \
    type=&ldquo;Microsoft.Web.Services3.Security.Tokens.SecurityContextTokenManager,
Microsoft.Web.Services3, Version=3.0.0.0, Culture=neutral,
PublicKeyToken=31BF3856AD364E35&rdquo; \
    namespace=&ldquo;<a href="http://schemas.xmlsoap.org/ws/2005/02/sc">http://schemas.xmlsoap.org/ws/2005/02/sc</a>&rdquo;>\
    &lt;keyAlgorithm name=&ldquo;AES256&rdquo;/>\
  &lt;/add>\
&lt;/securityTokenManager>\
&lt;/security>\
&lt;/microsoft.web.services3>\</p>

<p> </p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/08/01/421233/">SAML Preview for WSE 3.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-08-01T00:00:00-03:00" pubdate data-updated="true">Aug 1<span>st</span>, 2005</time>
        
         | <a href="/blog/2005/08/01/421233/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Nowadays, single sign-on is a common problem in many applications.
Getting some credentials from a well-known authentication authority, \
and use them later in different places is a good idea, but sometimes is
difficult to implement. \
Different vendors have implemented solutions to solve this problem, but
they lack a main attribute, &ldquo;Interoperability&rdquo;. \
SAML comes to solve this problem, providing a secure and interoperable
protocol based on xml. \
SAML is an acronym for &ldquo;Security Assertions Markup Language&rdquo;, a
vendor-neutral framework for exchanging security-related information
called &ldquo;assertions&rdquo;.\
Its first specification set (1.0) was developed by the &ldquo;OASIS&rdquo;
consortium. \
The SAML specification doesn&rsquo;t define any mechanism for authentication
or authorization, instead, it establishes how identity and access
information is exchanged.\</p>

<h3>Sample Scenario</h3>

<p><img src="/images/legacy/SAML1.gif" alt="" /></p>

<p>This image illustrates a client using a SAML token to consume a web
service.\
The client and the service don&rsquo;t know each other, but both trust in the
same authority. \
So the client can authenticate once against that authority and use the
SAML assertion to consume the service.\</p>

<h3>SAML implementation for WSE 3.0</h3>

<p>An initial preview for this implementation is available in this <a href="http://practices.gotdotnet.com/projects/saml">GDN
workspace</a>, and it is
based on the new policy framework shipped in WSE 3.0.\
We are open to hear your feedback on on what you think about this
solution, so, don&rsquo;t miss this opportunity.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2005/07/19/419921/">WS-I BSP Sample Application for WSE 3</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-07-19T00:00:00-03:00" pubdate data-updated="true">Jul 19<span>th</span>, 2005</time>
        
         | <a href="/blog/2005/07/19/419921/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The <strong>&ldquo;WS-I Basic Security Profile Sample Application&rdquo;</strong> preview for WSE
3.0 is out, you can get it in the <a href="http://practices.gotdotnet.com/projects/wsibsp">GDN
workspace</a>.\
This sample illustrates how to build secure and interoperable web
services based in the specification <a href="http://www.ws-i.org/Profiles/BasicProfile-1.1-2004-08-24.html">WS-I Basic Profile
1.1</a>. \
When we started to develop this application, we faced some challenges,
all of them related to the new policy framework shipped in WSE 3.0. \
Some parts of the policies used by the previous version of this
application weren&rsquo;t easy to migrate, so we had to develop some custom
assertions.\
In this post, I will give a brief description about the new WSE &ldquo;Policy
framework&rdquo;, and the custom assertion shipped in this preview.
(CustomX509Assertion)</p>

<h3>Policy framework</h3>

<p><img src="/images/legacy/ArchitectureWSE.gif" alt="" />\
\
<strong>Policies</strong>\
\
A policy allows to apply different claims for incoming and outgoing
messages on the client and the service (All messages to a particular
endpoint).\
It is used to describe the requirements for a service and as a factory
for runtime objects &ndash; Pipeline and Assertions. \
As you can see in the image, the policy is converted in a pipeline at
runtime. This pipeline contains an ordered list of assertions, \
each assertion performs different message transformations through the
use of Filters. \
\
Policy definition sample: \</p>

<p>&lt;policies>\
  &lt;extensions>\
    &lt;extension name=&ldquo;mutualX509Security&rdquo;
type=&ldquo;Microsoft.Web.Services3.Design.MutualX509Assertion,
Microsoft.Web.Services3, Version=3.0.0.0, Culture=neutral,
PublicKeyToken=31bf3856ad364e35&rdquo; />\
    &lt;extension name=&ldquo;x509&rdquo;
type=&ldquo;Microsoft.Web.Services3.Design.X509TokenProvider,
Microsoft.Web.Services3, Version=3.0.0.0, Culture=neutral,
PublicKeyToken=31bf3856ad364e35&rdquo; />\
  &lt;/extensions>\
  &lt;policy name=&ldquo;MyPolicy&rdquo;>\
    &lt;mutualX509Security establishSecurityContext=&ldquo;false&rdquo;
renewExpiredSecurityContext=&ldquo;true&rdquo; signatureConfirmation=&ldquo;true&rdquo;
protectionOrder=&ldquo;SignBeforeEncryptingAndEncryptSignature&rdquo;
deriveKeys=&ldquo;true&rdquo; actor=&ldquo;&rdquo;>\
      &lt;clientToken>\
        &lt;x509 storeLocation=&ldquo;CurrentUser&rdquo; storeName=&ldquo;My&rdquo;
findValue=&ldquo;CN=WSE2QuickStartClient&rdquo;
findType=&ldquo;FindBySubjectDistinguishedName&rdquo; />\
      &lt;/clientToken>\
      &lt;serviceToken>\
        &lt;x509 storeLocation=&ldquo;CurrentUser&rdquo; storeName=&ldquo;AddressBook&rdquo;
findValue=&ldquo;CN=WSE2QuickStartServer&rdquo;
findType=&ldquo;FindBySubjectDistinguishedName&rdquo; />\
      &lt;/serviceToken>\
      &lt;protection>\
        &lt;request signatureOptions=&ldquo;IncludeAddressing, IncludeTimestamp,
IncludeSoapBody&rdquo; encryptBody=&ldquo;true&rdquo; />\
        &lt;response signatureOptions=&ldquo;IncludeAddressing,
IncludeTimestamp, IncludeSoapBody&rdquo; encryptBody=&ldquo;true&rdquo; />\
        &lt;fault signatureOptions=&ldquo;IncludeAddressing, IncludeTimestamp,
IncludeSoapBody&rdquo; encryptBody=&ldquo;false&rdquo; />\
      &lt;/protection>\
    &lt;/mutualX509Security>\
  &lt;/policy>\
&lt;/policies>\
\</p>

<p>In this case, the policy specifies security requirements for the
service. ( Some parts of the message should be encrypted and signed with
X509 certificates) \
\
A policy can be assigned to a proxy or a service using a declarative or
imperative way. The following examples show how to assign a policy \
to a proxy and a service:\
\
<strong>Client proxy with PolicyAttribute:</strong> \
\</p>

<p>[PolicyAttribute(&ldquo;MyPolicy&rdquo;)]\
public partial class MyService :
Microsoft.Web.Services3.WebServicesClientProtocol \
{\
  public string HelloWorld() {\
    object[] results = this.Invoke(&ldquo;HelloWorld&rdquo;, new object[0]);\
    return ((string)(results[0]));\
  }\
}\</p>

<p>\
<strong>Imperative use of policy on the client</strong> \
\</p>

<p>MyService service = new MyService();\
service.SetPolicy(&ldquo;MyPolicy&rdquo;);</p>

<p>\
<strong>Web Service with PolicyAttribute:</strong> \
\</p>

<p>[PolicyAttribute(&ldquo;MyPolicy&rdquo;)]\
public class MyService : System.Web.Services.WebService \
{\
  [WebMethod]\
  public string HelloWorld() {\
    return &ldquo;Hello world&rdquo;;\
  }\
}\</p>

<p>\
<strong>Assertions</strong>\
\
An assertion uses filters to perform message processing in different
stages. Each assertion is capable of creating up to four soap filters: \
\</p>

<p><strong>ClientOutputFilter:</strong> for outgoing messages on the client</p>

<p><strong>ClientInputFilter:</strong> for incoming messages on the client</p>

<p><strong>ServiceOutputFilter:</strong> for outgoing messages on the service</p>

<p><strong>ServiceInputFilter:</strong> for incoming messages on the service \
\
An assertion may not create a filter in one of the four locations. In
that case, this assertion does not affect message processing in this
location.\
For example, a security assertion could use the output stages to protect
a soap document, and the input stages to validate that protection \
\
<strong>Assertion code sample :</strong> \
\</p>

<p>class MyAssertion : PolicyAssertion\
{\
  public override SoapFilter
CreateClientInputFilter(FilterCreationContext context)\
  {\
    return null;\
   }\
\
   public override SoapFilter
CreateClientOutputFilter(FilterCreationContext context)\
   {\
     return null;\
   }\
\
   public override SoapFilter
CreateServiceInputFilter(FilterCreationContext context)\
   {\
     return null;\
   }\
\
   public override SoapFilter
CreateServiceOutputFilter(FilterCreationContext context)\
   {\
     return null;\
   }\
}\</p>

<p>\
This assertion does not return any filter, it is useless in a real
scenario. \
\
WSE includes the following list of assertions:\
\</p>

<hr />

<p>  AnonymousOverCertificateAssertion                 The client is not authenticated and the security protection is via a server&rsquo;s X.509 certificate
  CertificateMutualAuthenticationProfileAssertion   X.509 certificates are used for authentication and message protection. It doesn&rsquo;t use the WS-Security 1.1 extensions
  KerberosAssertion                                 Kerberos tickets are used for authentication and message protection
  MutualCertificateAssertion                        X.509 certificates are used for authentication and message protection. It uses the WS-Security 1.1 extensions
  UsernameOverCertificateAssertion                  The client is authenticated via a suplied &ldquo;UsernameToken&rdquo; ( user and password ) and the security protection is performed by a X.509 certificate
  UsernameOverTransportAssertion                    The client is authenticated via a supplied &ldquo;UsernameToken&rdquo; and the security protection is performed at the transport level
  AuthorizationAssertion                            It performs authorization checks using the identity token. The identity token is determined after the client authentication</p>

<hr />

<p>\
<strong>Filters</strong>\
\
Soap filters use lower level mechanisms to perform different message
processing tasks. For example, a security filter could use signatures
and encryption tokens to protect a message.\
All filters inherit from the base class &ldquo;SoapFilter&rdquo; and implement the
abstract method &ldquo;ProcessMessage&rdquo;. \
\</p>

<p>public abstract class SoapFilter\
{\
  protected SoapFilter();\
  public virtual T GetBehavior();\
  public abstract SoapFilterResult ProcessMessage(SoapEnvelope
envelope);\
}</p>

<p>\
That method returns a &ldquo;SoapFilterResult&rdquo; class, which is used to control
the pipeline execution. It can take the following values:\
\</p>

<p>Continue: To keep executing the next filters in the pipeline</p>

<p>Terminate: To terminate the pipeline execution\
\
WSE also includes the classes &ldquo;SendSecurityFilter&rdquo; and
&ldquo;ReceiveSecurityFitler&rdquo; to build security filters. These classes inherit
from &ldquo;SoapFilter&rdquo;, but they implement the &ldquo;ProcessMessage&rdquo; method in
order to parse the security headers included in the soap document. \
\</p>

<p>public abstract class SendSecurityFilter : SoapFilter\
{\
  protected abstract void SecureMessage(SoapEnvelope envelope, Security
security);\
} \
\
public abstract class SendSecurityFilter : SoapFilter\
{\
  protected abstract void ValidateMessageSecurity(SoapEnvelope envelope,
Security security);\
}</p>

<h3>Custom Security Assertion</h3>

<p>The &ldquo;MutualCertificateAssertion&rdquo; did not solve some security aspects
required \
by the application, so we had to develop a custom security assertion (
&ldquo;X509CustomSecurityAssertion&rdquo; ) \
This assertion allows us to fulfill the following requeriments: \
\
1. Sign and encrypt the messages with different X509 certificates ( One
certificate to sign the message and \
another to encrypt it ). The &ldquo;MutualCertificateAssertion&rdquo; assertion only
signs and encrypts the messages with a key derived from\
the same certificate.\
2. Different certificates for requests and responses. The
&ldquo;MutualCertificateAssertion&rdquo; does not allow to specify that\
3. Custom headers encryption. The &ldquo;MutualCertificateAssertion&rdquo; only
signs custom headers, but it does not encrypt them.\
4. Different protection order for the request and response. The
&ldquo;MutualCertificateAssertion&rdquo; specifies the same protection order\
for the request and the response ( Protection order =
SignBeforeEncryptingAndEncryptSignature, SignBeforeEncrypting,
EncryptBeforeSigning).\
\
This policy is used by client application to consume the Retailer
services:\</p>

<p>&lt;policy name=&ldquo;RetailerServices&rdquo;>\
  &lt;customX509Security actor=&ldquo;&rdquo;>\
    <strong>&lt;request></strong>\
      &lt;clientToken>\
        &lt;!&mdash; WebClient Signing Certificate &mdash;>\
        &lt;x509 storeLocation=&ldquo;LocalMachine&rdquo; storeName=&ldquo;My&rdquo;
findValue=&ldquo;8d5f67d8991bc6517785b3266a333fb871cf2c6f&rdquo;
findType=&ldquo;FindBySubjectKeyIdentifier&rdquo; />\
      &lt;/clientToken>\
      &lt;serviceToken>\
        &lt;!&mdash; Retailer Encrypting Certificate &mdash;>\
        &lt;x509 storeLocation=&ldquo;LocalMachine&rdquo; storeName=&ldquo;My&rdquo;
findValue=&ldquo;944e5a12f31f6f8456ae6ad479581792af15eb6b&rdquo;
findType=&ldquo;FindBySubjectKeyIdentifier&rdquo; />\
      &lt;/serviceToken>\
    <strong>&lt;/request></strong>\
    <strong>&lt;response></strong>\
      &lt;clientToken>\
        &lt;!&mdash;Retailer Signing Certificate&mdash;> \
        &lt;x509 storeLocation=&ldquo;LocalMachine&rdquo; storeName=&ldquo;My&rdquo;
findValue=&ldquo;4cd379e9caff8759da99b17c85ffa15b66c60dcb&rdquo;
findType=&ldquo;FindBySubjectKeyIdentifier&rdquo; />\
      &lt;/clientToken>\
      &lt;serviceToken>\
        &lt;!&mdash; WebClient Encrypting Certificate &mdash;>\
        &lt;x509 storeLocation=&ldquo;LocalMachine&rdquo; storeName=&ldquo;My&rdquo;
findValue=&ldquo;399cb4ee8d3339c36618f667dfa03183948f145c&rdquo;
findType=&ldquo;FindBySubjectKeyIdentifier&rdquo; />\
      &lt;/serviceToken>\
    <strong>&lt;/response></strong>\
    &lt;!&mdash; getCatalog &mdash;>\
    &lt;protection requestAction=&ldquo;getCatalog&rdquo;>\
      &lt;request signatureOptions=&ldquo;IncludeAddressing, IncludeTimestamp,
IncludeSoapBody&rdquo; encryptBody=&ldquo;false&rdquo;
<strong>protectionOrder=&ldquo;SignBeforeEncrypting&rdquo;</strong>>\
        <strong>&lt;customHeader name=&ldquo;UsernameToken&rdquo;
ns=&ldquo;<a href="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd">http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd</a>&rdquo;
signed=&ldquo;true&rdquo; encrypted=&ldquo;false&rdquo;>&lt;/customHeader></strong>\
      &lt;/request>\
      &lt;response signatureOptions=&ldquo;IncludeTimestamp, IncludeSoapBody&rdquo;
encryptBody=&ldquo;true&rdquo;
<strong>protectionOrder=&ldquo;SignBeforeEncryptingAndEncryptSignature&rdquo;</strong> />\
    &lt;/protection>\
    &lt;!&mdash; submitOrder &mdash;>\
    &lt;protection requestAction=&ldquo;submitOrder&rdquo;>\
      &lt;request signatureOptions=&ldquo;IncludeAddressing, IncludeTimestamp,
IncludeSoapBody&rdquo; encryptBody=&ldquo;true&rdquo;
<strong>protectionOrder=&ldquo;SignBeforeEncryptingAndEncryptSignature&rdquo;</strong>>\
        <strong>&lt;customHeader name=&ldquo;Configuration&rdquo;
ns=&ldquo;<a href="http://www.ws-i.org/SampleApplications/SupplyChainManagement/2002-08/Configuration.xsd">http://www.ws-i.org/SampleApplications/SupplyChainManagement/2002-08/Configuration.xsd</a>&rdquo;
signed=&ldquo;true&rdquo; encrypted=&ldquo;false&rdquo;>&lt;/customHeader></strong>\
        <strong>&lt;customHeader name=&ldquo;UsernameToken&rdquo;
ns=&ldquo;<a href="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd">http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd</a>&rdquo;
signed=&ldquo;true&rdquo; encrypted=&ldquo;true&rdquo;>&lt;/customHeader></strong>\
      &lt;/request>\
      &lt;response signatureOptions=&ldquo;IncludeTimestamp, IncludeSoapBody&rdquo;
encryptBody=&ldquo;true&rdquo;
<strong>protectionOrder=&ldquo;SignBeforeEncryptingAndEncryptSignature&rdquo;</strong> />\
    &lt;/protection>\
  &lt;/customX509Security>\
&lt;/policy></p>

<p>\
Many changes were introduced to the policy. It supports different X509
certificates for requests and responses (&ldquo;Request&rdquo; and &ldquo;Response&rdquo;
elements ).\
Also, it specifies different protection requirements for custom headers
and different protection order for each message. \
\
If you are interested to build secure and interoperable web services,
then you should look this application, it is a good starting point.\
That is all for now, I will blog more about WSE and WSI soon.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/26/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/24/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/23/appfabric-outputcaching/">AppFabric OutputCaching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/31/making-ajax-calls-with-hawk-authentication-to-asp-dot-net-web-api/">Making Ajax Calls With Hawk Authentication to ASP.NET Web API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/13/coordinating-async-work-in-node-dot-js/">Coordinating Async Work in Node.js</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/27/oauth-bridge-for-adfs-with-thinkteckture-authorization-server/">OAuth Bridge for ADFS With ThinkTecture Authorization Server</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/22/automatic-client-cert-detection-in-adfs-2-dot-0/">Automatic Client Cert Detection in ADFS 2.0</a>
      </li>
    
  </ul>
</section>
 <a href="http://feeds.feedburner.com/cibrax"><img src="http://feeds.feedburner.com/~fc/cibrax?bg=FF3300&amp;fg=000000&amp;anim=0" style="border:0" alt="" /></a>

 <script type="text/javascript" language="javascript" src="http://twittercounter.com/embed/?username=cibrax&style=white"></script>
<a href="https://mvp.microsoft.com/en-us/mvp/Pablo%20Cibraro-33800"><img src="/images/mvp.gif" border="0" /></a>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pcibraro">@pcibraro</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pcibraro',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Cibrax -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cibrax';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
