
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pablo Cibraro (Cibrax)</title>
  <meta name="author" content="Cibrax">

  
  <meta name="description" content="Web Sockets is a relatively new specification introduced as part of HTML
5 to support a full duplex-communication channel over http in web
browsers &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cibrax.me/blog/page/6">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/cibrax" rel="alternate" title="Pablo Cibraro (Cibrax)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44468149-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pablo Cibraro (Cibrax)</a></h1>
  
    <h2>All about software development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/cibrax" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cibrax.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/06/10/to-push-or-not-to-push-the-web-socket-dilemma/">To Push, or Not to Push, the Web Socket Dilemma</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-10T00:00:00-03:00" pubdate data-updated="true">Jun 10<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/06/10/to-push-or-not-to-push-the-web-socket-dilemma/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Web Sockets is a relatively new specification introduced as part of HTML
5 to support a full duplex-communication channel over http in web
browsers.  This  represents a great advance toward real-time and event
driven web applications. Before Web Sockets jumped in scene, the only
available  solutions for emulating real time notifications in web
applications were different variants of Http Long polling. Real time
notifications in this context became particularly important for specific
scenarios, such as reporting stock pricing updates, online gaming or
news reports to name a few.</p>

<p>All the Http polling variants were pretty much similar in nature. They
all try to emulate a bidirectional connection over http by keeping
client connections open for a period of time until some notifications
becomes available and can be sent as part of the response or the
connection times out.  However, these techniques usually require the use
of two connections for streaming data to and from the client. Another
common issue with this approach is that developers need to implement the
server side carefully to make an efficient use of the server resources.</p>

<p>There is, however, an area where Http polling has proved to very
effective over the years, and that is pub/sub. We can find in this area
simple usages of pub/sub over http like syndication feeds or more
complex solutions for business to business integration, but as you can
see, they are not related to real time notifications in a web browser at
all.</p>

<p>Web Sockets on the other hand is going to be supported natively on any
web browser compliant with HTML 5, so  removing the need of relying on
different workarounds with HTTP Ajax and timers for emulating real time
notifications in the browser.  As I said before, the specification is
relatively new so the support you find today in all the major browsers
is partial or incompatible in some cases. However, I am pretty sure Web
Sockets will become the standard technology for pushing real time data
to web browsers in the upcoming years. </p>

<h2>Web Sockets in Detail</h2>

<p>The Web Socket interface definition according to the spec looks as
follow,</p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: white; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
[Constructor(in DOMString url)]
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: #f4f4f4; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
interface WebSocket {
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: white; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
readonly attribute DOMString URL;
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: #f4f4f4; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
// ready state
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: white; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
const unsigned short CONNECTING = 0;
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: #f4f4f4; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
const unsigned short OPEN = 1;
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: white; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
const unsigned short CLOSED = 2;
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: #f4f4f4; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
readonly attribute int readyState;
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: white; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
// networking
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: #f4f4f4; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
attribute EventListener onopen;
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: white; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
attribute EventListener onmessage;
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: #f4f4f4; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
attribute EventListener onclosed;
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: white; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
void postMessage(in DOMString data);
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: #f4f4f4; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
void disconnect();
</del></p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: white; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
};
</del></p>

<p>As you can see, this API is very straightforward and simple to use.
There is a constructor you can use to create a new Web Socket instance
or connection, a callback for receiving messages (onmessage) and two
additional methods for sending new messages (postMessage) or close the
socket instance (disconnect) respectively. .</p>

<p>A Web Socket connection is established by upgrading from the HTTP
protocol to the Web Socket protocol during an initial handshake between
the client and the server, over the same underlying TCP/IP connection.
Once the connection is established, the data can be sent back and forth
between the client and the server in full-duplex mode. Here is how you
create a new Web Socket connection in the browser,</p>

<p>var mySocket = new WebSocket(&ldquo;ws://weblogs.asp.net/cibrax&rdquo;);</p>

<p>The “ws” prefix indicates a Web Socket connection. There is also a “wss”
prefix for secure connections. Once the connection has been opened, you
can associate a handler for the “onmessage” event for start receiving
messages,</p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: white; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
mySocket.onmessage = function(evt) { alert( &ldquo;Message Received:  &rdquo;  +  evt.data); };
</del></p>

<p>Or send messages with the “postMessage” method,</p>

<p><del> {style=&ldquo;BORDER-BOTTOM-STYLE: none; TEXT-ALIGN: left; PADDING-BOTTOM: 0px; LINE-HEIGHT: 12pt; BORDER-RIGHT-STYLE: none; BACKGROUND-COLOR: white; MARGIN: 0em; PADDING-LEFT: 0px; WIDTH: 100%; PADDING-RIGHT: 0px; FONT-FAMILY: &lsquo;Courier New&rsquo;, courier, monospace; DIRECTION: ltr; BORDER-TOP-STYLE: none; COLOR: black; FONT-SIZE: 8pt; BORDER-LEFT-STYLE: none; OVERFLOW: visible; PADDING-TOP: 0px&rdquo;}
mySocket.postMessage(&ldquo;Hello World!!!!&rdquo;);
</del></p>

<p>There are a couple of implementations already in .NET for implementing
the server side part required for pushing notifications, and some of
there are <a href="http://nugget.codeplex.com/">Nugget</a> (Not really a good name
for an open source project given the existing NuGet project from
Microsoft) or <a href="https://github.com/statianzo/Fleck">Fleck</a>.   The WCF
team is also working on an implementation as part of the WCF Web Apis
framework and you can see some announcements
<a href="http://blogs.msdn.com/b/endpoint/archive/2011/04/24/websockets-ria-js-and-wcf-web-api-at-mix-a-whole-lotta-love-for-the-web.aspx">here</a>.</p>

<h2>Web Sockets in the Cloud</h2>

<p>There is a particular implementation in the cloud that caught my
attention in the last few months, and that is
<a href="http://pusher.com/">“Pusher”</a>. “Pusher” is a service hosted in the
cloud that provides all the service side infrastructure for pushing
notifications to the different clients (browsers running in all kind of
devices or personal computers) using web sockets if it is available or a
flash-based socket communication otherwise.</p>

<p> <a href="http://weblogs.asp.net/blogs/cibrax/Pusher_03AF728F.jpg"><img src="http://weblogs.asp.net/blogs/cibrax/Pusher_thumb_3B1583BD.jpg" title="Pusher" alt="Pusher" /></a></p>

<p>Your server code publishes notifications in an specific “Pusher” channel
using a simple REST Api, and they take care of broadcasting the
notifications to all the subscribers for that channel. They provide a
javascript API  that you can use in a web page for subscribing to a
channel, and the REST API for publishing messages on the server side.
There is also different open source implementations for wrapping up the
REST API in a simple object model, and you can find here for example to
<a href="https://github.com/grahamscott/pusherdotnet">“PusherDotNet”</a>, a .NET
implementation in C#. The pricing model is also very easy to
understand, you pay for a flat rate that gives you access to a specific
number of messages and connections per day.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/06/06/pub-sub-in-the-cloud-a-brief-comparison-between-azure-service-bus-and-pubnub/">Pub/Sub in the cloud–A Brief Comparison Between Azure Service Bus and PubNub</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-06T00:00:00-03:00" pubdate data-updated="true">Jun 6<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/06/06/pub-sub-in-the-cloud-a-brief-comparison-between-azure-service-bus-and-pubnub/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Publish/Subscribe in the cloud has became relatively important lately as
an integration pattern for business to business scenarios between
organizations. The major benefit of using a service hosted in the cloud
as intermediary is that publishers and subscribers don’t need to be
publicly addressable, be in the same network  or be able to talk each
other directly. The cloud infrastructure allows this intermediary
service to scale correctly as the number of publishers or subscribers
increase, and also to act as a firewall for brokering the communication
(Publishers or subscribers need explicit permissions to connect, send or
receive messages from the intermediary service).</p>

<p>This pattern can  be used in workflow systems to relay events among
distributed computer applications, update data in business systems or as
a way to move data between data stores. For example, in an order
processing application, notifications must be sent whenever a
transaction occurs; an order is placed in a system, the order details
are forwarded as a message to a payment processor service for approval,
and finally, an order confirmation message is sent back to the system
where the order was originally created.</p>

<p><a href="http://weblogs.asp.net/blogs/cibrax/pubsub_478E0620.jpg"><img src="http://weblogs.asp.net/blogs/cibrax/pubsub_thumb_5A6289CA.jpg" title="pubsub" alt="pubsub" /></a></p>

<p>This infrastructure typically supports the idea of “topics” or named
logical channels. Subscribers will receive all the messages published to
the topics to which they subscribe, and all subscribers to a topic will
receive the same messages.</p>

<p>I am going to discuss today two available solutions in the cloud, the
“AppFabric Service Bus”, which is part of the Microsoft PaaS cloud
strategy known as Azure and also a relatively new implementation
“PubNub” hosted in the  Amazon EC2 cloud infrastructure.</p>

<h2>AppFabric Service Bus</h2>

<p>The AppFabric Service Bus is a service running in Microsoft data
centers. This service acts as broker for relaying messages through the
cloud to services running on premises behind network obstacles of any
kind, such as firewalls or NAT devices. The Service Bus secures all its
endpoints by using the claim based security model provided by the Access
Control service (Another service available as part of Azure AppFabric).
You can find a lot of interesting features as part of the service bus
such as federated authentication for listening or sending to the cloud, 
a naming mechanism for the endpoints in the cloud, a common messaging
fabric with a great variety of communication options, or a discoverable
service registry that any application trying to integrate with it can
use. \
In the first release, the service bus originally provided a relay
service for integrating on-premises applications with services running
on the cloud. At that time, the integration with the relay service could
be done in two ways, a message buffer in the cloud accessible through a
REST API or using the traditional WCF programming model with special
channels talking to the relay service on the cloud. By using the WCF
programming model, the interaction with the relay binding was almost
transparent for applications, as all the communications details were
handled at channel level by WCF.  This message buffer was a temporary
store for the messages, so they disappeared after being consumed or when
they expired.</p>

<p>The AppFabric team recently announced the availability of a new feature
for supporting durable messaging at the service bus level. Durable
messaging in this context comes in two flavors,  reliable message
queuing and  durable publish/subscribe messaging. The main difference
between them is the number of parties that can consume a message
published in the service bus. While a message is consumed by a single
party when a queue is used, the publish/subscribe model relies on
topics, which allows multiple parties to subscribe to the messages
received in an specific topic (Every party receives a copy of the
message basically).</p>

<p>The pricing model for the service bus is currently based on the number
of used connections. Every message sent to the service bus usually
involves two connections, one connection for sending or publishing the
message and another connection for receiving it (this might change for
the model where you have multiple subscribers for a message). <a href="http://social.msdn.microsoft.com/Forums/en-US/netservices/thread/11d687db-7b3f-4148-8e81-48a8290f8146/">This
thread</a>
in the MSDN forums discusses the model in details, and I have to admit
it takes some time to digest.</p>

<p>Advantages</p>

<ul>
<li>The service bus supports a good isolation level based on service
namespaces.  A service namespace represents a level of isolation for
a particular set endpoints, and you can associate multiple service
namespaces to an Azure account. For example, you can have two
different applications associated to your Azure account and each one
them listening on a different service namespace address.</li>
<li>The great number of communication options you can find as part of
the service bus.</li>
<li>The REST API, the .NET APIs and the WCF bindings makes the service
bus really easy to use from any application.</li>
</ul>


<p>Disadvantages</p>

<ul>
<li>The pricing model is to complex to understand and it is hard to
predict. Microsoft does not currently offers a good monitoring
option for determining the number of used connections or predicting
costs before receiving the monthly bill.</li>
<li>The number of service namespaces that you can create in an specific
Azure account is limited (I believe the number is 50 namespaces, and
that number can be increased if you make an explicit request). This
is still a big problem if you want to use the service bus to route
messages to several machines listening on different namespaces, or
support a multitenant schema in which a different namespace is
assigned per tenant. </li>
<li>There is not an API for managing the service namespaces, which
represents an inconvenient if you want to allocate service
namespaces dynamically.</li>
</ul>


<h2>PubNub</h2>

<p>PubNub is a relatively new push service hosted in the cloud. It’s
currently hosted in the Amazon EC2 infrastructure, and provide a set of
APIs for pushing or receiving messages in almost all the languages and
platforms you can imagine. All those APIs are also available as open
source in <a href="https://github.com/pubnub/pubnub-api">GitHub</a>.   While the
main purpose of this service is to serve as a mechanism for pushing data
to different devices (mobile devices, web browsers, etc) via Http, I can
also a find a good use case of this service for pub/sub in the
enterprise.</p>

<p>PubNub pushes data to the different subscribers using a BOSH comet
technology. The idea BOSH comet is to define a transport protocol that
emulates the semantics of a long-lived, bidirectional TCP connection
between a client and a server by efficiently using multiple synchronous
HTTP request/response pairs without requiring the use of frequent
polling or chunked responses.</p>

<p>Subscribers must issue a API call to begin listening for messages on an
specific channel (similar to a topic), automatically keeping the
connection open until the application is closed. Every message sent by a
client application to an specific channel will be forwarded to all the
subscriber listening on that channel.</p>

<p>One the main disadvantages probably is the maximum size for the message
payload that you can send or receive, which is 1.8 Kb (This limit might
be increased, or otherwise, you might need to implement a chunking
channel on your end).</p>

<p>Advantages</p>

<ul>
<li>Extremely fast and easy to use.</li>
<li>The pricing model is very easy to understand, you pay for every
message that you sent basically. This model scales well for a great
number of clients and servers as well as the price you pay for every
message is relatively cheap.</li>
<li>They offer an API for managing accounts, which is the mechanism they
use for billing.</li>
<li>Client API available in a great number of technologies and
languages.</li>
</ul>


<p>Disadvantages</p>

<ul>
<li>The supported message payload size, which is by default, 1.8 kb.</li>
<li>They don’t have an exclusive isolation level like the service bus
does. The only isolation level here is the account.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/05/27/integrating-elmha-with-mongodb/">Integrating ELMAH With MongoDB</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-05-27T00:00:00-03:00" pubdate data-updated="true">May 27<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/05/27/integrating-elmha-with-mongodb/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>MongoDB is by far one of the most well-known and powerful documental
databases created in the open source community. The simplicity that you
find in this database is also another factor that help a lot in
adoption, as you don’t need to know much to start using it.  </p>

<p>ELMAH, which stands for Error Logging Modules and Handlers, is another
famous open source project in the .NET world. Almost any ASP.NET
developer in the planet is already familiar with the project and what
you can do it with it. If you haven’t heard of it yet, it is an
extensible framework that provides an application-wide error logging
facility for ASP.NET applications.</p>

<p>MongoDB represents a group of documents as a collection. As an analogy
with relational databases, a document could be seen as a row, and a
collection as a table. The main difference is that collections are
schema-free and can store any kind of document, and a document can have
any structure.</p>

<p>Collections are usually created dynamically and automatically grow in
size to fit additional data.  However, there is an specific collection
type called “capped collection”, which is created in advance and is
fixed in size. A capped collection behave like circular queues, so if
the collection runs out of space, the oldest documents will be deleted,
and the new ones will take their place. Documents in this type of
collection can not be moved or deleted, making this collection extremely
fast for new insertions. There is no need to allocate additional space,
or search through a free list to find the right place to put a document.
The inserted document can always be placed directly at the tail of the
collection and overwrite old documents if needed.</p>

<p>This makes capped collections a great fit for use cases like logging.
Having said that, capped collections in MongoDB are also a great
candidate for being used in a logging provider for ELMAH. </p>

<p>ELMAH organizes log entries per application, so I though it would be a
good idea to use the same approach in MongoDB and have separate
collections for applications. For this implementation, I used
<a href="https://github.com/samus/mongodb-csharp">mongodb-csharp</a>.</p>

<p>When a new entry needs to be persisted in the database, I first check
whether the collection exists and I create one on the fly in case it
does not.</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
using (var mongo = new Mongo(_connectionString))
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
{
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>mongo.Connect();
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>var master = mongo.GetDatabase("master");
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>IMongoCollection collection = null;
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>if (!master.GetCollectionNames().Any(collectionName =&gt; collectionName.EndsWith(ApplicationName)))
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>{
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    // Create event collection
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    var options = new Document();
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    options.Add("capped", true);
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    options.Add("max", _maxEntriesCount);
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    options.Add("size", _defaultCollectionSize);
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    master.Metadata.CreateCollection(ApplicationName, options);
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    var indexes = new Document();
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    indexes.Add("id", 1);
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    collection = master.GetCollection(ApplicationName);
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    collection.MetaData.Indexes.Add("id", indexes);
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>}
</code></pre>

<p>~~~~</p>

<p>As you can see, that’s something really easy to accomplish with a few
lines of code. I also created an index for the “id” property, which is
the one that ELMAH uses for searching specific entries.</p>

<p>Once the collection is created, the ELMAH log entries need to be
transformed to a document and stored in the collection, so I wrote an
small helper for doing that.</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
var document = ErrorDocument.EncodeDocument(error);
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
document.Add(&ldquo;id&rdquo;, id);
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
collection.Save(document);
</del></p>

<p>Getting the documents from the collection is also very straightforward,
as the MongoDB API already support paging, which is something the ELMHA
providers must provide.</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
mongo.Connect();
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
var master = mongo.GetDatabase(&ldquo;master&rdquo;);
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
var collection = master.GetCollection(ApplicationName);
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
var documents = collection.FindAll()
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>.Skip(pageIndex * pageSize)
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>.Limit(pageSize)
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>.Documents;
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
foreach (var document in documents)
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
{
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>var errorLog = ErrorDocument.DecodeError(document);
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>errorEntryList.Add(new ErrorLogEntry(this, (string)document["id"], errorLog));
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
}
</del></p>

<p>You can use this provider in any existing ASP.NET web application by
adding this configuration to define the provider and the connection
string to an existing MongoDB instance.</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
<elmah>
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>&lt;errorLog type="Elmah.MongoDb.MongoDbErrorLog, Elmah.MongoDb" connectionStringName="ELMAH.MongoDB" /&gt;
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
</elmah>
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
<connectionStrings>
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>&lt;add name="ELMAH.MongoDB" connectionString="Server=localhost:27017"/&gt;
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
</connectionStrings>
</del></p>

<p>The code is available to download from
<a href="/images/legacy/MongoDbErrorLog.zip">here</a>. (Don’t forget
to download the <a href="https://github.com/samus/mongodb-csharp">MongoDB</a>
drivers to compile the code)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/05/25/extending-the-so-aware-repository-with-custom-metadata/">Extending the SO-Aware Repository With Custom Metadata</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-05-25T00:00:00-03:00" pubdate data-updated="true">May 25<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/05/25/extending-the-so-aware-repository-with-custom-metadata/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the main features that SO-Aware provides is the central
repository for storing service artifacts (WSLD, schemas, bindings) and
configuration that any organization generates. This central repository
is completely exposed as an OData service that third party applications
and tools can easily consume using Http.</p>

<p>However, the initial SO-Aware release lack of support for extending the
standard artifacts with custom metadata. For example, if you wanted to
associate some external documentation to your WCF bindings or set the
developer or owner for an specific service,  that was not supported out
of the box.</p>

<p>Based on all the feedback we received from customers, we decided to
include this feature in the latest version. From the UI standpoint, you
will see a new tab “Custom Metadata” in every resource.</p>

<p><a href="http://weblogs.asp.net/blogs/cibrax/Metadata_12A02530.png"><img src="http://weblogs.asp.net/blogs/cibrax/Metadata_thumb_3CBFAD4B.png" title="Metadata" alt="Metadata" /></a>     </p>

<p>The custom metadata that you can associate to existing resources is
represented by key/value pairs (Metadata Term and Value). For example,
the Metadata term can be “Owner” and the value “Pablo Cibraro”.</p>

<p>SO-Aware will create also a dictionary of available “Metadata” terms
that every user can reuse in the repository.  These metadata terms can
also be queried and modified through the standard OData API that the
repository exposes. </p>

<p>Enjoy!!.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/05/18/caching-strategies-for-soap-and-rest-services/">Caching Strategies for SOAP and REST Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-05-18T00:00:00-03:00" pubdate data-updated="true">May 18<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/05/18/caching-strategies-for-soap-and-rest-services/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>SOAP services are in nature transport agnostics so they can not rely on
specific transport features. Http is a great example where SOAP services
make a poor use of Http as application protocol. This means that many of
the http constraints are simply ignored, http headers are not used at
all, messages are not self descriptive (You can not easily infer what a
message does by looking at the content), the uniform interface is not
used either as everything goes as a POST to the server and the list
keeps growing. This makes impossible to leverage the existing web
architecture and use intermediaries for caching results.  </p>

<p>As consequence of this, the only viable alternative is to provide
caching as part of the service implementation. Caching at this level
might be a good option for improving the service performance when some
bottlenecks are detected and caused by IO operations with long delays
(Calls to databases, legacy services, etc.) or CPU intensive code. In
both scenarios, you might want to keep the results in memory as much as
you can to reuse them in the service implementation. Here is where a
distributed cache solution like AppFabric caching, NCache or MemCached
makes a lot of sense. Local caches in memory such as Enterprise library
might be another option but only if you are not running services in a
farm scenario.</p>

<p>Client applications might opt to cache responses from the services too,
but there is not any explicit mechanism for negotiating the lifetime of
the cached copies between clients and services, making necessary to use
out of band information.</p>

<p><a href="http://weblogs.asp.net/blogs/cibrax/Cache_663FEA5F.jpg"><img src="http://weblogs.asp.net/blogs/cibrax/Cache_thumb_6BAE5B03.jpg" title="Cache" alt="Cache" /></a> </p>

<p>On the other hand, REST services can reuse all the available caching
infrastructure in the web by leveraging Http as application protocol.
Http already specifies headers for caching control and a process to
revalidate cached copies that any intermediary can use (No need to use
out of band information). Intermediaries in this contexts are usually
represented by local caches like the one might find in a browser,
proxies or reverse proxies. In described the implementation details
<a href="http://weblogs.asp.net/cibrax/archive/2011/04/25/implementing-caching-in-your-wcf-web-apis.aspx">here</a>.</p>

<p><a href="http://weblogs.asp.net/blogs/cibrax/Cache2_02F95F75.jpg"><img src="http://weblogs.asp.net/blogs/cibrax/Cache2_thumb_0867D019.jpg" title="Cache2" alt="Cache2" /></a></p>

<p>REST services can still use a caching layer on the service
implementation as it was discussed with SOAP services or use some output
caching mechanism in the web server (ASP.NET Cache for example), but a
good thing is that the web can be your friend in this matter too.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/05/14/don-t-use-services-unless-you-necessarily-need-them/">Don’t Use Services Unless You Necessarily Need Them</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-05-14T00:00:00-03:00" pubdate data-updated="true">May 14<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/05/14/don-t-use-services-unless-you-necessarily-need-them/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There are multiple factors or requirements that might lead you to
refactor some functionality into services. Here are some examples,</p>

<ul>
<li>You have explicit requirements to distribute work across machines.
This is a typical example of smart client applications (i.e.
Silverlight apps), which runs a thin UI layer and have all the
backend logic as part of services.</li>
<li>You need to run code remotely in a specific machine, so a good
choice is to expose that as a service.  </li>
<li>You need to expose certain functionally of your system to other
parties in a loosely coupled manner. Other parties in this context
could mean anything such as other applications in the same
organization, third party client applications, etc.</li>
<li>You have some CPU intensive code that you might want to execute in
another machine to do some load balancing.</li>
</ul>


<p>If you don’t have any of these requirements, you might want to think
twice before coming up with the crazy idea of building services because
you just think it is cool. The idea of building services must born from
explicit requirements in the system you are creating, and that must be
planned carefully. </p>

<p>A common problem I usually see is that many developers or architects opt
to build services to follow old principles of work distribution like you
find in N-Tier applications, so they end up with tons of services that
only makes sense in the context of the application they are building,
but not as a unit of reuse.  In many cases, these services are usually
UI driven, which means they are tied to the UI workflow and does not
have a well defined interface.</p>

<p>Here is where I recommend to stick to the Martin Fowler’s <a href="http://martinfowler.com/bliki/FirstLaw.html">first law of
distribution</a>, “Don’t
distribute your objects”. Using a different layer with services for your
business logic to solve scalability issues don’t necessarily makes sense
these days. That’s a problem you can usually solve by scaling
horizontally with additional web servers to support more user requests
at the same time. If you still need to reuse some logic from different
places within your application, nothing prevents you from moving all
that logic to common libraries that run within the same process.</p>

<p>Services when used incorrectly only adds more complexity to the solution
you are creating. You have an additional layer to maintain and
configure, and configuring services is not something trivial. Unless you
don’t use a central repository, you will probably run into a
configuration hell with configuration files everywhere.  This generally
leads to maintainability issues in the long run.</p>

<p>In conclusion, avoid distributing work with services unless you really
need it.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/05/07/making-the-httpmessagehandlerfactory-in-wcf-web-apis-more-di-friendly/">Making the HttpMessageHandlerFactory in WCF Web Apis More DI Friendly</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-05-07T00:00:00-03:00" pubdate data-updated="true">May 7<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/05/07/making-the-httpmessagehandlerfactory-in-wcf-web-apis-more-di-friendly/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The HttpMessageHandlerFactory shipped out of the box in the WCF Web Apis
Preview 4 can only construct channels instances with a single argument
in the constructor representing the inner channel in the pipeline.</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
public abstract class DelegatingChannel : HttpMessageChannel
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
{
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>protected DelegatingChannel(HttpMessageChannel innerChannel);
</code></pre>

<p>~~~~</p>

<p>This is the constructor that the factory always try to invoke by
default. However, this approach does not work well when you need to
inject some dependencies into the channels for doing some real work and
making the channel more testable.</p>

<p>Going back to the example I shown a couple of weeks ago for doing a key
validation, the key validator was an external dependency I had to inject
into my channel.</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
public class ApiKeyVerificationChannel : DelegatingChannel
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
{
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>public const string KeyHeaderName = "X-AuthKey";
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>IKeyVerifier keyVerifier;
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>public ApiKeyVerificationChannel(HttpMessageChannel innerChannel)
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    : this(innerChannel, new KeyVerifier())
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>{
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>}
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>public ApiKeyVerificationChannel(HttpMessageChannel innerChannel, IKeyVerifier keyVerifier)
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    : base(innerChannel)
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>{
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    this.keyVerifier = keyVerifier;
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>}
</code></pre>

<p>~~~~</p>

<p>At that time, I just used a poor man DI solution for passing that
dependency to the channel. The constructor invoked by the factory was
creating an instance of the concrete implementation and passing that to
the constructor receiving the dependency as an interface.</p>

<p>The good thing is that the HttpMessageHandlerFactory can be extended to
support other strategies, so that’s what I am going to do as part of
this post to show how the factory can be extended to inject any number
of external dependencies into the channels.</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
public class CustomHttpMessageHandlerFactory : HttpMessageHandlerFactory
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
{
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>Func&lt;HttpMessageChannel, DelegatingChannel&gt;[] factories;
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>public CustomHttpMessageHandlerFactory()
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    : base()
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>{
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>}
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>public CustomHttpMessageHandlerFactory(params Func&lt;HttpMessageChannel, DelegatingChannel&gt;[] factories)
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>{
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    this.factories = factories;
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>}
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>protected override HttpMessageChannel OnCreate(HttpMessageChannel innerChannel)
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>{
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    if (innerChannel == null)
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    {
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>        throw new ArgumentNullException("innerChannel");
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    }
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    HttpMessageChannel pipeline = innerChannel;
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    foreach (var factory in this.factories)
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    {
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>        pipeline = factory(innerChannel);
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    }
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    return pipeline;
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>}
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
}
</del></p>

<p>The trick here is to pass an array of Func delegates representing
factories for the channels as part of the constructor, and override the
OnCreate method to actually instantiate those channels with the
delegates.</p>

<p>This makes possible to do things like the following to instantiate the
channels as part of the configuration,</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
var keyVerifier = new KeyVerifier();
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
var config = HttpHostConfiguration.Create()
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>.SetMessageHandlerFactory(new CustomHttpMessageHandlerFactory(innerChannel =&gt;
</code></pre>

<p>~~~~</p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>    new ApiKeyVerificationChannel(innerChannel, keyVerifier)));
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
// setting up contacts services
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
RouteTable.Routes.MapServiceRoute<ContactsResource>(&ldquo;contacts&rdquo;, config);
</del></p>

<p>As you can see, I am passing a lambda expression for instantiating the
ApiKeyVerificationChannel with an existing IKeyVerifier instance. No
need to use the Poor Man DI approach anymore
<img src="http://weblogs.asp.net/blogs/cibrax/wlEmoticon-smile_0D510C67.png" alt="Smile" />.
You can also extend this example and resolve things like the
IKeyVerifier from a service container, but I will let that part as
homework for the reader.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/05/05/we-have-iqueryable-so-why-bother-with-a-repository/">We Have IQueryable, So Why Bother With a Repository</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-05-05T00:00:00-03:00" pubdate data-updated="true">May 5<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/05/05/we-have-iqueryable-so-why-bother-with-a-repository/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The repository pattern became popular a couple of years ago by the hand
of Eric Evans with the DDD (Domain Driven Design) movement and Martin
Fowler with his catalog of Enterprise Application Patterns.</p>

<p>The idea of having persistence ignorant entities inferred from the
business domain and a repository as a simple intermediary for
abstracting the underline persistence storage details had a great
acceptance in the development community. No matter if you decided to
stick to DDD or not, the repository pattern brought an incredible value
to the table by decoupling your business domain code from details of the
database access code (or any other underline storage).  This was
particularly important for unit testing your business domain classes. I
personally don’t think in a case of completely replacing  the underline
storage, from a database to a http service or a file for example,
because those scenarios are not very common and usually involves more
changes than just switch the repository layer. </p>

<p>The idea of using an abstraction layer at that level was not new at all,
but it was mutating with different names and shapes over the time. I am
pretty sure many of you still remember the data access layer in the old
times of COM when the N Tier architecture was a popular idea pushed by
Microsoft. Same idea but different name, design and implementation
details.</p>

<p>However, a time after the repository became popular, a great game
changer was introduced in the .NET ecosystem with something with all
know as Linq.</p>

<p>Linq already provides an abstraction layer with common query
capabilities on top of any data source so why bother with yet another
abstraction layer like a repository. It results that the entry point to
the query system in Linq, IQueryable, is not enough most of the times
and only provides a read-only view with query support over the data
source. We also need operations to persist changes in the repository,
and that’s not something we get out of the box with IQueryable.</p>

<p>Microsoft on his side has provided some popular Linq implementations as
part of the .NET framework to address particular scenarios or common
problems like object relation mapping for databases with Entity
Framework, xml management with Linq to XML or data management over http
with WCF data services to name a few.</p>

<p>An initial problem with some of these implementations is that they
didn’t make certain abstractions implicit making really hard to
replicate their behavior with mocks or stubs as part of an unit test. A
typical example was the the “eager loading” capability of EF in the
initial versions. It was not possible to use lazy loading for
associations, and the Include method for loading those was not something
you could easily abstract as part of the repository. While this issue
was partially addressed with POCOs, only the latest EF code first bits
makes the approach of making an unit testable  repository <a href="http://blogs.clariusconsulting.net/kzu/how-to-design-a-unit-testable-domain-model-with-entity-framework-code-first/">something
possible</a>.</p>

<p>I agree with Daniel that a repository should only provide IQueryable for
the aggregated roots  and methods for persisting changes in the
underline store. This is how the ideal repository abstraction should
look to me,</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
public interface IRepository
</del></p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
{
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>void SaveChanges();
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>void Add&lt;T&gt;(T entity) where T : IEntity;
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>void Update&lt;T&gt;(T entity) where T : IEntity;
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>void Delete&lt;T&gt;(long id) where T : IEntity;
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>IQueryable&lt;OneEntity&gt; Entities { get; }
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
 
</del></p>

<p>~~~~ {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}</p>

<pre><code>// Other aggregate roots.
</code></pre>

<p>~~~~</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
}
</del></p>

<p>Before you say something, this is not the typical repository pattern,
yes, because it also uses the unit of work pattern to submit the
changes. To be honest, I don’t really care having the unit of work as
part of this abstraction because it makes the repository easier to test
and use too. However, there are some disadvantages of exposing
IQueryable directly in your repository.</p>

<ul>
<li>You can not easily reuse queries. At that point, you might want to
have some pre-defined extension methods for creating IQueryable
instances with all the filters already set. If you are still not a
big fan of using this approach, you might want to switch to an
approach based on query specs as this one,
<a href="http://linqspecs.codeplex.com/">LinqSpecs</a>. </li>
<li>Other developers can alter the original purpose of the queries, or
make things wrong with it. I think this is not a problem of this
approach at all, but it mostly related to <a href="http://davybrion.com/blog/2009/04/educate-developers-instead-of-protecting-them/">“developer
protection”</a>.</li>
</ul>


<p>What about methods for filtering data that receive an expression like
this one,</p>

<p><del> {style=&ldquo;border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &lsquo;Courier New&rsquo;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px&rdquo;}
IQueryable<T> Find(Expression&lt;Func&lt;T,bool>> predicate);
</del></p>

<p>Unless Microsoft provides a good support for comparing expression trees
in the .NET framework, I would stay away from that approach. I made a
mistake myself of using it in the past for a repository over WCF Data
Services. What I learned from that experience is that most of the
mocking frameworks don’t support that approach very well, so it works
<a href="http://www.codethinked.com/comparing-simple-lambda-expressions-with-moq">some
times</a>.</p>

<p>In conclusion, try to provide a single entry point to your unit of work
and expose all the aggregate roots with IQueryable as part of it
whenever it is possible.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/05/05/tellago-upcoming-webinars/">Tellago Upcoming Webinars</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-05-05T00:00:00-03:00" pubdate data-updated="true">May 5<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/05/05/tellago-upcoming-webinars/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We are happy to announce a new program “Technology Updates” as part our
plans to help developers and IT people to adopt new technologies.</p>

<p>As part of this program, we will explore and debate about many of the
emergent technologies through different webinars.  The first two
webinars announced are:</p>

<p>• <a href="http://www.regonline.com/970013">NOSQL Databases for the .Net developer: What’s the fuss all
about</a> ? (May 24 2011 &ndash; 2:00pm &ndash; 3:00pm
EST)  \
• <a href="https://www.regonline.com/developingnetapplicationsforiphoneandandroid">I Like IPHONE and ANDROID but I am a .Net Developer: Developing .Net
Applications for IPHONE and
ANDROID</a>
(Jun 21 2011 &ndash; 2:00pm &ndash; 3:00pm EST)</p>

<p>You can read more about these webinars in our <a href="http://www.tellago.com">brand new
website</a>!  Those webinars are completely free
and open to anyone.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/04/29/second-round-on-web-http-caching/">Second Round of Web Http Caching</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-04-29T00:00:00-03:00" pubdate data-updated="true">Apr 29<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/04/29/second-round-on-web-http-caching/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As I discussed in my <a href="http://weblogs.asp.net/cibrax/archive/2011/04/25/implementing-caching-in-your-wcf-web-apis.aspx">previous
post</a>,
web caching relies on specific headers that you need to use correctly on
your services. That’s an http application protocol thing, and something
that you can easily use in any application framework that treats Http as
first citizen. This means that you don’t need to implement anything
fancy or exclusively rely on an specific caching technology or
components for doing ouput caching (e.g ASP.NET Cache).</p>

<p>You only need to worry about using the Expires and Cache-Control headers
correctly and optionally setting up a validation process with
conditional gets. If the application framework automatically provides
this for you under the hood, that’s definitely a good thing too.</p>

<p>I promised to write a more detailed post with some extensions for WCF,
but Jose beat me to it. He wrote an <a href="http://jfromaniello.blogspot.com/2011/04/http-cache-and-rest-services.html">excellent
post</a>
on how to implement some generic extensions for WCF Web Apis, and what’s
more important, how to configure intermediaries like local caches in the
browser or reverse proxies (Squid) to cache the data for us. </p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/7/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/5/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/11/22/automatic-client-cert-detection-in-adfs-2-dot-0/">Automatic Client Cert Detection in ADFS 2.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/21/injecting-dynamic-content-in-windows-azure-package/">Injecting Dynamic Content in Windows Azure Packages</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/01/full-text-searches-in-sql-azure-with-solr/">Full-Text Searches in SQL Azure With Solr</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/27/unit-testing-improvements-in-asp-dot-net-web-api/">Unit Testing Improvements in ASP.NET Web API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/29/using-the-katana-authentication-handlers-with-nancyfx/">Using the Katana Authentication Handlers With NancyFx</a>
      </li>
    
  </ul>
</section>
 <a href="http://feeds.feedburner.com/cibrax"><img src="http://feeds.feedburner.com/~fc/cibrax?bg=FF3300&amp;fg=000000&amp;anim=0" style="border:0" alt="" /></a>

 <script type="text/javascript" language="javascript" src="http://twittercounter.com/embed/?username=cibrax&style=white"></script>
<a href="https://mvp.microsoft.com/en-us/mvp/Pablo%20Cibraro-33800"><img src="/images/mvp.gif" border="0" /></a>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pcibraro">@pcibraro</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pcibraro',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Cibrax -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cibrax';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
