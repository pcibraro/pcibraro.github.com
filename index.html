
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pablo Cibraro (Cibrax)</title>
  <meta name="author" content="Cibrax">

  
  <meta name="description" content="ADFS 2.0 supports multiple authentication methods through authentication handlers that are mutually exclusive. If one of the handlers runs, the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cibrax.me">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/cibrax" rel="alternate" title="Pablo Cibraro (Cibrax)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44468149-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pablo Cibraro (Cibrax)</a></h1>
  
    <h2>All about software development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/cibrax" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cibrax.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/22/automatic-client-cert-detection-in-adfs-2-dot-0/">Automatic Client Cert Detection in ADFS 2.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-22T12:29:00-03:00" pubdate data-updated="true">Nov 22<span>nd</span>, 2013</time>
        
         | <a href="/blog/2013/11/22/automatic-client-cert-detection-in-adfs-2-dot-0/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ADFS 2.0 supports multiple authentication methods through authentication handlers that are mutually exclusive. If one of the handlers runs, the others don&rsquo;t. There is no way to implement a fallback logic if one the handlers fail to run or the user was not able to provide the expected credentials, so supporting dual authentication such as username/password and client certificates is sometimes problematic.  The following list shows the handlers included out of the box with ADFS 2.0,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;microsoft.identityServer.web&gt;</span>
</span><span class='line'>  <span class="nt">&lt;localAuthenticationTypes&gt;</span>
</span><span class='line'>      <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;Forms&quot;</span> <span class="na">page=</span><span class="s">&quot;FormsSignIn.aspx&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;Integrated&quot;</span> <span class="na">page=</span><span class="s">&quot;auth/integrated/&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;TlsClient&quot;</span> <span class="na">page=</span><span class="s">&quot;auth/sslclient/&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;Basic&quot;</span> <span class="na">page=</span><span class="s">&quot;auth/basic/&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/localAuthenticationTypes&gt;</span>
</span><span class='line'><span class="nt">&lt;microsoft.identityServer.web&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Those handlers are for Forms Authentication (Username/Password in an html form), Integrated Windows Authentication, Client Cert Authentication, and finally Http Basic Auth Authentication. The order in this list determines the priority by default unless the priority has been changed in the execution context. The order in the execution context can be changed in multiple ways. For example, when you are doing WS-Federation, the relying party can pass an additional &ldquo;WAuth&rdquo; query string parameter with the expected authentication type such as &ldquo;urn:oasis:names:tc:SAML:1.0:am:password&rdquo; for Forms Authentication or &ldquo;urn:ietf:rfc:2246&rdquo; for Client Cert authentication, which overrides the priority in the list set on the configuration. The same thing can be done for SAML 2.0 by changing the authentication context in the SAML Request message or changing the URL.</p>

<p>However, as I said before, in one of the handlers run, you will not have a chance to run any of the other handlers unless you implement some workaround. For example, you might want to add a checkbox in the html form for Forms authentication to allow the user to authenticate with a client certificate. When the checkbox is clicked, you do an http redirect to ADFS but changing the URL this time to use this new authentication method. If the RP is using WS-Federation, that means a new redirect that includes the WAuth query string variable with the value &ldquo;urn:ietf:rfc:2246&rdquo;, or a redirect to &ldquo;auth/sslclient/&rdquo; in the case of SAML 2.0.</p>

<p>If you want to avoid this manual step and detect the client certificate automatically, more work is involved, and it is what we are going to discuss next.</p>

<ol>
<li>Enable Forms Authentication as default in the configuration file. The &ldquo;Forms&rdquo; handler must be on top of the list.</li>
<li>Create a new virtual directory in the ADFS IIS, and configure that virtual directory to require HTTPS and Accept Client Certs.</li>
</ol>


<p><img src="/images/adfs_cert/iis.png" title="IIS Settings" alt="IIS Settings" /></p>

<ol>
<li>Configure an ASP.NET Generic handler in that virtual directory to check if the certificate is present or not</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Web</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">CertificateHandler</span> <span class="p">:</span> <span class="n">IHttpHandler</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">ProcessRequest</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="s">&quot;application/javascript&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">ClientCertificate</span><span class="p">.</span><span class="n">IsPresent</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;if(typeof(certificateCallback) == &#39;function&#39;) </span>
</span><span class='line'>              <span class="p">{</span> <span class="p">(</span><span class="n">certificateCallback</span><span class="p">)</span> <span class="p">(</span><span class="k">true</span><span class="p">);</span> <span class="p">}</span><span class="s">&quot;);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;if(typeof(certificateCallback) == &#39;function&#39;) </span>
</span><span class='line'>              <span class="p">{</span> <span class="p">(</span><span class="n">certificateCallback</span><span class="p">)</span> <span class="p">(</span><span class="k">false</span><span class="p">);</span> <span class="p">}</span><span class="s">&quot;);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsReusable</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code checks if the client certificate is present and invokes a javascript callback with &ldquo;true&rdquo; or &ldquo;false&rdquo; based on that condition. This code does not check the authenticity of the cert or anything else, and it is only for determining if the certificate is present. The rest of the validations will be done by ADFS.</p>

<ol>
<li>Configure this handler in the web.config of that virtual directory.</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;system.webServer&gt;</span>
</span><span class='line'>  <span class="nt">&lt;handlers&gt;</span>
</span><span class='line'>    <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;certificate&quot;</span> <span class="na">type=</span><span class="s">&quot;CertificateHandler&quot;</span> <span class="na">path=</span><span class="s">&quot;Script&quot;</span> <span class="na">verb=</span><span class="s">&quot;GET&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/handlers&gt;</span>
</span><span class='line'><span class="nt">&lt;/system.webServer&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Include a CertCallBack.js javascript file into the ADFS folder with the code required for the callback,</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">certificateCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cert</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">url</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">cert</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">url</span> <span class="o">=</span> <span class="s2">&quot;auth/sslclient/&quot;</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">;</span>
</span><span class='line'>        <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code is very simple. It simply does a redirect when the cert is present (the callback was called with a &ldquo;true&rdquo; value). The redirect in this sample is only valid for SAML 2.0</p>

<ol>
<li>Modify the FormsSign.aspx page to include the following code at the end of the Page_Load event,</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="kt">string</span> <span class="n">script</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">ReadAllText</span><span class="p">(</span><span class="n">Server</span><span class="p">.</span><span class="n">MapPath</span><span class="p">(</span><span class="s">&quot;CertCallBack.js&quot;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="k">this</span><span class="p">.</span><span class="n">Page</span><span class="p">.</span><span class="n">ClientScript</span><span class="p">.</span><span class="n">RegisterClientScriptBlock</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">GetType</span><span class="p">(),</span> <span class="s">&quot;callback&quot;</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="k">this</span><span class="p">.</span><span class="n">Page</span><span class="p">.</span><span class="n">ClientScript</span><span class="p">.</span><span class="n">RegisterClientScriptInclude</span><span class="p">(</span><span class="s">&quot;certauth&quot;</span><span class="p">,</span> <span class="s">&quot;/CertDetection/Script&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code injects our CertCallBack.js script in the page and it also includes the script located in the virtual directory configured to accept client certs (/CertDetection/Script invokes the ASP.NET Handler basically)</p>

<p>That should be all. If the browser detects a client certificate when the script in the CertDetection virtual directory is resolved, the callback will be executed with a true value, making the form to do a redirect to authenticate the client with a Client Certificate instead. Otherwise, the client will see the Form to enter the username and password. We are adding a new virtual directory for not interferring with the existing authentication methods in the ADFS virtual directory.</p>

<p>The code for the handler and the javascript callback is included in the <a href="/external/adfs_cert/CertDetection.zip">attached zip file</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/21/injecting-dynamic-content-in-windows-azure-package/">Injecting Dynamic Content in Windows Azure Packages</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-21T10:52:00-03:00" pubdate data-updated="true">Nov 21<span>st</span>, 2013</time>
        
         | <a href="/blog/2013/11/21/injecting-dynamic-content-in-windows-azure-package/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The Windows Azure Tools 1.7 introduced a new feature for adding content to the Windows Azure projects called &ldquo;Role Content Folders&rdquo;. In some scenarios, you might want to add custom content such as static pages, documentation, configuration files or external binaries for example. This is useful for example if you want to deploy a solution not written in .NET such as java implementation, and you don&rsquo;t want to mix that with the .NET code in the Role project. The following image shows how the content folders are added in the Azure project.</p>

<p><img src="/images/azure_content/content_folders.png" title="Content Folders" alt="Content Folders" /></p>

<p>That content is included in the generated Azure package, and it is deployed in the AppRoot folder when the package is finally published in VM in the cloud.</p>

<p>One of the problem with this feature is that you might want to include content with an structure that changes often or content with thousands of folders/files, which requires some tedious manual work in Visual Studio to keep that content updated in the project.</p>

<p>Good news is that you can use a MSBuild task to inject that custom content automatically when the package is being generated. You have to include a custom Target &ldquo;BeforeRoleAddContent&rdquo; right after the declaration of the &ldquo;Microsoft.WindowsAzure.targets&rdquo; as it is shown bellow,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Import</span> <span class="na">Project=</span><span class="s">&quot;$(CloudExtensionsDir)Microsoft.WindowsAzure.targets&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">&quot;BeforeAddRoleContent&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;ItemGroup&gt;</span>
</span><span class='line'>    <span class="nt">&lt;AzureRoleContent</span> <span class="na">Include=</span><span class="s">&quot;..\Solr\Solr&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;RoleName&gt;</span>SolrMasterHostWorkerRole<span class="nt">&lt;/RoleName&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Destination&gt;</span>Solr<span class="nt">&lt;/Destination&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/AzureRoleContent&gt;</span>
</span><span class='line'>    <span class="nt">&lt;AzureRoleContent</span> <span class="na">Include=</span><span class="s">&quot;..\Solr\jre6&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;RoleName&gt;</span>SolrMasterHostWorkerRole<span class="nt">&lt;/RoleName&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Destination&gt;</span>jre6<span class="nt">&lt;/Destination&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/AzureRoleContent&gt;</span>
</span><span class='line'>    <span class="nt">&lt;AzureRoleContent</span> <span class="na">Include=</span><span class="s">&quot;..\Solr\SolrFiles&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;RoleName&gt;</span>SolrMasterHostWorkerRole<span class="nt">&lt;/RoleName&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Destination&gt;</span>SolrFiles<span class="nt">&lt;/Destination&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/AzureRoleContent&gt;</span>
</span><span class='line'>    <span class="nt">&lt;AzureRoleContent</span> <span class="na">Include=</span><span class="s">&quot;..\Solr\Solr&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;RoleName&gt;</span>SolrSlaveHostWorkerRole<span class="nt">&lt;/RoleName&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Destination&gt;</span>Solr<span class="nt">&lt;/Destination&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/AzureRoleContent&gt;</span>
</span><span class='line'>    <span class="nt">&lt;AzureRoleContent</span> <span class="na">Include=</span><span class="s">&quot;..\Solr\jre6&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;RoleName&gt;</span>SolrSlaveHostWorkerRole<span class="nt">&lt;/RoleName&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Destination&gt;</span>jre6<span class="nt">&lt;/Destination&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/AzureRoleContent&gt;</span>
</span><span class='line'>    <span class="nt">&lt;AzureRoleContent</span> <span class="na">Include=</span><span class="s">&quot;..\Solr\SolrFiles&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;RoleName&gt;</span>SolrSlaveHostWorkerRole<span class="nt">&lt;/RoleName&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Destination&gt;</span>SolrFiles<span class="nt">&lt;/Destination&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/AzureRoleContent&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/ItemGroup&gt;</span>
</span><span class='line'><span class="nt">&lt;/Target&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The example above injects several content folders in two different roles, &ldquo;SolrMasterHostWorkerRole&rdquo; and &ldquo;SolrSlaveHostWorkerRole&rdquo;. The &ldquo;Include&rdquo; attribute specifies the source folder, and the Destination folder within the AppRoot is specified in the Destination element.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/01/full-text-searches-in-sql-azure-with-solr/">Full-Text Searches in SQL Azure With Solr</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-01T15:41:00-03:00" pubdate data-updated="true">Nov 1<span>st</span>, 2013</time>
        
         | <a href="/blog/2013/11/01/full-text-searches-in-sql-azure-with-solr/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Solr is a robust search platform created by the open source community on top of Apache Lucene. It&rsquo;s completelly written in java, and uses the Lucene java implementation at is core for full-text indexing and search. In addition, it exposes an http web interface for doing the full text searches and perform management tasks.
On other hand, we have SQL Azure, which currently does not support full text searches, so these two services complement very well each other.</p>

<p>As Solr is mainly a java implementation, you only have a few alternatives to run in on Windows Azure. You can deploy it as a worker role together with the java runtime machine, or you can deploy it in a VM. As any solution in the cloud, the state persisted in the worker role or VM goes away when the VMs are replaced or they go down. As Solr persists the indexes in disk, you need to make sure it is stored in a permament storage like Azure Drive or the storage service. If you decide to use a worker role, this requires some additional work to make Solr to store the indexes in Azure drive for example, which is a VHD stored in the storage service that can be mounted by the VM as a local disk. Good news is that MS Open Tech has already done this for us. They have a created a template that deployes Solr with a fail-over configuration(master-slave) in two worker roles, one role for the master node, and another role for the slave node. The slave node replicates from the master node, so in case you lost one of them, you still have the other node available. . In addition, it configures a web role with an MVC application that acts as a admin dashboard for doing basic management stuff. This solution is hosted in Github as part of this project <a href="https://github.com/MSOpenTech/Windows-Azure-Solr">Windows-Azure-Solr</a>. The Github site also provides instructions to get the solution deployed in Windows Azure.</p>

<p>The template that you download from GitHub imports data into Solr by crawling some URLs. That&rsquo;s part of the data-config.xml file that you can find in the configuration folder of the master and slave nodes (SolrMasterWorkerRole\SolrFiles\data-config.xml and SolrSlaveWorkerRole\SolrFiles\data-config.xml). Solr supports the idea of data importers, which can be used to import data from different sources such as existing web sites, files in disk or even a database.</p>

<p>In this case, we will modify that data-config.xml file to use a data importer that pulls data from an existing SQL Azure instance. The following example shows how this data importer configuration looks like,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dataConfig&gt;</span>
</span><span class='line'>  <span class="nt">&lt;dataSource</span> <span class="na">type=</span><span class="s">&quot;JdbcDataSource&quot;</span> <span class="na">name=</span><span class="s">&quot;ds1&quot;</span>
</span><span class='line'>    <span class="na">driver=</span><span class="s">&quot;com.microsoft.sqlserver.jdbc.SQLServerDriver&quot;</span>
</span><span class='line'>    <span class="na">url=</span><span class="s">&quot;jdbc:sqlserver://[your server];database=[your database];user=[your user];password=[your user];encrypt=true;hostNameInCertificate=*.database.windows.net;loginTimeout=30;&quot;</span>
</span><span class='line'>    <span class="na">readOnly=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>  <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;document</span> <span class="na">name=</span><span class="s">&quot;articles&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;article&quot;</span> <span class="na">dataSource=</span><span class="s">&quot;ds1&quot;</span> <span class="na">pk=</span><span class="s">&quot;id&quot;</span>
</span><span class='line'>  <span class="na">query =</span> <span class="s">&quot;SELECT id, title, description, tags, author, lastupdated from Articles&quot;</span>
</span><span class='line'>  <span class="na">deltaQuery=</span><span class="s">&quot;select id FROM Articles WHERE LastUpdated &amp;gt; &#39;${dataimporter.last_index_time}&#39;&quot;</span>
</span><span class='line'>  <span class="na">deltaImportQuery=</span><span class="s">&quot;SELECT id, title, description, tags, author, lastupdated from Articles where id = &#39;${dataimporter.delta.id}&#39;&quot;</span>
</span><span class='line'>      <span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&quot;title&quot;</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&quot;description&quot;</span> <span class="na">name=</span><span class="s">&quot;description&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&quot;tags&quot;</span> <span class="na">name=</span><span class="s">&quot;tags&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&quot;author&quot;</span> <span class="na">name=</span><span class="s">&quot;author&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;field</span> <span class="na">column=</span><span class="s">&quot;lastupdated&quot;</span> <span class="na">name=</span><span class="s">&quot;lastupdated&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/entity&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/document&gt;</span>
</span><span class='line'><span class="nt">&lt;/dataConfig&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>First of all, we have defined a dataSource element that points to our SQL Azure instance. This is a Jdbc data source that uses the SQL Server driver and sets the connection string in the url attribute.
Secondly, we have defined a document, which specifies one or more entities that are mapped from the SQL Azure database with a select statement. The fields section maps the different fields in the document to the fields returned by the select statements. This document is what Solr stores in the index using Lucene. As you can see, three queries have been defined. The first one with the &ldquo;query&rdquo; attribute is used by the data importer when a full import of the complete database is done into Solr. The other two queries are used for supporting a delta or partial import scenario. These two are optional and useful only in scenarios where you have frecuent updates and a lot of data to import, which will make the full import considerably slow.</p>

<p>Since this data importer uses the SQL Server driver for the Jdbc data source, you will have to download that package from the Microsoft website and copying it in the folder where Solr looks for the external libraries (SolrMasterWorkerRole\Solr\dist and SolrSlaveWorkerRole\Solr\dist).</p>

<p>We have defined so far the mapping of a document against one or more tables in the database, but Solr still requires the definition of those fields, which are part of the schema. The schema definition can be found in the schema.xml file (SolrMasterWorkerRole\SolrFiles\v44\schema.xml and SolrSlaveWorkerRole\SolrFiles\v44\schema.xml). The following example shows how the schema is modified to include the fields used by the data importer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;description&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;tags&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;author&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;lastupdated&quot;</span> <span class="na">type=</span><span class="s">&quot;date&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is enough to get Solr configured to pull data from SQL Azure, so we are in conditions to deploy Solr into an Windows Azure subscription also using the tool provided by MS Open Tech. If you have installed all the pre-requisites and followed the instructions in the wiki page of the Github website, the following command should be enough to perform that deployment.</p>

<p>Inst4WA.exe -XmlConfigPath &ldquo;SolrInstWR_V4.4.xml&rdquo; -subscription &ldquo;[subscription name]&rdquo; -location &ldquo;[location]&rdquo; -DomainName &ldquo;[cloud service name]&rdquo;</p>

<p>If you are lucky enough to get the command to work in the first instance, it will open a new browser instance when the deployment is complete, and it will also redirect you to the MVC dashboard running in the web role.</p>

<p>You are in conditions now to execute a few commands to import the data into Solr. You will see the location and port where the Solr master and slave nodes are running as part of the home page in the dashboard. For doing a full import into the master role, you have to copy that location and port, and append &ldquo;/dataimport?command=full-import&rdquo;. For example, &ldquo;<a href="http://mysamplesolr.cloudapp.net:21000/solr/dataimport?command=full-import">http://mysamplesolr.cloudapp.net:21000/solr/dataimport?command=full-import</a>&rdquo;. That will start a full import that runs asynchronously, so you can use this other command to check the status of the import &ldquo;/dataimport?command=status&rdquo;. For doing a partial import, you only change the command to this one &ldquo;/dataimport?command=delta-import&rdquo;. Once the import is complete, you can do a search to verify that everything looks ok. That can be done with the following command &ldquo;/select?q=[query]&rdquo;. For example, &ldquo;<a href="http://mysamplesolr.cloudapp.net:21000/solr/select?q=azure">http://mysamplesolr.cloudapp.net:21000/solr/select?q=azure</a>&rdquo;</p>

<p>So you have Solr indexing all your data now, but what happens with the security ?. This thing is open to the world. Anyone can do anything with your Solr instances as everything is public. There are some ways to secure Solr pages by changing some settings in the web server, which is Jetty by default. However, the Solr documentation recommends to put Solr behind a reverse proxy that filters the requests. There are several reverse proxy implementations for Solr in Github, but I will use a different approach for Windows Azure here. Given that the MS Open Tech template includes a web role for the MVC dashboard, and two worker roles for running the Solr master and slave instances, we can make the Solr instances available in internal endpoints only and use the MVC application as a facade or reverse proxy to forward all the requests to these instances. The only public and visible face will be the MVC application in the web role. All the requests for Solr must go through this MVC application first, which can filter any request that looks malicious or any request that can damage the existing indexes. A simple way to do this is to allow only get operations and filter the rest. This is the approach I&rsquo;ve been taken and implemented as part of a fork created from the MS OpenTech project in Github. This fork is available <a href="https://github.com/pcibraro/Windows-Azure-Solr">here</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/27/unit-testing-improvements-in-asp-dot-net-web-api/">Unit Testing Improvements in ASP.NET Web API</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-27T12:46:00-03:00" pubdate data-updated="true">Sep 27<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/09/27/unit-testing-improvements-in-asp-dot-net-web-api/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A time ago I discussed some serious issues in ASP.NET Web API for testing controllers that were using the Request or UrlHelper instances because those required a valid HttpConfiguration instance. You could initialize the HttpConfiguration instace, but that required a lot of work and some ugly code as part of your tests.</p>

<p>The following method in a controller works to describe the problem,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">HttpResponseMessage</span> <span class="nf">Post</span><span class="p">(</span><span class="n">User</span> <span class="n">model</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">Request</span><span class="p">.</span><span class="n">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">Created</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">link</span> <span class="p">=</span> <span class="n">Url</span><span class="p">.</span><span class="n">Link</span><span class="p">(</span><span class="s">&quot;DefaultApi&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">id</span> <span class="p">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">controller</span> <span class="p">=</span> <span class="s">&quot;Users&quot;</span> <span class="p">});</span>
</span><span class='line'>  <span class="n">response</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Location</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The Request propery is being used to generate a content negotiated response, and the Url property to infer the new location for the resource. If you use ASP.NET Web API as it is today, you will have to write a lot of custom code to initialize the configuration instance as it is shown below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">controller</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UserController</span><span class="p">();</span>
</span><span class='line'><span class="n">controller</span><span class="p">.</span><span class="n">Configuration</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpConfiguration</span><span class="p">();</span>
</span><span class='line'><span class="kt">var</span> <span class="n">route</span> <span class="p">=</span> <span class="n">controller</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">Routes</span><span class="p">.</span><span class="n">MapHttpRoute</span><span class="p">(</span>
</span><span class='line'>         <span class="n">name</span><span class="p">:</span> <span class="s">&quot;DefaultApi&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="n">routeTemplate</span><span class="p">:</span> <span class="s">&quot;api/{controller}/{id}&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="n">defaults</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">id</span> <span class="p">=</span> <span class="n">RouteParameter</span><span class="p">.</span><span class="n">Optional</span> <span class="p">}</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="kt">var</span> <span class="n">routeData</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpRouteData</span><span class="p">(</span><span class="n">route</span><span class="p">,</span>
</span><span class='line'>       <span class="k">new</span> <span class="n">HttpRouteValueDictionary</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="p">{</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="s">&quot;1&quot;</span> <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span> <span class="s">&quot;controller&quot;</span><span class="p">,</span> <span class="s">&quot;Users&quot;</span> <span class="p">}</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="n">controller</span><span class="p">.</span><span class="n">Request</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpRequestMessage</span><span class="p">(</span><span class="n">HttpMethod</span><span class="p">.</span><span class="n">Post</span><span class="p">,</span>
</span><span class='line'>  <span class="s">&quot;http://localhost:9091/&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">controller</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Properties</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">HttpPropertyKeys</span><span class="p">.</span><span class="n">HttpConfigurationKey</span><span class="p">,</span> <span class="n">controller</span><span class="p">.</span><span class="n">Configuration</span><span class="p">);</span>
</span><span class='line'><span class="n">controller</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Properties</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">HttpPropertyKeys</span><span class="p">.</span><span class="n">HttpRouteDataKey</span><span class="p">,</span> <span class="n">routeData</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Glenn Block wrote a very nice extension as part of the Web API Contrib project for making this configuration much more simpler. This extension is available here, <a href="https://github.com/WebApiContrib/WebAPIContrib/blob/master/src/WebApiContrib.Testing/ApiControllerExtensions.cs.">https://github.com/WebApiContrib/WebAPIContrib/blob/master/src/WebApiContrib.Testing/ApiControllerExtensions.cs.</a></p>

<p>However, we can left all this in the past with the new ASP.NET Web API vNext release. The introduction of the IHttpActionResult interface (Equivalent to ActionResult in ASP.NET MVC) has simplified a lot the unit testing story for controllers. A controller method can return now an implementation of IHttpActionResult, which internally uses the Request or the UrlHelper for link generation, so the unit test only cares about the returned IHttpActionResult instance.</p>

<p>The following code shows the same controller method using an instance of IHttpActionResult.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">CreatedAtRouteNegotiatedContentResult</span><span class="p">&lt;</span><span class="n">UserModel</span><span class="p">&gt;</span> <span class="n">Post</span><span class="p">(</span><span class="n">UserModel</span> <span class="n">user</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">user</span><span class="p">.</span><span class="n">Id</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CreatedAtRouteNegotiatedContentResult</span><span class="p">&lt;</span><span class="n">UserModel</span><span class="p">&gt;(</span>
</span><span class='line'>    <span class="s">&quot;DefaultApi&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="p">{</span> <span class="p">{</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">Id</span> <span class="p">}</span> <span class="p">},</span>
</span><span class='line'>      <span class="n">user</span><span class="p">,</span>
</span><span class='line'>      <span class="k">this</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>CreatedAtRouteNegotiatedContentResult is an implementation also included in the framework for handling this scenario. A new resource is created and the location is set in the response message.</p>

<p>The code for the unit test is much simpler too.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[TestMethod]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">ShouldCreateUser</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">controller</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UserController</span><span class="p">();</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">controller</span><span class="p">.</span><span class="n">Post</span><span class="p">(</span><span class="k">new</span> <span class="n">UserModel</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;foo&quot;</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Assert</span><span class="p">.</span><span class="n">IsInstanceOfType</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">Content</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">UserModel</span><span class="p">));</span>
</span><span class='line'>    <span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The UrlHelper class has also been modified to make most of its methods virtual, so they can be mocked or overriden as part of an unit test. You can use this in case you still need to rely on the Url instance in the controller. For example, if you have a controller method like this one.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">HttpResponseMessage</span> <span class="nf">Post</span><span class="p">(</span><span class="n">UserModel</span> <span class="n">user</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">user</span><span class="p">.</span><span class="n">Id</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpResponseMessage</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">Created</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">link</span> <span class="p">=</span> <span class="n">Url</span><span class="p">.</span><span class="n">Link</span><span class="p">(</span><span class="s">&quot;DefaultApi&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="k">new</span> <span class="p">{</span> <span class="n">id</span> <span class="p">=</span> <span class="n">user</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">controller</span> <span class="p">=</span> <span class="s">&quot;User&quot;</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">response</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Location</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can create a custom class that derives from UrlHelper and overrides the Link method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[TestMethod]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">ShouldCreateUser</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">controller</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UserController</span><span class="p">();</span>
</span><span class='line'>  <span class="n">controller</span><span class="p">.</span><span class="n">Url</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyUrlHelper</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">controller</span><span class="p">.</span><span class="n">Post</span><span class="p">(</span>
</span><span class='line'>    <span class="k">new</span> <span class="n">UserModel</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;foo&quot;</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">MyUrlHelper</span> <span class="p">:</span> <span class="n">UrlHelper</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">override</span> <span class="kt">string</span> <span class="nf">Link</span><span class="p">(</span><span class="kt">string</span> <span class="n">routeName</span><span class="p">,</span> <span class="kt">object</span> <span class="n">routeValues</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;http://example.com/user/1&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/11/22/automatic-client-cert-detection-in-adfs-2-dot-0/">Automatic Client Cert Detection in ADFS 2.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/21/injecting-dynamic-content-in-windows-azure-package/">Injecting Dynamic Content in Windows Azure Packages</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/01/full-text-searches-in-sql-azure-with-solr/">Full-Text Searches in SQL Azure With Solr</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/27/unit-testing-improvements-in-asp-dot-net-web-api/">Unit Testing Improvements in ASP.NET Web API</a>
      </li>
    
  </ul>
</section>
 <a href="http://feeds.feedburner.com/cibrax"><img src="http://feeds.feedburner.com/~fc/cibrax?bg=FF3300&amp;fg=000000&amp;anim=0" style="border:0" alt="" /></a>

 <script type="text/javascript" language="javascript" src="http://twittercounter.com/embed/?username=cibrax&style=white"></script>
<a href="https://mvp.microsoft.com/en-us/mvp/Pablo%20Cibraro-33800"><img src="/images/mvp.gif" border="0" /></a>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pcibraro">@pcibraro</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pcibraro',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Cibrax -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cibrax';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
